/*! For license information please see p2p.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Hls=e():t.Hls=e()}(this,(()=>(()=>{var e={742:(t,e)=>{"use strict";e.byteLength=function(t){var e=l(t),i=e[0],r=e[1];return 3*(i+r)/4-r},e.toByteArray=function(t){var e,i,n=l(t),a=n[0],o=n[1],h=new s(function(t,e,i){return 3*(e+i)/4-i}(0,a,o)),d=0,c=o>0?a-4:a;for(i=0;i<c;i+=4)e=r[t.charCodeAt(i)]<<18|r[t.charCodeAt(i+1)]<<12|r[t.charCodeAt(i+2)]<<6|r[t.charCodeAt(i+3)],h[d++]=e>>16&255,h[d++]=e>>8&255,h[d++]=255&e;return 2===o&&(e=r[t.charCodeAt(i)]<<2|r[t.charCodeAt(i+1)]>>4,h[d++]=255&e),1===o&&(e=r[t.charCodeAt(i)]<<10|r[t.charCodeAt(i+1)]<<4|r[t.charCodeAt(i+2)]>>2,h[d++]=e>>8&255,h[d++]=255&e),h},e.fromByteArray=function(t){for(var e,r=t.length,s=r%3,n=[],a=16383,o=0,l=r-s;o<l;o+=a)n.push(h(t,o,o+a>l?l:o+a));return 1===s?(e=t[r-1],n.push(i[e>>2]+i[e<<4&63]+"==")):2===s&&(e=(t[r-2]<<8)+t[r-1],n.push(i[e>>10]+i[e>>4&63]+i[e<<2&63]+"=")),n.join("")};for(var i=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,o=n.length;a<o;++a)i[a]=n[a],r[n.charCodeAt(a)]=a;function l(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function h(t,e,r){for(var s,n,a=[],o=e;o<r;o+=3)s=(t[o]<<16&16711680)+(t[o+1]<<8&65280)+(255&t[o+2]),a.push(i[(n=s)>>18&63]+i[n>>12&63]+i[n>>6&63]+i[63&n]);return a.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},764:(t,e,i)=>{"use strict";const r=i(742),s=i(645),n="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=l,e.SlowBuffer=function(t){return+t!=t&&(t=0),l.alloc(+t)},e.INSPECT_MAX_BYTES=50;const a=2147483647;function o(t){if(t>a)throw new RangeError('The value "'+t+'" is invalid for option "size"');const e=new Uint8Array(t);return Object.setPrototypeOf(e,l.prototype),e}function l(t,e,i){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return c(t)}return h(t,e,i)}function h(t,e,i){if("string"==typeof t)return function(t,e){if("string"==typeof e&&""!==e||(e="utf8"),!l.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const i=0|p(t,e);let r=o(i);const s=r.write(t,e);return s!==i&&(r=r.slice(0,s)),r}(t,e);if(ArrayBuffer.isView(t))return function(t){if(z(t,Uint8Array)){const e=new Uint8Array(t);return f(e.buffer,e.byteOffset,e.byteLength)}return u(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(z(t,ArrayBuffer)||t&&z(t.buffer,ArrayBuffer))return f(t,e,i);if("undefined"!=typeof SharedArrayBuffer&&(z(t,SharedArrayBuffer)||t&&z(t.buffer,SharedArrayBuffer)))return f(t,e,i);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');const r=t.valueOf&&t.valueOf();if(null!=r&&r!==t)return l.from(r,e,i);const s=function(t){if(l.isBuffer(t)){const e=0|g(t.length),i=o(e);return 0===i.length||t.copy(i,0,0,e),i}return void 0!==t.length?"number"!=typeof t.length||X(t.length)?o(0):u(t):"Buffer"===t.type&&Array.isArray(t.data)?u(t.data):void 0}(t);if(s)return s;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return l.from(t[Symbol.toPrimitive]("string"),e,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function d(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function c(t){return d(t),o(t<0?0:0|g(t))}function u(t){const e=t.length<0?0:0|g(t.length),i=o(e);for(let r=0;r<e;r+=1)i[r]=255&t[r];return i}function f(t,e,i){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(i||0))throw new RangeError('"length" is outside of buffer bounds');let r;return r=void 0===e&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,e):new Uint8Array(t,e,i),Object.setPrototypeOf(r,l.prototype),r}function g(t){if(t>=a)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a.toString(16)+" bytes");return 0|t}function p(t,e){if(l.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||z(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);const i=t.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===i)return 0;let s=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return q(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return W(t).length;default:if(s)return r?-1:q(t).length;e=(""+e).toLowerCase(),s=!0}}function m(t,e,i){let r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return k(this,e,i);case"utf8":case"utf-8":return A(this,e,i);case"ascii":return C(this,e,i);case"latin1":case"binary":return I(this,e,i);case"base64":return _(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return D(this,e,i);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function y(t,e,i){const r=t[e];t[e]=t[i],t[i]=r}function v(t,e,i,r,s){if(0===t.length)return-1;if("string"==typeof i?(r=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),X(i=+i)&&(i=s?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(s)return-1;i=t.length-1}else if(i<0){if(!s)return-1;i=0}if("string"==typeof e&&(e=l.from(e,r)),l.isBuffer(e))return 0===e.length?-1:E(t,e,i,r,s);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?s?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):E(t,[e],i,r,s);throw new TypeError("val must be string, number or Buffer")}function E(t,e,i,r,s){let n,a=1,o=t.length,l=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;a=2,o/=2,l/=2,i/=2}function h(t,e){return 1===a?t[e]:t.readUInt16BE(e*a)}if(s){let r=-1;for(n=i;n<o;n++)if(h(t,n)===h(e,-1===r?0:n-r)){if(-1===r&&(r=n),n-r+1===l)return r*a}else-1!==r&&(n-=n-r),r=-1}else for(i+l>o&&(i=o-l),n=i;n>=0;n--){let i=!0;for(let r=0;r<l;r++)if(h(t,n+r)!==h(e,r)){i=!1;break}if(i)return n}return-1}function T(t,e,i,r){i=Number(i)||0;const s=t.length-i;r?(r=Number(r))>s&&(r=s):r=s;const n=e.length;let a;for(r>n/2&&(r=n/2),a=0;a<r;++a){const r=parseInt(e.substr(2*a,2),16);if(X(r))return a;t[i+a]=r}return a}function b(t,e,i,r){return Y(q(e,t.length-i),t,i,r)}function S(t,e,i,r){return Y(function(t){const e=[];for(let i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,r)}function w(t,e,i,r){return Y(W(e),t,i,r)}function R(t,e,i,r){return Y(function(t,e){let i,r,s;const n=[];for(let a=0;a<t.length&&!((e-=2)<0);++a)i=t.charCodeAt(a),r=i>>8,s=i%256,n.push(s),n.push(r);return n}(e,t.length-i),t,i,r)}function _(t,e,i){return 0===e&&i===t.length?r.fromByteArray(t):r.fromByteArray(t.slice(e,i))}function A(t,e,i){i=Math.min(t.length,i);const r=[];let s=e;for(;s<i;){const e=t[s];let n=null,a=e>239?4:e>223?3:e>191?2:1;if(s+a<=i){let i,r,o,l;switch(a){case 1:e<128&&(n=e);break;case 2:i=t[s+1],128==(192&i)&&(l=(31&e)<<6|63&i,l>127&&(n=l));break;case 3:i=t[s+1],r=t[s+2],128==(192&i)&&128==(192&r)&&(l=(15&e)<<12|(63&i)<<6|63&r,l>2047&&(l<55296||l>57343)&&(n=l));break;case 4:i=t[s+1],r=t[s+2],o=t[s+3],128==(192&i)&&128==(192&r)&&128==(192&o)&&(l=(15&e)<<18|(63&i)<<12|(63&r)<<6|63&o,l>65535&&l<1114112&&(n=l))}}null===n?(n=65533,a=1):n>65535&&(n-=65536,r.push(n>>>10&1023|55296),n=56320|1023&n),r.push(n),s+=a}return function(t){const e=t.length;if(e<=L)return String.fromCharCode.apply(String,t);let i="",r=0;for(;r<e;)i+=String.fromCharCode.apply(String,t.slice(r,r+=L));return i}(r)}e.kMaxLength=a,l.TYPED_ARRAY_SUPPORT=function(){try{const t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),l.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(l.prototype,"parent",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.buffer}}),Object.defineProperty(l.prototype,"offset",{enumerable:!0,get:function(){if(l.isBuffer(this))return this.byteOffset}}),l.poolSize=8192,l.from=function(t,e,i){return h(t,e,i)},Object.setPrototypeOf(l.prototype,Uint8Array.prototype),Object.setPrototypeOf(l,Uint8Array),l.alloc=function(t,e,i){return function(t,e,i){return d(t),t<=0?o(t):void 0!==e?"string"==typeof i?o(t).fill(e,i):o(t).fill(e):o(t)}(t,e,i)},l.allocUnsafe=function(t){return c(t)},l.allocUnsafeSlow=function(t){return c(t)},l.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==l.prototype},l.compare=function(t,e){if(z(t,Uint8Array)&&(t=l.from(t,t.offset,t.byteLength)),z(e,Uint8Array)&&(e=l.from(e,e.offset,e.byteLength)),!l.isBuffer(t)||!l.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let i=t.length,r=e.length;for(let s=0,n=Math.min(i,r);s<n;++s)if(t[s]!==e[s]){i=t[s],r=e[s];break}return i<r?-1:r<i?1:0},l.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return l.alloc(0);let i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;const r=l.allocUnsafe(e);let s=0;for(i=0;i<t.length;++i){let e=t[i];if(z(e,Uint8Array))s+e.length>r.length?(l.isBuffer(e)||(e=l.from(e)),e.copy(r,s)):Uint8Array.prototype.set.call(r,e,s);else{if(!l.isBuffer(e))throw new TypeError('"list" argument must be an Array of Buffers');e.copy(r,s)}s+=e.length}return r},l.byteLength=p,l.prototype._isBuffer=!0,l.prototype.swap16=function(){const t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)y(this,e,e+1);return this},l.prototype.swap32=function(){const t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)y(this,e,e+3),y(this,e+1,e+2);return this},l.prototype.swap64=function(){const t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)y(this,e,e+7),y(this,e+1,e+6),y(this,e+2,e+5),y(this,e+3,e+4);return this},l.prototype.toString=function(){const t=this.length;return 0===t?"":0===arguments.length?A(this,0,t):m.apply(this,arguments)},l.prototype.toLocaleString=l.prototype.toString,l.prototype.equals=function(t){if(!l.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===l.compare(this,t)},l.prototype.inspect=function(){let t="";const i=e.INSPECT_MAX_BYTES;return t=this.toString("hex",0,i).replace(/(.{2})/g,"$1 ").trim(),this.length>i&&(t+=" ... "),"<Buffer "+t+">"},n&&(l.prototype[n]=l.prototype.inspect),l.prototype.compare=function(t,e,i,r,s){if(z(t,Uint8Array)&&(t=l.from(t,t.offset,t.byteLength)),!l.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===r&&(r=0),void 0===s&&(s=this.length),e<0||i>t.length||r<0||s>this.length)throw new RangeError("out of range index");if(r>=s&&e>=i)return 0;if(r>=s)return-1;if(e>=i)return 1;if(this===t)return 0;let n=(s>>>=0)-(r>>>=0),a=(i>>>=0)-(e>>>=0);const o=Math.min(n,a),h=this.slice(r,s),d=t.slice(e,i);for(let t=0;t<o;++t)if(h[t]!==d[t]){n=h[t],a=d[t];break}return n<a?-1:a<n?1:0},l.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},l.prototype.indexOf=function(t,e,i){return v(this,t,e,i,!0)},l.prototype.lastIndexOf=function(t,e,i){return v(this,t,e,i,!1)},l.prototype.write=function(t,e,i,r){if(void 0===e)r="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)r=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(i)?(i>>>=0,void 0===r&&(r="utf8")):(r=i,i=void 0)}const s=this.length-e;if((void 0===i||i>s)&&(i=s),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let n=!1;for(;;)switch(r){case"hex":return T(this,t,e,i);case"utf8":case"utf-8":return b(this,t,e,i);case"ascii":case"latin1":case"binary":return S(this,t,e,i);case"base64":return w(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,t,e,i);default:if(n)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),n=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const L=4096;function C(t,e,i){let r="";i=Math.min(t.length,i);for(let s=e;s<i;++s)r+=String.fromCharCode(127&t[s]);return r}function I(t,e,i){let r="";i=Math.min(t.length,i);for(let s=e;s<i;++s)r+=String.fromCharCode(t[s]);return r}function k(t,e,i){const r=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>r)&&(i=r);let s="";for(let r=e;r<i;++r)s+=Q[t[r]];return s}function D(t,e,i){const r=t.slice(e,i);let s="";for(let t=0;t<r.length-1;t+=2)s+=String.fromCharCode(r[t]+256*r[t+1]);return s}function P(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function x(t,e,i,r,s,n){if(!l.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>s||e<n)throw new RangeError('"value" argument is out of bounds');if(i+r>t.length)throw new RangeError("Index out of range")}function O(t,e,i,r,s){K(e,r,s,t,i,7);let n=Number(e&BigInt(4294967295));t[i++]=n,n>>=8,t[i++]=n,n>>=8,t[i++]=n,n>>=8,t[i++]=n;let a=Number(e>>BigInt(32)&BigInt(4294967295));return t[i++]=a,a>>=8,t[i++]=a,a>>=8,t[i++]=a,a>>=8,t[i++]=a,i}function M(t,e,i,r,s){K(e,r,s,t,i,7);let n=Number(e&BigInt(4294967295));t[i+7]=n,n>>=8,t[i+6]=n,n>>=8,t[i+5]=n,n>>=8,t[i+4]=n;let a=Number(e>>BigInt(32)&BigInt(4294967295));return t[i+3]=a,a>>=8,t[i+2]=a,a>>=8,t[i+1]=a,a>>=8,t[i]=a,i+8}function F(t,e,i,r,s,n){if(i+r>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function N(t,e,i,r,n){return e=+e,i>>>=0,n||F(t,0,i,4),s.write(t,e,i,r,23,4),i+4}function U(t,e,i,r,n){return e=+e,i>>>=0,n||F(t,0,i,8),s.write(t,e,i,r,52,8),i+8}l.prototype.slice=function(t,e){const i=this.length;(t=~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),(e=void 0===e?i:~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),e<t&&(e=t);const r=this.subarray(t,e);return Object.setPrototypeOf(r,l.prototype),r},l.prototype.readUintLE=l.prototype.readUIntLE=function(t,e,i){t>>>=0,e>>>=0,i||P(t,e,this.length);let r=this[t],s=1,n=0;for(;++n<e&&(s*=256);)r+=this[t+n]*s;return r},l.prototype.readUintBE=l.prototype.readUIntBE=function(t,e,i){t>>>=0,e>>>=0,i||P(t,e,this.length);let r=this[t+--e],s=1;for(;e>0&&(s*=256);)r+=this[t+--e]*s;return r},l.prototype.readUint8=l.prototype.readUInt8=function(t,e){return t>>>=0,e||P(t,1,this.length),this[t]},l.prototype.readUint16LE=l.prototype.readUInt16LE=function(t,e){return t>>>=0,e||P(t,2,this.length),this[t]|this[t+1]<<8},l.prototype.readUint16BE=l.prototype.readUInt16BE=function(t,e){return t>>>=0,e||P(t,2,this.length),this[t]<<8|this[t+1]},l.prototype.readUint32LE=l.prototype.readUInt32LE=function(t,e){return t>>>=0,e||P(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},l.prototype.readUint32BE=l.prototype.readUInt32BE=function(t,e){return t>>>=0,e||P(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},l.prototype.readBigUInt64LE=J((function(t){H(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||V(t,this.length-8);const r=e+256*this[++t]+65536*this[++t]+this[++t]*2**24,s=this[++t]+256*this[++t]+65536*this[++t]+i*2**24;return BigInt(r)+(BigInt(s)<<BigInt(32))})),l.prototype.readBigUInt64BE=J((function(t){H(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||V(t,this.length-8);const r=e*2**24+65536*this[++t]+256*this[++t]+this[++t],s=this[++t]*2**24+65536*this[++t]+256*this[++t]+i;return(BigInt(r)<<BigInt(32))+BigInt(s)})),l.prototype.readIntLE=function(t,e,i){t>>>=0,e>>>=0,i||P(t,e,this.length);let r=this[t],s=1,n=0;for(;++n<e&&(s*=256);)r+=this[t+n]*s;return s*=128,r>=s&&(r-=Math.pow(2,8*e)),r},l.prototype.readIntBE=function(t,e,i){t>>>=0,e>>>=0,i||P(t,e,this.length);let r=e,s=1,n=this[t+--r];for(;r>0&&(s*=256);)n+=this[t+--r]*s;return s*=128,n>=s&&(n-=Math.pow(2,8*e)),n},l.prototype.readInt8=function(t,e){return t>>>=0,e||P(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},l.prototype.readInt16LE=function(t,e){t>>>=0,e||P(t,2,this.length);const i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},l.prototype.readInt16BE=function(t,e){t>>>=0,e||P(t,2,this.length);const i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},l.prototype.readInt32LE=function(t,e){return t>>>=0,e||P(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},l.prototype.readInt32BE=function(t,e){return t>>>=0,e||P(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},l.prototype.readBigInt64LE=J((function(t){H(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||V(t,this.length-8);const r=this[t+4]+256*this[t+5]+65536*this[t+6]+(i<<24);return(BigInt(r)<<BigInt(32))+BigInt(e+256*this[++t]+65536*this[++t]+this[++t]*2**24)})),l.prototype.readBigInt64BE=J((function(t){H(t>>>=0,"offset");const e=this[t],i=this[t+7];void 0!==e&&void 0!==i||V(t,this.length-8);const r=(e<<24)+65536*this[++t]+256*this[++t]+this[++t];return(BigInt(r)<<BigInt(32))+BigInt(this[++t]*2**24+65536*this[++t]+256*this[++t]+i)})),l.prototype.readFloatLE=function(t,e){return t>>>=0,e||P(t,4,this.length),s.read(this,t,!0,23,4)},l.prototype.readFloatBE=function(t,e){return t>>>=0,e||P(t,4,this.length),s.read(this,t,!1,23,4)},l.prototype.readDoubleLE=function(t,e){return t>>>=0,e||P(t,8,this.length),s.read(this,t,!0,52,8)},l.prototype.readDoubleBE=function(t,e){return t>>>=0,e||P(t,8,this.length),s.read(this,t,!1,52,8)},l.prototype.writeUintLE=l.prototype.writeUIntLE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||x(this,t,e,i,Math.pow(2,8*i)-1,0);let s=1,n=0;for(this[e]=255&t;++n<i&&(s*=256);)this[e+n]=t/s&255;return e+i},l.prototype.writeUintBE=l.prototype.writeUIntBE=function(t,e,i,r){t=+t,e>>>=0,i>>>=0,r||x(this,t,e,i,Math.pow(2,8*i)-1,0);let s=i-1,n=1;for(this[e+s]=255&t;--s>=0&&(n*=256);)this[e+s]=t/n&255;return e+i},l.prototype.writeUint8=l.prototype.writeUInt8=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,1,255,0),this[e]=255&t,e+1},l.prototype.writeUint16LE=l.prototype.writeUInt16LE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},l.prototype.writeUint16BE=l.prototype.writeUInt16BE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},l.prototype.writeUint32LE=l.prototype.writeUInt32LE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},l.prototype.writeUint32BE=l.prototype.writeUInt32BE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},l.prototype.writeBigUInt64LE=J((function(t,e=0){return O(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),l.prototype.writeBigUInt64BE=J((function(t,e=0){return M(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),l.prototype.writeIntLE=function(t,e,i,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*i-1);x(this,t,e,i,r-1,-r)}let s=0,n=1,a=0;for(this[e]=255&t;++s<i&&(n*=256);)t<0&&0===a&&0!==this[e+s-1]&&(a=1),this[e+s]=(t/n>>0)-a&255;return e+i},l.prototype.writeIntBE=function(t,e,i,r){if(t=+t,e>>>=0,!r){const r=Math.pow(2,8*i-1);x(this,t,e,i,r-1,-r)}let s=i-1,n=1,a=0;for(this[e+s]=255&t;--s>=0&&(n*=256);)t<0&&0===a&&0!==this[e+s+1]&&(a=1),this[e+s]=(t/n>>0)-a&255;return e+i},l.prototype.writeInt8=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},l.prototype.writeInt16LE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},l.prototype.writeInt16BE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},l.prototype.writeInt32LE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},l.prototype.writeInt32BE=function(t,e,i){return t=+t,e>>>=0,i||x(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},l.prototype.writeBigInt64LE=J((function(t,e=0){return O(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),l.prototype.writeBigInt64BE=J((function(t,e=0){return M(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),l.prototype.writeFloatLE=function(t,e,i){return N(this,t,e,!0,i)},l.prototype.writeFloatBE=function(t,e,i){return N(this,t,e,!1,i)},l.prototype.writeDoubleLE=function(t,e,i){return U(this,t,e,!0,i)},l.prototype.writeDoubleBE=function(t,e,i){return U(this,t,e,!1,i)},l.prototype.copy=function(t,e,i,r){if(!l.isBuffer(t))throw new TypeError("argument should be a Buffer");if(i||(i=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<i&&(r=i),r===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-i&&(r=t.length-e+i);const s=r-i;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,i,r):Uint8Array.prototype.set.call(t,this.subarray(i,r),e),s},l.prototype.fill=function(t,e,i,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,i=this.length):"string"==typeof i&&(r=i,i=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!l.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===t.length){const e=t.charCodeAt(0);("utf8"===r&&e<128||"latin1"===r)&&(t=e)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;let s;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(s=e;s<i;++s)this[s]=t;else{const n=l.isBuffer(t)?t:l.from(t,r),a=n.length;if(0===a)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(s=0;s<i-e;++s)this[s+e]=n[s%a]}return this};const B={};function $(t,e,i){B[t]=class extends i{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function G(t){let e="",i=t.length;const r="-"===t[0]?1:0;for(;i>=r+4;i-=3)e=`_${t.slice(i-3,i)}${e}`;return`${t.slice(0,i)}${e}`}function K(t,e,i,r,s,n){if(t>i||t<e){const r="bigint"==typeof e?"n":"";let s;throw s=n>3?0===e||e===BigInt(0)?`>= 0${r} and < 2${r} ** ${8*(n+1)}${r}`:`>= -(2${r} ** ${8*(n+1)-1}${r}) and < 2 ** ${8*(n+1)-1}${r}`:`>= ${e}${r} and <= ${i}${r}`,new B.ERR_OUT_OF_RANGE("value",s,t)}!function(t,e,i){H(e,"offset"),void 0!==t[e]&&void 0!==t[e+i]||V(e,t.length-(i+1))}(r,s,n)}function H(t,e){if("number"!=typeof t)throw new B.ERR_INVALID_ARG_TYPE(e,"number",t)}function V(t,e,i){if(Math.floor(t)!==t)throw H(t,i),new B.ERR_OUT_OF_RANGE(i||"offset","an integer",t);if(e<0)throw new B.ERR_BUFFER_OUT_OF_BOUNDS;throw new B.ERR_OUT_OF_RANGE(i||"offset",`>= ${i?1:0} and <= ${e}`,t)}$("ERR_BUFFER_OUT_OF_BOUNDS",(function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),$("ERR_INVALID_ARG_TYPE",(function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`}),TypeError),$("ERR_OUT_OF_RANGE",(function(t,e,i){let r=`The value of "${t}" is out of range.`,s=i;return Number.isInteger(i)&&Math.abs(i)>2**32?s=G(String(i)):"bigint"==typeof i&&(s=String(i),(i>BigInt(2)**BigInt(32)||i<-(BigInt(2)**BigInt(32)))&&(s=G(s)),s+="n"),r+=` It must be ${e}. Received ${s}`,r}),RangeError);const j=/[^+/0-9A-Za-z-_]/g;function q(t,e){let i;e=e||1/0;const r=t.length;let s=null;const n=[];for(let a=0;a<r;++a){if(i=t.charCodeAt(a),i>55295&&i<57344){if(!s){if(i>56319){(e-=3)>-1&&n.push(239,191,189);continue}if(a+1===r){(e-=3)>-1&&n.push(239,191,189);continue}s=i;continue}if(i<56320){(e-=3)>-1&&n.push(239,191,189),s=i;continue}i=65536+(s-55296<<10|i-56320)}else s&&(e-=3)>-1&&n.push(239,191,189);if(s=null,i<128){if((e-=1)<0)break;n.push(i)}else if(i<2048){if((e-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function W(t){return r.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(j,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function Y(t,e,i,r){let s;for(s=0;s<r&&!(s+i>=e.length||s>=t.length);++s)e[s+i]=t[s];return s}function z(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function X(t){return t!=t}const Q=function(){const t="0123456789abcdef",e=new Array(256);for(let i=0;i<16;++i){const r=16*i;for(let s=0;s<16;++s)e[r+s]=t[i]+t[s]}return e}();function J(t){return"undefined"==typeof BigInt?Z:t}function Z(){throw new Error("BigInt not supported")}},114:t=>{"use strict";function e(t,e){for(const i in e)Object.defineProperty(t,i,{value:e[i],enumerable:!0,configurable:!0});return t}t.exports=function(t,i,r){if(!t||"string"==typeof t)throw new TypeError("Please pass an Error to err-code");r||(r={}),"object"==typeof i&&(r=i,i=""),i&&(r.code=i);try{return e(t,r)}catch(i){r.message=t.message,r.stack=t.stack;const s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(t)),e(new s,r)}}},187:t=>{"use strict";var e,i="object"==typeof Reflect?Reflect:null,r=i&&"function"==typeof i.apply?i.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};e=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var s=Number.isNaN||function(t){return t!=t};function n(){n.init.call(this)}t.exports=n,t.exports.once=function(t,e){return new Promise((function(i,r){function s(i){t.removeListener(e,n),r(i)}function n(){"function"==typeof t.removeListener&&t.removeListener("error",s),i([].slice.call(arguments))}p(t,e,n,{once:!0}),"error"!==e&&function(t,e,i){"function"==typeof t.on&&p(t,"error",e,{once:!0})}(t,s)}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var a=10;function o(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function l(t){return void 0===t._maxListeners?n.defaultMaxListeners:t._maxListeners}function h(t,e,i,r){var s,n,a,h;if(o(i),void 0===(n=t._events)?(n=t._events=Object.create(null),t._eventsCount=0):(void 0!==n.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),n=t._events),a=n[e]),void 0===a)a=n[e]=i,++t._eventsCount;else if("function"==typeof a?a=n[e]=r?[i,a]:[a,i]:r?a.unshift(i):a.push(i),(s=l(t))>0&&a.length>s&&!a.warned){a.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=t,d.type=e,d.count=a.length,h=d,console&&console.warn&&console.warn(h)}return t}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function c(t,e,i){var r={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},s=d.bind(r);return s.listener=i,r.wrapFn=s,s}function u(t,e,i){var r=t._events;if(void 0===r)return[];var s=r[e];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(s):g(s,s.length)}function f(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(t,e){for(var i=new Array(e),r=0;r<e;++r)i[r]=t[r];return i}function p(t,e,i,r){if("function"==typeof t.on)r.once?t.once(e,i):t.on(e,i);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function s(n){r.once&&t.removeEventListener(e,s),i(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");a=t}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||s(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},n.prototype.getMaxListeners=function(){return l(this)},n.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var s="error"===t,n=this._events;if(void 0!==n)s=s&&void 0===n.error;else if(!s)return!1;if(s){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=n[t];if(void 0===l)return!1;if("function"==typeof l)r(l,this,e);else{var h=l.length,d=g(l,h);for(i=0;i<h;++i)r(d[i],this,e)}return!0},n.prototype.addListener=function(t,e){return h(this,t,e,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(t,e){return h(this,t,e,!0)},n.prototype.once=function(t,e){return o(e),this.on(t,c(this,t,e)),this},n.prototype.prependOnceListener=function(t,e){return o(e),this.prependListener(t,c(this,t,e)),this},n.prototype.removeListener=function(t,e){var i,r,s,n,a;if(o(e),void 0===(r=this._events))return this;if(void 0===(i=r[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete r[t],r.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(s=-1,n=i.length-1;n>=0;n--)if(i[n]===e||i[n].listener===e){a=i[n].listener,s=n;break}if(s<0)return this;0===s?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,s),1===i.length&&(r[t]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",t,a||e)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(t){var e,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var s,n=Object.keys(i);for(r=0;r<n.length;++r)"removeListener"!==(s=n[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(r=e.length-1;r>=0;r--)this.removeListener(t,e[r]);return this},n.prototype.listeners=function(t){return u(this,t,!0)},n.prototype.rawListeners=function(t){return u(this,t,!1)},n.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}},177:t=>{t.exports=function(){if("undefined"==typeof globalThis)return null;var t={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return t.RTCPeerConnection?t:null}},645:(t,e)=>{e.read=function(t,e,i,r,s){var n,a,o=8*s-r-1,l=(1<<o)-1,h=l>>1,d=-7,c=i?s-1:0,u=i?-1:1,f=t[e+c];for(c+=u,n=f&(1<<-d)-1,f>>=-d,d+=o;d>0;n=256*n+t[e+c],c+=u,d-=8);for(a=n&(1<<-d)-1,n>>=-d,d+=r;d>0;a=256*a+t[e+c],c+=u,d-=8);if(0===n)n=1-h;else{if(n===l)return a?NaN:1/0*(f?-1:1);a+=Math.pow(2,r),n-=h}return(f?-1:1)*a*Math.pow(2,n-r)},e.write=function(t,e,i,r,s,n){var a,o,l,h=8*n-s-1,d=(1<<h)-1,c=d>>1,u=23===s?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:n-1,g=r?1:-1,p=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,a=d):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),(e+=a+c>=1?u/l:u*Math.pow(2,1-c))*l>=2&&(a++,l/=2),a+c>=d?(o=0,a=d):a+c>=1?(o=(e*l-1)*Math.pow(2,s),a+=c):(o=e*Math.pow(2,c-1)*Math.pow(2,s),a=0));s>=8;t[i+f]=255&o,f+=g,o/=256,s-=8);for(a=a<<s|o,h+=s;h>0;t[i+f]=255&a,f+=g,a/=256,h-=8);t[i+f-g]|=128*p}},717:t=>{"function"==typeof Object.create?t.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(t,e){if(e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}}},155:t=>{var e,i,r=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function a(t){if(e===setTimeout)return setTimeout(t,0);if((e===s||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(i){try{return e.call(null,t,0)}catch(i){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:s}catch(t){e=s}try{i="function"==typeof clearTimeout?clearTimeout:n}catch(t){i=n}}();var o,l=[],h=!1,d=-1;function c(){h&&o&&(h=!1,o.length?l=o.concat(l):d=-1,l.length&&u())}function u(){if(!h){var t=a(c);h=!0;for(var e=l.length;e;){for(o=l,l=[];++d<e;)o&&o[d].run();d=-1,e=l.length}o=null,h=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===n||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{return i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function g(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];l.push(new f(t,e)),1!==l.length||h||a(u)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},375:(t,e,i)=>{let r;t.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:i.g):t=>(r||(r=Promise.resolve())).then(t).catch((t=>setTimeout((()=>{throw t}),0)))},798:(t,e,i)=>{"use strict";var r=i(155),s=65536,n=i(509).Buffer,a=i.g.crypto||i.g.msCrypto;a&&a.getRandomValues?t.exports=function(t,e){if(t>4294967295)throw new RangeError("requested too many random bytes");var i=n.allocUnsafe(t);if(t>0)if(t>s)for(var o=0;o<t;o+=s)a.getRandomValues(i.slice(o,o+s));else a.getRandomValues(i);return"function"==typeof e?r.nextTick((function(){e(null,i)})):i}:t.exports=function(){throw new Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}},281:t=>{"use strict";var e={};function i(t,i,r){r||(r=Error);var s=function(t){var e,r;function s(e,r,s){return t.call(this,function(t,e,r){return"string"==typeof i?i:i(t,e,r)}(e,r,s))||this}return r=t,(e=s).prototype=Object.create(r.prototype),e.prototype.constructor=e,e.__proto__=r,s}(r);s.prototype.name=r.name,s.prototype.code=t,e[t]=s}function r(t,e){if(Array.isArray(t)){var i=t.length;return t=t.map((function(t){return String(t)})),i>2?"one of ".concat(e," ").concat(t.slice(0,i-1).join(", "),", or ")+t[i-1]:2===i?"one of ".concat(e," ").concat(t[0]," or ").concat(t[1]):"of ".concat(e," ").concat(t[0])}return"of ".concat(e," ").concat(String(t))}i("ERR_INVALID_OPT_VALUE",(function(t,e){return'The value "'+e+'" is invalid for option "'+t+'"'}),TypeError),i("ERR_INVALID_ARG_TYPE",(function(t,e,i){var s,n,a,o,l;if("string"==typeof e&&(n="not ",e.substr(0,n.length)===n)?(s="must not be",e=e.replace(/^not /,"")):s="must be",function(t,e,i){return(void 0===i||i>t.length)&&(i=t.length),t.substring(i-e.length,i)===e}(t," argument"))a="The ".concat(t," ").concat(s," ").concat(r(e,"type"));else{var h=("number"!=typeof l&&(l=0),l+".".length>(o=t).length||-1===o.indexOf(".",l)?"argument":"property");a='The "'.concat(t,'" ').concat(h," ").concat(s," ").concat(r(e,"type"))}return a+". Received type ".concat(typeof i)}),TypeError),i("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),i("ERR_METHOD_NOT_IMPLEMENTED",(function(t){return"The "+t+" method is not implemented"})),i("ERR_STREAM_PREMATURE_CLOSE","Premature close"),i("ERR_STREAM_DESTROYED",(function(t){return"Cannot call "+t+" after a stream was destroyed"})),i("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),i("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),i("ERR_STREAM_WRITE_AFTER_END","write after end"),i("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),i("ERR_UNKNOWN_ENCODING",(function(t){return"Unknown encoding: "+t}),TypeError),i("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),t.exports.q=e},753:(t,e,i)=>{"use strict";var r=i(155),s=Object.keys||function(t){var e=[];for(var i in t)e.push(i);return e};t.exports=d;var n=i(481),a=i(229);i(717)(d,n);for(var o=s(a.prototype),l=0;l<o.length;l++){var h=o[l];d.prototype[h]||(d.prototype[h]=a.prototype[h])}function d(t){if(!(this instanceof d))return new d(t);n.call(this,t),a.call(this,t),this.allowHalfOpen=!0,t&&(!1===t.readable&&(this.readable=!1),!1===t.writable&&(this.writable=!1),!1===t.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",c)))}function c(){this._writableState.ended||r.nextTick(u,this)}function u(t){t.end()}Object.defineProperty(d.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(d.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(d.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(d.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(t){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=t,this._writableState.destroyed=t)}})},725:(t,e,i)=>{"use strict";t.exports=s;var r=i(605);function s(t){if(!(this instanceof s))return new s(t);r.call(this,t)}i(717)(s,r),s.prototype._transform=function(t,e,i){i(null,t)}},481:(t,e,i)=>{"use strict";var r,s=i(155);t.exports=_,_.ReadableState=R,i(187).EventEmitter;var n,a=function(t,e){return t.listeners(e).length},o=i(503),l=i(764).Buffer,h=(void 0!==i.g?i.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}).Uint8Array||function(){},d=i(616);n=d&&d.debuglog?d.debuglog("stream"):function(){};var c,u,f,g=i(327),p=i(195),m=i(457).getHighWaterMark,y=i(281).q,v=y.ERR_INVALID_ARG_TYPE,E=y.ERR_STREAM_PUSH_AFTER_EOF,T=y.ERR_METHOD_NOT_IMPLEMENTED,b=y.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;i(717)(_,o);var S=p.errorOrDestroy,w=["error","close","destroy","pause","resume"];function R(t,e,s){r=r||i(753),t=t||{},"boolean"!=typeof s&&(s=e instanceof r),this.objectMode=!!t.objectMode,s&&(this.objectMode=this.objectMode||!!t.readableObjectMode),this.highWaterMark=m(this,t,"readableHighWaterMark",s),this.buffer=new g,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(c||(c=i(553).s),this.decoder=new c(t.encoding),this.encoding=t.encoding)}function _(t){if(r=r||i(753),!(this instanceof _))return new _(t);var e=this instanceof r;this._readableState=new R(t,this,e),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),o.call(this)}function A(t,e,i,r,s){n("readableAddChunk",e);var a,o=t._readableState;if(null===e)o.reading=!1,function(t,e){if(n("onEofChunk"),!e.ended){if(e.decoder){var i=e.decoder.end();i&&i.length&&(e.buffer.push(i),e.length+=e.objectMode?1:i.length)}e.ended=!0,e.sync?k(t):(e.needReadable=!1,e.emittedReadable||(e.emittedReadable=!0,D(t)))}}(t,o);else if(s||(a=function(t,e){var i,r;return r=e,l.isBuffer(r)||r instanceof h||"string"==typeof e||void 0===e||t.objectMode||(i=new v("chunk",["string","Buffer","Uint8Array"],e)),i}(o,e)),a)S(t,a);else if(o.objectMode||e&&e.length>0)if("string"==typeof e||o.objectMode||Object.getPrototypeOf(e)===l.prototype||(e=function(t){return l.from(t)}(e)),r)o.endEmitted?S(t,new b):L(t,o,e,!0);else if(o.ended)S(t,new E);else{if(o.destroyed)return!1;o.reading=!1,o.decoder&&!i?(e=o.decoder.write(e),o.objectMode||0!==e.length?L(t,o,e,!1):P(t,o)):L(t,o,e,!1)}else r||(o.reading=!1,P(t,o));return!o.ended&&(o.length<o.highWaterMark||0===o.length)}function L(t,e,i,r){e.flowing&&0===e.length&&!e.sync?(e.awaitDrain=0,t.emit("data",i)):(e.length+=e.objectMode?1:i.length,r?e.buffer.unshift(i):e.buffer.push(i),e.needReadable&&k(t)),P(t,e)}Object.defineProperty(_.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(t){this._readableState&&(this._readableState.destroyed=t)}}),_.prototype.destroy=p.destroy,_.prototype._undestroy=p.undestroy,_.prototype._destroy=function(t,e){e(t)},_.prototype.push=function(t,e){var i,r=this._readableState;return r.objectMode?i=!0:"string"==typeof t&&((e=e||r.defaultEncoding)!==r.encoding&&(t=l.from(t,e),e=""),i=!0),A(this,t,e,!1,i)},_.prototype.unshift=function(t){return A(this,t,null,!0,!1)},_.prototype.isPaused=function(){return!1===this._readableState.flowing},_.prototype.setEncoding=function(t){c||(c=i(553).s);var e=new c(t);this._readableState.decoder=e,this._readableState.encoding=this._readableState.decoder.encoding;for(var r=this._readableState.buffer.head,s="";null!==r;)s+=e.write(r.data),r=r.next;return this._readableState.buffer.clear(),""!==s&&this._readableState.buffer.push(s),this._readableState.length=s.length,this};var C=1073741824;function I(t,e){return t<=0||0===e.length&&e.ended?0:e.objectMode?1:t!=t?e.flowing&&e.length?e.buffer.head.data.length:e.length:(t>e.highWaterMark&&(e.highWaterMark=function(t){return t>=C?t=C:(t--,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t++),t}(t)),t<=e.length?t:e.ended?e.length:(e.needReadable=!0,0))}function k(t){var e=t._readableState;n("emitReadable",e.needReadable,e.emittedReadable),e.needReadable=!1,e.emittedReadable||(n("emitReadable",e.flowing),e.emittedReadable=!0,s.nextTick(D,t))}function D(t){var e=t._readableState;n("emitReadable_",e.destroyed,e.length,e.ended),e.destroyed||!e.length&&!e.ended||(t.emit("readable"),e.emittedReadable=!1),e.needReadable=!e.flowing&&!e.ended&&e.length<=e.highWaterMark,N(t)}function P(t,e){e.readingMore||(e.readingMore=!0,s.nextTick(x,t,e))}function x(t,e){for(;!e.reading&&!e.ended&&(e.length<e.highWaterMark||e.flowing&&0===e.length);){var i=e.length;if(n("maybeReadMore read 0"),t.read(0),i===e.length)break}e.readingMore=!1}function O(t){var e=t._readableState;e.readableListening=t.listenerCount("readable")>0,e.resumeScheduled&&!e.paused?e.flowing=!0:t.listenerCount("data")>0&&t.resume()}function M(t){n("readable nexttick read 0"),t.read(0)}function F(t,e){n("resume",e.reading),e.reading||t.read(0),e.resumeScheduled=!1,t.emit("resume"),N(t),e.flowing&&!e.reading&&t.read(0)}function N(t){var e=t._readableState;for(n("flow",e.flowing);e.flowing&&null!==t.read(););}function U(t,e){return 0===e.length?null:(e.objectMode?i=e.buffer.shift():!t||t>=e.length?(i=e.decoder?e.buffer.join(""):1===e.buffer.length?e.buffer.first():e.buffer.concat(e.length),e.buffer.clear()):i=e.buffer.consume(t,e.decoder),i);var i}function B(t){var e=t._readableState;n("endReadable",e.endEmitted),e.endEmitted||(e.ended=!0,s.nextTick($,e,t))}function $(t,e){if(n("endReadableNT",t.endEmitted,t.length),!t.endEmitted&&0===t.length&&(t.endEmitted=!0,e.readable=!1,e.emit("end"),t.autoDestroy)){var i=e._writableState;(!i||i.autoDestroy&&i.finished)&&e.destroy()}}function G(t,e){for(var i=0,r=t.length;i<r;i++)if(t[i]===e)return i;return-1}_.prototype.read=function(t){n("read",t),t=parseInt(t,10);var e=this._readableState,i=t;if(0!==t&&(e.emittedReadable=!1),0===t&&e.needReadable&&((0!==e.highWaterMark?e.length>=e.highWaterMark:e.length>0)||e.ended))return n("read: emitReadable",e.length,e.ended),0===e.length&&e.ended?B(this):k(this),null;if(0===(t=I(t,e))&&e.ended)return 0===e.length&&B(this),null;var r,s=e.needReadable;return n("need readable",s),(0===e.length||e.length-t<e.highWaterMark)&&n("length less than watermark",s=!0),e.ended||e.reading?n("reading or ended",s=!1):s&&(n("do read"),e.reading=!0,e.sync=!0,0===e.length&&(e.needReadable=!0),this._read(e.highWaterMark),e.sync=!1,e.reading||(t=I(i,e))),null===(r=t>0?U(t,e):null)?(e.needReadable=e.length<=e.highWaterMark,t=0):(e.length-=t,e.awaitDrain=0),0===e.length&&(e.ended||(e.needReadable=!0),i!==t&&e.ended&&B(this)),null!==r&&this.emit("data",r),r},_.prototype._read=function(t){S(this,new T("_read()"))},_.prototype.pipe=function(t,e){var i=this,r=this._readableState;switch(r.pipesCount){case 0:r.pipes=t;break;case 1:r.pipes=[r.pipes,t];break;default:r.pipes.push(t)}r.pipesCount+=1,n("pipe count=%d opts=%j",r.pipesCount,e);var o=e&&!1===e.end||t===s.stdout||t===s.stderr?p:l;function l(){n("onend"),t.end()}r.endEmitted?s.nextTick(o):i.once("end",o),t.on("unpipe",(function e(s,a){n("onunpipe"),s===i&&a&&!1===a.hasUnpiped&&(a.hasUnpiped=!0,n("cleanup"),t.removeListener("close",f),t.removeListener("finish",g),t.removeListener("drain",h),t.removeListener("error",u),t.removeListener("unpipe",e),i.removeListener("end",l),i.removeListener("end",p),i.removeListener("data",c),d=!0,!r.awaitDrain||t._writableState&&!t._writableState.needDrain||h())}));var h=function(t){return function(){var e=t._readableState;n("pipeOnDrain",e.awaitDrain),e.awaitDrain&&e.awaitDrain--,0===e.awaitDrain&&a(t,"data")&&(e.flowing=!0,N(t))}}(i);t.on("drain",h);var d=!1;function c(e){n("ondata");var s=t.write(e);n("dest.write",s),!1===s&&((1===r.pipesCount&&r.pipes===t||r.pipesCount>1&&-1!==G(r.pipes,t))&&!d&&(n("false write response, pause",r.awaitDrain),r.awaitDrain++),i.pause())}function u(e){n("onerror",e),p(),t.removeListener("error",u),0===a(t,"error")&&S(t,e)}function f(){t.removeListener("finish",g),p()}function g(){n("onfinish"),t.removeListener("close",f),p()}function p(){n("unpipe"),i.unpipe(t)}return i.on("data",c),function(t,e,i){if("function"==typeof t.prependListener)return t.prependListener(e,i);t._events&&t._events[e]?Array.isArray(t._events[e])?t._events[e].unshift(i):t._events[e]=[i,t._events[e]]:t.on(e,i)}(t,"error",u),t.once("close",f),t.once("finish",g),t.emit("pipe",i),r.flowing||(n("pipe resume"),i.resume()),t},_.prototype.unpipe=function(t){var e=this._readableState,i={hasUnpiped:!1};if(0===e.pipesCount)return this;if(1===e.pipesCount)return t&&t!==e.pipes||(t||(t=e.pipes),e.pipes=null,e.pipesCount=0,e.flowing=!1,t&&t.emit("unpipe",this,i)),this;if(!t){var r=e.pipes,s=e.pipesCount;e.pipes=null,e.pipesCount=0,e.flowing=!1;for(var n=0;n<s;n++)r[n].emit("unpipe",this,{hasUnpiped:!1});return this}var a=G(e.pipes,t);return-1===a||(e.pipes.splice(a,1),e.pipesCount-=1,1===e.pipesCount&&(e.pipes=e.pipes[0]),t.emit("unpipe",this,i)),this},_.prototype.on=function(t,e){var i=o.prototype.on.call(this,t,e),r=this._readableState;return"data"===t?(r.readableListening=this.listenerCount("readable")>0,!1!==r.flowing&&this.resume()):"readable"===t&&(r.endEmitted||r.readableListening||(r.readableListening=r.needReadable=!0,r.flowing=!1,r.emittedReadable=!1,n("on readable",r.length,r.reading),r.length?k(this):r.reading||s.nextTick(M,this))),i},_.prototype.addListener=_.prototype.on,_.prototype.removeListener=function(t,e){var i=o.prototype.removeListener.call(this,t,e);return"readable"===t&&s.nextTick(O,this),i},_.prototype.removeAllListeners=function(t){var e=o.prototype.removeAllListeners.apply(this,arguments);return"readable"!==t&&void 0!==t||s.nextTick(O,this),e},_.prototype.resume=function(){var t=this._readableState;return t.flowing||(n("resume"),t.flowing=!t.readableListening,function(t,e){e.resumeScheduled||(e.resumeScheduled=!0,s.nextTick(F,t,e))}(this,t)),t.paused=!1,this},_.prototype.pause=function(){return n("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(n("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},_.prototype.wrap=function(t){var e=this,i=this._readableState,r=!1;for(var s in t.on("end",(function(){if(n("wrapped end"),i.decoder&&!i.ended){var t=i.decoder.end();t&&t.length&&e.push(t)}e.push(null)})),t.on("data",(function(s){n("wrapped data"),i.decoder&&(s=i.decoder.write(s)),i.objectMode&&null==s||(i.objectMode||s&&s.length)&&(e.push(s)||(r=!0,t.pause()))})),t)void 0===this[s]&&"function"==typeof t[s]&&(this[s]=function(e){return function(){return t[e].apply(t,arguments)}}(s));for(var a=0;a<w.length;a++)t.on(w[a],this.emit.bind(this,w[a]));return this._read=function(e){n("wrapped _read",e),r&&(r=!1,t.resume())},this},"function"==typeof Symbol&&(_.prototype[Symbol.asyncIterator]=function(){return void 0===u&&(u=i(850)),u(this)}),Object.defineProperty(_.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(_.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(_.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(t){this._readableState&&(this._readableState.flowing=t)}}),_._fromList=U,Object.defineProperty(_.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(_.from=function(t,e){return void 0===f&&(f=i(167)),f(_,t,e)})},605:(t,e,i)=>{"use strict";t.exports=d;var r=i(281).q,s=r.ERR_METHOD_NOT_IMPLEMENTED,n=r.ERR_MULTIPLE_CALLBACK,a=r.ERR_TRANSFORM_ALREADY_TRANSFORMING,o=r.ERR_TRANSFORM_WITH_LENGTH_0,l=i(753);function h(t,e){var i=this._transformState;i.transforming=!1;var r=i.writecb;if(null===r)return this.emit("error",new n);i.writechunk=null,i.writecb=null,null!=e&&this.push(e),r(t);var s=this._readableState;s.reading=!1,(s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}function d(t){if(!(this instanceof d))return new d(t);l.call(this,t),this._transformState={afterTransform:h.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,t&&("function"==typeof t.transform&&(this._transform=t.transform),"function"==typeof t.flush&&(this._flush=t.flush)),this.on("prefinish",c)}function c(){var t=this;"function"!=typeof this._flush||this._readableState.destroyed?u(this,null,null):this._flush((function(e,i){u(t,e,i)}))}function u(t,e,i){if(e)return t.emit("error",e);if(null!=i&&t.push(i),t._writableState.length)throw new o;if(t._transformState.transforming)throw new a;return t.push(null)}i(717)(d,l),d.prototype.push=function(t,e){return this._transformState.needTransform=!1,l.prototype.push.call(this,t,e)},d.prototype._transform=function(t,e,i){i(new s("_transform()"))},d.prototype._write=function(t,e,i){var r=this._transformState;if(r.writecb=i,r.writechunk=t,r.writeencoding=e,!r.transforming){var s=this._readableState;(r.needTransform||s.needReadable||s.length<s.highWaterMark)&&this._read(s.highWaterMark)}},d.prototype._read=function(t){var e=this._transformState;null===e.writechunk||e.transforming?e.needTransform=!0:(e.transforming=!0,this._transform(e.writechunk,e.writeencoding,e.afterTransform))},d.prototype._destroy=function(t,e){l.prototype._destroy.call(this,t,(function(t){e(t)}))}},229:(t,e,i)=>{"use strict";var r,s=i(155);function n(t){var e=this;this.next=null,this.entry=null,this.finish=function(){!function(t,e,i){var r=t.entry;for(t.entry=null;r;){var s=r.callback;e.pendingcb--,s(undefined),r=r.next}e.corkedRequestsFree.next=t}(e,t)}}t.exports=_,_.WritableState=R;var a,o={deprecate:i(927)},l=i(503),h=i(764).Buffer,d=(void 0!==i.g?i.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{}).Uint8Array||function(){},c=i(195),u=i(457).getHighWaterMark,f=i(281).q,g=f.ERR_INVALID_ARG_TYPE,p=f.ERR_METHOD_NOT_IMPLEMENTED,m=f.ERR_MULTIPLE_CALLBACK,y=f.ERR_STREAM_CANNOT_PIPE,v=f.ERR_STREAM_DESTROYED,E=f.ERR_STREAM_NULL_VALUES,T=f.ERR_STREAM_WRITE_AFTER_END,b=f.ERR_UNKNOWN_ENCODING,S=c.errorOrDestroy;function w(){}function R(t,e,a){r=r||i(753),t=t||{},"boolean"!=typeof a&&(a=e instanceof r),this.objectMode=!!t.objectMode,a&&(this.objectMode=this.objectMode||!!t.writableObjectMode),this.highWaterMark=u(this,t,"writableHighWaterMark",a),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var o=!1===t.decodeStrings;this.decodeStrings=!o,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(t){!function(t,e){var i=t._writableState,r=i.sync,n=i.writecb;if("function"!=typeof n)throw new m;if(function(t){t.writing=!1,t.writecb=null,t.length-=t.writelen,t.writelen=0}(i),e)!function(t,e,i,r,n){--e.pendingcb,i?(s.nextTick(n,r),s.nextTick(D,t,e),t._writableState.errorEmitted=!0,S(t,r)):(n(r),t._writableState.errorEmitted=!0,S(t,r),D(t,e))}(t,i,r,e,n);else{var a=I(i)||t.destroyed;a||i.corked||i.bufferProcessing||!i.bufferedRequest||C(t,i),r?s.nextTick(L,t,i,a,n):L(t,i,a,n)}}(e,t)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==t.emitClose,this.autoDestroy=!!t.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new n(this)}function _(t){var e=this instanceof(r=r||i(753));if(!e&&!a.call(_,this))return new _(t);this._writableState=new R(t,this,e),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),l.call(this)}function A(t,e,i,r,s,n,a){e.writelen=r,e.writecb=a,e.writing=!0,e.sync=!0,e.destroyed?e.onwrite(new v("write")):i?t._writev(s,e.onwrite):t._write(s,n,e.onwrite),e.sync=!1}function L(t,e,i,r){i||function(t,e){0===e.length&&e.needDrain&&(e.needDrain=!1,t.emit("drain"))}(t,e),e.pendingcb--,r(),D(t,e)}function C(t,e){e.bufferProcessing=!0;var i=e.bufferedRequest;if(t._writev&&i&&i.next){var r=e.bufferedRequestCount,s=new Array(r),a=e.corkedRequestsFree;a.entry=i;for(var o=0,l=!0;i;)s[o]=i,i.isBuf||(l=!1),i=i.next,o+=1;s.allBuffers=l,A(t,e,!0,e.length,s,"",a.finish),e.pendingcb++,e.lastBufferedRequest=null,a.next?(e.corkedRequestsFree=a.next,a.next=null):e.corkedRequestsFree=new n(e),e.bufferedRequestCount=0}else{for(;i;){var h=i.chunk,d=i.encoding,c=i.callback;if(A(t,e,!1,e.objectMode?1:h.length,h,d,c),i=i.next,e.bufferedRequestCount--,e.writing)break}null===i&&(e.lastBufferedRequest=null)}e.bufferedRequest=i,e.bufferProcessing=!1}function I(t){return t.ending&&0===t.length&&null===t.bufferedRequest&&!t.finished&&!t.writing}function k(t,e){t._final((function(i){e.pendingcb--,i&&S(t,i),e.prefinished=!0,t.emit("prefinish"),D(t,e)}))}function D(t,e){var i=I(e);if(i&&(function(t,e){e.prefinished||e.finalCalled||("function"!=typeof t._final||e.destroyed?(e.prefinished=!0,t.emit("prefinish")):(e.pendingcb++,e.finalCalled=!0,s.nextTick(k,t,e)))}(t,e),0===e.pendingcb&&(e.finished=!0,t.emit("finish"),e.autoDestroy))){var r=t._readableState;(!r||r.autoDestroy&&r.endEmitted)&&t.destroy()}return i}i(717)(_,l),R.prototype.getBuffer=function(){for(var t=this.bufferedRequest,e=[];t;)e.push(t),t=t.next;return e},function(){try{Object.defineProperty(R.prototype,"buffer",{get:o.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(t){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(a=Function.prototype[Symbol.hasInstance],Object.defineProperty(_,Symbol.hasInstance,{value:function(t){return!!a.call(this,t)||this===_&&t&&t._writableState instanceof R}})):a=function(t){return t instanceof this},_.prototype.pipe=function(){S(this,new y)},_.prototype.write=function(t,e,i){var r,n=this._writableState,a=!1,o=!n.objectMode&&(r=t,h.isBuffer(r)||r instanceof d);return o&&!h.isBuffer(t)&&(t=function(t){return h.from(t)}(t)),"function"==typeof e&&(i=e,e=null),o?e="buffer":e||(e=n.defaultEncoding),"function"!=typeof i&&(i=w),n.ending?function(t,e){var i=new T;S(t,i),s.nextTick(e,i)}(this,i):(o||function(t,e,i,r){var n;return null===i?n=new E:"string"==typeof i||e.objectMode||(n=new g("chunk",["string","Buffer"],i)),!n||(S(t,n),s.nextTick(r,n),!1)}(this,n,t,i))&&(n.pendingcb++,a=function(t,e,i,r,s,n){if(!i){var a=function(t,e,i){return t.objectMode||!1===t.decodeStrings||"string"!=typeof e||(e=h.from(e,i)),e}(e,r,s);r!==a&&(i=!0,s="buffer",r=a)}var o=e.objectMode?1:r.length;e.length+=o;var l=e.length<e.highWaterMark;if(l||(e.needDrain=!0),e.writing||e.corked){var d=e.lastBufferedRequest;e.lastBufferedRequest={chunk:r,encoding:s,isBuf:i,callback:n,next:null},d?d.next=e.lastBufferedRequest:e.bufferedRequest=e.lastBufferedRequest,e.bufferedRequestCount+=1}else A(t,e,!1,o,r,s,n);return l}(this,n,o,t,e,i)),a},_.prototype.cork=function(){this._writableState.corked++},_.prototype.uncork=function(){var t=this._writableState;t.corked&&(t.corked--,t.writing||t.corked||t.bufferProcessing||!t.bufferedRequest||C(this,t))},_.prototype.setDefaultEncoding=function(t){if("string"==typeof t&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw new b(t);return this._writableState.defaultEncoding=t,this},Object.defineProperty(_.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(_.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),_.prototype._write=function(t,e,i){i(new p("_write()"))},_.prototype._writev=null,_.prototype.end=function(t,e,i){var r=this._writableState;return"function"==typeof t?(i=t,t=null,e=null):"function"==typeof e&&(i=e,e=null),null!=t&&this.write(t,e),r.corked&&(r.corked=1,this.uncork()),r.ending||function(t,e,i){e.ending=!0,D(t,e),i&&(e.finished?s.nextTick(i):t.once("finish",i)),e.ended=!0,t.writable=!1}(this,r,i),this},Object.defineProperty(_.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(_.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(t){this._writableState&&(this._writableState.destroyed=t)}}),_.prototype.destroy=c.destroy,_.prototype._undestroy=c.undestroy,_.prototype._destroy=function(t,e){e(t)}},850:(t,e,i)=>{"use strict";var r,s=i(155);function n(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var a=i(610),o=Symbol("lastResolve"),l=Symbol("lastReject"),h=Symbol("error"),d=Symbol("ended"),c=Symbol("lastPromise"),u=Symbol("handlePromise"),f=Symbol("stream");function g(t,e){return{value:t,done:e}}function p(t){var e=t[o];if(null!==e){var i=t[f].read();null!==i&&(t[c]=null,t[o]=null,t[l]=null,e(g(i,!1)))}}function m(t){s.nextTick(p,t)}var y=Object.getPrototypeOf((function(){})),v=Object.setPrototypeOf((n(r={get stream(){return this[f]},next:function(){var t=this,e=this[h];if(null!==e)return Promise.reject(e);if(this[d])return Promise.resolve(g(void 0,!0));if(this[f].destroyed)return new Promise((function(e,i){s.nextTick((function(){t[h]?i(t[h]):e(g(void 0,!0))}))}));var i,r=this[c];if(r)i=new Promise(function(t,e){return function(i,r){t.then((function(){e[d]?i(g(void 0,!0)):e[u](i,r)}),r)}}(r,this));else{var n=this[f].read();if(null!==n)return Promise.resolve(g(n,!1));i=new Promise(this[u])}return this[c]=i,i}},Symbol.asyncIterator,(function(){return this})),n(r,"return",(function(){var t=this;return new Promise((function(e,i){t[f].destroy(null,(function(t){t?i(t):e(g(void 0,!0))}))}))})),r),y);t.exports=function(t){var e,i=Object.create(v,(n(e={},f,{value:t,writable:!0}),n(e,o,{value:null,writable:!0}),n(e,l,{value:null,writable:!0}),n(e,h,{value:null,writable:!0}),n(e,d,{value:t._readableState.endEmitted,writable:!0}),n(e,u,{value:function(t,e){var r=i[f].read();r?(i[c]=null,i[o]=null,i[l]=null,t(g(r,!1))):(i[o]=t,i[l]=e)},writable:!0}),e));return i[c]=null,a(t,(function(t){if(t&&"ERR_STREAM_PREMATURE_CLOSE"!==t.code){var e=i[l];return null!==e&&(i[c]=null,i[o]=null,i[l]=null,e(t)),void(i[h]=t)}var r=i[o];null!==r&&(i[c]=null,i[o]=null,i[l]=null,r(g(void 0,!0))),i[d]=!0})),t.on("readable",m.bind(null,i)),i}},327:(t,e,i)=>{"use strict";function r(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function s(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(Object(i),!0).forEach((function(e){n(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function n(t,e,i){return(e=o(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function a(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,o(r.key),r)}}function o(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}var l=i(764).Buffer,h=i(361).inspect,d=h&&h.custom||"inspect";t.exports=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.head=null,this.tail=null,this.length=0}var e,i;return e=t,(i=[{key:"push",value:function(t){var e={data:t,next:null};this.length>0?this.tail.next=e:this.head=e,this.tail=e,++this.length}},{key:"unshift",value:function(t){var e={data:t,next:this.head};0===this.length&&(this.tail=e),this.head=e,++this.length}},{key:"shift",value:function(){if(0!==this.length){var t=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,t}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(t){if(0===this.length)return"";for(var e=this.head,i=""+e.data;e=e.next;)i+=t+e.data;return i}},{key:"concat",value:function(t){if(0===this.length)return l.alloc(0);for(var e,i,r,s=l.allocUnsafe(t>>>0),n=this.head,a=0;n;)e=n.data,i=s,r=a,l.prototype.copy.call(e,i,r),a+=n.data.length,n=n.next;return s}},{key:"consume",value:function(t,e){var i;return t<this.head.data.length?(i=this.head.data.slice(0,t),this.head.data=this.head.data.slice(t)):i=t===this.head.data.length?this.shift():e?this._getString(t):this._getBuffer(t),i}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(t){var e=this.head,i=1,r=e.data;for(t-=r.length;e=e.next;){var s=e.data,n=t>s.length?s.length:t;if(n===s.length?r+=s:r+=s.slice(0,t),0==(t-=n)){n===s.length?(++i,e.next?this.head=e.next:this.head=this.tail=null):(this.head=e,e.data=s.slice(n));break}++i}return this.length-=i,r}},{key:"_getBuffer",value:function(t){var e=l.allocUnsafe(t),i=this.head,r=1;for(i.data.copy(e),t-=i.data.length;i=i.next;){var s=i.data,n=t>s.length?s.length:t;if(s.copy(e,e.length-t,0,n),0==(t-=n)){n===s.length?(++r,i.next?this.head=i.next:this.head=this.tail=null):(this.head=i,i.data=s.slice(n));break}++r}return this.length-=r,e}},{key:d,value:function(t,e){return h(this,s(s({},e),{},{depth:0,customInspect:!1}))}}])&&a(e.prototype,i),Object.defineProperty(e,"prototype",{writable:!1}),t}()},195:(t,e,i)=>{"use strict";var r=i(155);function s(t,e){a(t,e),n(t)}function n(t){t._writableState&&!t._writableState.emitClose||t._readableState&&!t._readableState.emitClose||t.emit("close")}function a(t,e){t.emit("error",e)}t.exports={destroy:function(t,e){var i=this,o=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return o||l?(e?e(t):t&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,r.nextTick(a,this,t)):r.nextTick(a,this,t)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,(function(t){!e&&t?i._writableState?i._writableState.errorEmitted?r.nextTick(n,i):(i._writableState.errorEmitted=!0,r.nextTick(s,i,t)):r.nextTick(s,i,t):e?(r.nextTick(n,i),e(t)):r.nextTick(n,i)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(t,e){var i=t._readableState,r=t._writableState;i&&i.autoDestroy||r&&r.autoDestroy?t.destroy(e):t.emit("error",e)}}},610:(t,e,i)=>{"use strict";var r=i(281).q.ERR_STREAM_PREMATURE_CLOSE;function s(){}t.exports=function t(e,i,n){if("function"==typeof i)return t(e,null,i);i||(i={}),n=function(t){var e=!1;return function(){if(!e){e=!0;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];t.apply(this,r)}}}(n||s);var a=i.readable||!1!==i.readable&&e.readable,o=i.writable||!1!==i.writable&&e.writable,l=function(){e.writable||d()},h=e._writableState&&e._writableState.finished,d=function(){o=!1,h=!0,a||n.call(e)},c=e._readableState&&e._readableState.endEmitted,u=function(){a=!1,c=!0,o||n.call(e)},f=function(t){n.call(e,t)},g=function(){var t;return a&&!c?(e._readableState&&e._readableState.ended||(t=new r),n.call(e,t)):o&&!h?(e._writableState&&e._writableState.ended||(t=new r),n.call(e,t)):void 0},p=function(){e.req.on("finish",d)};return function(t){return t.setHeader&&"function"==typeof t.abort}(e)?(e.on("complete",d),e.on("abort",g),e.req?p():e.on("request",p)):o&&!e._writableState&&(e.on("end",l),e.on("close",l)),e.on("end",u),e.on("finish",d),!1!==i.error&&e.on("error",f),e.on("close",g),function(){e.removeListener("complete",d),e.removeListener("abort",g),e.removeListener("request",p),e.req&&e.req.removeListener("finish",d),e.removeListener("end",l),e.removeListener("close",l),e.removeListener("finish",d),e.removeListener("end",u),e.removeListener("error",f),e.removeListener("close",g)}}},167:t=>{t.exports=function(){throw new Error("Readable.from is not available in the browser")}},946:(t,e,i)=>{"use strict";var r,s=i(281).q,n=s.ERR_MISSING_ARGS,a=s.ERR_STREAM_DESTROYED;function o(t){if(t)throw t}function l(t){t()}function h(t,e){return t.pipe(e)}t.exports=function(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];var d,c=function(t){return t.length?"function"!=typeof t[t.length-1]?o:t.pop():o}(e);if(Array.isArray(e[0])&&(e=e[0]),e.length<2)throw new n("streams");var u=e.map((function(t,s){var n=s<e.length-1;return function(t,e,s,n){n=function(t){var e=!1;return function(){e||(e=!0,t.apply(void 0,arguments))}}(n);var o=!1;t.on("close",(function(){o=!0})),void 0===r&&(r=i(610)),r(t,{readable:e,writable:s},(function(t){if(t)return n(t);o=!0,n()}));var l=!1;return function(e){if(!o&&!l)return l=!0,function(t){return t.setHeader&&"function"==typeof t.abort}(t)?t.abort():"function"==typeof t.destroy?t.destroy():void n(e||new a("pipe"))}}(t,n,s>0,(function(t){d||(d=t),t&&u.forEach(l),n||(u.forEach(l),c(d))}))}));return e.reduce(h)}},457:(t,e,i)=>{"use strict";var r=i(281).q.ERR_INVALID_OPT_VALUE;t.exports={getHighWaterMark:function(t,e,i,s){var n=function(t,e,i){return null!=t.highWaterMark?t.highWaterMark:e?t[i]:null}(e,s,i);if(null!=n){if(!isFinite(n)||Math.floor(n)!==n||n<0)throw new r(s?i:"highWaterMark",n);return Math.floor(n)}return t.objectMode?16:16384}}},503:(t,e,i)=>{t.exports=i(187).EventEmitter},473:(t,e,i)=>{(e=t.exports=i(481)).Stream=e,e.Readable=e,e.Writable=i(229),e.Duplex=i(753),e.Transform=i(605),e.PassThrough=i(725),e.finished=i(610),e.pipeline=i(946)},847:t=>{"use strict";var e=function(t){return t&&2===t.CLOSING},i=function(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){t[i]=e},enumerable:!0,configurable:!0})},r=function(t){return t.minReconnectionDelay+Math.random()*t.minReconnectionDelay},s=["onopen","onclose","onmessage","onerror"],n=function(t,a,o){var l,h,d=this;void 0===o&&(o={});var c=0,u=0,f=!0,g=null,p={};if(!(this instanceof n))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var m={constructor:"undefined"!=typeof WebSocket&&e(WebSocket)?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1};if(Object.keys(m).filter((function(t){return o.hasOwnProperty(t)})).forEach((function(t){return m[t]=o[t]})),!e(m.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var y=m.debug?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return console.log.apply(console,["RWS:"].concat(t))}:function(){},v=function(t,e){return setTimeout((function(){var i=new Error(e);i.code=t,Array.isArray(p.error)&&p.error.forEach((function(t){return(0,t[0])(i)})),l.onerror&&l.onerror(i)}),0)},E=function(){y("handleClose",{shouldRetry:f}),u++,y("retries count:",u),u>m.maxRetries?v("EHOSTDOWN","Too many failed connection attempts"):(c=c?function(t,e){var i=e*t.reconnectionDelayGrowFactor;return i>t.maxReconnectionDelay?t.maxReconnectionDelay:i}(m,c):r(m),y("handleClose - reconnectDelay:",c),f&&setTimeout(T,c))},T=function(){if(f){y("connect");var e=l,n="function"==typeof t?t():t;for(var o in l=new m.constructor(n,a),h=setTimeout((function(){y("timeout"),l.close(),v("ETIMEDOUT","Connection timeout")}),m.connectionTimeout),y("bypass properties"),l)["addEventListener","removeEventListener","close","send"].indexOf(o)<0&&i(l,d,o);l.addEventListener("open",(function(){clearTimeout(h),y("open"),c=r(m),y("reconnectDelay:",c),u=0})),l.addEventListener("close",E),function(t,e,i){Object.keys(i).forEach((function(e){i[e].forEach((function(i){var r=i[0],s=i[1];t.addEventListener(e,r,s)}))})),e&&s.forEach((function(i){t[i]=e[i]}))}(l,e,p),l.onclose=l.onclose||g,g=null}};y("init"),T(),this.close=function(t,e,i){void 0===t&&(t=1e3),void 0===e&&(e="");var r=void 0===i?{}:i,s=r.keepClosed,n=void 0!==s&&s,a=r.fastClose,o=void 0===a||a,h=r.delay,d=void 0===h?0:h;if(y("close - params:",{reason:e,keepClosed:n,fastClose:o,delay:d,retriesCount:u,maxRetries:m.maxRetries}),f=!n&&u<=m.maxRetries,d&&(c=d),l.close(t,e),o){var v={code:t,reason:e,wasClean:!0};E(),l.removeEventListener("close",E),Array.isArray(p.close)&&p.close.forEach((function(t){var e=t[0],i=t[1];e(v),l.removeEventListener("close",e,i)})),l.onclose&&(g=l.onclose,l.onclose(v),l.onclose=null)}},this.send=function(t){l.send(t)},this.addEventListener=function(t,e,i){Array.isArray(p[t])?p[t].some((function(t){return t[0]===e}))||p[t].push([e,i]):p[t]=[[e,i]],l.addEventListener(t,e,i)},this.removeEventListener=function(t,e,i){Array.isArray(p[t])&&(p[t]=p[t].filter((function(t){return t[0]!==e}))),l.removeEventListener(t,e,i)}};t.exports=n},509:(t,e,i)=>{var r=i(764),s=r.Buffer;function n(t,e){for(var i in t)e[i]=t[i]}function a(t,e,i){return s(t,e,i)}s.from&&s.alloc&&s.allocUnsafe&&s.allocUnsafeSlow?t.exports=r:(n(r,e),e.Buffer=a),a.prototype=Object.create(s.prototype),n(s,a),a.from=function(t,e,i){if("number"==typeof t)throw new TypeError("Argument must not be a number");return s(t,e,i)},a.alloc=function(t,e,i){if("number"!=typeof t)throw new TypeError("Argument must be a number");var r=s(t);return void 0!==e?"string"==typeof i?r.fill(e,i):r.fill(e):r.fill(0),r},a.allocUnsafe=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return s(t)},a.allocUnsafeSlow=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return r.SlowBuffer(t)}},853:(t,e,i)=>{const r=i(488)("simple-peer"),s=i(177),n=i(798),a=i(473),o=i(375),l=i(114),{Buffer:h}=i(764),d=65536;function c(t){return t.replace(/a=ice-options:trickle\s\n/g,"")}class u extends a.Duplex{constructor(t){if(super(t=Object.assign({allowHalfOpen:!1},t)),this._id=n(4).toString("hex").slice(0,7),this._debug("new peer %o",t),this.channelName=t.initiator?t.channelName||n(20).toString("hex"):null,this.initiator=t.initiator||!1,this.channelConfig=t.channelConfig||u.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},u.config,t.config),this.offerOptions=t.offerOptions||{},this.answerOptions=t.answerOptions||{},this.sdpTransform=t.sdpTransform||(t=>t),this.streams=t.streams||(t.stream?[t.stream]:[]),this.trickle=void 0===t.trickle||t.trickle,this.allowHalfTrickle=void 0!==t.allowHalfTrickle&&t.allowHalfTrickle,this.iceCompleteTimeout=t.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=t.wrtc&&"object"==typeof t.wrtc?t.wrtc:s(),!this._wrtc)throw"undefined"==typeof window?l(new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):l(new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(t){return void this.destroy(l(t,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=t=>{this._onIceCandidate(t)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch((t=>{this.destroy(l(t,"ERR_PC_PEER_IDENTITY"))})),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=t=>{this._setupData(t)},this.streams&&this.streams.forEach((t=>{this.addStream(t)})),this._pc.ontrack=t=>{this._onTrack(t)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(t){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}this._debug("signal()"),t.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),t.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(t.transceiverRequest.kind,t.transceiverRequest.init)),t.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(t.candidate):this._pendingCandidates.push(t.candidate)),t.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(t)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((t=>{this._addIceCandidate(t)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((t=>{this.destroy(l(t,"ERR_SET_REMOTE_DESCRIPTION"))})),t.sdp||t.candidate||t.renegotiate||t.transceiverRequest||this.destroy(l(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(t){const e=new this._wrtc.RTCIceCandidate(t);this._pc.addIceCandidate(e).catch((t=>{!e.address||e.address.endsWith(".local")?("Ignoring unsupported ICE candidate.",console.warn("Ignoring unsupported ICE candidate.")):this.destroy(l(t,"ERR_ADD_ICE_CANDIDATE"))}))}send(t){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(t)}}addTransceiver(t,e){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(t,e),this._needsNegotiation()}catch(t){this.destroy(l(t,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:t,init:e}})}}addStream(t){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),t.getTracks().forEach((e=>{this.addTrack(e,t)}))}}addTrack(t,e){if(this.destroying)return;if(this.destroyed)throw l(new Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const i=this._senderMap.get(t)||new Map;let r=i.get(e);if(r)throw r.removed?l(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):l(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED");r=this._pc.addTrack(t,e),i.set(e,r),this._senderMap.set(t,i),this._needsNegotiation()}replaceTrack(t,e,i){if(this.destroying)return;if(this.destroyed)throw l(new Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const r=this._senderMap.get(t),s=r?r.get(i):null;if(!s)throw l(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");e&&this._senderMap.set(e,r),null!=s.replaceTrack?s.replaceTrack(e):this.destroy(l(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(t,e){if(this.destroying)return;if(this.destroyed)throw l(new Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const i=this._senderMap.get(t),r=i?i.get(e):null;if(!r)throw l(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{r.removed=!0,this._pc.removeTrack(r)}catch(t){"NS_ERROR_UNEXPECTED"===t.name?this._sendersAwaitingStable.push(r):this.destroy(l(t,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(t){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),t.getTracks().forEach((e=>{this.removeTrack(e,t)}))}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,o((()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1})))}negotiate(){if(!this.destroying){if(this.destroyed)throw l(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(t){this._destroy(t,(()=>{}))}_destroy(t,e){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),o((()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",t&&(t.message||t)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(t){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(t){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),this.emit("close"),e()})))}_setupData(t){if(!t.channel)return this.destroy(l(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=t.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=d),this.channelName=this._channel.label,this._channel.onmessage=t=>{this._onChannelMessage(t)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=t=>{const e=t.error instanceof Error?t.error:new Error(`Datachannel error: ${t.message} ${t.filename}:${t.lineno}:${t.colno}`);this.destroy(l(e,"ERR_DATA_CHANNEL"))};let e=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(e&&this._onChannelClose(),e=!0):e=!1}),5e3)}_read(){}_write(t,e,i){if(this.destroyed)return i(l(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(t)}catch(t){return this.destroy(l(t,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>d?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=i):i(null)}else this._debug("write before connect"),this._chunk=t,this._cb=i}_onFinish(){if(this.destroyed)return;const t=()=>{setTimeout((()=>this.destroy()),1e3)};this._connected?t():this.once("connect",t)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((t=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(t.sdp=c(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{if(this.destroyed)return;const e=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp})};this._pc.setLocalDescription(t).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))})).catch((t=>{this.destroy(l(t,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((t=>{this.destroy(l(t,"ERR_CREATE_OFFER"))}))}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((t=>{t.mid||!t.sender.track||t.requested||(t.requested=!0,this.addTransceiver(t.sender.track.kind))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((t=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(t.sdp=c(t.sdp)),t.sdp=this.sdpTransform(t.sdp);const e=()=>{if(this.destroyed)return;const e=this._pc.localDescription||t;this._debug("signal"),this.emit("signal",{type:e.type,sdp:e.sdp}),this.initiator||this._requestMissingTransceivers()};this._pc.setLocalDescription(t).then((()=>{this.destroyed||(this.trickle||this._iceComplete?e():this.once("_iceComplete",e))})).catch((t=>{this.destroy(l(t,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((t=>{this.destroy(l(t,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||"failed"===this._pc.connectionState&&this.destroy(l(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const t=this._pc.iceConnectionState,e=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",t,e),this.emit("iceStateChange",t,e),"connected"!==t&&"completed"!==t||(this._pcReady=!0,this._maybeReady()),"failed"===t&&this.destroy(l(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===t&&this.destroy(l(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(t){const e=t=>("[object Array]"===Object.prototype.toString.call(t.values)&&t.values.forEach((e=>{Object.assign(t,e)})),t);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((i=>{const r=[];i.forEach((t=>{r.push(e(t))})),t(null,r)}),(e=>t(e))):this._pc.getStats.length>0?this._pc.getStats((i=>{if(this.destroyed)return;const r=[];i.result().forEach((t=>{const i={};t.names().forEach((e=>{i[e]=t.stat(e)})),i.id=t.id,i.type=t.type,i.timestamp=t.timestamp,r.push(e(i))})),t(null,r)}),(e=>t(e))):t(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const t=()=>{this.destroyed||this.getStats(((e,i)=>{if(this.destroyed)return;e&&(i=[]);const r={},s={},n={};let a=!1;i.forEach((t=>{"remotecandidate"!==t.type&&"remote-candidate"!==t.type||(r[t.id]=t),"localcandidate"!==t.type&&"local-candidate"!==t.type||(s[t.id]=t),"candidatepair"!==t.type&&"candidate-pair"!==t.type||(n[t.id]=t)}));const o=t=>{a=!0;let e=s[t.localCandidateId];e&&(e.ip||e.address)?(this.localAddress=e.ip||e.address,this.localPort=Number(e.port)):e&&e.ipAddress?(this.localAddress=e.ipAddress,this.localPort=Number(e.portNumber)):"string"==typeof t.googLocalAddress&&(e=t.googLocalAddress.split(":"),this.localAddress=e[0],this.localPort=Number(e[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let i=r[t.remoteCandidateId];i&&(i.ip||i.address)?(this.remoteAddress=i.ip||i.address,this.remotePort=Number(i.port)):i&&i.ipAddress?(this.remoteAddress=i.ipAddress,this.remotePort=Number(i.portNumber)):"string"==typeof t.googRemoteAddress&&(i=t.googRemoteAddress.split(":"),this.remoteAddress=i[0],this.remotePort=Number(i[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(i.forEach((t=>{"transport"===t.type&&t.selectedCandidatePairId&&o(n[t.selectedCandidatePairId]),("googCandidatePair"===t.type&&"true"===t.googActiveConnection||("candidatepair"===t.type||"candidate-pair"===t.type)&&t.selected)&&o(t)})),a||Object.keys(n).length&&!Object.keys(s).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(e){return this.destroy(l(e,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const t=this._cb;this._cb=null,t(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(t,100)}))};t()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>d||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((t=>{this._pc.removeTrack(t),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(t){this.destroyed||(t.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}}):t.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),t.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(t){if(this.destroyed)return;let e=t.data;e instanceof ArrayBuffer&&(e=h.from(e)),this.push(e)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const t=this._cb;this._cb=null,t(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(t){this.destroyed||t.streams.forEach((e=>{this._debug("on track"),this.emit("track",t.track,e),this._remoteTracks.push({track:t.track,stream:e}),this._remoteStreams.some((t=>t.id===e.id))||(this._remoteStreams.push(e),o((()=>{this._debug("on stream"),this.emit("stream",e)})))}))}_debug(){const t=[].slice.call(arguments);t[0]="["+this._id+"] "+t[0],r.apply(null,t)}}u.WEBRTC_SUPPORT=!!s(),u.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},u.channelConfig={},t.exports=u},488:(t,e,i)=>{var r=i(155);e.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;e.splice(1,0,i,"color: inherit");let r=0,s=0;e[0].replace(/%[a-zA-Z%]/g,(t=>{"%%"!==t&&(r++,"%c"===t&&(s=r))})),e.splice(s,0,i)},e.save=function(t){try{t?e.storage.setItem("debug",t):e.storage.removeItem("debug")}catch(t){}},e.load=function(){let t;try{t=e.storage.getItem("debug")}catch(t){}return!t&&void 0!==r&&"env"in r&&(t=r.env.DEBUG),t},e.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},e.storage=function(){try{return localStorage}catch(t){}}(),e.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=i(474)(e);const{formatters:s}=t.exports;s.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}},474:(t,e,i)=>{t.exports=function(t){function e(t){let i,s,n,a=null;function o(...t){if(!o.enabled)return;const r=o,s=Number(new Date),n=s-(i||s);r.diff=n,r.prev=i,r.curr=s,i=s,t[0]=e.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let a=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,((i,s)=>{if("%%"===i)return"%";a++;const n=e.formatters[s];if("function"==typeof n){const e=t[a];i=n.call(r,e),t.splice(a,1),a--}return i})),e.formatArgs.call(r,t),(r.log||e.log).apply(r,t)}return o.namespace=t,o.useColors=e.useColors(),o.color=e.selectColor(t),o.extend=r,o.destroy=e.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(s!==e.namespaces&&(s=e.namespaces,n=e.enabled(t)),n),set:t=>{a=t}}),"function"==typeof e.init&&e.init(o),o}function r(t,i){const r=e(this.namespace+(void 0===i?":":i)+t);return r.log=this.log,r}function s(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return e.debug=e,e.default=e,e.coerce=function(t){return t instanceof Error?t.stack||t.message:t},e.disable=function(){const t=[...e.names.map(s),...e.skips.map(s).map((t=>"-"+t))].join(",");return e.enable(""),t},e.enable=function(t){let i;e.save(t),e.namespaces=t,e.names=[],e.skips=[];const r=("string"==typeof t?t:"").split(/[\s,]+/),s=r.length;for(i=0;i<s;i++)r[i]&&("-"===(t=r[i].replace(/\*/g,".*?"))[0]?e.skips.push(new RegExp("^"+t.slice(1)+"$")):e.names.push(new RegExp("^"+t+"$")))},e.enabled=function(t){if("*"===t[t.length-1])return!0;let i,r;for(i=0,r=e.skips.length;i<r;i++)if(e.skips[i].test(t))return!1;for(i=0,r=e.names.length;i<r;i++)if(e.names[i].test(t))return!0;return!1},e.humanize=i(673),e.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach((i=>{e[i]=t[i]})),e.names=[],e.skips=[],e.formatters={},e.selectColor=function(t){let i=0;for(let e=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return e.colors[Math.abs(i)%e.colors.length]},e.enable(e.load()),e}},673:t=>{var e=1e3,i=60*e,r=60*i,s=24*r;function n(t,e,i,r){var s=e>=1.5*i;return Math.round(t/i)+" "+r+(s?"s":"")}t.exports=function(t,a){a=a||{};var o,l,h=typeof t;if("string"===h&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var n=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(n){var a=parseFloat(n[1]);switch((n[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*a;case"weeks":case"week":case"w":return 6048e5*a;case"days":case"day":case"d":return a*s;case"hours":case"hour":case"hrs":case"hr":case"h":return a*r;case"minutes":case"minute":case"mins":case"min":case"m":return a*i;case"seconds":case"second":case"secs":case"sec":case"s":return a*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return a;default:return}}}}(t);if("number"===h&&isFinite(t))return a.long?(o=t,(l=Math.abs(o))>=s?n(o,l,s,"day"):l>=r?n(o,l,r,"hour"):l>=i?n(o,l,i,"minute"):l>=e?n(o,l,e,"second"):o+" ms"):function(t){var n=Math.abs(t);return n>=s?Math.round(t/s)+"d":n>=r?Math.round(t/r)+"h":n>=i?Math.round(t/i)+"m":n>=e?Math.round(t/e)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},553:(t,e,i)=>{"use strict";var r=i(509).Buffer,s=r.isEncoding||function(t){switch((t=""+t)&&t.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function n(t){var e;switch(this.encoding=function(t){var e=function(t){if(!t)return"utf8";for(var e;;)switch(t){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return t;default:if(e)return;t=(""+t).toLowerCase(),e=!0}}(t);if("string"!=typeof e&&(r.isEncoding===s||!s(t)))throw new Error("Unknown encoding: "+t);return e||t}(t),this.encoding){case"utf16le":this.text=l,this.end=h,e=4;break;case"utf8":this.fillLast=o,e=4;break;case"base64":this.text=d,this.end=c,e=3;break;default:return this.write=u,void(this.end=f)}this.lastNeed=0,this.lastTotal=0,this.lastChar=r.allocUnsafe(e)}function a(t){return t<=127?0:t>>5==6?2:t>>4==14?3:t>>3==30?4:t>>6==2?-1:-2}function o(t){var e=this.lastTotal-this.lastNeed,i=function(t,e,i){if(128!=(192&e[0]))return t.lastNeed=0,"�";if(t.lastNeed>1&&e.length>1){if(128!=(192&e[1]))return t.lastNeed=1,"�";if(t.lastNeed>2&&e.length>2&&128!=(192&e[2]))return t.lastNeed=2,"�"}}(this,t);return void 0!==i?i:this.lastNeed<=t.length?(t.copy(this.lastChar,e,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(t.copy(this.lastChar,e,0,t.length),void(this.lastNeed-=t.length))}function l(t,e){if((t.length-e)%2==0){var i=t.toString("utf16le",e);if(i){var r=i.charCodeAt(i.length-1);if(r>=55296&&r<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1],i.slice(0,-1)}return i}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=t[t.length-1],t.toString("utf16le",e,t.length-1)}function h(t){var e=t&&t.length?this.write(t):"";if(this.lastNeed){var i=this.lastTotal-this.lastNeed;return e+this.lastChar.toString("utf16le",0,i)}return e}function d(t,e){var i=(t.length-e)%3;return 0===i?t.toString("base64",e):(this.lastNeed=3-i,this.lastTotal=3,1===i?this.lastChar[0]=t[t.length-1]:(this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1]),t.toString("base64",e,t.length-i))}function c(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+this.lastChar.toString("base64",0,3-this.lastNeed):e}function u(t){return t.toString(this.encoding)}function f(t){return t&&t.length?this.write(t):""}e.s=n,n.prototype.write=function(t){if(0===t.length)return"";var e,i;if(this.lastNeed){if(void 0===(e=this.fillLast(t)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<t.length?e?e+this.text(t,i):this.text(t,i):e||""},n.prototype.end=function(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+"�":e},n.prototype.text=function(t,e){var i=function(t,e,i){var r=e.length-1;if(r<i)return 0;var s=a(e[r]);return s>=0?(s>0&&(t.lastNeed=s-1),s):--r<i||-2===s?0:(s=a(e[r]))>=0?(s>0&&(t.lastNeed=s-2),s):--r<i||-2===s?0:(s=a(e[r]))>=0?(s>0&&(2===s?s=0:t.lastNeed=s-3),s):0}(this,t,e);if(!this.lastNeed)return t.toString("utf8",e);this.lastTotal=i;var r=t.length-(i-this.lastNeed);return t.copy(this.lastChar,0,r),t.toString("utf8",e,r)},n.prototype.fillLast=function(t){if(this.lastNeed<=t.length)return t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,t.length),this.lastNeed-=t.length}},238:function(t,e,i){var r;!function(s,n){"use strict";var a="function",o="undefined",l="object",h="string",d="major",c="model",u="name",f="type",g="vendor",p="version",m="architecture",y="console",v="mobile",E="tablet",T="smarttv",b="wearable",S="embedded",w="Amazon",R="Apple",_="ASUS",A="BlackBerry",L="Browser",C="Chrome",I="Firefox",k="Google",D="Huawei",P="LG",x="Microsoft",O="Motorola",M="Opera",F="Samsung",N="Sharp",U="Sony",B="Xiaomi",$="Zebra",G="Facebook",K="Chromium OS",H="Mac OS",V=function(t){for(var e={},i=0;i<t.length;i++)e[t[i].toUpperCase()]=t[i];return e},j=function(t,e){return typeof t===h&&-1!==q(e).indexOf(q(t))},q=function(t){return t.toLowerCase()},W=function(t,e){if(typeof t===h)return t=t.replace(/^\s\s*/,""),typeof e===o?t:t.substring(0,350)},Y=function(t,e){for(var i,r,s,o,h,d,c=0;c<e.length&&!h;){var u=e[c],f=e[c+1];for(i=r=0;i<u.length&&!h&&u[i];)if(h=u[i++].exec(t))for(s=0;s<f.length;s++)d=h[++r],typeof(o=f[s])===l&&o.length>0?2===o.length?typeof o[1]==a?this[o[0]]=o[1].call(this,d):this[o[0]]=o[1]:3===o.length?typeof o[1]!==a||o[1].exec&&o[1].test?this[o[0]]=d?d.replace(o[1],o[2]):n:this[o[0]]=d?o[1].call(this,d,o[2]):n:4===o.length&&(this[o[0]]=d?o[3].call(this,d.replace(o[1],o[2])):n):this[o]=d||n;c+=2}},z=function(t,e){for(var i in e)if(typeof e[i]===l&&e[i].length>0){for(var r=0;r<e[i].length;r++)if(j(e[i][r],t))return"?"===i?n:i}else if(j(e[i],t))return"?"===i?n:i;return t},X={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Q={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,p],[/opios[\/ ]+([\w\.]+)/i],[p,[u,M+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[u,M]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[u,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[u,"UC"+L]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[u,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[p,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure "+L],p],[/\bfocus\/([\w\.]+)/i],[p,[u,I+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[u,M+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[u,M+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[u,"MIUI "+L]],[/fxios\/([-\w\.]+)/i],[p,[u,I]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 "+L]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 "+L],p],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,G],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[u,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[p,[u,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[u,C+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,C+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[u,"Android "+L]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[u,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[p,z,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[u,I+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[u,p],[/(cobalt)\/([\w\.]+)/i],[u,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,q]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",q]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,q]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[c,[g,F],[f,E]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[c,[g,F],[f,v]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[c,[g,R],[f,v]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[c,[g,R],[f,E]],[/(macintosh);/i],[c,[g,R]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[c,[g,N],[f,v]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[c,[g,D],[f,E]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[c,[g,D],[f,v]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[c,/_/g," "],[g,B],[f,v]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[c,/_/g," "],[g,B],[f,E]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[c,[g,"OPPO"],[f,v]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[c,[g,"Vivo"],[f,v]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[c,[g,"Realme"],[f,v]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[c,[g,O],[f,v]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[c,[g,O],[f,E]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[c,[g,P],[f,E]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[c,[g,P],[f,v]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[c,[g,"Lenovo"],[f,E]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[c,/_/g," "],[g,"Nokia"],[f,v]],[/(pixel c)\b/i],[c,[g,k],[f,E]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[c,[g,k],[f,v]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[c,[g,U],[f,v]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[c,"Xperia Tablet"],[g,U],[f,E]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[c,[g,"OnePlus"],[f,v]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[c,[g,w],[f,E]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[c,/(.+)/g,"Fire Phone $1"],[g,w],[f,v]],[/(playbook);[-\w\),; ]+(rim)/i],[c,g,[f,E]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[c,[g,A],[f,v]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[c,[g,_],[f,E]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[c,[g,_],[f,v]],[/(nexus 9)/i],[c,[g,"HTC"],[f,E]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[g,[c,/_/g," "],[f,v]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[c,[g,"Acer"],[f,E]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[c,[g,"Meizu"],[f,v]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[g,c,[f,v]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[g,c,[f,E]],[/(surface duo)/i],[c,[g,x],[f,E]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[c,[g,"Fairphone"],[f,v]],[/(u304aa)/i],[c,[g,"AT&T"],[f,v]],[/\bsie-(\w*)/i],[c,[g,"Siemens"],[f,v]],[/\b(rct\w+) b/i],[c,[g,"RCA"],[f,E]],[/\b(venue[\d ]{2,7}) b/i],[c,[g,"Dell"],[f,E]],[/\b(q(?:mv|ta)\w+) b/i],[c,[g,"Verizon"],[f,E]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[c,[g,"Barnes & Noble"],[f,E]],[/\b(tm\d{3}\w+) b/i],[c,[g,"NuVision"],[f,E]],[/\b(k88) b/i],[c,[g,"ZTE"],[f,E]],[/\b(nx\d{3}j) b/i],[c,[g,"ZTE"],[f,v]],[/\b(gen\d{3}) b.+49h/i],[c,[g,"Swiss"],[f,v]],[/\b(zur\d{3}) b/i],[c,[g,"Swiss"],[f,E]],[/\b((zeki)?tb.*\b) b/i],[c,[g,"Zeki"],[f,E]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[g,"Dragon Touch"],c,[f,E]],[/\b(ns-?\w{0,9}) b/i],[c,[g,"Insignia"],[f,E]],[/\b((nxa|next)-?\w{0,9}) b/i],[c,[g,"NextBook"],[f,E]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[g,"Voice"],c,[f,v]],[/\b(lvtel\-)?(v1[12]) b/i],[[g,"LvTel"],c,[f,v]],[/\b(ph-1) /i],[c,[g,"Essential"],[f,v]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[c,[g,"Envizen"],[f,E]],[/\b(trio[-\w\. ]+) b/i],[c,[g,"MachSpeed"],[f,E]],[/\btu_(1491) b/i],[c,[g,"Rotor"],[f,E]],[/(shield[\w ]+) b/i],[c,[g,"Nvidia"],[f,E]],[/(sprint) (\w+)/i],[g,c,[f,v]],[/(kin\.[onetw]{3})/i],[[c,/\./g," "],[g,x],[f,v]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[c,[g,$],[f,E]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[c,[g,$],[f,v]],[/smart-tv.+(samsung)/i],[g,[f,T]],[/hbbtv.+maple;(\d+)/i],[[c,/^/,"SmartTV"],[g,F],[f,T]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[g,P],[f,T]],[/(apple) ?tv/i],[g,[c,R+" TV"],[f,T]],[/crkey/i],[[c,C+"cast"],[g,k],[f,T]],[/droid.+aft(\w)( bui|\))/i],[c,[g,w],[f,T]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[c,[g,N],[f,T]],[/(bravia[\w ]+)( bui|\))/i],[c,[g,U],[f,T]],[/(mitv-\w{5}) bui/i],[c,[g,B],[f,T]],[/Hbbtv.*(technisat) (.*);/i],[g,c,[f,T]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[g,W],[c,W],[f,T]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[f,T]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[g,c,[f,y]],[/droid.+; (shield) bui/i],[c,[g,"Nvidia"],[f,y]],[/(playstation [345portablevi]+)/i],[c,[g,U],[f,y]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[c,[g,x],[f,y]],[/((pebble))app/i],[g,c,[f,b]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[c,[g,R],[f,b]],[/droid.+; (glass) \d/i],[c,[g,k],[f,b]],[/droid.+; (wt63?0{2,3})\)/i],[c,[g,$],[f,b]],[/(quest( 2| pro)?)/i],[c,[g,G],[f,b]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[g,[f,S]],[/(aeobc)\b/i],[c,[g,w],[f,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[c,[f,v]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[c,[f,E]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[f,E]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[f,v]],[/(android[-\w\. ]{0,9});.+buil/i],[c,[g,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[u,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[p,z,X]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[p,z,X]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/ios;fbsv\/([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,H],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,p],[/\(bb(10);/i],[p,[u,A]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[u,I+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[u,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[u,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[u,C+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[u,K],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,p],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[u,p]]},J=function(t,e){if(typeof t===l&&(e=t,t=n),!(this instanceof J))return new J(t,e).getResult();var i=typeof s!==o&&s.navigator?s.navigator:n,r=t||(i&&i.userAgent?i.userAgent:""),y=i&&i.userAgentData?i.userAgentData:n,T=e?function(t,e){var i={};for(var r in t)e[r]&&e[r].length%2==0?i[r]=e[r].concat(t[r]):i[r]=t[r];return i}(Q,e):Q,b=i&&i.userAgent==r;return this.getBrowser=function(){var t,e={};return e[u]=n,e[p]=n,Y.call(e,r,T.browser),e[d]=typeof(t=e[p])===h?t.replace(/[^\d\.]/g,"").split(".")[0]:n,b&&i&&i.brave&&typeof i.brave.isBrave==a&&(e[u]="Brave"),e},this.getCPU=function(){var t={};return t[m]=n,Y.call(t,r,T.cpu),t},this.getDevice=function(){var t={};return t[g]=n,t[c]=n,t[f]=n,Y.call(t,r,T.device),b&&!t[f]&&y&&y.mobile&&(t[f]=v),b&&"Macintosh"==t[c]&&i&&typeof i.standalone!==o&&i.maxTouchPoints&&i.maxTouchPoints>2&&(t[c]="iPad",t[f]=E),t},this.getEngine=function(){var t={};return t[u]=n,t[p]=n,Y.call(t,r,T.engine),t},this.getOS=function(){var t={};return t[u]=n,t[p]=n,Y.call(t,r,T.os),b&&!t[u]&&y&&"Unknown"!=y.platform&&(t[u]=y.platform.replace(/chrome os/i,K).replace(/macos/i,H)),t},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return r},this.setUA=function(t){return r=typeof t===h&&t.length>350?W(t,350):t,this},this.setUA(r),this};J.VERSION="0.7.35",J.BROWSER=V([u,p,d]),J.CPU=V([m]),J.DEVICE=V([c,g,f,y,v,T,E,b,S]),J.ENGINE=J.OS=V([u,p]),typeof e!==o?(t.exports&&(e=t.exports=J),e.UAParser=J):i.amdO?(r=function(){return J}.call(e,i,e,t))===n||(t.exports=r):typeof s!==o&&(s.UAParser=J);var Z=typeof s!==o&&(s.jQuery||s.Zepto);if(Z&&!Z.ua){var tt=new J;Z.ua=tt.getResult(),Z.ua.get=function(){return tt.getUA()},Z.ua.set=function(t){tt.setUA(t);var e=tt.getResult();for(var i in e)Z.ua[i]=e[i]}}}("object"==typeof window?window:this)},927:(t,e,i)=>{function r(t){try{if(!i.g.localStorage)return!1}catch(t){return!1}var e=i.g.localStorage[t];return null!=e&&"true"===String(e).toLowerCase()}t.exports=function(t,e){if(r("noDeprecation"))return t;var i=!1;return function(){if(!i){if(r("throwDeprecation"))throw new Error(e);r("traceDeprecation")?console.trace(e):console.warn(e),i=!0}return t.apply(this,arguments)}}},361:()=>{},616:()=>{}},i={};function r(t){var s=i[t];if(void 0!==s)return s.exports;var n=i[t]={exports:{}};return e[t].call(n.exports,n,n.exports,r),n.exports}r.amdO={},r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var s={};return(()=>{"use strict";r.d(s,{default:()=>Fn});var e={};function i(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function n(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?i(Object(r),!0).forEach((function(e){a(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function a(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},o.apply(this,arguments)}!function(t,e){var i,r,s,n,a;i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,n=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(t,e,i){if(i=i||{},t=t.trim(),!(e=e.trim())){if(!i.alwaysNormalize)return t;var s=a.parseURL(t);if(!s)throw new Error("Error trying to parse base URL.");return s.path=a.normalizePath(s.path),a.buildURLFromParts(s)}var n=a.parseURL(e);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return i.alwaysNormalize?(n.path=a.normalizePath(n.path),a.buildURLFromParts(n)):e;var o=a.parseURL(t);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=r.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var h={scheme:o.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(h.netLoc=o.netLoc,"/"!==n.path[0]))if(n.path){var d=o.path,c=d.substring(0,d.lastIndexOf("/")+1)+n.path;h.path=a.normalizePath(c)}else h.path=o.path,n.params||(h.params=o.params,n.query||(h.query=o.query));return null===h.path&&(h.path=i.alwaysNormalize?a.normalizePath(n.path):n.path),a.buildURLFromParts(h)},parseURL:function(t){var e=i.exec(t);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(s,"");t.length!==(t=t.replace(n,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}},t.exports=a}({get exports(){return e},set exports(t){e=t}});const l=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)};let h=function(t){return t.MEDIA_ATTACHING="hlsMediaAttaching",t.MEDIA_ATTACHED="hlsMediaAttached",t.MEDIA_DETACHING="hlsMediaDetaching",t.MEDIA_DETACHED="hlsMediaDetached",t.BUFFER_RESET="hlsBufferReset",t.BUFFER_CODECS="hlsBufferCodecs",t.BUFFER_CREATED="hlsBufferCreated",t.BUFFER_APPENDING="hlsBufferAppending",t.BUFFER_APPENDED="hlsBufferAppended",t.BUFFER_EOS="hlsBufferEos",t.BUFFER_FLUSHING="hlsBufferFlushing",t.BUFFER_FLUSHED="hlsBufferFlushed",t.MANIFEST_LOADING="hlsManifestLoading",t.MANIFEST_LOADED="hlsManifestLoaded",t.MANIFEST_PARSED="hlsManifestParsed",t.LEVEL_SWITCHING="hlsLevelSwitching",t.LEVEL_SWITCHED="hlsLevelSwitched",t.LEVEL_LOADING="hlsLevelLoading",t.LEVEL_LOADED="hlsLevelLoaded",t.LEVEL_UPDATED="hlsLevelUpdated",t.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",t.LEVELS_UPDATED="hlsLevelsUpdated",t.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",t.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",t.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",t.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",t.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",t.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",t.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",t.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",t.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",t.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",t.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",t.CUES_PARSED="hlsCuesParsed",t.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",t.INIT_PTS_FOUND="hlsInitPtsFound",t.FRAG_LOADING="hlsFragLoading",t.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",t.FRAG_LOADED="hlsFragLoaded",t.FRAG_DECRYPTED="hlsFragDecrypted",t.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",t.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",t.FRAG_PARSING_METADATA="hlsFragParsingMetadata",t.FRAG_PARSED="hlsFragParsed",t.FRAG_BUFFERED="hlsFragBuffered",t.FRAG_CHANGED="hlsFragChanged",t.FPS_DROP="hlsFpsDrop",t.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",t.ERROR="hlsError",t.DESTROYING="hlsDestroying",t.KEY_LOADING="hlsKeyLoading",t.KEY_LOADED="hlsKeyLoaded",t.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",t.BACK_BUFFER_REACHED="hlsBackBufferReached",t}({}),d=function(t){return t.NETWORK_ERROR="networkError",t.MEDIA_ERROR="mediaError",t.KEY_SYSTEM_ERROR="keySystemError",t.MUX_ERROR="muxError",t.OTHER_ERROR="otherError",t}({}),c=function(t){return t.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",t.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",t.KEY_SYSTEM_NO_SESSION="keySystemNoSession",t.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",t.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",t.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",t.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",t.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",t.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",t.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",t.MANIFEST_LOAD_ERROR="manifestLoadError",t.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",t.MANIFEST_PARSING_ERROR="manifestParsingError",t.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",t.LEVEL_EMPTY_ERROR="levelEmptyError",t.LEVEL_LOAD_ERROR="levelLoadError",t.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",t.LEVEL_PARSING_ERROR="levelParsingError",t.LEVEL_SWITCH_ERROR="levelSwitchError",t.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",t.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",t.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",t.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",t.FRAG_LOAD_ERROR="fragLoadError",t.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",t.FRAG_DECRYPT_ERROR="fragDecryptError",t.FRAG_PARSING_ERROR="fragParsingError",t.FRAG_GAP="fragGap",t.REMUX_ALLOC_ERROR="remuxAllocError",t.KEY_LOAD_ERROR="keyLoadError",t.KEY_LOAD_TIMEOUT="keyLoadTimeOut",t.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",t.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",t.BUFFER_APPEND_ERROR="bufferAppendError",t.BUFFER_APPENDING_ERROR="bufferAppendingError",t.BUFFER_STALLED_ERROR="bufferStalledError",t.BUFFER_FULL_ERROR="bufferFullError",t.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",t.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",t.INTERNAL_EXCEPTION="internalException",t.INTERNAL_ABORTED="aborted",t.UNKNOWN="unknown",t}({});const u=function(){},f={trace:u,debug:u,log:u,warn:u,info:u,error:u};let g=f;const p=g,m=/^(\d+)x(\d+)$/,y=/(.+?)=(".*?"|.*?)(?:,|$)/g;class v{constructor(t){"string"==typeof t&&(t=v.parseAttrList(t));for(const e in t)t.hasOwnProperty(e)&&("X-"===e.substring(0,2)&&(this.clientAttrs=this.clientAttrs||[],this.clientAttrs.push(e)),this[e]=t[e])}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(1&e.length?"0":"")+e;const i=new Uint8Array(e.length/2);for(let t=0;t<e.length/2;t++)i[t]=parseInt(e.slice(2*t,2*t+2),16);return i}return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}bool(t){return"YES"===this[t]}decimalResolution(t){const e=m.exec(this[t]);if(null!==e)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;const i={};for(y.lastIndex=0;null!==(e=y.exec(t));){let t=e[2];0===t.indexOf('"')&&t.lastIndexOf('"')===t.length-1&&(t=t.slice(1,-1)),i[e[1].trim()]=t}return i}}function E(t){return"SCTE35-OUT"===t||"SCTE35-IN"===t}class T{constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){const i=e.attr;for(const e in i)if(Object.prototype.hasOwnProperty.call(t,e)&&t[e]!==i[e]){p.warn(`DATERANGE tag attribute: "${e}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=e;break}t=o(new v({}),i,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const t=new Date(this.attr["END-DATE"]);l(t.getTime())&&(this._endDate=t)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const t=this.duration;return null!==t?new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if(l(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&l(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class b{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var S={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class w{constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[S.AUDIO]:null,[S.VIDEO]:null,[S.AUDIOVIDEO]:null},this.baseurl=t}setByteRange(t,e){const i=t.split("@",2),r=[];1===i.length?r[0]=e?e.byteRangeEndOffset:0:r[0]=parseInt(i[1]),r[1]=parseInt(i[0])+r[0],this._byteRange=r}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=e.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}}class R extends w{constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new b,this.urlId=0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.type=t}get decryptdata(){const{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const t=Object.keys(this.levelkeys);if(1===t.length)return this._decryptdata=this.levelkeys[t[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!l(this.programDateTime))return null;const t=l(this.duration)?this.duration:0;return this.programDateTime+1e3*t}get encrypted(){var t;if(null!=(t=this._decryptdata)&&t.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),e=t.length;if(e>1||1===e&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){const e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;null==(t=this.loader)||t.abort(),null==(e=this.keyLoader)||e.abort()}setElementaryStreamInfo(t,e,i,r,s,n=!1){const{elementaryStreams:a}=this,o=a[t];o?(o.startPTS=Math.min(o.startPTS,e),o.endPTS=Math.max(o.endPTS,i),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,s)):a[t]={startPTS:e,endPTS:i,startDTS:r,endDTS:s,partial:n}}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[S.AUDIO]=null,t[S.VIDEO]=null,t[S.AUDIOVIDEO]=null}}class _ extends w{constructor(t,e,i,r,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new b,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=r;const n=t.enumeratedString("BYTERANGE");n&&this.setByteRange(n,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}class A{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t)return this.advanced=!0,void(this.updated=!0);const e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e,this.advanced=this.endSN>t.endSN||e>0||0===e&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*t.misses):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&l(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const t=this.driftEndTime-this.driftStartTime;return t>0?1e3*(this.driftEnd-this.driftStart)/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function L(t){return Uint8Array.from(atob(t),(t=>t.charCodeAt(0)))}function C(t){return Uint8Array.from(unescape(encodeURIComponent(t)),(t=>t.charCodeAt(0)))}var I={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},k="org.w3.clearkey",D="com.apple.streamingkeydelivery",P="com.microsoft.playready",x="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function O(t){switch(t){case D:return I.FAIRPLAY;case P:return I.PLAYREADY;case x:return I.WIDEVINE;case k:return I.CLEARKEY}}var M="edef8ba979d64acea3c827dcd51d21ed";function F(t){switch(t){case I.FAIRPLAY:return D;case I.PLAYREADY:return P;case I.WIDEVINE:return x;case I.CLEARKEY:return k}}function N(t){const{drmSystems:e,widevineLicenseUrl:i}=t,r=e?[I.FAIRPLAY,I.WIDEVINE,I.PLAYREADY,I.CLEARKEY].filter((t=>!!e[t])):[];return!r[I.WIDEVINE]&&i&&r.push(I.WIDEVINE),r}const U="undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function B(t,e,i){return Uint8Array.prototype.slice?t.slice(e,i):new Uint8Array(Array.prototype.slice.call(t,e,i))}const $=(t,e)=>e+10<=t.length&&73===t[e]&&68===t[e+1]&&51===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,G=(t,e)=>e+10<=t.length&&51===t[e]&&68===t[e+1]&&73===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,K=(t,e)=>{const i=e;let r=0;for(;$(t,e);)r+=10,r+=H(t,e+6),G(t,e+10)&&(r+=10),e+=r;if(r>0)return t.subarray(i,i+r)},H=(t,e)=>{let i=0;return i=(127&t[e])<<21,i|=(127&t[e+1])<<14,i|=(127&t[e+2])<<7,i|=127&t[e+3],i},V=(t,e)=>$(t,e)&&H(t,e+6)+10<=t.length-e,j=t=>t&&"PRIV"===t.key&&"com.apple.streaming.transportStreamTimestamp"===t.info,q=t=>{const e=String.fromCharCode(t[0],t[1],t[2],t[3]),i=H(t,4);return{type:e,size:i,data:t.subarray(10,10+i)}},W=t=>{let e=0;const i=[];for(;$(t,e);){const r=H(t,e+6);e+=10;const s=e+r;for(;e+8<s;){const r=q(t.subarray(e)),s=Y(r);s&&i.push(s),e+=r.size+10}G(t,e)&&(e+=10)}return i},Y=t=>"PRIV"===t.type?z(t):"W"===t.type[0]?Q(t):X(t),z=t=>{if(t.size<2)return;const e=Z(t.data,!0),i=new Uint8Array(t.data.subarray(e.length+1));return{key:t.type,info:e,data:i.buffer}},X=t=>{if(t.size<2)return;if("TXXX"===t.type){let e=1;const i=Z(t.data.subarray(e),!0);e+=i.length+1;const r=Z(t.data.subarray(e));return{key:t.type,info:i,data:r}}const e=Z(t.data.subarray(1));return{key:t.type,data:e}},Q=t=>{if("WXXX"===t.type){if(t.size<2)return;let e=1;const i=Z(t.data.subarray(e),!0);e+=i.length+1;const r=Z(t.data.subarray(e));return{key:t.type,info:i,data:r}}const e=Z(t.data);return{key:t.type,data:e}},J=t=>{if(8===t.data.byteLength){const e=new Uint8Array(t.data),i=1&e[3];let r=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return r/=45,i&&(r+=47721858.84),Math.round(r)}},Z=(t,e=!1)=>{const i=et();if(i){const r=i.decode(t);if(e){const t=r.indexOf("\0");return-1!==t?r.substring(0,t):r}return r.replace(/\0/g,"")}const r=t.length;let s,n,a,o="",l=0;for(;l<r;){if(s=t[l++],0===s&&e)return o;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:n=t[l++],o+=String.fromCharCode((31&s)<<6|63&n);break;case 14:n=t[l++],a=t[l++],o+=String.fromCharCode((15&s)<<12|(63&n)<<6|(63&a)<<0)}}return o};let tt;function et(){return tt||void 0===self.TextDecoder||(tt=new self.TextDecoder("utf-8")),tt}const it=function(t){let e="";for(let i=0;i<t.length;i++){let r=t[i].toString(16);r.length<2&&(r="0"+r),e+=r}return e},rt=Math.pow(2,32)-1,st=[].push,nt={video:1,audio:2,id3:3,text:4};function at(t){return String.fromCharCode.apply(null,t)}function ot(t,e){const i=t[e]<<8|t[e+1];return i<0?65536+i:i}function lt(t,e){const i=ht(t,e);return i<0?4294967296+i:i}function ht(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function dt(t,e,i){t[e]=i>>24,t[e+1]=i>>16&255,t[e+2]=i>>8&255,t[e+3]=255&i}function ct(t,e){const i=[];if(!e.length)return i;const r=t.byteLength;for(let s=0;s<r;){const n=lt(t,s),a=n>1?s+n:r;if(at(t.subarray(s+4,s+8))===e[0])if(1===e.length)i.push(t.subarray(s+8,a));else{const r=ct(t.subarray(s+8,a),e.slice(1));r.length&&st.apply(i,r)}s=a}return i}function ut(t){const e=[],i=t[0];let r=8;const s=lt(t,r);r+=4,r+=0===i?8:16,r+=2;let n=t.length+0;const a=ot(t,r);r+=2;for(let i=0;i<a;i++){let i=r;const a=lt(t,i);i+=4;const o=2147483647&a;if(1==(2147483648&a)>>>31)return p.warn("SIDX has hierarchical references (not supported)"),null;const l=lt(t,i);i+=4,e.push({referenceSize:o,subsegmentDuration:l,info:{duration:l/s,start:n,end:n+o-1}}),n+=o,i+=4,r=i}return{earliestPresentationTime:0,timescale:s,version:i,referencesCount:a,references:e}}function ft(t){const e=[],i=ct(t,["moov","trak"]);for(let t=0;t<i.length;t++){const r=i[t],s=ct(r,["tkhd"])[0];if(s){let t=s[0],i=0===t?12:20;const n=lt(s,i),a=ct(r,["mdia","mdhd"])[0];if(a){t=a[0],i=0===t?12:20;const s=lt(a,i),o=ct(r,["mdia","hdlr"])[0];if(o){const t=at(o.subarray(8,12)),i={soun:S.AUDIO,vide:S.VIDEO}[t];if(i){const t=ct(r,["mdia","minf","stbl","stsd"])[0];let a;t&&(a=at(t.subarray(12,16))),e[n]={timescale:s,type:i},e[i]={timescale:s,id:n,codec:a}}}}}}return ct(t,["moov","mvex","trex"]).forEach((t=>{const i=lt(t,4),r=e[i];r&&(r.default={duration:lt(t,12),flags:lt(t,20)})})),e}function gt(t){const e=ct(t,["schm"])[0];if(e){const i=at(e.subarray(4,8));if("cbcs"===i||"cenc"===i)return ct(t,["schi","tenc"])[0]}return p.error("[eme] missing 'schm' box"),null}function pt(t){const e=lt(t,0);let i=8;1&e&&(i+=4),4&e&&(i+=4);let r=0;const s=lt(t,4);for(let n=0;n<s;n++)256&e&&(r+=lt(t,i),i+=4),512&e&&(i+=4),1024&e&&(i+=4),2048&e&&(i+=4);return r}function mt(t,e){const i=new Uint8Array(t.length+e.length);return i.set(t),i.set(e,t.length),i}function yt(t,e){const i=[],r=e.samples,s=e.timescale,n=e.id;let a=!1;return ct(r,["moof"]).map((o=>{const l=o.byteOffset-8;ct(o,["traf"]).map((o=>{const h=ct(o,["tfdt"]).map((t=>{const e=t[0];let i=lt(t,4);return 1===e&&(i*=Math.pow(2,32),i+=lt(t,8)),i/s}))[0];return void 0!==h&&(t=h),ct(o,["tfhd"]).map((h=>{const d=lt(h,4),c=16777215&lt(h,0);let u=0;const f=0!=(16&c);let g=0;const p=0!=(32&c);let m=8;d===n&&(0!=(1&c)&&(m+=8),0!=(2&c)&&(m+=4),0!=(8&c)&&(u=lt(h,m),m+=4),f&&(g=lt(h,m),m+=4),p&&(m+=4),"video"===e.type&&(a=function(t){if(!t)return!1;const e=t.indexOf("."),i=e<0?t:t.substring(0,e);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}(e.codec)),ct(o,["trun"]).map((n=>{const o=n[0],h=16777215&lt(n,0),d=0!=(1&h);let c=0;const f=0!=(4&h),p=0!=(256&h);let m=0;const y=0!=(512&h);let v=0;const E=0!=(1024&h),T=0!=(2048&h);let b=0;const w=lt(n,4);let R=8;d&&(c=lt(n,R),R+=4),f&&(R+=4);let _=c+l;for(let l=0;l<w;l++){if(p?(m=lt(n,R),R+=4):m=u,y?(v=lt(n,R),R+=4):v=g,E&&(R+=4),T&&(b=0===o?lt(n,R):ht(n,R),R+=4),e.type===S.VIDEO){let e=0;for(;e<v;){const n=lt(r,_);_+=4,vt(a,r[_])&&Et(r.subarray(_,_+n),a?2:1,t+b/s,i),_+=n,e+=n+4}}t+=m/s}})))}))}))})),i}function vt(t,e){if(t){const t=e>>1&63;return 39===t||40===t}return 6==(31&e)}function Et(t,e,i,r){const s=Tt(t);let n=0;n+=e;let a=0,o=0,l=!1,h=0;for(;n<s.length;){a=0;do{if(n>=s.length)break;h=s[n++],a+=h}while(255===h);o=0;do{if(n>=s.length)break;h=s[n++],o+=h}while(255===h);const t=s.length-n;if(!l&&4===a&&n<s.length){if(l=!0,181===s[n++]){const t=ot(s,n);if(n+=2,49===t){const t=lt(s,n);if(n+=4,1195456820===t){const t=s[n++];if(3===t){const e=s[n++],o=64&e,l=o?2+3*(31&e):0,h=new Uint8Array(l);if(o){h[0]=e;for(let t=1;t<l;t++)h[t]=s[n++]}r.push({type:t,payloadType:a,pts:i,bytes:h})}}}}}else if(5===a&&o<t){if(l=!0,o>16){const t=[];for(let e=0;e<16;e++){const i=s[n++].toString(16);t.push(1==i.length?"0"+i:i),3!==e&&5!==e&&7!==e&&9!==e||t.push("-")}const e=o-16,l=new Uint8Array(e);for(let t=0;t<e;t++)l[t]=s[n++];r.push({payloadType:a,pts:i,uuid:t.join(""),userData:Z(l),userDataBytes:l})}}else if(o<t)n+=o;else if(o>t)break}}function Tt(t){const e=t.byteLength,i=[];let r=1;for(;r<e-2;)0===t[r]&&0===t[r+1]&&3===t[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return t;const s=e-i.length,n=new Uint8Array(s);let a=0;for(r=0;r<s;a++,r++)a===i[0]&&(a++,i.shift()),n[r]=t[a];return n}let bt={};class St{static clearKeyUriToKeyIdMap(){bt={}}constructor(t,e,i,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=r,this.iv=s,this.encrypted=!!t&&"NONE"!==t,this.isCommonEncryption=this.encrypted&&"AES-128"!==t}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case D:case x:case P:case k:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof t&&("AES-128"!==this.method||this.iv||p.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);const e=function(t){const e=new Uint8Array(16);for(let i=12;i<16;i++)e[i]=t>>8*(15-i)&255;return e}(t);return new St(this.method,this.uri,"identity",this.keyFormatVersions,e)}const e=function(t){const e=t.split(":");let i=null;if("data"===e[0]&&2===e.length){const t=e[1].split(";"),r=t[t.length-1].split(",");if(2===r.length){const e="base64"===r[0],s=r[1];e?(t.splice(-1,1),i=L(s)):i=function(t){const e=C(t).subarray(0,16),i=new Uint8Array(16);return i.set(e,16-e.length),i}(s)}}return i}(this.uri);if(e)switch(this.keyFormat){case x:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case P:{const t=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(t,e,i){if(16!==t.byteLength)throw new RangeError("Invalid system id");let r,s,n;if(e){r=1,s=new Uint8Array(16*e.length);for(let t=0;t<e.length;t++){const i=e[t];if(16!==i.byteLength)throw new RangeError("Invalid key");s.set(i,16*t)}}else r=0,s=new Uint8Array;r>0?(n=new Uint8Array(4),e.length>0&&new DataView(n.buffer).setUint32(0,e.length,!1)):n=new Uint8Array;const a=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(a.buffer).setUint32(0,i.byteLength,!1),function(t,...e){const i=e.length;let r=8,s=i;for(;s--;)r+=e[s].byteLength;const n=new Uint8Array(r);for(n[0]=r>>24&255,n[1]=r>>16&255,n[2]=r>>8&255,n[3]=255&r,n.set(t,4),s=0,r=8;s<i;s++)n.set(e[s],r),r+=e[s].byteLength;return n}([112,115,115,104],new Uint8Array([r,0,0,0]),t,n,s,a,i||new Uint8Array)}(t,null,e);const i=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),r=String.fromCharCode.apply(null,Array.from(i)),s=r.substring(r.indexOf("<"),r.length),n=(new DOMParser).parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(n){const t=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");if(t){const e=L(t).subarray(0,16);!function(t){const e=function(t,e,i){const r=t[e];t[e]=t[i],t[i]=r};e(t,0,3),e(t,1,2),e(t,4,5),e(t,6,7)}(e),this.keyId=e}}break}default:{let t=e.subarray(0,16);if(16!==t.length){const e=new Uint8Array(16);e.set(t,16-t.length),t=e}this.keyId=t;break}}if(!this.keyId||16!==this.keyId.byteLength){let t=bt[this.uri];if(!t){const e=Object.keys(bt).length%Number.MAX_SAFE_INTEGER;t=new Uint8Array(16),new DataView(t.buffer,12,4).setUint32(0,e),bt[this.uri]=t}this.keyId=t}return this}}const wt=/\{\$([a-zA-Z0-9-_]+)\}/g;function Rt(t){return wt.test(t)}function _t(t,e,i){if(null!==t.variableList||t.hasVariableRefs)for(let r=i.length;r--;){const s=i[r],n=e[s];n&&(e[s]=At(t,n))}}function At(t,e){if(null!==t.variableList||t.hasVariableRefs){const i=t.variableList;return e.replace(wt,(e=>{const r=e.substring(2,e.length-1),s=null==i?void 0:i[r];return void 0===s?(t.playlistParsingError||(t.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),e):s}))}return e}function Lt(t,e,i){let r,s,n=t.variableList;if(n||(t.variableList=n={}),"QUERYPARAM"in e){r=e.QUERYPARAM;try{const t=new self.URL(i).searchParams;if(!t.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${i}"`);s=t.get(r)}catch(e){t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${e.message}`))}}else r=e.NAME,s=e.VALUE;r in n?t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):n[r]=s||""}function Ct(t,e,i){const r=e.IMPORT;if(i&&r in i){let e=t.variableList;e||(t.variableList=e={}),e[r]=i[r]}else t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}const It={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function kt(t,e){return MediaSource.isTypeSupported(`${e||"video"}/mp4;codecs="${t}"`)}const Dt=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Pt=/#EXT-X-MEDIA:(.*)/g,xt=/^#EXT(?:INF|-X-TARGETDURATION):/m,Ot=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Mt=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Ft{static findGroup(t,e){for(let i=0;i<t.length;i++){const r=t[i];if(r.id===e)return r}}static convertAVC1ToAVCOTI(t){const e=t.split(".");if(e.length>2){let t=e.shift()+".";return t+=parseInt(e.shift()).toString(16),t+=("000"+parseInt(e.shift()).toString(16)).slice(-4),t}return t}static resolve(t,i){return e.buildAbsoluteURL(i,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return xt.test(t)}static parseMasterPlaylist(t,e){const i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:Rt(t)},r=[];let s;for(Dt.lastIndex=0;null!=(s=Dt.exec(t));)if(s[1]){var n;const t=new v(s[1]);_t(i,t,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const a=At(i,s[2]),o={attrs:t,bitrate:t.decimalInteger("AVERAGE-BANDWIDTH")||t.decimalInteger("BANDWIDTH"),name:t.NAME,url:Ft.resolve(a,e)},l=t.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),Bt((t.CODECS||"").split(/[ ,]+/).filter((t=>t)),o),o.videoCodec&&-1!==o.videoCodec.indexOf("avc1")&&(o.videoCodec=Ft.convertAVC1ToAVCOTI(o.videoCodec)),null!=(n=o.unknownCodecs)&&n.length||r.push(o),i.levels.push(o)}else if(s[3]){const t=s[3],r=s[4];switch(t){case"SESSION-DATA":{const t=new v(r);_t(i,t,["DATA-ID","LANGUAGE","VALUE","URI"]);const e=t["DATA-ID"];e&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[e]=t);break}case"SESSION-KEY":{const t=Nt(r,e,i);t.encrypted&&t.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(t)):p.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":{const t=new v(r);_t(i,t,["NAME","VALUE","QUERYPARAM"]),Lt(i,t,e)}break;case"CONTENT-STEERING":{const t=new v(r);_t(i,t,["SERVER-URI","PATHWAY-ID"]),i.contentSteering={uri:Ft.resolve(t["SERVER-URI"],e),pathwayId:t["PATHWAY-ID"]||"."};break}case"START":i.startTimeOffset=Ut(r)}}const a=r.length>0&&r.length<i.levels.length;return i.levels=a?r:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(t,e,i){let r;const s={},n=i.levels,a={AUDIO:n.map((t=>({id:t.attrs.AUDIO,audioCodec:t.audioCodec}))),SUBTITLES:n.map((t=>({id:t.attrs.SUBTITLES,textCodec:t.textCodec}))),"CLOSED-CAPTIONS":[]};let o=0;for(Pt.lastIndex=0;null!==(r=Pt.exec(t));){const t=new v(r[1]),n=t.TYPE;if(n){const r=a[n],l=s[n]||[];s[n]=l,_t(i,t,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const h={attrs:t,bitrate:0,id:o++,groupId:t["GROUP-ID"]||"",instreamId:t["INSTREAM-ID"],name:t.NAME||t.LANGUAGE||"",type:n,default:t.bool("DEFAULT"),autoselect:t.bool("AUTOSELECT"),forced:t.bool("FORCED"),lang:t.LANGUAGE,url:t.URI?Ft.resolve(t.URI,e):""};if(null!=r&&r.length){const t=Ft.findGroup(r,h.groupId)||r[0];$t(h,t,"audioCodec"),$t(h,t,"textCodec")}l.push(h)}}return s}static parseLevelPlaylist(t,e,i,r,s,n){const a=new A(e),h=a.fragments;let d,c,u,f=null,g=0,m=0,y=0,E=0,b=null,S=new R(r,e),w=-1,L=!1;for(Ot.lastIndex=0,a.m3u8=t,a.hasVariableRefs=Rt(t);null!==(d=Ot.exec(t));){L&&(L=!1,S=new R(r,e),S.start=y,S.sn=g,S.cc=E,S.level=i,f&&(S.initSegment=f,S.rawProgramDateTime=f.rawProgramDateTime,f.rawProgramDateTime=null));const t=d[1];if(t){S.duration=parseFloat(t);const e=(" "+d[2]).slice(1);S.title=e||null,S.tagList.push(e?["INF",t,e]:["INF",t])}else if(d[3]){if(l(S.duration)){S.start=y,u&&Ht(S,u,a),S.sn=g,S.level=i,S.cc=E,S.urlId=s,h.push(S);const t=(" "+d[3]).slice(1);S.relurl=At(a,t),Gt(S,b),b=S,y+=S.duration,g++,m=0,L=!0}}else if(d[4]){const t=(" "+d[4]).slice(1);b?S.setByteRange(t,b):S.setByteRange(t)}else if(d[5])S.rawProgramDateTime=(" "+d[5]).slice(1),S.tagList.push(["PROGRAM-DATE-TIME",S.rawProgramDateTime]),-1===w&&(w=h.length);else{if(d=d[0].match(Mt),!d){p.warn("No matches on slow regex match for level playlist!");continue}for(c=1;c<d.length&&void 0===d[c];c++);const t=(" "+d[c]).slice(1),s=(" "+d[c+1]).slice(1),y=d[c+2]?(" "+d[c+2]).slice(1):"";switch(t){case"PLAYLIST-TYPE":a.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":g=a.startSN=parseInt(s);break;case"SKIP":{const t=new v(s);_t(a,t,["RECENTLY-REMOVED-DATERANGES"]);const e=t.decimalInteger("SKIPPED-SEGMENTS");if(l(e)){a.skippedSegments=e;for(let t=e;t--;)h.unshift(null);g+=e}const i=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(a.recentlyRemovedDateranges=i.split("\t"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(s),1);break;case"VERSION":a.version=parseInt(s);break;case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(s||y)&&S.tagList.push(y?[s,y]:[s]);break;case"DISCONTINUITY":E++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([t]);break;case"BITRATE":S.tagList.push([t,s]);break;case"DATERANGE":{const t=new v(s);_t(a,t,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),_t(a,t,t.clientAttrs);const e=new T(t,a.dateRanges[t.ID]);e.isValid||a.skippedSegments?a.dateRanges[e.id]=e:p.warn(`Ignoring invalid DATERANGE tag: "${s}"`),S.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{const t=new v(s);_t(a,t,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in t?Ct(a,t,n):Lt(a,t,e)}break;case"DISCONTINUITY-SEQUENCE":E=parseInt(s);break;case"KEY":{const t=Nt(s,e,a);if(t.isSupported()){if("NONE"===t.method){u=void 0;break}u||(u={}),u[t.keyFormat]&&(u=o({},u)),u[t.keyFormat]=t}else p.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${s}"`);break}case"START":a.startTimeOffset=Ut(s);break;case"MAP":{const t=new v(s);if(_t(a,t,["BYTERANGE","URI"]),S.duration){const s=new R(r,e);Kt(s,t,i,u),f=s,S.initSegment=f,f.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=f.rawProgramDateTime)}else Kt(S,t,i,u),f=S,L=!0;break}case"SERVER-CONTROL":{const t=new v(s);a.canBlockReload=t.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=t.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&t.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=t.optionalFloat("PART-HOLD-BACK",0),a.holdBack=t.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const t=new v(s);a.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let t=a.partList;t||(t=a.partList=[]);const i=m>0?t[t.length-1]:void 0,r=m++,n=new v(s);_t(a,n,["BYTERANGE","URI"]);const o=new _(n,S,e,r,i);t.push(o),S.duration+=o.duration;break}case"PRELOAD-HINT":{const t=new v(s);_t(a,t,["URI"]),a.preloadHint=t;break}case"RENDITION-REPORT":{const t=new v(s);_t(a,t,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(t);break}default:p.warn(`line parsed but not handled: ${d}`)}}}b&&!b.relurl?(h.pop(),y-=b.duration,a.partList&&(a.fragmentHint=b)):a.partList&&(Gt(S,b),S.cc=E,a.fragmentHint=S,u&&Ht(S,u,a));const C=h.length,I=h[0],k=h[C-1];if(y+=a.skippedSegments*a.targetduration,y>0&&C&&k){a.averagetargetduration=y/C;const t=k.sn;a.endSN="initSegment"!==t?t:0,a.live||(k.endList=!0),I&&(a.startCC=I.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(y+=a.fragmentHint.duration),a.totalduration=y,a.endCC=E,w>0&&function(t,e){let i=t[e];for(let r=e;r--;){const e=t[r];if(!e)return;e.programDateTime=i.programDateTime-1e3*e.duration,i=e}}(h,w),a}}function Nt(t,e,i){var r,s;const n=new v(t);_t(i,n,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=null!=(r=n.METHOD)?r:"",o=n.URI,l=n.hexadecimalInteger("IV"),h=n.KEYFORMATVERSIONS,d=null!=(s=n.KEYFORMAT)?s:"identity";o&&n.IV&&!l&&p.error(`Invalid IV: ${n.IV}`);const c=o?Ft.resolve(o,e):"",u=(h||"1").split("/").map(Number).filter(Number.isFinite);return new St(a,c,d,u,l)}function Ut(t){const e=new v(t).decimalFloatingPoint("TIME-OFFSET");return l(e)?e:null}function Bt(t,e){["video","audio","text"].forEach((i=>{const r=t.filter((t=>function(t,e){const i=It[e];return!!i&&!0===i[t.slice(0,4)]}(t,i)));if(r.length){const s=r.filter((t=>0===t.lastIndexOf("avc1",0)||0===t.lastIndexOf("mp4a",0)));e[`${i}Codec`]=s.length>0?s[0]:r[0],t=t.filter((t=>-1===r.indexOf(t)))}})),e.unknownCodecs=t}function $t(t,e,i){const r=e[i];r&&(t[i]=r)}function Gt(t,e){t.rawProgramDateTime?t.programDateTime=Date.parse(t.rawProgramDateTime):null!=e&&e.programDateTime&&(t.programDateTime=e.endProgramDateTime),l(t.programDateTime)||(t.programDateTime=null,t.rawProgramDateTime=null)}function Kt(t,e,i,r){t.relurl=e.URI,e.BYTERANGE&&t.setByteRange(e.BYTERANGE),t.level=i,t.sn="initSegment",r&&(t.levelkeys=r),t.initSegment=null}function Ht(t,e,i){t.levelkeys=e;const{encryptedFragments:r}=i;r.length&&r[r.length-1].levelkeys===e||!Object.keys(e).some((t=>e[t].isCommonEncryption))||r.push(t)}var Vt={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},jt={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function qt(t){const{type:e}=t;switch(e){case Vt.AUDIO_TRACK:return jt.AUDIO;case Vt.SUBTITLE_TRACK:return jt.SUBTITLE;default:return jt.MAIN}}function Wt(t,e){let i=t.url;return void 0!==i&&0!==i.indexOf("data:")||(i=e.url),i}class Yt{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(h.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(h.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){const e=this.hls.config,i=e.pLoader,r=e.loader,s=new(i||r)(e);return this.loaders[t.type]=s,s}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Vt.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(t,e){const{id:i,level:r,url:s,deliveryDirectives:n}=e;this.load({id:i,level:r,responseType:"text",type:Vt.LEVEL,url:s,deliveryDirectives:n})}onAudioTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:n}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:Vt.AUDIO_TRACK,url:s,deliveryDirectives:n})}onSubtitleTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:n}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:Vt.SUBTITLE_TRACK,url:s,deliveryDirectives:n})}load(t){var e;const i=this.hls.config;let r,s=this.getInternalLoader(t);if(s){const e=s.context;if(e&&e.url===t.url)return void p.trace("[playlist-loader]: playlist request ongoing");p.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),s.abort()}if(r=t.type===Vt.MANIFEST?i.manifestLoadPolicy.default:o({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(t),null!=(e=t.deliveryDirectives)&&e.part){let e;if(t.type===Vt.LEVEL&&null!==t.level?e=this.hls.levels[t.level].details:t.type===Vt.AUDIO_TRACK&&null!==t.id?e=this.hls.audioTracks[t.id].details:t.type===Vt.SUBTITLE_TRACK&&null!==t.id&&(e=this.hls.subtitleTracks[t.id].details),e){const t=e.partTarget,i=e.targetduration;if(t&&i){const e=1e3*Math.max(3*t,.8*i);r=o({},r,{maxTimeToFirstByteMs:Math.min(e,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(e,r.maxTimeToFirstByteMs)})}}}const n=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0},l={onSuccess:(t,e,i,r)=>{const s=this.getInternalLoader(i);this.resetInternalLoader(i.type);const n=t.data;0===n.indexOf("#EXTM3U")?(e.parsing.start=performance.now(),Ft.isMediaPlaylist(n)?this.handleTrackOrLevelPlaylist(t,e,i,r||null,s):this.handleMasterPlaylist(t,e,i,r)):this.handleManifestParsingError(t,i,new Error("no EXTM3U delimiter"),r||null,e)},onError:(t,e,i,r)=>{this.handleNetworkError(e,i,!1,t,r)},onTimeout:(t,e,i)=>{this.handleNetworkError(e,i,!0,void 0,t)}};s.load(t,a,l)}handleMasterPlaylist(t,e,i,r){const s=this.hls,n=t.data,a=Wt(t,i),o=Ft.parseMasterPlaylist(n,a);if(o.playlistParsingError)return void this.handleManifestParsingError(t,i,o.playlistParsingError,r,e);const{contentSteering:l,levels:d,sessionData:c,sessionKeys:u,startTimeOffset:f,variableList:g}=o;this.variableList=g;const{AUDIO:m=[],SUBTITLES:y,"CLOSED-CAPTIONS":E}=Ft.parseMasterPlaylistMedia(n,a,o);m.length&&(m.some((t=>!t.url))||!d[0].audioCodec||d[0].attrs.AUDIO||(p.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new v({}),bitrate:0,url:""}))),s.trigger(h.MANIFEST_LOADED,{levels:d,audioTracks:m,subtitles:y,captions:E,contentSteering:l,url:a,stats:e,networkDetails:r,sessionData:c,sessionKeys:u,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(t,e,i,r,s){const n=this.hls,{id:a,level:o,type:d}=i,c=Wt(t,i),u=l(a)?a:0,f=l(o)?o:u,g=qt(i),p=Ft.parseLevelPlaylist(t.data,c,f,g,u,this.variableList);if(d===Vt.MANIFEST){const t={attrs:new v({}),bitrate:0,details:p,name:"",url:c};n.trigger(h.MANIFEST_LOADED,{levels:[t],audioTracks:[],url:c,stats:e,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=p,this.handlePlaylistLoaded(p,t,e,i,r,s)}handleManifestParsingError(t,e,i,r,s){this.hls.trigger(h.ERROR,{type:d.NETWORK_ERROR,details:c.MANIFEST_PARSING_ERROR,fatal:e.type===Vt.MANIFEST,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:r,stats:s})}handleNetworkError(t,e,i=!1,r,s){let a=`A network ${i?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${t.type}`;t.type===Vt.LEVEL?a+=`: ${t.level} id: ${t.id}`:t.type!==Vt.AUDIO_TRACK&&t.type!==Vt.SUBTITLE_TRACK||(a+=` id: ${t.id} group-id: "${t.groupId}"`);const o=new Error(a);p.warn(`[playlist-loader]: ${a}`);let l=c.UNKNOWN,u=!1;const f=this.getInternalLoader(t);switch(t.type){case Vt.MANIFEST:l=i?c.MANIFEST_LOAD_TIMEOUT:c.MANIFEST_LOAD_ERROR,u=!0;break;case Vt.LEVEL:l=i?c.LEVEL_LOAD_TIMEOUT:c.LEVEL_LOAD_ERROR,u=!1;break;case Vt.AUDIO_TRACK:l=i?c.AUDIO_TRACK_LOAD_TIMEOUT:c.AUDIO_TRACK_LOAD_ERROR,u=!1;break;case Vt.SUBTITLE_TRACK:l=i?c.SUBTITLE_TRACK_LOAD_TIMEOUT:c.SUBTITLE_LOAD_ERROR,u=!1}f&&this.resetInternalLoader(t.type);const g={type:d.NETWORK_ERROR,details:l,fatal:u,url:t.url,loader:f,context:t,error:o,networkDetails:e,stats:s};if(r){const i=(null==e?void 0:e.url)||t.url;g.response=n({url:i,data:void 0},r)}this.hls.trigger(h.ERROR,g)}handlePlaylistLoaded(t,e,i,r,s,n){const a=this.hls,{type:o,level:l,id:u,groupId:f,deliveryDirectives:g}=r,p=Wt(e,r),m=qt(r),y="number"==typeof r.level&&m===jt.MAIN?l:void 0;if(!t.fragments.length){const t=new Error("No Segments found in Playlist");return void a.trigger(h.ERROR,{type:d.NETWORK_ERROR,details:c.LEVEL_EMPTY_ERROR,fatal:!1,url:p,error:t,reason:t.message,response:e,context:r,level:y,parent:m,networkDetails:s,stats:i})}t.targetduration||(t.playlistParsingError=new Error("Missing Target Duration"));const v=t.playlistParsingError;if(v)a.trigger(h.ERROR,{type:d.NETWORK_ERROR,details:c.LEVEL_PARSING_ERROR,fatal:!1,url:p,error:v,reason:v.message,response:e,context:r,level:y,parent:m,networkDetails:s,stats:i});else switch(t.live&&n&&(n.getCacheAge&&(t.ageHeader=n.getCacheAge()||0),n.getCacheAge&&!isNaN(t.ageHeader)||(t.ageHeader=0)),o){case Vt.MANIFEST:case Vt.LEVEL:a.trigger(h.LEVEL_LOADED,{details:t,level:y||0,id:u||0,stats:i,networkDetails:s,deliveryDirectives:g});break;case Vt.AUDIO_TRACK:a.trigger(h.AUDIO_TRACK_LOADED,{details:t,id:u||0,groupId:f||"",stats:i,networkDetails:s,deliveryDirectives:g});break;case Vt.SUBTITLE_TRACK:a.trigger(h.SUBTITLE_TRACK_LOADED,{details:t,id:u||0,groupId:f||"",stats:i,networkDetails:s,deliveryDirectives:g})}}}function zt(t,e){let i;try{i=new Event("addtrack")}catch(t){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=t,e.dispatchEvent(i)}function Xt(t,e){const i=t.mode;if("disabled"===i&&(t.mode="hidden"),t.cues&&!t.cues.getCueById(e.id))try{if(t.addCue(e),!t.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){p.debug(`[texttrack-utils]: ${i}`);const r=new self.TextTrackCue(e.startTime,e.endTime,e.text);r.id=e.id,t.addCue(r)}"disabled"===i&&(t.mode=i)}function Qt(t){const e=t.mode;if("disabled"===e&&(t.mode="hidden"),t.cues)for(let e=t.cues.length;e--;)t.removeCue(t.cues[e]);"disabled"===e&&(t.mode=e)}function Jt(t,e,i,r){const s=t.mode;if("disabled"===s&&(t.mode="hidden"),t.cues&&t.cues.length>0){const s=function(t,e,i){const r=[],s=function(t,e){if(e<t[0].startTime)return 0;const i=t.length-1;if(e>t[i].endTime)return-1;let r=0,s=i;for(;r<=s;){const n=Math.floor((s+r)/2);if(e<t[n].startTime)s=n-1;else{if(!(e>t[n].startTime&&r<i))return n;r=n+1}}return t[r].startTime-e<e-t[s].startTime?r:s}(t,e);if(s>-1)for(let n=s,a=t.length;n<a;n++){const s=t[n];if(s.startTime>=e&&s.endTime<=i)r.push(s);else if(s.startTime>i)return r}return r}(t.cues,e,i);for(let e=0;e<s.length;e++)r&&!r(s[e])||t.removeCue(s[e])}"disabled"===s&&(t.mode=s)}var Zt="org.id3",te="https://aomedia.org/emsg/ID3";function ee(){if("undefined"!=typeof self)return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}const ie=(()=>{const t=ee();try{new t(0,Number.POSITIVE_INFINITY,"")}catch(t){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function re(t,e){return t.getTime()/1e3-e}class se{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(Qt(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const i=t[e];if("metadata"===i.kind&&"id3"===i.label)return zt(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;const{samples:s}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const n=ee();for(let t=0;t<s.length;t++){const e=s[t].type;if(e===te&&!i||!r)continue;const a=W(s[t].data);if(a){const i=s[t].pts;let r=i+s[t].duration;r>ie&&(r=ie),r-i<=0&&(r=i+.25);for(let t=0;t<a.length;t++){const s=a[t];if(!j(s)){this.updateId3CueEnds(i);const t=new n(i,r,"");t.value=s,e&&(t.type=e),this.id3Track.addCue(t)}}}}}updateId3CueEnds(t){var e;const i=null==(e=this.id3Track)?void 0:e.cues;if(i)for(let e=i.length;e--;){const r=i[e];r.startTime<t&&r.endTime===ie&&(r.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:i,type:r}){const{id3Track:s,hls:n}=this;if(!n)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=n;if(s&&(a||o)){let t;t="audio"===r?t=>t.type===Zt&&o:"video"===r?t=>t.type===te&&a:t=>t.type===Zt&&o||t.type===te&&a,Jt(s,e,i,t)}}onLevelUpdated(t,{details:e}){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:r}=this,{dateRanges:s}=e,n=Object.keys(s);if(r){const t=Object.keys(i).filter((t=>!n.includes(t)));for(let e=t.length;e--;){const s=t[e];Object.keys(i[s].cues).forEach((t=>{r.removeCue(i[s].cues[t])})),delete i[s]}}const a=e.fragments[e.fragments.length-1];if(0===n.length||!l(null==a?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=a.programDateTime/1e3-a.start,h=ee();for(let t=0;t<n.length;t++){const e=n[t],r=s[e],a=i[e],l=(null==a?void 0:a.cues)||{};let u=(null==a?void 0:a.durationKnown)||!1;const f=re(r.startDate,o);let g=ie;const p=r.endDate;if(p)g=re(p,o),u=!0;else if(r.endOnNext&&!u){const t=n.reduce(((t,e)=>{const i=s[e];return i.class===r.class&&i.id!==e&&i.startDate>r.startDate&&t.push(i),t}),[]).sort(((t,e)=>t.startDate.getTime()-e.startDate.getTime()))[0];t&&(g=re(t.startDate,o),u=!0)}const m=Object.keys(r.attr);for(let t=0;t<m.length;t++){const i=m[t];if("ID"===(c=i)||"CLASS"===c||"START-DATE"===c||"DURATION"===c||"END-DATE"===c||"END-ON-NEXT"===c)continue;let s=l[i];if(s)u&&!a.durationKnown&&(s.endTime=g);else{let t=r.attr[i];s=new h(f,g,""),E(i)&&(d=t,t=Uint8Array.from(d.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer),s.value={key:i,data:t},s.type="com.apple.quicktime.HLS",s.id=e,this.id3Track.addCue(s),l[i]=s}}i[e]={cues:l,dateRange:r,durationKnown:u}}var d,c}}class ne{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:t,levelDetails:e}=this;return void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const{levelDetails:t}=this;if(null===t)return null;const{holdBack:e,partHoldBack:i,targetduration:r}=t,{liveSyncDuration:s,liveSyncDurationCount:n,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&i||e;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==s?s:n*r);const h=r;return l+Math.min(1*this.stallCount,h)}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency,i=this.levelDetails;if(null===t||null===e||null===i)return null;const r=i.edge,s=t-e-this.edgeStalled,n=r-i.totalduration,a=r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(n,s),a)}get drift(){const{levelDetails:t}=this;return null===t?1:t.drift}get edgeStalled(){const{levelDetails:t}=this;if(null===t)return 0;const e=3*(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t,levelDetails:e}=this;if(!t||!e)return 0;const i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(h.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(h.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(h.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(h.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){this.levelDetails=e,e.advanced&&this.timeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var i;e.details===c.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(i=this.levelDetails)&&i.live&&p.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||1===s)return;const n=this.targetLatency;if(null===n)return;const a=i-n,o=a<Math.min(this.maxLatency,n+e.targetduration);if(e.live&&o&&a>.05&&this.forwardBufferLength>1){const e=Math.min(2,Math.max(1,s)),i=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;t.playbackRate=Math.min(e,Math.max(1,i))}else 1!==t.playbackRate&&0!==t.playbackRate&&(t.playbackRate=1)}estimateLiveEdge(){const{levelDetails:t}=this;return null===t?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return null===t?null:t-this.currentTime}}const ae=["NONE","TYPE-0","TYPE-1",null];var oe="",le="YES",he="v2";class de{constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}addDirectives(t){const e=new self.URL(t);return void 0!==this.msn&&e.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class ce{constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.unknownCodecs=t.unknownCodecs,this.codecSet=[t.videoCodec,t.audioCodec].filter((t=>t)).join(",").replace(/\.[^.,]+/g,"")}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get attrs(){return this._attrs[this._urlId]}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get uri(){return this.url[this._urlId]||""}get urlId(){return this._urlId}set urlId(t){const e=t%this.url.length;this._urlId!==e&&(this.fragmentError=0,this.loadError=0,this.details=void 0,this._urlId=e)}get audioGroupId(){var t;return null==(t=this.audioGroupIds)?void 0:t[this.urlId]}get textGroupId(){var t;return null==(t=this.textGroupIds)?void 0:t[this.urlId]}addFallback(t){this.url.push(t.url),this._attrs.push(t.attrs)}}function ue(t,e){const i=e.startPTS;if(l(i)){let r,s=0;e.sn>t.sn?(s=i-t.start,r=t):(s=t.start-i,r=e),r.duration!==s&&(r.duration=s)}else e.sn>t.sn?t.cc===e.cc&&t.minEndPTS?e.start=t.start+(t.minEndPTS-t.start):e.start=t.start+t.duration:e.start=Math.max(t.start-e.duration,0)}function fe(t,e,i,r,s,n){r-i<=0&&(p.warn("Fragment should have a positive duration",e),r=i+e.duration,n=s+e.duration);let a=i,o=r;const h=e.startPTS,d=e.endPTS;if(l(h)){const t=Math.abs(h-i);l(e.deltaPTS)?e.deltaPTS=Math.max(t,e.deltaPTS):e.deltaPTS=t,a=Math.max(i,h),i=Math.min(i,h),s=Math.min(s,e.startDTS),o=Math.min(r,d),r=Math.max(r,d),n=Math.max(n,e.endDTS)}const c=i-e.start;0!==e.start&&(e.start=i),e.duration=r-e.start,e.startPTS=i,e.maxStartPTS=a,e.startDTS=s,e.endPTS=r,e.minEndPTS=o,e.endDTS=n;const u=e.sn;if(!t||u<t.startSN||u>t.endSN)return 0;let f;const g=u-t.startSN,m=t.fragments;for(m[g]=e,f=g;f>0;f--)ue(m[f],m[f-1]);for(f=g;f<m.length-1;f++)ue(m[f],m[f+1]);return t.fragmentHint&&ue(m[m.length-1],t.fragmentHint),t.PTSKnown=t.alignedSliding=!0,c}function ge(t,e){const i=e.startSN+e.skippedSegments-t.startSN,r=t.fragments;i<0||i>=r.length||pe(e,r[i].start)}function pe(t,e){if(e){const i=t.fragments;for(let r=t.skippedSegments;r<i.length;r++)i[r].start+=e;t.fragmentHint&&(t.fragmentHint.start+=e)}}function me(t,e,i){var r;return null!=t&&t.details?ye(null==(r=t.details)?void 0:r.partList,e,i):null}function ye(t,e,i){if(t)for(let r=t.length;r--;){const s=t[r];if(s.index===i&&s.fragment.sn===e)return s}return null}function ve(t){switch(t.details){case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_TIMEOUT:case c.LEVEL_LOAD_TIMEOUT:case c.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Ee(t,e){const i=ve(e);return t.default[(i?"timeout":"error")+"Retry"]}function Te(t,e){const i="linear"===t.backoff?1:Math.pow(2,e);return Math.min(i*t.retryDelayMs,t.maxRetryDelayMs)}function be(t){return n(n({},t),{errorRetry:null,timeoutRetry:null})}function Se(t,e,i,r){return!!t&&e<t.maxNumRetry&&(function(t){return 0===t&&!1===navigator.onLine||!!t&&(t<400||t>499)}(r)||!!i)}const we={search:function(t,e){let i=0,r=t.length-1,s=null,n=null;for(;i<=r;){s=(i+r)/2|0,n=t[s];const a=e(n);if(a>0)i=s+1;else{if(!(a<0))return n;r=s-1}}return null}};function Re(t,e,i=0,r=0){let s=null;if(t?s=e[t.sn-e[0].sn+1]||null:0===i&&0===e[0].start&&(s=e[0]),s&&0===_e(i,r,s))return s;const n=we.search(e,_e.bind(null,i,r));return!n||n===t&&s?s:n}function _e(t=0,e=0,i){if(i.start<=t&&i.start+i.duration>t)return 0;const r=Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=t?1:i.start-r>t&&i.start?-1:0}function Ae(t,e,i){const r=1e3*Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-r>t}function Le(t,e,i){if(performance.now()-t.lastErrorPerfMs>3e5)return!0;const r=t.details;if(e.details===c.FRAG_GAP&&r&&e.frag){const t=e.frag.start,i=Re(null,r.fragments,t);if(i&&!i.gap)return!0}if(i&&t.errors.length<i.errors.length){const i=t.errors[t.errors.length-1];if(r&&i.frag&&e.frag&&Math.abs(i.frag.start-e.frag.start)>3*r.targetduration)return!0}return!1}class Ce{constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=p.log.bind(p,`${e}:`),this.warn=p.warn.bind(p,`${e}:`),this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e){const i=null==e?void 0:e.renditionReports;if(i){let r=-1;for(let s=0;s<i.length;s++){const n=i[s];let a;try{a=new self.URL(n.URI,e.url).href}catch(t){p.warn(`Could not construct new URL for Rendition Report: ${t}`),a=n.URI||""}if(a===t){r=s;break}a===t.substring(0,a.length)&&(r=s)}if(-1!==r){const t=i[r],s=parseInt(t["LAST-MSN"])||(null==e?void 0:e.lastPartSn);let n=parseInt(t["LAST-PART"])||(null==e?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){const t=Math.min(e.age-e.partTarget,e.targetduration);n>=0&&t>e.partTarget&&(n+=1)}return new de(s,n>=0?n:void 0,oe)}}}loadPlaylist(t){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,i){const{details:r,stats:s}=e,n=self.performance.now(),a=s.loading.first?Math.max(0,n-s.loading.first):0;if(r.advancedDateTime=Date.now()-a,r.live||null!=i&&i.live){if(r.reloaded(i),i&&this.log(`live playlist ${t} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:"MISSED"}`),i&&r.fragments.length>0&&function(t,e){let i=null;const r=t.fragments;for(let t=r.length-1;t>=0;t--){const e=r[t].initSegment;if(e){i=e;break}}t.fragmentHint&&delete t.fragmentHint.endPTS;let s,n=0;if(function(t,e,i){const r=e.skippedSegments,s=Math.max(t.startSN,e.startSN)-e.startSN,n=(t.fragmentHint?1:0)+(r?e.endSN:Math.min(t.endSN,e.endSN))-e.startSN,a=e.startSN-t.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments;for(let t=s;t<=n;t++){const s=l[a+t];let n=o[t];r&&!n&&t<r&&(n=e.fragments[t]=s),s&&n&&i(s,n)}}(t,e,((t,r)=>{t.relurl&&(n=t.cc-r.cc),l(t.startPTS)&&l(t.endPTS)&&(r.start=r.startPTS=t.startPTS,r.startDTS=t.startDTS,r.maxStartPTS=t.maxStartPTS,r.endPTS=t.endPTS,r.endDTS=t.endDTS,r.minEndPTS=t.minEndPTS,r.duration=t.endPTS-t.startPTS,r.duration&&(s=r),e.PTSKnown=e.alignedSliding=!0),r.elementaryStreams=t.elementaryStreams,r.loader=t.loader,r.stats=t.stats,r.urlId=t.urlId,t.initSegment&&(r.initSegment=t.initSegment,i=t.initSegment)})),i&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach((t=>{var e;t.initSegment&&t.initSegment.relurl!==(null==(e=i)?void 0:e.relurl)||(t.initSegment=i)})),e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some((t=>!t)),e.deltaUpdateFailed){p.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let t=e.skippedSegments;t--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=function(t,e,i){const r=o({},t);return i&&i.forEach((t=>{delete r[t]})),Object.keys(e).forEach((t=>{const i=new T(e[t].attr,r[t]);i.isValid?r[t]=i:p.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[t].attr)}"`)})),r}(t.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const a=e.fragments;if(n){p.warn("discontinuity sliding from playlist, take drift into account");for(let t=0;t<a.length;t++)a[t].cc+=n}e.skippedSegments&&(e.startCC=e.fragments[0].cc),function(t,e,i){if(t&&e){let r=0;for(let s=0,n=t.length;s<=n;s++){const n=t[s],a=e[s+r];n&&a&&n.index===a.index&&n.fragment.sn===a.fragment.sn?i(n,a):r--}}}(t.partList,e.partList,((t,e)=>{e.elementaryStreams=t.elementaryStreams,e.stats=t.stats})),s?fe(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):ge(t,e),a.length&&(e.totalduration=e.edge-a[0].start),e.driftStartTime=t.driftStartTime,e.driftStart=t.driftStart;const h=e.advancedDateTime;if(e.advanced&&h){const t=e.edge;e.driftStart||(e.driftStartTime=h,e.driftStart=t),e.driftEndTime=h,e.driftEnd=t}else e.driftEndTime=t.driftEndTime,e.driftEnd=t.driftEnd,e.advancedDateTime=t.advancedDateTime}(i,r),!this.canLoad||!r.live)return;let a,h,d;if(r.canBlockReload&&r.endSN&&r.advanced){const t=this.hls.config.lowLatencyMode,s=r.lastPartSn,n=r.endSN,o=r.lastPartIndex,l=s===n;-1!==o?(h=l?n+1:s,d=l?t?0:o:o+1):h=n+1;const c=r.age,u=c+r.ageHeader;let f=Math.min(u-r.partTarget,1.5*r.targetduration);if(f>0){if(i&&f>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${f} with playlist age: ${r.age}`),f=0;else{const t=Math.floor(f/r.targetduration);h+=t,void 0!==d&&(d+=Math.round(f%r.targetduration/r.partTarget)),this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${c.toFixed(2)}s goal: ${f} skip sn ${t} to part ${d}`)}r.tuneInGoal=f}if(a=this.getDeliveryDirectives(r,e.deliveryDirectives,h,d),t||!l)return void this.loadPlaylist(a)}else r.canBlockReload&&(a=this.getDeliveryDirectives(r,e.deliveryDirectives,h,d));const c=this.hls.mainForwardBufferInfo,u=c?c.end-c.len:0,f=function(t,e=1/0){let i=1e3*t.targetduration;if(t.updated){const r=t.fragments,s=4;if(r.length&&i*s>e){const t=1e3*r[r.length-1].duration;t<i&&(i=t)}}else i/=2;return Math.round(i)}(r,1e3*(r.edge-u));r.updated&&n>this.requestScheduled+f&&(this.requestScheduled=s.loading.start),void 0!==h&&r.canBlockReload?this.requestScheduled=s.loading.first+f-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+f<n?this.requestScheduled=n:this.requestScheduled-n<=0&&(this.requestScheduled+=f);let g=this.requestScheduled-n;g=Math.max(0,g),this.log(`reload live playlist ${t} in ${Math.round(g)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(a)),g)}else this.clearTimer()}getDeliveryDirectives(t,e,i,r){let s=function(t,e){const{canSkipUntil:i,canSkipDateRanges:r,endSN:s}=t;return i&&(void 0!==e?e-s:0)<i?r?he:le:oe}(t,i);return null!=e&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,r=e.part,s=oe),new de(i,r,s)}checkRetry(t){const e=t.details,i=ve(t),r=t.errorAction,{action:s,retryCount:n=0,retryConfig:a}=r||{},o=5===s&&!!r&&!!a;if(o){var l;if(this.requestScheduled=-1,i&&null!=(l=t.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${n+1}/${a.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const t=Te(a,n);this.timer=self.setTimeout((()=>this.loadPlaylist()),t),this.warn(`Retrying playlist loading ${n+1}/${a.maxNumRetry} after "${e}" in ${t}ms`)}t.levelRetry=!0,r.resolved=!0}return o}}let Ie;class ke extends Ce{constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this),t.on(h.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this),t.off(h.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}startLoad(){this._levels.forEach((t=>{t.loadError=0,t.fragmentError=0})),super.startLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[]}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const i=[],r={};let s;e.levels.forEach((t=>{var e;const n=t.attrs;-1!==(null==(e=t.audioCodec)?void 0:e.indexOf("mp4a.40.34"))&&(Ie||(Ie=/chrome|firefox/i.test(navigator.userAgent)),Ie&&(t.audioCodec=void 0));const{AUDIO:a,CODECS:o,"FRAME-RATE":l,"PATHWAY-ID":h,RESOLUTION:d,SUBTITLES:c}=n,u=`${h||"."}-${t.bitrate}-${d}-${l}-${o}`;s=r[u],s?s.addFallback(t):(s=new ce(t),r[u]=s,i.push(s)),De(s,"audio",a),De(s,"text",c)})),this.filterAndSortMediaOptions(i,e)}filterAndSortMediaOptions(t,e){let i=[],r=[],s=!1,n=!1,a=!1,o=t.filter((({audioCodec:t,videoCodec:e,width:i,height:r,unknownCodecs:o})=>(s||(s=!(!i||!r)),n||(n=!!e),a||(a=!!t),!(null!=o&&o.length)&&(!t||kt(t,"audio"))&&(!e||kt(e,"video")))));if((s||n)&&a&&(o=o.filter((({videoCodec:t,width:e,height:i})=>!!t||!(!e||!i)))),0===o.length)return void Promise.resolve().then((()=>{if(this.hls){const t=new Error("no level with compatible codecs found in manifest");this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:t,reason:t.message})}}));e.audioTracks&&(i=e.audioTracks.filter((t=>!t.audioCodec||kt(t.audioCodec,"audio"))),Pe(i)),e.subtitles&&(r=e.subtitles,Pe(r));const l=o.slice(0);o.sort(((t,e)=>t.attrs["HDCP-LEVEL"]!==e.attrs["HDCP-LEVEL"]?(t.attrs["HDCP-LEVEL"]||"")>(e.attrs["HDCP-LEVEL"]||"")?1:-1:t.bitrate!==e.bitrate?t.bitrate-e.bitrate:t.attrs["FRAME-RATE"]!==e.attrs["FRAME-RATE"]?t.attrs.decimalFloatingPoint("FRAME-RATE")-e.attrs.decimalFloatingPoint("FRAME-RATE"):t.attrs.SCORE!==e.attrs.SCORE?t.attrs.decimalFloatingPoint("SCORE")-e.attrs.decimalFloatingPoint("SCORE"):s&&t.height!==e.height?t.height-e.height:0));let u=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let t=0;t<l.length;t++)if(l[t].pathwayId===o[0].pathwayId){u=l[t];break}this._levels=o;for(let t=0;t<o.length;t++)if(o[t]===u){this._firstLevel=t,this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${u.bitrate}`);break}const f=a&&!n,g={levels:o,audioTracks:i,subtitleTracks:r,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:a,video:n,altAudio:!f&&i.some((t=>!!t.url))};this.hls.trigger(h.MANIFEST_PARSED,g),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(0===e.length)return;if(t<0||t>=e.length){const i=new Error("invalid level idx"),r=t<0;if(this.hls.trigger(h.ERROR,{type:d.OTHER_ERROR,details:c.LEVEL_SWITCH_ERROR,level:t,fatal:r,error:i,reason:i.message}),r)return;t=Math.min(t,e.length-1)}const i=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,n=e[t],a=n.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=n,i===t&&n.details&&r&&s===a)return;this.log(`Switching to level ${t}${a?" with Pathway "+a:""} from level ${i}${s?" with Pathway "+s:""}`);const l=o({},n,{level:t,maxBitrate:n.maxBitrate,attrs:n.attrs,uri:n.uri,urlId:n.urlId});delete l._attrs,delete l._urlId,this.hls.trigger(h.LEVEL_SWITCHING,l);const u=n.details;if(!u||u.live){const t=this.switchParams(n.uri,null==r?void 0:r.details);this.loadPlaylist(t)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,void 0===this._startLevel&&(this._startLevel=t),-1!==t&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(void 0===this._startLevel){const t=this.hls.config.startLevel;return void 0!==t?t:this._firstLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){!e.fatal&&e.context&&e.context.type===Vt.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragLoaded(t,{frag:e}){if(void 0!==e&&e.type===jt.MAIN){const t=this._levels[e.level];void 0!==t&&(t.loadError=0)}}onLevelLoaded(t,e){var i;const{level:r,details:s}=e,n=this._levels[r];var a;if(!n)return this.warn(`Invalid level index ${r}`),void(null!=(a=e.deliveryDirectives)&&a.skip&&(s.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===n.fragmentError&&(n.loadError=0),this.playlistLoaded(r,e,n.details)):null!=(i=e.deliveryDirectives)&&i.skip&&(s.deltaUpdateFailed=!0)}onAudioTrackSwitched(t,e){const i=this.currentLevel;if(!i)return;const r=this.hls.audioTracks[e.id].groupId;if(i.audioGroupIds&&i.audioGroupId!==r){let t=-1;for(let e=0;e<i.audioGroupIds.length;e++)if(i.audioGroupIds[e]===r){t=e;break}-1!==t&&t!==i.urlId&&(i.urlId=t,this.canLoad&&this.startLoad())}}loadPlaylist(t){super.loadPlaylist();const e=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){const r=i.urlId;let s=i.uri;if(t)try{s=t.addDirectives(s)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}const n=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${e}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""} with${n?" Pathway "+n:""} URI ${r+1}/${i.url.length} ${s}`),this.clearTimer(),this.hls.trigger(h.LEVEL_LOADING,{url:s,level:e,id:r,deliveryDirectives:t||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=t)}removeLevel(t,e){const i=(t,i)=>i!==e,r=this._levels.filter(((r,s)=>s!==t||(r.url.length>1&&void 0!==e?(r.url=r.url.filter(i),r.audioGroupIds&&(r.audioGroupIds=r.audioGroupIds.filter(i)),r.textGroupIds&&(r.textGroupIds=r.textGroupIds.filter(i)),r.urlId=0,!0):(this.steering&&this.steering.removeLevel(r),!1))));this.hls.trigger(h.LEVELS_UPDATED,{levels:r})}onLevelsUpdated(t,{levels:e}){e.forEach(((t,e)=>{const{details:i}=t;null!=i&&i.fragments&&i.fragments.forEach((t=>{t.level=e}))})),this._levels=e}}function De(t,e,i){i&&("audio"===e?(t.audioGroupIds||(t.audioGroupIds=[]),t.audioGroupIds[t.url.length-1]=i):"text"===e&&(t.textGroupIds||(t.textGroupIds=[]),t.textGroupIds[t.url.length-1]=i))}function Pe(t){const e={};t.forEach((t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++}))}var xe="NOT_LOADED",Oe="APPENDING",Me="PARTIAL",Fe="OK";class Ne{constructor(t){this.mainFragEntity=null,this.activeParts=null,this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(h.BUFFER_APPENDED,this.onBufferAppended,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.BUFFER_APPENDED,this.onBufferAppended,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.endListFragments=this.timeRanges=this.mainFragEntity=this.activeParts=null}getAppendedFrag(t,e){if(e===jt.MAIN){const{mainFragEntity:e,activeParts:i}=this;if(e)if(e&&i)for(let r=i.length;r--;){const s=i[r],n=s?s.end:e.appendedPTS;if(s.start<=t&&null!==n&&t<=n)return r>9&&(this.activeParts=i.slice(r-9)),s}else if(e.body.start<=t&&null!==e.appendedPTS&&t<=e.appendedPTS)return e.body}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){const{fragments:i}=this,r=Object.keys(i);for(let s=r.length;s--;){const n=i[r[s]];if((null==n?void 0:n.body.type)===e&&n.buffered){const e=n.body;if(e.start<=t&&t<=e.end)return e}}return null}detectEvictedFragments(t,e,i){this.timeRanges&&(this.timeRanges[t]=e),Object.keys(this.fragments).forEach((r=>{const s=this.fragments[r];if(!s)return;if(!s.buffered&&!s.loaded)return void(s.body.type===i&&this.removeFragment(s.body));const n=s.range[t];n&&n.time.some((t=>{const i=!this.isTimeBuffered(t.startPTS,t.endPTS,e);return i&&this.removeFragment(s.body),i}))}))}detectPartialFragments(t){const e=this.timeRanges,{frag:i,part:r}=t;if(!e||"initSegment"===i.sn)return;const s=Be(i),n=this.fragments[s];n&&(Object.keys(e).forEach((t=>{const s=i.elementaryStreams[t];if(!s)return;const a=e[t],o=null!==r||!0===s.partial;n.range[t]=this.getBufferedTimes(i,r,o,a)})),n.loaded=null,Object.keys(n.range).length?(n.buffered=!0,n.body.endList&&(this.endListFragments[n.body.type]=n)):this.removeFragment(n.body))}fragBuffered(t,e){const i=Be(t);let r=this.fragments[i];!r&&e&&(r=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(t,e,i,r){const s={time:[],partial:i},n=e?e.start:t.start,a=e?e.end:t.end,o=t.minEndPTS||a,l=t.maxStartPTS||n;for(let t=0;t<r.length;t++){const e=r.start(t)-this.bufferPadding,i=r.end(t)+this.bufferPadding;if(l>=e&&o<=i){s.time.push({startPTS:Math.max(n,r.start(t)),endPTS:Math.min(a,r.end(t))});break}if(n<i&&a>e)s.partial=!0,s.time.push({startPTS:Math.max(n,r.start(t)),endPTS:Math.min(a,r.end(t))});else if(a<=e)break}return s}getPartialFragment(t){let e,i,r,s=null,n=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach((l=>{const h=o[l];h&&Ue(h)&&(i=h.body.start-a,r=h.body.end+a,t>=i&&t<=r&&(e=Math.min(t-i,r-t),n<=e&&(s=h.body,n=e)))})),s}isEndListAppended(t){const e=this.endListFragments[t];return void 0!==e&&(e.buffered||Ue(e))}getState(t){const e=Be(t),i=this.fragments[e];return i?i.buffered?Ue(i)?Me:Fe:Oe:xe}isTimeBuffered(t,e,i){let r,s;for(let n=0;n<i.length;n++){if(r=i.start(n)-this.bufferPadding,s=i.end(n)+this.bufferPadding,t>=r&&e<=s)return!0;if(e<=r)return!1}return!1}onFragLoaded(t,e){const{frag:i,part:r}=e;if("initSegment"===i.sn||i.bitrateTest||r)return;const s=Be(i);this.fragments[s]={body:i,appendedPTS:null,loaded:e,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:i,part:r,timeRanges:s}=e;let n=this.mainFragEntity;if(i.type===jt.MAIN){const t=n?n.body:null;if(t!==i){n&&t&&t.sn!==i.sn&&(n.buffered=!0,this.fragments[Be(t)]=n);const e=Be(i);n=this.mainFragEntity=this.fragments[e]||{body:i,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)}}if(r){let t=this.activeParts;t||(this.activeParts=t=[]),t.push(r)}else this.activeParts=null}this.timeRanges=s,Object.keys(s).forEach((t=>{const e=s[t];if(this.detectEvictedFragments(t,e),!r&&n){const r=i.elementaryStreams[t];if(!r)return;for(let t=0;t<e.length;t++){const i=e.end(t);i<=r.endPTS&&i>r.startPTS?n.appendedPTS=Math.max(i,n.appendedPTS||0):n.appendedPTS=r.endPTS}}}))}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=Be(t);return!!this.fragments[e]}removeFragmentsInRange(t,e,i,r,s){r&&!this.hasGaps||Object.keys(this.fragments).forEach((n=>{const a=this.fragments[n];if(!a)return;const o=a.body;o.type!==i||r&&!o.gap||o.start<e&&o.end>t&&(a.buffered||s)&&this.removeFragment(o)}))}removeFragment(t){const e=Be(t);t.stats.loaded=0,t.clearElementaryStreamInfo(),this.mainFragEntity===this.fragments[e]&&(this.mainFragEntity=null),delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.mainFragEntity=null,this.activeParts=null,this.hasGaps=!1}}function Ue(t){var e,i;return t.buffered&&(t.body.gap||(null==(e=t.range.video)?void 0:e.partial)||(null==(i=t.range.audio)?void 0:i.partial))}function Be(t){return`${t.type}_${t.level}_${t.urlId}_${t.sn}`}const $e=Math.pow(2,17);class Ge{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const i=t.url;if(!i)return Promise.reject(new Ve({type:d.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise(((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap)return void l(He(t));const h=this.loader=t.loader=s?new s(r):new a(r),u=Ke(t),f=be(r.fragLoadPolicy.default),g={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===t.sn?1/0:$e};t.stats=h.stats,h.load(u,g,{onSuccess:(e,i,r,s)=>{this.resetLoader(t,h);let n=e.data;r.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(n.slice(0,16)),n=n.slice(16)),o({frag:t,part:null,payload:n,networkDetails:s})},onError:(e,r,s,a)=>{this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:n({url:i,data:void 0},e),error:new Error(`HTTP Error ${e.code} ${e.text}`),networkDetails:s,stats:a}))},onAbort:(e,i,r)=>{this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:r,stats:e}))},onTimeout:(e,i,r)=>{this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${g.timeout}ms`),networkDetails:r,stats:e}))},onProgress:(i,r,s,n)=>{e&&e({frag:t,part:null,payload:s,networkDetails:n})}})}))}loadPart(t,e,i){this.abort();const r=this.config,s=r.fLoader,a=r.loader;return new Promise(((o,l)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap)return void l(He(t,e));const h=this.loader=t.loader=s?new s(r):new a(r),u=Ke(t,e),f=be(r.fragLoadPolicy.default),g={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:$e};e.stats=h.stats,h.load(u,g,{onSuccess:(r,s,n,a)=>{this.resetLoader(t,h),this.updateStatsFromPart(t,e);const l={frag:t,part:e,payload:r.data,networkDetails:a};i(l),o(l)},onError:(i,r,s,a)=>{this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:n({url:u.url,data:void 0},i),error:new Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:s,stats:a}))},onAbort:(i,r,s)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:s,stats:i}))},onTimeout:(i,r,s)=>{this.resetLoader(t,h),l(new Ve({type:d.NETWORK_ERROR,details:c.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${g.timeout}ms`),networkDetails:s,stats:i}))}})}))}updateStatsFromPart(t,e){const i=t.stats,r=e.stats,s=r.total;if(i.loaded+=r.loaded,s){const r=Math.round(t.duration/e.duration),n=Math.min(Math.round(i.loaded/s),r),a=(r-n)*Math.round(i.loaded/n);i.total=i.loaded+a}else i.total=Math.max(i.loaded,i.total);const n=i.loading,a=r.loading;n.start?n.first+=a.first-a.start:(n.start=a.start,n.first=a.first),n.end=a.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function Ke(t,e=null){const i=e||t,r={frag:t,part:e,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},s=i.byteRangeStartOffset,n=i.byteRangeEndOffset;if(l(s)&&l(n)){var a;let e=s,i=n;if("initSegment"===t.sn&&"AES-128"===(null==(a=t.decryptdata)?void 0:a.method)){const t=n-s;t%16&&(i=n+(16-t%16)),0!==s&&(r.resetIV=!0,e=s-16)}r.rangeStart=e,r.rangeEnd=i}return r}function He(t,e){const i=new Error(`GAP ${t.gap?"tag":"attribute"} found`),r={type:d.MEDIA_ERROR,details:c.FRAG_GAP,fatal:!1,frag:t,error:i,networkDetails:null};return e&&(r.part=e),(e||t).stats.aborted=!0,new Ve(r)}class Ve extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class je{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.abort()}}detach(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=c.KEY_LOAD_ERROR,i,r,s){return new Ve({type:d.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:s,error:i,networkDetails:r})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:r}=t;for(let t=0;t<e.length;t++){const s=e[t];if(r<=s.cc&&("initSegment"===i||"initSegment"===s.sn||i<s.sn)){this.emeController.selectKeySystemFormat(s).then((t=>{s.setKeyFormat(t)}));break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(t).then((e=>this.loadInternal(t,e))):this.loadInternal(t)}loadInternal(t,e){var i,r;e&&t.setKeyFormat(e);const s=t.decryptdata;if(!s){const i=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,c.KEY_LOAD_ERROR,i))}const n=s.uri;if(!n)return Promise.reject(this.createKeyLoadError(t,c.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${n}"`)));let a=this.keyUriToKeyInfo[n];if(null!=(i=a)&&i.decryptdata.key)return s.key=a.decryptdata.key,Promise.resolve({frag:t,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then((e=>(s.key=e.keyInfo.decryptdata.key,{frag:t,keyInfo:a})))}switch(a=this.keyUriToKeyInfo[n]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===s.keyFormat?this.loadKeyHTTP(a,t):this.loadKeyEME(a,t);case"AES-128":return this.loadKeyHTTP(a,t);default:return Promise.reject(this.createKeyLoadError(t,c.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(t,e){const i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){const e=this.emeController.loadKey(i);if(e)return(t.keyLoadPromise=e.then((e=>(t.mediaKeySessionContext=e,i)))).catch((e=>{throw t.keyLoadPromise=null,e}))}return Promise.resolve(i)}loadKeyHTTP(t,e){const i=this.config,r=new(0,i.loader)(i);return e.keyLoader=t.loader=r,t.keyLoadPromise=new Promise(((s,a)=>{const o={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},l=i.keyLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(t,e,i,r)=>{const{frag:n,keyInfo:o,url:l}=i;if(!n.decryptdata||o!==this.keyUriToKeyInfo[l])return a(this.createKeyLoadError(n,c.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=n.decryptdata.key=new Uint8Array(t.data),n.keyLoader=null,o.loader=null,s({frag:n,keyInfo:o})},onError:(t,i,r,s)=>{this.resetLoader(i),a(this.createKeyLoadError(e,c.KEY_LOAD_ERROR,new Error(`HTTP Error ${t.code} loading key ${t.text}`),r,n({url:o.url,data:void 0},t)))},onTimeout:(t,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(e,c.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(t,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(e,c.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(o,h,d)}))}resetLoader(t){const{frag:e,keyInfo:i,url:r}=t,s=i.loader;e.keyLoader===s&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}}class qe{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}const We={length:0,start:()=>0,end:()=>0};class Ye{static isBuffered(t,e){try{if(t){const i=Ye.getBuffered(t);for(let t=0;t<i.length;t++)if(e>=i.start(t)&&e<=i.end(t))return!0}}catch(t){}return!1}static bufferInfo(t,e,i){try{if(t){const r=Ye.getBuffered(t),s=[];let n;for(n=0;n<r.length;n++)s.push({start:r.start(n),end:r.end(n)});return this.bufferedInfo(s,e,i)}}catch(t){}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,i){e=Math.max(0,e),t.sort((function(t,e){return t.start-e.start||e.end-t.end}));let r=[];if(i)for(let e=0;e<t.length;e++){const s=r.length;if(s){const n=r[s-1].end;t[e].start-n<i?t[e].end>n&&(r[s-1].end=t[e].end):r.push(t[e])}else r.push(t[e])}else r=t;let s,n=0,a=e,o=e;for(let t=0;t<r.length;t++){const l=r[t].start,h=r[t].end;if(e+i>=l&&e<h)a=l,o=h,n=o-e;else if(e+i<l){s=l;break}}return{len:n,start:a||0,end:o||0,nextStart:s}}static getBuffered(t){try{return t.buffered}catch(t){return p.log("failed to get media.buffered",t),We}}}class ze{constructor(t,e,i,r=0,s=-1,n=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=t,this.sn=e,this.id=i,this.size=r,this.part=s,this.partial=n}}function Xe(t,e){let i=null;for(let r=0,s=t.length;r<s;r++){const s=t[r];if(s&&s.cc===e){i=s;break}}return i}function Qe(t,e){if(t){const i=t.start+e;t.start=t.startPTS=i,t.endPTS=i+t.duration}}function Je(t,e){const i=e.fragments;for(let e=0,r=i.length;e<r;e++)Qe(i[e],t);e.fragmentHint&&Qe(e.fragmentHint,t),e.alignedSliding=!0}function Ze(t,e){if(!t.hasProgramDateTime||!e.hasProgramDateTime)return;const i=t.fragments,r=e.fragments;if(!i.length||!r.length)return;const s=r[Math.round(r.length/2)-1],n=Xe(i,s.cc)||i[Math.round(i.length/2)-1],a=s.programDateTime,o=n.programDateTime;null!==a&&null!==o&&Je((o-a)/1e3-(n.start-s.start),t)}class ti{constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class ei{constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class ii{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),i=new Uint32Array(4);for(let t=0;t<4;t++)i[t]=e.getUint32(4*t);return i}initTable(){const t=this.sBox,e=this.invSBox,i=this.subMix,r=i[0],s=i[1],n=i[2],a=i[3],o=this.invSubMix,l=o[0],h=o[1],d=o[2],c=o[3],u=new Uint32Array(256);let f=0,g=0,p=0;for(p=0;p<256;p++)u[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,t[f]=i,e[i]=f;const o=u[f],p=u[o],m=u[p];let y=257*u[i]^16843008*i;r[f]=y<<24|y>>>8,s[f]=y<<16|y>>>16,n[f]=y<<8|y>>>24,a[f]=y,y=16843009*m^65537*p^257*o^16843008*f,l[i]=y<<24|y>>>8,h[i]=y<<16|y>>>16,d[i]=y<<8|y>>>24,c[i]=y,f?(f=o^u[u[u[m^o]]],g^=u[u[g]]):f=g=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let i=!0,r=0;for(;r<e.length&&i;)i=e[r]===this.key[r],r++;if(i)return;this.key=e;const s=this.keySize=e.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const n=this.ksRows=4*(s+6+1);let a,o;const l=this.keySchedule=new Uint32Array(n),h=this.invKeySchedule=new Uint32Array(n),d=this.sBox,c=this.rcon,u=this.invSubMix,f=u[0],g=u[1],p=u[2],m=u[3];let y,v;for(a=0;a<n;a++)a<s?y=l[a]=e[a]:(v=y,a%s==0?(v=v<<8|v>>>24,v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v],v^=c[a/s|0]<<24):s>6&&a%s==4&&(v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v]),l[a]=y=(l[a-s]^v)>>>0);for(o=0;o<n;o++)a=n-o,v=3&o?l[a]:l[a-4],h[o]=o<4||a<=4?v:f[d[v>>>24]]^g[d[v>>>16&255]]^p[d[v>>>8&255]]^m[d[255&v]],h[o]=h[o]>>>0}networkToHostOrderSwap(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24}decrypt(t,e,i){const r=this.keySize+6,s=this.invKeySchedule,n=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],h=a[2],d=a[3],c=this.uint8ArrayToUint32Array_(i);let u=c[0],f=c[1],g=c[2],p=c[3];const m=new Int32Array(t),y=new Int32Array(m.length);let v,E,T,b,S,w,R,_,A,L,C,I,k,D;const P=this.networkToHostOrderSwap;for(;e<m.length;){for(A=P(m[e]),L=P(m[e+1]),C=P(m[e+2]),I=P(m[e+3]),S=A^s[0],w=I^s[1],R=C^s[2],_=L^s[3],k=4,D=1;D<r;D++)v=o[S>>>24]^l[w>>16&255]^h[R>>8&255]^d[255&_]^s[k],E=o[w>>>24]^l[R>>16&255]^h[_>>8&255]^d[255&S]^s[k+1],T=o[R>>>24]^l[_>>16&255]^h[S>>8&255]^d[255&w]^s[k+2],b=o[_>>>24]^l[S>>16&255]^h[w>>8&255]^d[255&R]^s[k+3],S=v,w=E,R=T,_=b,k+=4;v=n[S>>>24]<<24^n[w>>16&255]<<16^n[R>>8&255]<<8^n[255&_]^s[k],E=n[w>>>24]<<24^n[R>>16&255]<<16^n[_>>8&255]<<8^n[255&S]^s[k+1],T=n[R>>>24]<<24^n[_>>16&255]<<16^n[S>>8&255]<<8^n[255&w]^s[k+2],b=n[_>>>24]<<24^n[S>>16&255]<<16^n[w>>8&255]<<8^n[255&R]^s[k+3],y[e]=P(v^u),y[e+1]=P(b^f),y[e+2]=P(T^g),y[e+3]=P(E^p),u=A,f=L,g=C,p=I,e+=4}return y.buffer}}class ri{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const t=self.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch(t){}null===this.subtle&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const i=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?function(t){const e=t.byteLength,i=e&&new DataView(t.buffer).getUint8(e-1);return i?B(t,0,e-i):t}(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i){return this.useSoftware?new Promise(((r,s)=>{this.softwareDecrypt(new Uint8Array(t),e,i);const n=this.flush();n?r(n.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(t),e,i)}softwareDecrypt(t,e,i){const{currentIV:r,currentResult:s,remainderData:n}=this;this.logOnce("JS AES decrypt"),n&&(t=mt(n,t),this.remainderData=null);const a=this.getValidChunk(t);if(!a.length)return null;r&&(i=r);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new ii),o.expandKey(e);const l=s;return this.currentResult=o.decrypt(a.buffer,0,i),this.currentIV=B(a,-16).buffer,l||null}webCryptoDecrypt(t,e,i){const r=this.subtle;return this.key===e&&this.fastAesKey||(this.key=e,this.fastAesKey=new ei(r,e)),this.fastAesKey.expandKey().then((e=>r?(this.logOnce("WebCrypto AES decrypt"),new ti(r,new Uint8Array(i)).decrypt(t.buffer,e)):Promise.reject(new Error("web crypto not initialized")))).catch((r=>(p.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(t,e,i))))}onWebCryptoError(t,e,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t;const i=t.length-t.length%16;return i!==t.length&&(e=B(t,0,i),this.remainderData=B(t,i)),e}logOnce(t){this.logEnabled&&(p.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const si="STOPPED",ni="IDLE",ai="KEY_LOADING",oi="FRAG_LOADING",li="FRAG_LOADING_WAITING_RETRY",hi="WAITING_TRACK",di="PARSING",ci="PARSED",ui="ENDED",fi="ERROR",gi="WAITING_INIT_PTS",pi="WAITING_LEVEL";class mi extends qe{constructor(t,e,i,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=si,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=p.log.bind(p,`${r}:`),this.warn=p.warn.bind(p,`${r}:`),this.hls=t,this.fragmentLoader=new Ge(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new ri(t.config),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort();const t=this.fragCurrent;null!=t&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=si}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;const i=e.partList;if(null!=i&&i.length){const t=i[i.length-1];return Ye.isBuffered(this.media,t.start+t.duration/2)}const r=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){var t;if(this.levels&&null!==this.levelLastLoaded)return null==(t=this.levels[this.levelLastLoaded])?void 0:t.details}onMediaAttached(t,e){const i=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===si&&this.startLoad(r.startPosition)}onMediaDetaching(){const t=this.media;null!=t&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:t,fragCurrent:e,media:i,mediaBuffer:r,state:s}=this,n=i?i.currentTime:0,a=Ye.bufferInfo(r||i,n,t.maxBufferHole);if(this.log(`media seeking to ${l(n)?n.toFixed(3):n}, state: ${s}`),this.state===ui)this.resetLoadingState();else if(e){const i=t.maxFragLookUpTolerance,r=e.start-i,s=e.start+e.duration+i;if(!a.len||s<a.start||r>a.end){const t=n>s;(n<r||t)&&(t&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests()),this.resetLoadingState())}}i&&(this.fragmentTracker.removeFragmentsInRange(n,1/0,this.playlistType,!0),this.lastCurrentTime=n),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=n),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.stopLoad(),super.onHandlerDestroying()}onHandlerDestroyed(){this.state=si,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){this._doFragLoad(t,e,i,(e=>{if(this.fragContextChanged(t))return this.warn(`Fragment ${t.sn}${e.part?" p: "+e.part.index:""} of level ${t.level} was dropped during download.`),void this.fragmentTracker.removeFragment(t);t.stats.chunkCount++,this._handleFragmentLoadProgress(e)})).then((e=>{if(!e)return;const i=this.state;this.fragContextChanged(t)?(i===oi||!this.fragCurrent&&i===di)&&(this.fragmentTracker.removeFragment(t),this.state=ni):("payload"in e&&(this.log(`Loaded fragment ${t.sn} of level ${t.level}`),this.hls.trigger(h.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e))})).catch((e=>{this.state!==si&&this.state!==fi&&(this.warn(e),this.resetFragmentLoading(t))}))}clearTrackerIfNeeded(t){var e;if(this.fragmentTracker.getState(t)===Oe){const e=t.type,i=this.getFwdBufferInfo(this.mediaBuffer,e),r=Math.max(t.duration,i?i.len:this.config.maxBufferLength);this.reduceMaxBufferLength(r)&&this.fragmentTracker.removeFragment(t)}else 0===(null==(e=this.mediaBuffer)?void 0:e.buffered.length)&&this.fragmentTracker.removeAllFragments()}flushMainBuffer(t,e,i=null){if(!(t-e))return;const r={startOffset:t,endOffset:e,type:i};this.hls.trigger(h.BUFFER_FLUSHING,r)}_loadInitSegment(t,e){this._doFragLoad(t,e).then((e=>{if(!e||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return e})).then((e=>{const{hls:i}=this,{payload:r}=e,s=t.decryptdata;if(r&&r.byteLength>0&&s&&s.key&&s.iv&&"AES-128"===s.method){const n=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),s.key.buffer,s.iv.buffer).catch((e=>{throw i.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((r=>{const s=self.performance.now();return i.trigger(h.FRAG_DECRYPTED,{frag:t,payload:r,stats:{tstart:n,tdecrypt:s}}),e.payload=r,e}))}return e})).then((i=>{const{fragCurrent:r,hls:s,levels:n}=this;if(!n)throw new Error("init load aborted, missing levels");const a=t.stats;this.state=ni,e.fragmentError=0,t.data=new Uint8Array(i.payload),a.parsing.start=a.buffering.start=self.performance.now(),a.parsing.end=a.buffering.end=self.performance.now(),i.frag===r&&s.trigger(h.FRAG_BUFFERED,{stats:a,frag:r,part:null,id:t.type}),this.tick()})).catch((e=>{this.state!==si&&this.state!==fi&&(this.warn(e),this.resetFragmentLoading(t))}))}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.level!==e.level||t.sn!==e.sn||t.urlId!==e.urlId}fragBufferedComplete(t,e){var i,r,s,n;const a=this.mediaBuffer?this.mediaBuffer:this.media;this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${"[stream-controller]"===this.logPrefix?"level":"track"} ${t.level} (frag:[${(null!=(i=t.startPTS)?i:NaN).toFixed(3)}-${(null!=(r=t.endPTS)?r:NaN).toFixed(3)}] > buffer:${a?function(t){let e="";const i=t.length;for(let r=0;r<i;r++)e+=`[${t.start(r).toFixed(3)}-${t.end(r).toFixed(3)}]`;return e}(Ye.getBuffered(a)):"(detached)"})`),this.state=ni,a&&(!this.loadedmetadata&&t.type==jt.MAIN&&a.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(n=this.fragPrevious)?void 0:n.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:i,part:r,partsLoaded:s}=t,n=!s||0===s.length||s.some((t=>!t)),a=new ze(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!n);e.flush(a)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,i=null,r){var s;const n=null==e?void 0:e.details;if(!this.levels||!n)throw new Error(`frag load aborted, missing level${n?"":" detail"}s`);let a=null;if(!t.encrypted||null!=(s=t.decryptdata)&&s.key?!t.encrypted&&n.encryptedFragments.length&&this.keyLoader.loadClear(t,n.encryptedFragments):(this.log(`Loading key for ${t.sn} of [${n.startSN}-${n.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${t.level}`),this.state=ai,this.fragCurrent=t,a=this.keyLoader.load(t).then((t=>{if(!this.fragContextChanged(t.frag))return this.hls.trigger(h.KEY_LOADED,t),this.state===ai&&(this.state=ni),t})),this.hls.trigger(h.KEY_LOADING,{frag:t}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),i=Math.max(t.start,i||0),this.config.lowLatencyMode){const s=n.partList;if(s&&r){i>t.end&&n.fragmentHint&&(t=n.fragmentHint);const o=this.getNextPart(s,t,i);if(o>-1){const l=s[o];let d;return this.log(`Loading part sn: ${t.sn} p: ${l.index} cc: ${t.cc} of playlist [${n.startSN}-${n.endSN}] parts [0-${o}-${s.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=oi,d=a?a.then((i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(t,l,e,r))).catch((t=>this.handleFragLoadError(t))):this.doFragPartsLoad(t,l,e,r).catch((t=>this.handleFragLoadError(t))),this.hls.trigger(h.FRAG_LOADING,{frag:t,part:l,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):d}if(!t.url||this.loadedEndOfParts(s,i))return Promise.resolve(null)}}this.log(`Loading fragment ${t.sn} cc: ${t.cc} ${n?"of ["+n.startSN+"-"+n.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),l(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=oi;const o=this.config.progressive;let d;return d=o&&a?a.then((e=>!e||this.fragContextChanged(null==e?void 0:e.frag)?null:this.fragmentLoader.load(t,r))).catch((t=>this.handleFragLoadError(t))):Promise.all([this.fragmentLoader.load(t,o?r:void 0),a]).then((([t])=>(!o&&t&&r&&r(t),t))).catch((t=>this.handleFragLoadError(t))),this.hls.trigger(h.FRAG_LOADING,{frag:t,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):d}doFragPartsLoad(t,e,i,r){return new Promise(((s,n)=>{var a;const o=[],l=null==(a=i.details)?void 0:a.partList,d=e=>{this.fragmentLoader.loadPart(t,e,r).then((r=>{o[e.index]=r;const n=r.part;this.hls.trigger(h.FRAG_LOADED,r);const a=me(i,t.sn,e.index+1)||ye(l,t.sn,e.index+1);if(!a)return s({frag:t,part:n,partsLoaded:o});d(a)})).catch(n)};d(e)}))}handleFragLoadError(t){if("data"in t){const e=t.data;t.data&&e.details===c.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(h.ERROR,e)}else this.hls.trigger(h.ERROR,{type:d.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==di)return void(this.fragCurrent||this.state===si||this.state===fi||(this.state=ni));const{frag:i,part:r,level:s}=e,n=self.performance.now();i.stats.parsing.end=n,r&&(r.stats.parsing.end=n),this.updateLevelTiming(i,r,s,t.partial)}getCurrentContext(t){const{levels:e,fragCurrent:i}=this,{level:r,sn:s,part:n}=t;if(null==e||!e[r])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${r}. The current chunk will not be buffered.`),null;const a=e[r],o=n>-1?me(a,s,n):null,l=o?o.fragment:function(t,e,i){if(null==t||!t.details)return null;const r=t.details;let s=r.fragments[e-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===e?s:e<r.startSN&&i&&i.sn===e?i:null)}(a,s,i);return l?(i&&i!==l&&(l.stats=i.stats),{frag:l,part:o,level:a}):null}bufferFragmentData(t,e,i,r){var s;if(!t||this.state!==di)return;const{data1:n,data2:a}=t;let o=n;if(n&&a&&(o=mt(n,a)),null==(s=o)||!s.length)return;const l={type:t.type,frag:e,part:i,chunkMeta:r,parent:e.type,data:o};this.hls.trigger(h.BUFFER_APPENDING,l),t.dropped&&t.independent&&!i&&this.flushBufferGap(e)}flushBufferGap(t){const e=this.media;if(!e)return;if(!Ye.isBuffered(e,e.currentTime))return void this.flushMainBuffer(0,t.start);const i=e.currentTime,r=Ye.bufferInfo(e,i,0),s=t.duration,n=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),a=Math.max(Math.min(t.start-n,r.end-n),i+n);t.start-a>n&&this.flushMainBuffer(a,t.start)}getFwdBufferInfo(t,e){const i=this.getLoadPosition();return l(i)?this.getFwdBufferInfoAtPos(t,i,e):null}getFwdBufferInfoAtPos(t,e,i){const{config:{maxBufferHole:r}}=this,s=Ye.bufferInfo(t,e,r);if(0===s.len&&void 0!==s.nextStart){const n=this.fragmentTracker.getBufferedFrag(e,i);if(n&&s.nextStart<n.end)return Ye.bufferInfo(t,e,Math.max(s.nextStart,r))}return s}getMaxBufferLength(t){const{config:e}=this;let i;return i=t?Math.max(8*e.maxBufferSize/t,e.maxBufferLength):e.maxBufferLength,Math.min(i,e.maxMaxBufferLength)}reduceMaxBufferLength(t){const e=this.config,i=t||e.maxBufferLength;return e.maxMaxBufferLength>=i&&(e.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${e.maxMaxBufferLength}s`),!0)}getNextFragment(t,e){const i=e.fragments,r=i.length;if(!r)return null;const{config:s}=this,n=i[0].start;let a;if(e.live){const n=s.initialLiveManifestSize;if(r<n)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${n})`),null;e.PTSKnown||this.startFragRequested||-1!==this.startPosition||(a=this.getInitialLiveFragment(e,i),this.startPosition=a?this.hls.liveSyncPosition||a.start:t)}else t<=n&&(a=i[0]);if(!a){const i=s.lowLatencyMode?e.partEnd:e.fragmentEnd;a=this.getFragmentAtPosition(t,i,e)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(t,e){const i=this.fragmentTracker.getState(t);return(i===Fe||i===Me&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,r,s){const n=t.gap,a=this.getNextFragment(this.nextLoadPosition,e);if(null===a)return a;if(t=a,n&&t&&!t.gap&&i.nextStart){const e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r);if(null!==e&&i.len+e.len>=s)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${t.sn}`),null}return t}mapToInitFragWhenRequired(t){return null==t||!t.initSegment||null!=t&&t.initSegment.data||this.bitrateTest?t:t.initSegment}getNextPart(t,e,i){let r=-1,s=!1,n=!0;for(let a=0,o=t.length;a<o;a++){const o=t[a];if(n=n&&!o.independent,r>-1&&i<o.start)break;const l=o.loaded;l?r=-1:(s||o.independent||n)&&o.fragment===e&&(r=a),s=l}return r}loadedEndOfParts(t,e){const i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t,e){const i=this.fragPrevious;let r=null;if(i){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),r=function(t,e,i){if(null===e||!Array.isArray(t)||!t.length||!l(e))return null;if(e<(t[0].programDateTime||0))return null;if(e>=(t[t.length-1].endProgramDateTime||0))return null;i=i||0;for(let r=0;r<t.length;++r){const s=t[r];if(Ae(e,i,s))return s}return null}(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const s=i.sn+1;if(s>=t.startSN&&s<=t.endSN){const n=e[s-t.startSN];i.cc===n.cc&&(r=n,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=function(t,e){return we.search(t,(t=>t.cc<e?1:t.cc>e?-1:0))}(e,i.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const e=this.hls.liveSyncPosition;null!==e&&(r=this.getFragmentAtPosition(e,this.bitrateTest?t.fragmentEnd:t.edge,t))}return r}getFragmentAtPosition(t,e,i){const{config:r}=this;let{fragPrevious:s}=this,{fragments:n,endSN:a}=i;const{fragmentHint:o}=i,l=r.maxFragLookUpTolerance,h=!!(r.lowLatencyMode&&i.partList&&o);let d;if(h&&o&&!this.bitrateTest&&(n=n.concat(o),a=o.sn),d=t<e?Re(s,n,t,t>e-l?0:l):n[n.length-1],d){const t=d.sn-i.startSN,e=this.fragmentTracker.getState(d);if((e===Fe||e===Me&&d.gap)&&(s=d),s&&d.sn===s.sn&&!h&&s&&d.level===s.level){const e=n[t+1];d=d.sn<a&&this.fragmentTracker.getState(e)!==Fe?e:null}}return d}synchronizeToLiveEdge(t){const{config:e,media:i}=this;if(!i)return;const r=this.hls.liveSyncPosition,s=i.currentTime,n=t.fragments[0].start,a=t.edge,o=s>=n-e.maxFragLookUpTolerance&&s<=a;if(null!==r&&i.duration>r&&(s<r||!o)){const n=void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!o&&i.readyState<4||s<a-n)&&(this.loadedmetadata||(this.nextLoadPosition=r),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),i.currentTime=r))}}alignPlaylists(t,e){const{levels:i,levelLastLoaded:r,fragPrevious:s}=this,n=null!==r?i[r]:null,a=t.fragments.length;if(!a)return this.warn("No fragments in live playlist"),0;const o=t.fragments[0].start,h=!e,d=t.alignedSliding&&l(o);if(h||!d&&!o){!function(t,e,i){e&&(function(t,e,i){if(function(t,e,i){return!(!e.details||!(i.endCC>i.startCC||t&&t.cc<i.startCC))}(t,i,e)){const t=function(t,e,i=0){const r=t.fragments,s=e.fragments;if(!s.length||!r.length)return void p.log("No fragments to align");const n=Xe(r,s[0].cc);if(n&&(!n||n.startPTS))return n;p.log("No frag in previous level to align on")}(i.details,e);t&&l(t.start)&&(p.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),Je(t.start,e))}}(t,i,e),!i.alignedSliding&&e.details&&function(t,e){if(!e.fragments.length||!t.hasProgramDateTime||!e.hasProgramDateTime)return;const i=e.fragments[0].programDateTime,r=t.fragments[0].programDateTime,s=(r-i)/1e3+e.fragments[0].start;s&&l(s)&&(p.log(`Adjusting PTS using programDateTime delta ${r-i}ms, sliding:${s.toFixed(3)} ${t.url} `),Je(s,t))}(i,e.details),i.alignedSliding||!e.details||i.skippedSegments||ge(e.details,i))}(s,n,t);const i=t.fragments[0].start;return this.log(`Live playlist sliding: ${i.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} prev-sn: ${s?s.sn:"na"} fragments: ${a}`),i}return o}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,3*t.partTarget)}setStartPosition(t,e){let i=this.startPosition;if(i<e&&(i=-1),-1===i||-1===this.lastCurrentTime){const r=null!==this.startTimeOffset,s=r?this.startTimeOffset:t.startTimeOffset;null!==s&&l(s)?(i=e+s,s<0&&(i+=t.totalduration),i=Math.min(Math.max(e,i),e+t.totalduration),this.log(`Start time offset ${s} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):t.live?i=this.hls.liveSyncPosition||e:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:t}=this;let e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&"initSegment"!==t.sn&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part"+e.index:""} of level ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){this.fragCurrent&&(this.fragContextChanged(t)||this.state===li)||(this.state=ni)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){const t=this.getCurrentContext(e.chunkMeta);t&&(e.frag=t.frag)}const i=e.frag;if(!i||i.type!==t||!this.levels)return;var r;if(this.fragContextChanged(i))return void this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const s=e.details===c.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const n=e.errorAction,{action:a,retryCount:o=0,retryConfig:l}=n||{};if(n&&5===a&&l){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);const r=Te(l,o);this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${r}ms`),n.resolved=!0,this.retryDate=self.performance.now()+r,this.state=li}else l&&n?(this.resetFragmentErrors(t),o<l.maxNumRetry?s||(n.resolved=!0):p.warn(`${e.details} reached or exceeded max retry (${o})`)):this.state=fi;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===di||this.state===ci){const e=t.parent,i=this.getFwdBufferInfo(this.mediaBuffer,e),r=i&&i.len>.5;r&&this.reduceMaxBufferLength(i.len);const s=!r;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${e} buffer`),t.frag&&(this.fragmentTracker.removeFragment(t.frag),this.nextLoadPosition=t.frag.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(t){t===jt.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==si&&(this.state=ni)}afterBufferFlushed(t,e,i){if(!t)return;const r=Ye.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,r,i),this.state===ui&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=ni}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;const e=this.levels?this.levels[t].details:null;null!=e&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of level ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(t.level),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,r){var s;const n=i.details;if(n){if(Object.keys(t.elementaryStreams).reduce(((e,s)=>{const a=t.elementaryStreams[s];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${t.sn} ${s} duration reliably (${o})`),e||!1;const l=r?0:fe(n,t,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(h.LEVEL_PTS_UPDATED,{details:n,level:i,drift:l,type:s,frag:t,start:a.startPTS,end:a.endPTS}),!0}return e}),!1))i.fragmentError=0;else if(null===(null==(s=this.transmuxer)?void 0:s.error)){const e=new Error(`Found no media in fragment ${t.sn} of level ${i.id} resetting transmuxer to fallback to playlist timing`);if(this.warn(e.message),this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,error:e,frag:t,reason:`Found no media in msn ${t.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=ci,this.hls.trigger(h.FRAG_PARSED,{frag:t,part:e})}else this.warn("level.details undefined")}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){"demuxerWorker"===t.event&&(this.resetTransmuxer(),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}function yi(){if("undefined"!=typeof self)return self.MediaSource||self.WebKitMediaSource}function vi(){return self.SourceBuffer||self.WebKitSourceBuffer}function Ei(t="",e=9e4){return{type:t,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class Ti{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){this.cachedData&&(t=mt(this.cachedData,t),this.cachedData=null);let i,r=K(t,0),s=r?r.length:0;const n=this._audioTrack,a=this._id3Track,o=r?(t=>{const e=W(t);for(let t=0;t<e.length;t++){const i=e[t];if(j(i))return J(i)}})(r):void 0,h=t.length;for((null===this.basePTS||0===this.frameIndex&&l(o))&&(this.basePTS=bi(o,e,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Zt,duration:Number.POSITIVE_INFINITY});s<h;){if(this.canParse(t,s)){const e=this.appendFrame(n,t,s);e?(this.frameIndex++,this.lastPTS=e.sample.pts,s+=e.length,i=s):s=h}else V(t,s)?(r=K(t,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:Zt,duration:Number.POSITIVE_INFINITY}),s+=r.length,i=s):s++;if(s===h&&i!==h){const e=B(t,i);this.cachedData?this.cachedData=mt(this.cachedData,e):this.cachedData=e}}return{audioTrack:n,videoTrack:Ei(),id3Track:a,textTrack:Ei()}}demuxSampleAes(t,e,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:Ei(),id3Track:this._id3Track,textTrack:Ei()}}destroy(){}}const bi=(t,e,i)=>l(t)?90*t:9e4*e+(i?9e4*i.baseTime/i.timescale:0);function Si(t,e){return 255===t[e]&&240==(246&t[e+1])}function wi(t,e){return 1&t[e+1]?7:9}function Ri(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function _i(t,e){return e+1<t.length&&Si(t,e)}function Ai(t,e){if(_i(t,e)){const i=wi(t,e);if(e+i>=t.length)return!1;const r=Ri(t,e);if(r<=i)return!1;const s=e+r;return s===t.length||_i(t,s)}return!1}function Li(t,e,i,r,s){if(!t.samplerate){const n=function(t,e,i,r){let s,n,a,o;const l=navigator.userAgent.toLowerCase(),u=r,f=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&e[i+2])>>>6);const g=(60&e[i+2])>>>2;if(!(g>f.length-1))return a=(1&e[i+2])<<2,a|=(192&e[i+3])>>>6,p.log(`manifest codec:${r}, ADTS type:${s}, samplingIndex:${g}`),/firefox/i.test(l)?g>=6?(s=5,o=new Array(4),n=g-3):(s=2,o=new Array(2),n=g):-1!==l.indexOf("android")?(s=2,o=new Array(2),n=g):(s=5,o=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&g>=6?n=g-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(g>=6&&1===a||/vivaldi/i.test(l))||!r&&1===a)&&(s=2,o=new Array(2)),n=g)),o[0]=s<<3,o[0]|=(14&g)>>1,o[1]|=(1&g)<<7,o[1]|=a<<3,5===s&&(o[1]|=(14&n)>>1,o[2]=(1&n)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:f[g],channelCount:a,codec:"mp4a.40."+s,manifestCodec:u};t.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${g}`})}(e,i,r,s);if(!n)return;t.config=n.config,t.samplerate=n.samplerate,t.channelCount=n.channelCount,t.codec=n.codec,t.manifestCodec=n.manifestCodec,p.log(`parsed codec:${t.codec}, rate:${n.samplerate}, channels:${n.channelCount}`)}}function Ci(t){return 9216e4/t}function Ii(t,e,i,r,s){const n=r+s*Ci(t.samplerate),a=function(t,e){const i=wi(t,e);if(e+i<=t.length){const r=Ri(t,e)-i;if(r>0)return{headerLength:i,frameLength:r}}}(e,i);let o;if(a){const{frameLength:r,headerLength:s}=a,l=s+r,h=Math.max(0,i+l-e.length);h?(o=new Uint8Array(l-s),o.set(e.subarray(i+s,e.length),0)):o=e.subarray(i+s,i+l);const d={unit:o,pts:n};return h||t.samples.push(d),{sample:d,length:l,missing:h}}const l=e.length-i;return o=new Uint8Array(l),o.set(e.subarray(i,e.length),0),{sample:{unit:o,pts:n},length:l,missing:-1}}const ki=/\/emsg[-/]ID3/i;let Di=null;const Pi=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],xi=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Oi=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Mi=[0,1,1,4];function Fi(t,e,i,r,s){if(i+24>e.length)return;const n=Ni(e,i);if(n&&i+n.frameLength<=e.length){const a=r+s*(9e4*n.samplesPerFrame/n.sampleRate),o={unit:e.subarray(i,i+n.frameLength),pts:a,dts:a};return t.config=[],t.channelCount=n.channelCount,t.samplerate=n.sampleRate,t.samples.push(o),{sample:o,length:n.frameLength,missing:0}}}function Ni(t,e){const i=t[e+1]>>3&3,r=t[e+1]>>1&3,s=t[e+2]>>4&15,n=t[e+2]>>2&3;if(1!==i&&0!==s&&15!==s&&3!==n){const a=t[e+2]>>1&1,o=t[e+3]>>6,l=1e3*Pi[14*(3===i?3-r:3===r?3:4)+s-1],h=xi[3*(3===i?0:2===i?1:2)+n],d=3===o?1:2,c=Oi[i][r],u=Mi[r],f=8*c*u,g=Math.floor(c*l/h+a)*u;if(null===Di){const t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Di=t?parseInt(t[1]):0}return!!Di&&Di<=87&&2===r&&l>=224e3&&0===o&&(t[e+3]=128|t[e+3]),{sampleRate:h,channelCount:d,frameLength:g,samplesPerFrame:f}}}function Ui(t,e){return 255===t[e]&&224==(224&t[e+1])&&0!=(6&t[e+1])}function Bi(t,e){return e+1<t.length&&Ui(t,e)}function $i(t,e){if(e+1<t.length&&Ui(t,e)){const i=4,r=Ni(t,e);let s=i;null!=r&&r.frameLength&&(s=r.frameLength);const n=e+s;return n===t.length||Bi(t,n)}return!1}class Gi{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,i=t.byteLength-e,r=new Uint8Array(4),s=Math.min(4,e);if(0===s)throw new Error("no bytes available");r.set(t.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(t){let e;t=Math.min(t,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(e=(t-=this.bitsAvailable)>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const i=this.word>>>32-e;if(t>32&&p.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return e=t-e,e>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if(0!=(this.word&2147483648>>>t))return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e,i=8,r=8;for(let s=0;s<t;s++)0!==r&&(e=this.readEG(),r=(i+e+256)%256),i=0===r?i:r}readSPS(){let t,e,i,r=0,s=0,n=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),h=this.readUEG.bind(this),d=this.readBoolean.bind(this),c=this.skipBits.bind(this),u=this.skipEG.bind(this),f=this.skipUEG.bind(this),g=this.skipScalingList.bind(this);o();const p=o();if(l(5),c(3),o(),f(),100===p||110===p||122===p||244===p||44===p||83===p||86===p||118===p||128===p){const t=h();if(3===t&&c(1),f(),f(),c(1),d())for(e=3!==t?8:12,i=0;i<e;i++)d()&&g(i<6?16:64)}f();const m=h();if(0===m)h();else if(1===m)for(c(1),u(),u(),t=h(),i=0;i<t;i++)u();f(),c(1);const y=h(),v=h(),E=l(1);0===E&&c(1),c(1),d()&&(r=h(),s=h(),n=h(),a=h());let T=[1,1];if(d()&&d())switch(o()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(y+1)-2*r-2*s),height:(2-E)*(v+1)*16-(E?2:4)*(n+a),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class Ki{constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new ri(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,i){const r=t[e].unit;if(r.length<=16)return;const s=r.subarray(16,r.length-r.length%16),n=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(n).then((s=>{const n=new Uint8Array(s);r.set(n,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)}))}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length)return void i();if(!(t[e].unit.length<32||(this.decryptAacSample(t,e,i),this.decrypter.isSync())))return}}getAvcEncryptedData(t){const e=16*Math.floor((t.length-48)/160)+16,i=new Int8Array(e);let r=0;for(let e=32;e<t.length-16;e+=160,r+=16)i.set(t.subarray(e,e+16),r);return i}getAvcDecryptedUnit(t,e){const i=new Uint8Array(e);let r=0;for(let e=32;e<t.length-16;e+=160,r+=16)t.set(i.subarray(r,r+16),e);return t}decryptAvcSample(t,e,i,r,s){const n=Tt(s.data),a=this.getAvcEncryptedData(n);this.decryptBuffer(a.buffer).then((a=>{s.data=this.getAvcDecryptedUnit(n,a),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,r)}))}decryptAvcSamples(t,e,i,r){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length)return void r();const s=t[e].units;for(;!(i>=s.length);i++){const n=s[i];if(!(n.data.length<=48||1!==n.type&&5!==n.type||(this.decryptAvcSample(t,e,i,r,n),this.decrypter.isSync())))return}}}}const Hi=188;class Vi{constructor(t,e,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=t,this.config=e,this.typeSupported=i}static probe(t){const e=Vi.syncOffset(t);return e>0&&p.warn(`MPEG2-TS detected but first sync word found @ offset ${e}`),-1!==e}static syncOffset(t){const e=t.length,i=Math.min(940,t.length-Hi)+1;let r=0;for(;r<i;){let s=!1;for(let n=r;n<e&&71===t[n];n+=Hi)if(s||0!==qi(t,n)||(s=!0),s&&n+Hi>i)return r;r++}return-1}static createTrack(t,e){return{container:"video"===t||"audio"===t?"video/mp2t":void 0,type:t,id:nt[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===t?e:void 0}}resetInitSegment(t,e,i,r){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=Vi.createTrack("video"),this._audioTrack=Vi.createTrack("audio",r),this._id3Track=Vi.createTrack("id3"),this._txtTrack=Vi.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_avcTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null}demux(t,e,i=!1,r=!1){let s;i||(this.sampleAes=null);const n=this._avcTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let u=n.pid,f=n.pesData,g=a.pid,m=o.pid,y=a.pesData,v=o.pesData,E=null,T=this.pmtParsed,b=this._pmtId,S=t.length;if(this.remainderData&&(S=(t=mt(this.remainderData,t)).length,this.remainderData=null),S<Hi&&!r)return this.remainderData=t,{audioTrack:a,videoTrack:n,id3Track:o,textTrack:l};const w=Math.max(0,Vi.syncOffset(t));S-=(S-w)%Hi,S<t.byteLength&&!r&&(this.remainderData=new Uint8Array(t.buffer,S,t.buffer.byteLength-S));let R=0;for(let e=w;e<S;e+=Hi)if(71===t[e]){const r=!!(64&t[e+1]),h=qi(t,e);let d;if((48&t[e+3])>>4>1){if(d=e+5+t[e+4],d===e+Hi)continue}else d=e+4;switch(h){case u:r&&(f&&(s=zi(f))&&this.parseAVCPES(n,l,s,!1),f={data:[],size:0}),f&&(f.data.push(t.subarray(d,e+Hi)),f.size+=e+Hi-d);break;case g:if(r){if(y&&(s=zi(y)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s)}y={data:[],size:0}}y&&(y.data.push(t.subarray(d,e+Hi)),y.size+=e+Hi-d);break;case m:r&&(v&&(s=zi(v))&&this.parseID3PES(o,s),v={data:[],size:0}),v&&(v.data.push(t.subarray(d,e+Hi)),v.size+=e+Hi-d);break;case 0:r&&(d+=t[d]+1),b=this._pmtId=Wi(t,d);break;case b:{r&&(d+=t[d]+1);const s=Yi(t,d,this.typeSupported,i);u=s.avc,u>0&&(n.pid=u),g=s.audio,g>0&&(a.pid=g,a.segmentCodec=s.segmentCodec),m=s.id3,m>0&&(o.pid=m),null===E||T||(p.warn(`MPEG-TS PMT found at ${e} after unknown PID '${E}'. Backtracking to sync byte @${w} to parse all TS packets.`),E=null,e=w-188),T=this.pmtParsed=!0;break}case 17:case 8191:break;default:E=h}}else R++;if(R>0){const t=new Error(`Found ${R} TS packet/s that do not start with 0x47`);this.observer.emit(h.ERROR,h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,error:t,reason:t.message})}n.pesData=f,a.pesData=y,o.pesData=v;const _={audioTrack:a,videoTrack:n,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(_),_}flush(){const{remainderData:t}=this;let e;return this.remainderData=null,e=t?this.demux(t,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:i,id3Track:r,textTrack:s}=t,n=i.pesData,a=e.pesData,o=r.pesData;let l;if(n&&(l=zi(n))?(this.parseAVCPES(i,s,l,!0),i.pesData=null):i.pesData=n,a&&(l=zi(a))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,l);break;case"mp3":this.parseMPEGPES(e,l)}e.pesData=null}else null!=a&&a.size&&p.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=a;o&&(l=zi(o))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(t,e,i){const r=this.demux(t,i,!0,!this.config.progressive),s=this.sampleAes=new Ki(this.observer,this.config,e);return this.decrypt(r,s)}decrypt(t,e){return new Promise((i=>{const{audioTrack:r,videoTrack:s}=t;r.samples&&"aac"===r.segmentCodec?e.decryptAacSamples(r.samples,0,(()=>{s.samples?e.decryptAvcSamples(s.samples,0,0,(()=>{i(t)})):i(t)})):s.samples&&e.decryptAvcSamples(s.samples,0,0,(()=>{i(t)}))}))}destroy(){this._duration=0}parseAVCPES(t,e,i,r){const s=this.parseAVCNALu(t,i.data);let n,a=this.avcSample,o=!1;i.data=null,a&&s.length&&!t.audFound&&(Xi(a,t),a=this.avcSample=ji(!1,i.pts,i.dts,"")),s.forEach((r=>{switch(r.type){case 1:{n=!0,a||(a=this.avcSample=ji(!0,i.pts,i.dts,"")),a.frame=!0;const t=r.data;if(o&&t.length>4){const e=new Gi(t).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(a.key=!0)}break}case 5:n=!0,a||(a=this.avcSample=ji(!0,i.pts,i.dts,"")),a.key=!0,a.frame=!0;break;case 6:n=!0,Et(r.data,1,i.pts,e.samples);break;case 7:if(n=!0,o=!0,!t.sps){const e=r.data,i=new Gi(e).readSPS();t.width=i.width,t.height=i.height,t.pixelRatio=i.pixelRatio,t.sps=[e],t.duration=this._duration;const s=e.subarray(1,4);let n="avc1.";for(let t=0;t<3;t++){let e=s[t].toString(16);e.length<2&&(e="0"+e),n+=e}t.codec=n}break;case 8:n=!0,t.pps||(t.pps=[r.data]);break;case 9:n=!1,t.audFound=!0,a&&Xi(a,t),a=this.avcSample=ji(!1,i.pts,i.dts,"");break;case 12:n=!0;break;default:n=!1,a&&(a.debug+="unknown NAL "+r.type+" ")}a&&n&&a.units.push(r)})),r&&a&&(Xi(a,t),this.avcSample=null)}getLastNalUnit(t){var e;let i,r=this.avcSample;if(r&&0!==r.units.length||(r=t[t.length-1]),null!=(e=r)&&e.units){const t=r.units;i=t[t.length-1]}return i}parseAVCNALu(t,e){const i=e.byteLength;let r=t.naluState||0;const s=r,n=[];let a,o,l,h=0,d=-1,c=0;for(-1===r&&(d=0,c=31&e[0],r=0,h=1);h<i;)if(a=e[h++],r)if(1!==r)if(a)if(1===a){if(d>=0){const t={data:e.subarray(d,h-r-1),type:c};n.push(t)}else{const i=this.getLastNalUnit(t.samples);if(i&&(s&&h<=4-s&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-s)),o=h-r-1,o>0)){const t=new Uint8Array(i.data.byteLength+o);t.set(i.data,0),t.set(e.subarray(0,o),i.data.byteLength),i.data=t,i.state=0}}h<i?(l=31&e[h],d=h,c=l,r=0):r=-1}else r=0;else r=3;else r=a?0:2;else r=a?0:1;if(d>=0&&r>=0){const t={data:e.subarray(d,i),type:c,state:r};n.push(t)}if(0===n.length){const i=this.getLastNalUnit(t.samples);if(i){const t=new Uint8Array(i.data.byteLength+e.byteLength);t.set(i.data,0),t.set(e,i.data.byteLength),i.data=t}}return t.naluState=r,n}parseAACPES(t,e){let i=0;const r=this.aacOverFlow;let s,n,a,o=e.data;if(r){this.aacOverFlow=null;const e=r.missing,s=r.sample.unit.byteLength;if(-1===e){const t=new Uint8Array(s+o.byteLength);t.set(r.sample.unit,0),t.set(o,s),o=t}else{const n=s-e;r.sample.unit.set(o.subarray(0,e),n),t.samples.push(r.sample),i=r.missing}}for(s=i,n=o.length;s<n-1&&!_i(o,s);s++);if(s!==i){let t;const e=s<n-1;t=e?`AAC PES did not start with ADTS header,offset:${s}`:"No ADTS header found in AAC PES";const i=new Error(t);if(p.warn(`parsing error: ${t}`),this.observer.emit(h.ERROR,h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:i,reason:t}),!e)return}if(Li(t,this.observer,o,s,this.audioCodec),void 0!==e.pts)a=e.pts;else{if(!r)return void p.warn("[tsdemuxer]: AAC PES unknown PTS");{const e=Ci(t.samplerate);a=r.sample.pts+e}}let l,u=0;for(;s<n;){if(l=Ii(t,o,s,a,u),s+=l.length,l.missing){this.aacOverFlow=l;break}for(u++;s<n-1&&!_i(o,s);s++);}}parseMPEGPES(t,e){const i=e.data,r=i.length;let s=0,n=0;const a=e.pts;if(void 0!==a)for(;n<r;)if(Bi(i,n)){const e=Fi(t,i,n,a,s);if(!e)break;n+=e.length,s++}else n++;else p.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseID3PES(t,e){if(void 0===e.pts)return void p.warn("[tsdemuxer]: ID3 PES unknown PTS");const i=o({},e,{type:this._avcTrack?te:Zt,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}}function ji(t,e,i,r){return{key:t,frame:!1,pts:e,dts:i,units:[],debug:r,length:0}}function qi(t,e){return((31&t[e+1])<<8)+t[e+2]}function Wi(t,e){return(31&t[e+10])<<8|t[e+11]}function Yi(t,e,i,r){const s={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},n=e+3+((15&t[e+1])<<8|t[e+2])-4;for(e+=12+((15&t[e+10])<<8|t[e+11]);e<n;){const n=qi(t,e);switch(t[e]){case 207:if(!r){p.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===s.audio&&(s.audio=n);break;case 21:-1===s.id3&&(s.id3=n);break;case 219:if(!r){p.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===s.avc&&(s.avc=n);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3?p.log("MPEG audio found, not supported in this browser"):-1===s.audio&&(s.audio=n,s.segmentCodec="mp3");break;case 36:p.warn("Unsupported HEVC stream type found")}e+=5+((15&t[e+3])<<8|t[e+4])}return s}function zi(t){let e,i,r,s,n,a=0;const o=t.data;if(!t||0===t.size)return null;for(;o[0].length<19&&o.length>1;){const t=new Uint8Array(o[0].length+o[1].length);t.set(o[0]),t.set(o[1],o[0].length),o[0]=t,o.splice(1,1)}if(e=o[0],1===(e[0]<<16)+(e[1]<<8)+e[2]){if(i=(e[4]<<8)+e[5],i&&i>t.size-6)return null;const l=e[7];192&l&&(s=536870912*(14&e[9])+4194304*(255&e[10])+16384*(254&e[11])+128*(255&e[12])+(254&e[13])/2,64&l?(n=536870912*(14&e[14])+4194304*(255&e[15])+16384*(254&e[16])+128*(255&e[17])+(254&e[18])/2,s-n>54e5&&(p.warn(`${Math.round((s-n)/9e4)}s delta between PTS and DTS, align them`),s=n)):n=s),r=e[8];let h=r+9;if(t.size<=h)return null;t.size-=h;const d=new Uint8Array(t.size);for(let t=0,i=o.length;t<i;t++){e=o[t];let i=e.byteLength;if(h){if(h>i){h-=i;continue}e=e.subarray(h),i-=h,h=0}d.set(e,a),a+=i}return i&&(i-=r+3),{data:d,pts:s,dts:n,len:i}}return null}function Xi(t,e){if(t.units.length&&t.frame){if(void 0===t.pts){const i=e.samples,r=i.length;if(!r)return void e.dropped++;{const e=i[r-1];t.pts=e.pts,t.dts=e.dts}}e.samples.push(t)}t.debug.length&&p.log(t.pts+"/"+t.dts+":"+t.debug)}class Qi{static getSilentFrame(t,e){if("mp4a.40.2"===t){if(1===e)return new Uint8Array([0,200,0,128,35,128]);if(2===e)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===e)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const Ji=Math.pow(2,32)-1;class Zi{static init(){let t;for(t in Zi.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},Zi.types)Zi.types.hasOwnProperty(t)&&(Zi.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);Zi.HDLR_TYPES={video:e,audio:i};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);Zi.STTS=Zi.STSC=Zi.STCO=s,Zi.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Zi.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),Zi.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),Zi.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const n=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);Zi.FTYP=Zi.box(Zi.types.ftyp,n,o,n,a),Zi.DINF=Zi.box(Zi.types.dinf,Zi.box(Zi.types.dref,r))}static box(t,...e){let i=8,r=e.length;const s=r;for(;r--;)i+=e[r].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=255&i,n.set(t,4),r=0,i=8;r<s;r++)n.set(e[r],i),i+=e[r].byteLength;return n}static hdlr(t){return Zi.box(Zi.types.hdlr,Zi.HDLR_TYPES[t])}static mdat(t){return Zi.box(Zi.types.mdat,t)}static mdhd(t,e){e*=t;const i=Math.floor(e/(Ji+1)),r=Math.floor(e%(Ji+1));return Zi.box(Zi.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(t){return Zi.box(Zi.types.mdia,Zi.mdhd(t.timescale,t.duration),Zi.hdlr(t.type),Zi.minf(t))}static mfhd(t){return Zi.box(Zi.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?Zi.box(Zi.types.minf,Zi.box(Zi.types.smhd,Zi.SMHD),Zi.DINF,Zi.stbl(t)):Zi.box(Zi.types.minf,Zi.box(Zi.types.vmhd,Zi.VMHD),Zi.DINF,Zi.stbl(t))}static moof(t,e,i){return Zi.box(Zi.types.moof,Zi.mfhd(t),Zi.traf(i,e))}static moov(t){let e=t.length;const i=[];for(;e--;)i[e]=Zi.trak(t[e]);return Zi.box.apply(null,[Zi.types.moov,Zi.mvhd(t[0].timescale,t[0].duration)].concat(i).concat(Zi.mvex(t)))}static mvex(t){let e=t.length;const i=[];for(;e--;)i[e]=Zi.trex(t[e]);return Zi.box.apply(null,[Zi.types.mvex,...i])}static mvhd(t,e){e*=t;const i=Math.floor(e/(Ji+1)),r=Math.floor(e%(Ji+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return Zi.box(Zi.types.mvhd,s)}static sdtp(t){const e=t.samples||[],i=new Uint8Array(4+e.length);let r,s;for(r=0;r<e.length;r++)s=e[r].flags,i[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return Zi.box(Zi.types.sdtp,i)}static stbl(t){return Zi.box(Zi.types.stbl,Zi.stsd(t),Zi.box(Zi.types.stts,Zi.STTS),Zi.box(Zi.types.stsc,Zi.STSC),Zi.box(Zi.types.stsz,Zi.STSZ),Zi.box(Zi.types.stco,Zi.STCO))}static avc1(t){let e,i,r,s=[],n=[];for(e=0;e<t.sps.length;e++)i=t.sps[e],r=i.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));for(e=0;e<t.pps.length;e++)i=t.pps[e],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));const a=Zi.box(Zi.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|t.sps.length].concat(s).concat([t.pps.length]).concat(n))),o=t.width,l=t.height,h=t.pixelRatio[0],d=t.pixelRatio[1];return Zi.box(Zi.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,Zi.box(Zi.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),Zi.box(Zi.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(t){const e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static mp4a(t){const e=t.samplerate;return Zi.box(Zi.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]),Zi.box(Zi.types.esds,Zi.esds(t)))}static mp3(t){const e=t.samplerate;return Zi.box(Zi.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]))}static stsd(t){return"audio"===t.type?"mp3"===t.segmentCodec&&"mp3"===t.codec?Zi.box(Zi.types.stsd,Zi.STSD,Zi.mp3(t)):Zi.box(Zi.types.stsd,Zi.STSD,Zi.mp4a(t)):Zi.box(Zi.types.stsd,Zi.STSD,Zi.avc1(t))}static tkhd(t){const e=t.id,i=t.duration*t.timescale,r=t.width,s=t.height,n=Math.floor(i/(Ji+1)),a=Math.floor(i%(Ji+1));return Zi.box(Zi.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}static traf(t,e){const i=Zi.sdtp(t),r=t.id,s=Math.floor(e/(Ji+1)),n=Math.floor(e%(Ji+1));return Zi.box(Zi.types.traf,Zi.box(Zi.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),Zi.box(Zi.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,n>>24,n>>16&255,n>>8&255,255&n])),Zi.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||4294967295,Zi.box(Zi.types.trak,Zi.tkhd(t),Zi.mdia(t))}static trex(t){const e=t.id;return Zi.box(Zi.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const i=t.samples||[],r=i.length,s=12+16*r,n=new Uint8Array(s);let a,o,l,h,d,c;for(e+=8+s,n.set(["video"===t.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),a=0;a<r;a++)o=i[a],l=o.duration,h=o.size,d=o.flags,c=o.cts,n.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,h>>>24&255,h>>>16&255,h>>>8&255,255&h,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*a);return Zi.box(Zi.types.trun,n)}static initSegment(t){Zi.types||Zi.init();const e=Zi.moov(t),i=new Uint8Array(Zi.FTYP.byteLength+e.byteLength);return i.set(Zi.FTYP),i.set(e,Zi.FTYP.byteLength),i}}Zi.types=void 0,Zi.HDLR_TYPES=void 0,Zi.STTS=void 0,Zi.STSC=void 0,Zi.STCO=void 0,Zi.STSZ=void 0,Zi.VMHD=void 0,Zi.SMHD=void 0,Zi.STSD=void 0,Zi.FTYP=void 0,Zi.DINF=void 0;const tr=9e4;function er(t,e,i=1,r=!1){const s=t*e*i;return r?Math.round(s):s}function ir(t,e=!1){return er(t,1e3,1/tr,e)}let rr,sr=null,nr=null;class ar{constructor(t,e,i,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=t,this.config=e,this.typeSupported=i,this.ISGenerated=!1,null===sr){const t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);sr=t?parseInt(t[1]):0}if(null===nr){const t=navigator.userAgent.match(/Safari\/(\d+)/i);nr=t?parseInt(t[1]):0}}destroy(){}resetTimeStamp(t){p.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){p.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){p.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1}getVideoStartPts(t){let e=!1;const i=t.reduce(((t,i)=>{const r=i.pts-t;return r<-4294967296?(e=!0,or(t,i.pts)):r>0?t:i.pts}),t[0].pts);return e&&p.debug("PTS rollover detected"),i}remux(t,e,i,r,s,n,a,o){let l,h,d,c,u,f,g=s,m=s;const y=t.pid>-1,v=e.pid>-1,E=e.samples.length,T=t.samples.length>0,b=a&&E>0||E>1;if((!y||T)&&(!v||b)||this.ISGenerated||a){this.ISGenerated||(d=this.generateIS(t,e,s,n));const i=this.isVideoContiguous;let r,a=-1;if(b&&(a=function(t){for(let e=0;e<t.length;e++)if(t[e].key)return e;return-1}(e.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){p.warn(`[mp4-remuxer]: Dropped ${a} out of ${E} video samples due to a missing keyframe`);const t=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(a),e.dropped+=a,m+=(e.samples[0].pts-t)/e.inputTimeScale,r=m}else-1===a&&(p.warn(`[mp4-remuxer]: No keyframe found out of ${E} video samples`),f=!1);if(this.ISGenerated){if(T&&b){const i=this.getVideoStartPts(e.samples),r=(or(t.samples[0].pts,i)-i)/e.inputTimeScale;g+=Math.max(0,r),m+=Math.max(0,-r)}if(T){if(t.samplerate||(p.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(t,e,s,n)),h=this.remuxAudio(t,g,this.isAudioContiguous,n,v||b||o===jt.AUDIO?m:void 0),b){const r=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(p.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(t,e,s,n)),l=this.remuxVideo(e,m,i,r)}}else b&&(l=this.remuxVideo(e,m,i,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(u=lr(i,s,this._initPTS,this._initDTS)),r.samples.length&&(c=hr(r,s,this._initPTS))),{audio:h,video:l,initSegment:d,independent:f,text:c,id3:u}}generateIS(t,e,i,r){const s=t.samples,n=e.samples,a=this.typeSupported,o={},l=this._initPTS;let h,d,c,u=!l||r,f="audio/mp4";if(u&&(h=d=1/0),t.config&&s.length&&(t.timescale=t.samplerate,"mp3"===t.segmentCodec&&(a.mpeg?(f="audio/mpeg",t.codec=""):a.mp3&&(t.codec="mp3")),o.audio={id:"audio",container:f,codec:t.codec,initSegment:"mp3"===t.segmentCodec&&a.mpeg?new Uint8Array(0):Zi.initSegment([t]),metadata:{channelCount:t.channelCount}},u&&(c=t.inputTimeScale,l&&c===l.timescale?u=!1:h=d=s[0].pts-Math.round(c*i))),e.sps&&e.pps&&n.length&&(e.timescale=e.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:Zi.initSegment([e]),metadata:{width:e.width,height:e.height}},u))if(c=e.inputTimeScale,l&&c===l.timescale)u=!1;else{const t=this.getVideoStartPts(n),e=Math.round(c*i);d=Math.min(d,or(n[0].dts,t)-e),h=Math.min(h,t-e)}if(Object.keys(o).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:h,timescale:c},this._initDTS={baseTime:d,timescale:c}):h=c=void 0,{tracks:o,initPTS:h,timescale:c}}remuxVideo(t,e,i,r){const s=t.inputTimeScale,n=t.samples,a=[],l=n.length,u=this._initPTS;let f,g,m=this.nextAvcDts,y=8,v=this.videoSampleDuration,E=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,b=!1;i&&null!==m||(m=e*s-(n[0].pts-or(n[0].dts,n[0].pts)));const S=u.baseTime*s/u.timescale;for(let t=0;t<l;t++){const e=n[t];e.pts=or(e.pts-S,m),e.dts=or(e.dts-S,m),e.dts<n[t>0?t-1:t].dts&&(b=!0)}b&&n.sort((function(t,e){const i=t.dts-e.dts,r=t.pts-e.pts;return i||r})),f=n[0].dts,g=n[n.length-1].dts;const w=g-f,R=w?Math.round(w/(l-1)):v||t.inputTimeScale/30;if(i){const t=f-m,e=t>R,i=t<-1;if((e||i)&&(e?p.warn(`AVC: ${ir(t,!0)} ms (${t}dts) hole between fragments detected, filling it`):p.warn(`AVC: ${ir(-t,!0)} ms (${t}dts) overlapping between fragments detected`),!i||m>n[0].pts)){f=m;const e=n[0].pts-t;n[0].dts=f,n[0].pts=e,p.log(`Video: First PTS/DTS adjusted: ${ir(e,!0)}/${ir(f,!0)}, delta: ${ir(t,!0)} ms`)}}f=Math.max(0,f);let _=0,A=0;for(let t=0;t<l;t++){const e=n[t],i=e.units,r=i.length;let s=0;for(let t=0;t<r;t++)s+=i[t].data.length;A+=s,_+=r,e.length=s,e.dts=Math.max(e.dts,f),E=Math.min(e.pts,E),T=Math.max(e.pts,T)}g=n[l-1].dts;const L=A+4*_+8;let C;try{C=new Uint8Array(L)}catch(t){return void this.observer.emit(h.ERROR,h.ERROR,{type:d.MUX_ERROR,details:c.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:L,reason:`fail allocating video mdat ${L}`})}const I=new DataView(C.buffer);I.setUint32(0,L),C.set(Zi.types.mdat,4);let k=!1,D=Number.POSITIVE_INFINITY,P=Number.POSITIVE_INFINITY,x=Number.NEGATIVE_INFINITY,O=Number.NEGATIVE_INFINITY;for(let t=0;t<l;t++){const e=n[t],i=e.units;let o,h=0;for(let t=0,e=i.length;t<e;t++){const e=i[t],r=e.data,s=e.data.byteLength;I.setUint32(y,s),y+=4,C.set(r,y),y+=s,h+=4+s}if(t<l-1)v=n[t+1].dts-e.dts,o=n[t+1].pts-e.pts;else{const i=this.config,a=t>0?e.dts-n[t-1].dts:R;if(o=t>0?e.pts-n[t-1].pts:R,i.stretchShortVideoTrack&&null!==this.nextAudioPts){const t=Math.floor(i.maxBufferHole*s),n=(r?E+r*s:this.nextAudioPts)-e.pts;n>t?(v=n-a,v<0?v=a:k=!0,p.log(`[mp4-remuxer]: It is approximately ${n/90} ms to the next segment; using duration ${v/90} ms for the last video frame.`)):v=a}else v=a}const d=Math.round(e.pts-e.dts);D=Math.min(D,v),x=Math.max(x,v),P=Math.min(P,o),O=Math.max(O,o),a.push(new dr(e.key,v,h,d))}if(a.length)if(sr){if(sr<70){const t=a[0].flags;t.dependsOn=2,t.isNonSync=0}}else if(nr&&O-P<x-D&&R/x<.025&&0===a[0].cts){p.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let t=f;for(let e=0,i=a.length;e<i;e++){const r=t+a[e].duration,s=t+a[e].cts;if(e<i-1){const t=r+a[e+1].cts;a[e].duration=t-s}else a[e].duration=e?a[e-1].duration:R;a[e].cts=0,t=r}}v=k||!v?R:v,this.nextAvcDts=m=g+v,this.videoSampleDuration=v,this.isVideoContiguous=!0;const M={data1:Zi.moof(t.sequenceNumber++,f,o({},t,{samples:a})),data2:C,startPTS:E/s,endPTS:(T+v)/s,startDTS:f/s,endDTS:m/s,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:t.dropped};return t.samples=[],t.dropped=0,M}remuxAudio(t,e,i,r,s){const n=t.inputTimeScale,a=n/(t.samplerate?t.samplerate:n),l="aac"===t.segmentCodec?1024:1152,u=l*a,f=this._initPTS,g="mp3"===t.segmentCodec&&this.typeSupported.mpeg,m=[],y=void 0!==s;let v=t.samples,E=g?0:8,T=this.nextAudioPts||-1;const b=e*n,S=f.baseTime*n/f.timescale;if(this.isAudioContiguous=i=i||v.length&&T>0&&(r&&Math.abs(b-T)<9e3||Math.abs(or(v[0].pts-S,b)-T)<20*u),v.forEach((function(t){t.pts=or(t.pts-S,b)})),!i||T<0){if(v=v.filter((t=>t.pts>=0)),!v.length)return;T=0===s?0:r&&!y?Math.max(0,b):v[0].pts}if("aac"===t.segmentCodec){const e=this.config.maxAudioFramesDrift;for(let i=0,r=T;i<v.length;i++){const s=v[i],a=s.pts,o=a-r,l=Math.abs(1e3*o/n);if(o<=-e*u&&y)0===i&&(p.warn(`Audio frame @ ${(a/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/n)} ms.`),this.nextAudioPts=T=r=a);else if(o>=e*u&&l<1e4&&y){let e=Math.round(o/u);r=a-e*u,r<0&&(e--,r+=u),0===i&&(this.nextAudioPts=T=r),p.warn(`[mp4-remuxer]: Injecting ${e} audio frame @ ${(r/n).toFixed(3)}s due to ${Math.round(1e3*o/n)} ms gap.`);for(let n=0;n<e;n++){const e=Math.max(r,0);let n=Qi.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);n||(p.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),n=s.unit.subarray()),v.splice(i,0,{unit:n,pts:e}),r+=u,i++}}s.pts=r,r+=u}}let w,R=null,_=null,A=0,L=v.length;for(;L--;)A+=v[L].unit.byteLength;for(let e=0,r=v.length;e<r;e++){const r=v[e],s=r.unit;let n=r.pts;if(null!==_)m[e-1].duration=Math.round((n-_)/a);else{if(i&&"aac"===t.segmentCodec&&(n=T),R=n,!(A>0))return;A+=E;try{w=new Uint8Array(A)}catch(t){return void this.observer.emit(h.ERROR,h.ERROR,{type:d.MUX_ERROR,details:c.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:A,reason:`fail allocating audio mdat ${A}`})}g||(new DataView(w.buffer).setUint32(0,A),w.set(Zi.types.mdat,4))}w.set(s,E);const o=s.byteLength;E+=o,m.push(new dr(!0,l,o,0)),_=n}const C=m.length;if(!C)return;const I=m[m.length-1];this.nextAudioPts=T=_+a*I.duration;const k=g?new Uint8Array(0):Zi.moof(t.sequenceNumber++,R/a,o({},t,{samples:m}));t.samples=[];const D=R/n,P=T/n,x={data1:k,data2:w,startPTS:D,endPTS:P,startDTS:D,endDTS:P,type:"audio",hasAudio:!0,hasVideo:!1,nb:C};return this.isAudioContiguous=!0,x}remuxEmptyAudio(t,e,i,r){const s=t.inputTimeScale,n=s/(t.samplerate?t.samplerate:s),a=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,h=(null!==a?a:r.startDTS*s)+l,d=r.endDTS*s+l,c=1024*n,u=Math.ceil((d-h)/c),f=Qi.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(p.warn("[mp4-remuxer]: remux empty Audio"),!f)return void p.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const g=[];for(let t=0;t<u;t++){const e=h+t*c;g.push({unit:f,pts:e,dts:e})}return t.samples=g,this.remuxAudio(t,e,i,!1)}}function or(t,e){let i;if(null===e)return t;for(i=e<t?-8589934592:8589934592;Math.abs(t-e)>4294967296;)t+=i;return t}function lr(t,e,i,r){const s=t.samples.length;if(!s)return;const n=t.inputTimeScale;for(let a=0;a<s;a++){const s=t.samples[a];s.pts=or(s.pts-9e4*i.baseTime/i.timescale,e*n)/n,s.dts=or(s.dts-9e4*r.baseTime/r.timescale,e*n)/n}const a=t.samples;return t.samples=[],{samples:a}}function hr(t,e,i){const r=t.samples.length;if(!r)return;const s=t.inputTimeScale;for(let n=0;n<r;n++){const r=t.samples[n];r.pts=or(r.pts-9e4*i.baseTime/i.timescale,e*s)/s}t.samples.sort(((t,e)=>t.pts-e.pts));const n=t.samples;return t.samples=[],{samples:n}}class dr{constructor(t,e,i,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=i,this.cts=r,this.flags=new cr(t)}}class cr{constructor(t){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=t?2:1,this.isNonSync=t?0:1}}function ur(t,e){const i=null==t?void 0:t.codec;return i&&i.length>4?i:"hvc1"===i||"hev1"===i?"hvc1.1.c.L120.90":"av01"===i?"av01.0.04M.08":"avc1"===i||e===S.VIDEO?"avc1.42e01e":"mp4a.40.5"}try{rr=self.performance.now.bind(self.performance)}catch(t){p.debug("Unable to use Performance API on this environment"),rr="undefined"!=typeof self&&self.Date.now}const fr=[{demux:class{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,i,r){const s=this.videoTrack=Ei("video",1),n=this.audioTrack=Ei("audio",1),a=this.txtTrack=Ei("text",1);if(this.id3Track=Ei("id3",1),this.timeOffset=0,null==t||!t.byteLength)return;const o=ft(t);if(o.video){const{id:t,timescale:e,codec:i}=o.video;s.id=t,s.timescale=a.timescale=e,s.codec=i}if(o.audio){const{id:t,timescale:e,codec:i}=o.audio;n.id=t,n.timescale=e,n.codec=i}a.id=nt.text,s.sampleDuration=0,s.duration=n.duration=r}resetContiguity(){}static probe(t){return ct(t=t.length>16384?t.subarray(0,16384):t,["moof"]).length>0}demux(t,e){this.timeOffset=e;let i=t;const r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=mt(this.remainderData,t));const e=function(t){const e={valid:null,remainder:null},i=ct(t,["moof"]);if(!i)return e;if(i.length<2)return e.remainder=t,e;const r=i[i.length-1];return e.valid=B(t,0,r.byteOffset-8),e.remainder=B(t,r.byteOffset-8),e}(i);this.remainderData=e.remainder,r.samples=e.valid||new Uint8Array}else r.samples=i;const n=this.extractID3Track(r,e);return s.samples=yt(e,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(e,this.timeOffset);return i.samples=yt(t,e),{videoTrack:e,audioTrack:Ei(),id3Track:r,textTrack:Ei()}}extractID3Track(t,e){const i=this.id3Track;if(t.samples.length){const r=ct(t.samples,["emsg"]);r&&r.forEach((t=>{const r=function(t){const e=t[0];let i="",r="",s=0,n=0,a=0,o=0,l=0,h=0;if(0===e){for(;"\0"!==at(t.subarray(h,h+1));)i+=at(t.subarray(h,h+1)),h+=1;for(i+=at(t.subarray(h,h+1)),h+=1;"\0"!==at(t.subarray(h,h+1));)r+=at(t.subarray(h,h+1)),h+=1;r+=at(t.subarray(h,h+1)),h+=1,s=lt(t,12),n=lt(t,16),o=lt(t,20),l=lt(t,24),h=28}else if(1===e){h+=4,s=lt(t,h),h+=4;const e=lt(t,h);h+=4;const n=lt(t,h);for(h+=4,a=2**32*e+n,Number.isSafeInteger(a)||(a=Number.MAX_SAFE_INTEGER,p.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=lt(t,h),h+=4,l=lt(t,h),h+=4;"\0"!==at(t.subarray(h,h+1));)i+=at(t.subarray(h,h+1)),h+=1;for(i+=at(t.subarray(h,h+1)),h+=1;"\0"!==at(t.subarray(h,h+1));)r+=at(t.subarray(h,h+1)),h+=1;r+=at(t.subarray(h,h+1)),h+=1}return{schemeIdUri:i,value:r,timeScale:s,presentationTime:a,presentationTimeDelta:n,eventDuration:o,id:l,payload:t.subarray(h,t.byteLength)}}(t);if(ki.test(r.schemeIdUri)){const t=l(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale;let s=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);const n=r.payload;i.samples.push({data:n,len:n.byteLength,dts:t,pts:t,type:te,duration:s})}}))}return i}demuxSampleAes(t,e,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,i,r){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(function(t,e){if(!t||!e)return t;const i=e.keyId;return i&&e.isCommonEncryption&&ct(t,["moov","trak"]).forEach((t=>{const e=ct(t,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=ct(e,["enca"]);const s=r.length>0;s||(r=ct(e,["encv"])),r.forEach((t=>{ct(s?t.subarray(28):t.subarray(78),["sinf"]).forEach((t=>{const e=gt(t);if(e){const t=e.subarray(8,24);t.some((t=>0!==t))||(p.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${it(t)} -> ${it(i)}`),e.set(i,8))}}))}))})),t}(t,r)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(null==t||!t.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=ft(t);e||(e=ur(r.audio,S.AUDIO)),i||(i=ur(r.video,S.VIDEO));const s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:e+","+i,initSegment:t,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:r.video?s.video={container:"video/mp4",codec:i,initSegment:t,id:"main"}:p.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(t,e,i,r,s,n){var a,o;let{initPTS:h,lastEndTime:d}=this;const c={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};l(d)||(d=this.lastEndTime=s||0);const u=e.samples;if(null==u||!u.length)return c;const f={initPTS:void 0,timescale:1};let g=this.initData;if(null!=(a=g)&&a.length||(this.generateInitSegment(u),g=this.initData),null==(o=g)||!o.length)return p.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),c;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);const m=function(t,e){return ct(e,["moof","traf"]).reduce(((e,i)=>{const r=ct(i,["tfdt"])[0],s=r[0],n=ct(i,["tfhd"]).reduce(((e,i)=>{const n=lt(i,4),a=t[n];if(a){let t=lt(r,4);if(1===s){if(t===rt)return p.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),e;t*=rt+1,t+=lt(r,8)}const i=t/(a.timescale||9e4);if(isFinite(i)&&(null===e||i<e))return i}return e}),null);return null!==n&&isFinite(n)&&(null===e||n<e)?n:e}),null)}(g,u),y=null===m?s:m;(function(t,e,i){if(null===t)return!0;const r=e-t.baseTime/t.timescale;return r<0&&Math.abs(r-i)>1}(h,y,s)||f.timescale!==h.timescale&&n)&&(f.initPTS=y-s,this.initPTS=h={baseTime:f.initPTS,timescale:1});const v=function(t,e){let i=0,r=0,s=0;const n=ct(t,["moof","traf"]);for(let t=0;t<n.length;t++){const a=n[t],o=ct(a,["tfhd"])[0],l=e[lt(o,4)];if(!l)continue;const h=l.default,d=lt(o,0)|(null==h?void 0:h.flags);let c=null==h?void 0:h.duration;8&d&&(c=lt(o,2&d?12:8));const u=l.timescale||9e4,f=ct(a,["trun"]);for(let t=0;t<f.length;t++)i=pt(f[t]),!i&&c&&(i=c*lt(f[t],4)),l.type===S.VIDEO?r+=i/u:l.type===S.AUDIO&&(s+=i/u)}if(0===r&&0===s){let e=0;const i=ct(t,["sidx"]);for(let t=0;t<i.length;t++){const r=ut(i[t]);null!=r&&r.references&&(e+=r.references.reduce(((t,e)=>t+e.info.duration||0),0))}return e}return r||s}(u,g),E=t?y-h.baseTime/h.timescale:d,T=E+v;!function(t,e,i){ct(e,["moof","traf"]).forEach((e=>{ct(e,["tfhd"]).forEach((r=>{const s=lt(r,4),n=t[s];if(!n)return;const a=n.timescale||9e4;ct(e,["tfdt"]).forEach((t=>{const e=t[0];let r=lt(t,4);if(0===e)r-=i*a,r=Math.max(r,0),dt(t,4,r);else{r*=Math.pow(2,32),r+=lt(t,8),r-=i*a,r=Math.max(r,0);const e=Math.floor(r/(rt+1)),s=Math.floor(r%(rt+1));dt(t,4,e),dt(t,8,s)}}))}))}))}(g,u,h.baseTime/h.timescale),v>0?this.lastEndTime=T:(p.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const b=!!g.audio,w=!!g.video;let R="";b&&(R+="audio"),w&&(R+="video");const _={data1:u,startPTS:E,startDTS:E,endPTS:T,endDTS:T,type:R,hasAudio:b,hasVideo:w,nb:1,dropped:0};return c.audio="audio"===_.type?_:void 0,c.video="audio"!==_.type?_:void 0,c.initSegment=f,c.id3=lr(i,s,h,h),r.samples.length&&(c.text=hr(r,s,h)),c}}},{demux:Vi,remux:ar},{demux:class extends Ti{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;let e=(K(t,0)||[]).length;for(let i=t.length;e<i;e++)if(Ai(t,e))return p.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return function(t,e){return function(t,e){return e+5<t.length}(t,e)&&Si(t,e)&&Ri(t,e)<=t.length-e}(t,e)}appendFrame(t,e,i){Li(t,this.observer,e,i,t.manifestCodec);const r=Ii(t,e,i,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:ar},{demux:class extends Ti{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;let e=(K(t,0)||[]).length;for(let i=t.length;e<i;e++)if($i(t,e))return p.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return function(t,e){return Ui(t,e)&&4<=t.length-e}(t,e)}appendFrame(t,e,i){if(null!==this.basePTS)return Fi(t,e,i,this.basePTS,this.frameIndex)}},remux:ar}];class gr{constructor(t,e,i,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.vendor=r,this.id=s}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,i,r){const s=i.transmuxing;s.executeStart=rr();let n=new Uint8Array(t);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:u,trackSwitch:f,accurateTimeOffset:g,timeOffset:m,initSegmentChange:y}=r||a,{audioCodec:v,videoCodec:E,defaultInitPts:T,duration:b,initSegmentData:S}=o,w=function(t,e){let i=null;return t.byteLength>0&&null!=e&&null!=e.key&&null!==e.iv&&null!=e.method&&(i=e),i}(n,e);if(w&&"AES-128"===w.method){const t=this.getDecrypter();if(!t.isSync())return this.decryptionPromise=t.webCryptoDecrypt(n,w.key.buffer,w.iv.buffer).then((t=>{const e=this.push(t,null,i);return this.decryptionPromise=null,e})),this.decryptionPromise;{let e=t.softwareDecrypt(n,w.key.buffer,w.iv.buffer);if(i.part>-1&&(e=t.flush()),!e)return s.executeEnd=rr(),pr(i);n=new Uint8Array(e)}}const R=this.needsProbing(u,f);if(R){const t=this.configureTransmuxer(n);if(t)return p.warn(`[transmuxer] ${t.message}`),this.observer.emit(h.ERROR,h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,error:t,reason:t.message}),s.executeEnd=rr(),pr(i)}(u||f||y||R)&&this.resetInitSegment(S,v,E,b,e),(u||y||R)&&this.resetInitialTimestamp(T),l||this.resetContiguity();const _=this.transmux(n,w,m,g,i),A=this.currentTransmuxState;return A.contiguous=!0,A.discontinuity=!1,A.trackSwitch=!1,s.executeEnd=rr(),_}flush(t){const e=t.transmuxing;e.executeStart=rr();const{decrypter:i,currentTransmuxState:r,decryptionPromise:s}=this;if(s)return s.then((()=>this.flush(t)));const n=[],{timeOffset:a}=r;if(i){const e=i.flush();e&&n.push(this.push(e,null,t))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return e.executeEnd=rr(),[pr(t)];const h=o.flush(a);return mr(h)?h.then((e=>(this.flushRemux(n,e,t),n))):(this.flushRemux(n,h,t),n)}flushRemux(t,e,i){const{audioTrack:r,videoTrack:s,id3Track:n,textTrack:a}=e,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;p.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const h=this.remuxer.remux(r,s,n,a,l,o,!0,this.id);t.push({remuxResult:h,chunkMeta:i}),i.transmuxing.executeEnd=rr()}resetInitialTimestamp(t){const{demuxer:e,remuxer:i}=this;e&&i&&(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;t&&e&&(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,r,s){const{demuxer:n,remuxer:a}=this;n&&a&&(n.resetInitSegment(t,e,i,r),a.resetInitSegment(t,e,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,r,s){let n;return n=e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(t,e,i,r,s):this.transmuxUnencrypted(t,i,r,s),n}transmuxUnencrypted(t,e,i,r){const{audioTrack:s,videoTrack:n,id3Track:a,textTrack:o}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,n,a,o,e,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(t,e,i,r,s){return this.demuxer.demuxSampleAes(t,e,i).then((t=>({remuxResult:this.remuxer.remux(t.audioTrack,t.videoTrack,t.id3Track,t.textTrack,i,r,!1,this.id),chunkMeta:s})))}configureTransmuxer(t){const{config:e,observer:i,typeSupported:r,vendor:s}=this;let n;for(let e=0,i=fr.length;e<i;e++)if(fr[e].demux.probe(t)){n=fr[e];break}if(!n)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,o=this.remuxer,l=n.remux,h=n.demux;o&&o instanceof l||(this.remuxer=new l(i,e,r,s)),a&&a instanceof h||(this.demuxer=new h(i,e,r),this.probe=h.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new ri(this.config)),t}}const pr=t=>({remuxResult:{},chunkMeta:t});function mr(t){return"then"in t&&t.then instanceof Function}class yr{constructor(t,e,i,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=r,this.defaultInitPts=s||null}}class vr{constructor(t,e,i,r,s,n){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=n}}var Er={};!function(t){var e=Object.prototype.hasOwnProperty,i="~";function r(){}function s(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function n(t,e,r,n,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,n||t,a),l=i?i+e:e;return t._events[l]?t._events[l].fn?t._events[l]=[t._events[l],o]:t._events[l].push(o):(t._events[l]=o,t._eventsCount++),t}function a(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),o.prototype.eventNames=function(){var t,r,s=[];if(0===this._eventsCount)return s;for(r in t=this._events)e.call(t,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(t)):s},o.prototype.listeners=function(t){var e=i?i+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,n=r.length,a=new Array(n);s<n;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(t){var e=i?i+t:t,r=this._events[e];return r?r.fn?1:r.length:0},o.prototype.emit=function(t,e,r,s,n,a){var o=i?i+t:t;if(!this._events[o])return!1;var l,h,d=this._events[o],c=arguments.length;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),c){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,r),!0;case 4:return d.fn.call(d.context,e,r,s),!0;case 5:return d.fn.call(d.context,e,r,s,n),!0;case 6:return d.fn.call(d.context,e,r,s,n,a),!0}for(h=1,l=new Array(c-1);h<c;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var u,f=d.length;for(h=0;h<f;h++)switch(d[h].once&&this.removeListener(t,d[h].fn,void 0,!0),c){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,e);break;case 3:d[h].fn.call(d[h].context,e,r);break;case 4:d[h].fn.call(d[h].context,e,r,s);break;default:if(!l)for(u=1,l=new Array(c-1);u<c;u++)l[u-1]=arguments[u];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(t,e,i){return n(this,t,e,i,!1)},o.prototype.once=function(t,e,i){return n(this,t,e,i,!0)},o.prototype.removeListener=function(t,e,r,s){var n=i?i+t:t;if(!this._events[n])return this;if(!e)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==e||s&&!o.once||r&&o.context!==r||a(this,n);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==e||s&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[n]=1===h.length?h[0]:h:a(this,n)}return this},o.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&a(this,e)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,t.exports=o}({get exports(){return Er},set exports(t){Er=t}});const Tr=yi()||{isTypeSupported:()=>!1};class br{constructor(t,e,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=t.config;this.hls=t,this.id=e,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;const n=(t,e)=>{(e=e||{}).frag=this.frag,e.id=this.id,t===h.ERROR&&(this.error=e.error),this.hls.trigger(t,e)};this.observer=new Er,this.observer.on(h.FRAG_DECRYPTED,n),this.observer.on(h.ERROR,n);const a={mp4:Tr.isTypeSupported("video/mp4"),mpeg:Tr.isTypeSupported("audio/mpeg"),mp3:Tr.isTypeSupported('audio/mp4; codecs="mp3"')},o=navigator.vendor;if(!this.useWorker||"undefined"==typeof Worker||!s.workerPath&&"function"!=typeof __HLS_WORKER_BUNDLE__)this.transmuxer=new gr(this.observer,a,s,o,e);else try{s.workerPath?(p.log(`loading Web Worker ${s.workerPath} for "${e}"`),this.workerContext=function(t){const e=new self.URL(t,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}(s.workerPath)):(p.log(`injecting Web Worker for "${e}"`),this.workerContext=function(){const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(t);return{worker:new self.Worker(e),objectURL:e}}()),this.onwmsg=t=>this.onWorkerMessage(t);const{worker:t}=this.workerContext;t.addEventListener("message",this.onwmsg),t.onerror=t=>{const i=new Error(`${t.message}  (${t.filename}:${t.lineno})`);s.enableWorker=!1,p.warn(`Error in "${e}" Web Worker, fallback to inline`),this.hls.trigger(h.ERROR,{type:d.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:i})},t.postMessage({cmd:"init",typeSupported:a,vendor:o,id:e,config:JSON.stringify(s)})}catch(t){p.warn(`Error setting up "${e}" Web Worker, fallback to inline`,t),this.resetWorker(),this.error=null,this.transmuxer=new gr(this.observer,a,s,o,e)}}resetWorker(){if(this.workerContext){const{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,i,r,s,n,a,o,l,h){var d,c;l.transmuxing.start=self.performance.now();const{transmuxer:u}=this,f=n?n.start:s.start,g=s.decryptdata,m=this.frag,y=!(m&&s.cc===m.cc),v=!(m&&l.level===m.level),E=m?l.sn-m.sn:-1,T=this.part?l.part-this.part.index:-1,b=0===E&&l.id>1&&l.id===(null==m?void 0:m.stats.chunkCount),S=!v&&(1===E||0===E&&(1===T||b&&T<=0)),w=self.performance.now();(v||E||0===s.stats.parsing.start)&&(s.stats.parsing.start=w),!n||!T&&S||(n.stats.parsing.start=w);const R=!(m&&(null==(d=s.initSegment)?void 0:d.url)===(null==(c=m.initSegment)?void 0:c.url)),_=new vr(y,S,o,v,f,R);if(!S||y||R){p.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${y}\n        trackSwitch: ${v}\n        contiguous: ${S}\n        accurateTimeOffset: ${o}\n        timeOffset: ${f}\n        initSegmentChange: ${R}`);const t=new yr(i,r,e,a,h);this.configureTransmuxer(t)}if(this.frag=s,this.part=n,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:g,chunkMeta:l,state:_},t instanceof ArrayBuffer?[t]:[]);else if(u){const e=u.push(t,g,l,_);mr(e)?(u.async=!0,e.then((t=>{this.handleTransmuxComplete(t)})).catch((t=>{this.transmuxerError(t,l,"transmuxer-interface push error")}))):(u.async=!1,this.handleTransmuxComplete(e))}}flush(t){t.transmuxing.start=self.performance.now();const{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let i=e.flush(t);mr(i)||e.async?(mr(i)||(i=Promise.resolve(i)),i.then((e=>{this.handleFlushResult(e,t)})).catch((e=>{this.transmuxerError(e,t,"transmuxer-interface flush error")}))):this.handleFlushResult(i,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,chunkMeta:e,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach((t=>{this.handleTransmuxComplete(t)})),this.onFlush(e)}onWorkerMessage(t){const e=t.data,i=this.hls;switch(e.event){case"init":{var r;const t=null==(r=this.workerContext)?void 0:r.objectURL;t&&self.URL.revokeObjectURL(t);break}case"transmuxComplete":this.handleTransmuxComplete(e.data);break;case"flush":this.onFlush(e.data);break;case"workerLog":p[e.data.logType]&&p[e.data.logType](e.data.message);break;default:e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,i.trigger(e.event,e.data)}}configureTransmuxer(t){const{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}class Sr{constructor(t,e,i,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=i,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){const{config:i,media:r,stalled:s}=this;if(null===r)return;const{currentTime:n,seeking:a}=r,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,n!==t){if(this.moved=!0,null!==s){if(this.stallReported){const t=self.performance.now()-s;p.warn(`playback not stuck anymore @${n}, after ${Math.round(t)}ms`),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if(l||o)return void(this.stalled=null);if(r.paused&&!a||r.ended||0===r.playbackRate||!Ye.getBuffered(r).length)return;const h=Ye.bufferInfo(r,n,0),d=h.len>0,c=h.nextStart||0;if(!d&&!c)return;if(a){const t=h.len>2,i=!c||e&&e.start<=n||c-n>2&&!this.fragmentTracker.getPartialFragment(n);if(t||i)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var u;const t=Math.max(c,h.start||0)-n,e=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,i=(null==e||null==(u=e.details)?void 0:u.live)?2*e.details.targetduration:2,r=this.fragmentTracker.getPartialFragment(n);if(t>0&&(t<=i||r))return void this._trySkipBufferHole(r)}const f=self.performance.now();if(null===s)return void(this.stalled=f);const g=f-s;if(!a&&g>=250&&(this._reportStall(h),!this.media))return;const m=Ye.bufferInfo(r,n,i.maxBufferHole);this._tryFixBufferStall(m,g)}_tryFixBufferStall(t,e){const{config:i,fragmentTracker:r,media:s}=this;if(null===s)return;const n=s.currentTime,a=r.getPartialFragment(n);(!a||!this._trySkipBufferHole(a)&&this.media)&&(t.len>i.maxBufferHole||t.nextStart&&t.nextStart-n<i.maxBufferHole)&&e>1e3*i.highBufferWatchdogPeriod&&(p.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){const{hls:e,media:i,stallReported:r}=this;if(!r&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(t)})`);p.warn(r.message),e.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:t.len})}}_trySkipBufferHole(t){const{config:e,hls:i,media:r}=this;if(null===r)return 0;const s=r.currentTime,n=Ye.bufferInfo(r,s,0),a=s<n.start?n.start:n.nextStart;if(a){const o=n.len<=e.maxBufferHole,l=n.len>0&&n.len<1&&r.readyState<3,u=a-s;if(u>0&&(o||l)){if(u>e.maxBufferHole){const{fragmentTracker:e}=this;let i=!1;if(0===s){const t=e.getAppendedFrag(0,jt.MAIN);t&&a<t.end&&(i=!0)}if(!i){const i=t||e.getAppendedFrag(s,jt.MAIN);if(i){let t=!1,r=i.end;for(;r<a;){const i=e.getPartialFragment(r);if(!i){t=!0;break}r+=i.duration}if(t)return 0}}}const n=Math.max(a+.05,s+.1);if(p.warn(`skipping hole, adjusting currentTime from ${s} to ${n}`),this.moved=!0,this.stalled=null,r.currentTime=n,t&&!t.gap){const e=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${n}`);i.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:e,reason:e.message,frag:t})}return n}}return 0}_tryNudgeBuffer(){const{config:t,hls:e,media:i,nudgeRetry:r}=this;if(null===i)return;const s=i.currentTime;if(this.nudgeRetry++,r<t.nudgeMaxRetry){const n=s+(r+1)*t.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${s} to ${n}`);p.warn(a.message),i.currentTime=n,e.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const i=new Error(`Playhead still not moving while enough data buffered @${s} after ${t.nudgeMaxRetry} nudges`);p.error(i.message),e.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_STALLED_ERROR,error:i,fatal:!0})}}}class wr extends mi{constructor(t,e,i){super(t,e,i,"[stream-controller]",jt.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(h.ERROR,this.onError,this),t.on(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this),t.on(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(h.ERROR,this.onError,this),t.off(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(h.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this),t.off(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(h.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),this.onMediaDetaching()}startLoad(t){if(this.levels){const{lastCurrentTime:e,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let t=i.startLevel;-1===t&&(i.config.testBandwidth&&this.levels.length>1?(t=0,this.bitrateTest=!0):t=i.nextAutoLevel),this.level=i.nextLoadLevel=t,this.loadedmetadata=!1}e>0&&-1===t&&(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e),this.state=ni,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=si}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case pi:{var t;const{levels:e,level:i}=this,r=null==e||null==(t=e[i])?void 0:t.details;if(r&&(!r.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(r))break;this.state=ni;break}break}case li:{var e;const t=self.performance.now(),i=this.retryDate;(!i||t>=i||null!=(e=this.media)&&e.seeking)&&(this.resetStartWhenNotLoaded(this.level),this.state=ni)}}this.state===ni&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:i,media:r}=this,{config:s,nextLoadLevel:n}=t;if(null===e||!r&&(this.startFragRequested||!s.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;if(null==i||!i[n])return;const a=i[n],o=this.getMainFwdBufferInfo();if(null===o)return;const l=this.getLevelDetails();if(l&&this._streamEnded(o,l)){const t={};return this.altAudio&&(t.type="video"),this.hls.trigger(h.BUFFER_EOS,t),void(this.state=ui)}t.loadLevel!==n&&-1===t.manualLevel&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=t.nextLoadLevel=n;const d=a.details;if(!d||this.state===pi||d.live&&this.levelLastLoaded!==n)return this.level=n,void(this.state=pi);const c=o.len,u=this.getMaxBufferLength(a.maxBitrate);if(c>=u)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:o.end;let g=this.getNextFragment(f,d);if(this.couldBacktrack&&!this.fragPrevious&&g&&"initSegment"!==g.sn&&this.fragmentTracker.getState(g)!==Fe){var p;const t=(null!=(p=this.backtrackFragment)?p:g).sn-d.startSN,e=d.fragments[t-1];e&&g.cc===e.cc&&(g=e,this.fragmentTracker.removeFragment(e))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(g&&this.isLoopLoading(g,f)){if(!g.gap){const t=this.audioOnly&&!this.altAudio?S.AUDIO:S.VIDEO,e=(t===S.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;e&&this.afterBufferFlushed(e,t,jt.MAIN)}g=this.getNextFragmentLoopLoading(g,d,o,jt.MAIN,u)}g&&(!g.initSegment||g.initSegment.data||this.bitrateTest||(g=g.initSegment),this.loadFragment(g,a,f))}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);this.fragCurrent=t,r===xe?"initSegment"===t.sn?this._loadInitSegment(t,e):this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}getAppendedFrag(t){const e=this.fragmentTracker.getAppendedFrag(t,jt.MAIN);return e&&"fragment"in e?e.fragment:e}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,jt.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(null!=e&&e.readyState){let i;const r=this.getAppendedFrag(e.currentTime);if(r&&r.start>1&&this.flushMainBuffer(0,r.start-1),!e.paused&&t){const e=t[this.hls.nextLoadLevel],r=this.fragLastKbps;i=r&&this.fragCurrent?this.fragCurrent.duration*e.maxBitrate/(1e3*r)+1:0}else i=0;const s=this.getBufferedFrag(e.currentTime+i);if(s){const t=this.followingBufferedFrag(s);if(t){this.abortCurrentFrag();const e=t.maxStartPTS?t.maxStartPTS:t.start,i=t.duration,r=Math.max(s.end,e+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,.5*i),.75*i));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case ai:case oi:case li:case di:case ci:this.state=ni}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const i=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new Sr(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const t=this.media,e=t?t.currentTime:null;l(e)&&this.log(`Media seeked to ${e.toFixed(3)}`);const i=this.getMainFwdBufferInfo();null!==i&&0!==i.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(h.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null}onManifestParsed(t,e){let i,r=!1,s=!1;e.levels.forEach((t=>{i=t.audioCodec,i&&(-1!==i.indexOf("mp4a.40.2")&&(r=!0),-1!==i.indexOf("mp4a.40.5")&&(s=!0))})),this.audioCodecSwitch=r&&s&&!function(){var t;const e=vi();return"function"==typeof(null==e||null==(t=e.prototype)?void 0:t.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:i}=this;if(!i||this.state!==ni)return;const r=i[e.level];(!r.details||r.details.live&&this.levelLastLoaded!==e.level||this.waitForCdnTuneIn(r.details))&&(this.state=pi)}onLevelLoaded(t,e){var i;const{levels:r}=this,s=e.level,n=e.details,a=n.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${n.startSN},${n.endSN}], cc [${n.startCC}, ${n.endCC}] duration:${a}`);const o=r[s],l=this.fragCurrent;!l||this.state!==oi&&this.state!==li||l.level===e.level&&l.urlId===o.urlId||!l.loader||this.abortCurrentFrag();let d=0;if(n.live||null!=(i=o.details)&&i.live){if(n.fragments[0]||(n.deltaUpdateFailed=!0),n.deltaUpdateFailed)return;d=this.alignPlaylists(n,o.details)}if(o.details=n,this.levelLastLoaded=s,this.hls.trigger(h.LEVEL_UPDATED,{details:n,level:s}),this.state===pi){if(this.waitForCdnTuneIn(n))return;this.state=ni}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,d),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{levels:n}=this;if(!n)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const a=n[i.level],o=a.details;if(!o)return this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),void this.fragmentTracker.removeFragment(i);const l=a.videoCodec,h=o.PTSKnown||!o.live,d=null==(e=i.initSegment)?void 0:e.data,c=this._getAudioCodec(a),u=this.transmuxer=this.transmuxer||new br(this.hls,jt.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,g=-1!==f,p=new ze(i.level,i.sn,i.stats.chunkCount,s.byteLength,f,g),m=this.initPTS[i.cc];u.push(s,d,c,l,i,r,o.totalduration,h,p,m)}onAudioTrackSwitching(t,e){const i=this.altAudio;if(!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const t=this.fragCurrent;t&&(this.log("Switching to main audio track, cancel main fragment load"),t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const t=this.hls;i&&(t.trigger(h.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),t.trigger(h.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const i=e.id,r=!!this.hls.audioTracks[i].url;if(r){const t=this.videoBuffer;t&&this.mediaBuffer!==t&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=t)}this.altAudio=r,this.tick()}onBufferCreated(t,e){const i=e.tracks;let r,s,n=!1;for(const t in i){const e=i[t];if("main"===e.id){if(s=t,r=e,"video"===t){const e=i[t];e&&(this.videoBuffer=e.buffer)}}else n=!0}n&&r?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:i,part:r}=e;if(i&&i.type!==jt.MAIN)return;if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===ci&&(this.state=ni));const s=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal)this.state=fi;else switch(e.details){case c.FRAG_GAP:case c.FRAG_PARSING_ERROR:case c.FRAG_DECRYPT_ERROR:case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(jt.MAIN,e);break;case c.LEVEL_LOAD_ERROR:case c.LEVEL_LOAD_TIMEOUT:case c.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==pi||(null==(i=e.context)?void 0:i.type)!==Vt.LEVEL||(this.state=ni);break;case c.BUFFER_FULL_ERROR:if(!e.parent||"main"!==e.parent)return;this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case c.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}checkBuffer(){const{media:t,gapController:e}=this;if(t&&e&&t.readyState){if(this.loadedmetadata||!Ye.getBuffered(t).length){const t=this.state!==ni?this.fragCurrent:null;e.poll(this.lastCurrentTime,t)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=ni,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==S.AUDIO||this.audioOnly&&!this.altAudio){const t=(e===S.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(t,e,jt.MAIN)}}onLevelsUpdated(t,e){this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let i=this.startPosition;if(i>=0&&e<i){if(t.seeking)return void this.log(`could not seek to ${i}, already seeking at ${e}`);const r=Ye.getBuffered(t),s=(r.length?r.start(0):0)-i;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${s} to match buffer start`),i+=s,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${e}`),t.currentTime=i}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then((i=>{const{hls:r}=this;if(!i||this.fragContextChanged(t))return;e.fragmentError=0,this.state=ni,this.startFragRequested=!1,this.bitrateTest=!1;const s=t.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(h.FRAG_LOADED,i),t.bitrateTest=!1}))}_handleTransmuxComplete(t){var e;const i="main",{hls:r}=this,{remuxResult:s,chunkMeta:n}=t,a=this.getCurrentContext(n);if(!a)return void this.resetWhenMissingContext(n);const{frag:o,part:d,level:c}=a,{video:u,text:f,id3:g,initSegment:p}=s,{details:m}=c,y=this.altAudio?void 0:s.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=di,p){p.tracks&&(this._bufferInitSegment(c,p.tracks,o,n),r.trigger(h.FRAG_PARSING_INIT_SEGMENT,{frag:o,id:i,tracks:p.tracks}));const t=p.initPTS,e=p.timescale;l(t)&&(this.initPTS[o.cc]={baseTime:t,timescale:e},r.trigger(h.INIT_PTS_FOUND,{frag:o,id:i,initPTS:t,timescale:e}))}if(u&&!1!==s.independent){if(m){const{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=u;if(d)d.elementaryStreams[u.type]={startPTS:t,endPTS:e,startDTS:i,endDTS:r};else if(u.firstKeyFrame&&u.independent&&1===n.id&&(this.couldBacktrack=!0),u.dropped&&u.independent){const i=this.getMainFwdBufferInfo();if((i?i.end:this.getLoadPosition())+this.config.maxBufferHole<(u.firstKeyFramePTS?u.firstKeyFramePTS:t)-this.config.maxBufferHole)return void this.backtrack(o);o.setElementaryStreamInfo(u.type,o.start,e,o.start,r,!0)}o.setElementaryStreamInfo(u.type,t,e,i,r),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(u,o,d,n)}}else if(!1===s.independent)return void this.backtrack(o);if(y){const{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=y;d&&(d.elementaryStreams[S.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(S.AUDIO,t,e,i,r),this.bufferFragmentData(y,o,d,n)}if(m&&null!=g&&null!=(e=g.samples)&&e.length){const t={id:i,frag:o,details:m,samples:g.samples};r.trigger(h.FRAG_PARSING_METADATA,t)}if(m&&f){const t={id:i,frag:o,details:m,samples:f.samples};r.trigger(h.FRAG_PARSING_USERDATA,t)}}}_bufferInitSegment(t,e,i,r){if(this.state!==di)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;const{audio:s,video:n,audiovideo:a}=e;if(s){let e=t.audioCodec;const i=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(e&&(e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===i.indexOf("firefox")&&(e="mp4a.40.5")),-1!==i.indexOf("android")&&"audio/mpeg"!==s.container&&(e="mp4a.40.2",this.log(`Android: force audio codec to ${e}`)),t.audioCodec&&t.audioCodec!==e&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${e}"`),s.levelCodec=e,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${e||""}/${t.audioCodec||""}/${s.codec}]`)}n&&(n.levelCodec=t.videoCodec,n.id="main",this.log(`Init video buffer, container:${n.container}, codecs[level/parsed]=[${t.videoCodec||""}/${n.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${t.attrs.CODECS||""}/${a.codec}]`),this.hls.trigger(h.BUFFER_CODECS,e),Object.keys(e).forEach((t=>{const s=e[t].initSegment;null!=s&&s.byteLength&&this.hls.trigger(h.BUFFER_APPENDING,{type:t,data:s,frag:i,part:null,chunkMeta:r,parent:i.type})})),this.tick()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,jt.MAIN)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=ni}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&!1===t.seeking){const i=t.currentTime;if(Ye.isBuffered(t,i)?e=this.getAppendedFrag(i):Ye.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;const t=this.fragPlaying,i=e.level;t&&e.sn===t.sn&&t.level===i&&e.urlId===t.urlId||(this.fragPlaying=e,this.hls.trigger(h.FRAG_CHANGED,{frag:e}),t&&t.level===i||this.hls.trigger(h.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){const t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){const t=this.media;if(t){const e=t.currentTime,i=this.currentFrag;if(i&&l(e)&&l(i.programDateTime)){const t=i.programDateTime+1e3*(e-i.start);return new Date(t)}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class Rr{constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}sample(t,e){const i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class _r{constructor(t,e,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Rr(t),this.fast_=new Rr(e),this.defaultTTFB_=r,this.ttfb_=new Rr(t)}update(t,e){const{slow_:i,fast_:r,ttfb_:s}=this;i.halfLife!==t&&(this.slow_=new Rr(t,i.getEstimate(),i.getTotalWeight())),r.halfLife!==e&&(this.fast_=new Rr(e,r.getEstimate(),r.getTotalWeight())),s.halfLife!==t&&(this.ttfb_=new Rr(t,s.getEstimate(),s.getTotalWeight()))}sample(t,e){const i=(t=Math.max(t,this.minDelayMs_))/1e3,r=8*e/i;this.fast_.sample(i,r),this.slow_.sample(i,r)}sampleTTFB(t){const e=t/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(i,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}class Ar{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let i;return t.length?(i=1===t.length?t[0]:function(t,e){const i=new Uint8Array(e);let r=0;for(let e=0;e<t.length;e++){const s=t[e];i.set(s,r),r+=s.length}return i}(t,e),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function Lr(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!Cr(t[i].attrs,e[i].attrs))return!1;return!0}function Cr(t,e){const i=t["STABLE-RENDITION-ID"];return i?i===e["STABLE-RENDITION-ID"]:!["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED"].some((i=>t[i]!==e[i]))}class Ir{constructor(t){this.buffered=void 0;const e=(e,i,r)=>{if((i>>>=0)>r-1)throw new DOMException(`Failed to execute '${e}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${r})`);return t[i][e]};this.buffered={get length(){return t.length},end:i=>e("end",i,t.length),start:i=>e("start",i,t.length)}}}function kr(t){const e=[];for(let i=0;i<t.length;i++){const r=t[i];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||e.push(t[i])}return e}class Dr{constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}append(t,e){const i=this.queues[e];i.push(t),1===i.length&&this.buffers[e]&&this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;const i=new Promise((t=>{e=t})),r={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,t),i}executeNext(t){const{buffers:e,queues:i}=this,r=e[t],s=i[t];if(s.length){const e=s[0];try{e.execute()}catch(i){p.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),e.onError(i),null!=r&&r.updating||(s.shift(),this.executeNext(t))}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}}const Pr=yi(),xr=/([ha]vc.)(?:\.[^.,]+)+/,Or={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Mr=function(t){let e=t;return Or.hasOwnProperty(t)&&(e=Or[t]),String.fromCharCode(e)},Fr=15,Nr=100,Ur={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Br={17:2,18:4,21:6,22:8,23:10,19:13,20:15},$r={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Gr={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Kr=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class Hr{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){const i="function"==typeof e?e():e;p.log(`${this.time} [${t}] ${i}`)}}}const Vr=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].toString(16));return e};class jr{constructor(t,e,i,r,s){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=t||"white",this.underline=e||!1,this.italics=i||!1,this.background=r||"black",this.flash=s||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){const e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){const r=e[i];t.hasOwnProperty(r)&&(this[r]=t[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class qr{constructor(t,e,i,r,s,n){this.uchar=void 0,this.penState=void 0,this.uchar=t||" ",this.penState=new jr(e,i,r,s,n)}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Wr{constructor(t){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(let t=0;t<Nr;t++)this.chars.push(new qr);this.logger=t,this.pos=0,this.currPenState=new jr}equals(t){let e=!0;for(let i=0;i<Nr;i++)if(!this.chars[i].equals(t.chars[i])){e=!1;break}return e}copy(t){for(let e=0;e<Nr;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<Nr;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Nr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Nr)}moveCursor(t){const e=this.pos+t;if(t>1)for(let t=this.pos+1;t<e+1;t++)this.chars[t].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();const e=Mr(t);this.pos>=Nr?this.logger.log(0,(()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1))}clearFromPos(t){let e;for(e=t;e<Nr;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let e=!0;for(let i=0;i<Nr;i++){const r=this.chars[i].uchar;" "!==r&&(e=!1),t.push(r)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}}class Yr{constructor(t){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(let e=0;e<Fr;e++)this.rows.push(new Wr(t));this.logger=t,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}reset(){for(let t=0;t<Fr;t++)this.rows[t].clear();this.currRow=14}equals(t){let e=!0;for(let i=0;i<Fr;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<Fr;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<Fr;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,(()=>"pacData = "+JSON.stringify(t)));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let t=0;t<Fr;t++)this.rows[t].clear();const t=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const r=i.rows[t].cueStartTime,s=this.logger.time;if(r&&null!==s&&r<s)for(let r=0;r<this.nrRollUpRows;r++)this.rows[e-this.nrRollUpRows+r+1].copy(i.rows[t+r])}}this.currRow=e;const i=this.rows[this.currRow];if(null!==t.indent){const e=t.indent,r=Math.max(e-1,0);i.setCursor(t.indent),t.color=i.chars[r].penState.foreground}const r={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(t){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(t))),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;const e=[];let i="",r=-1;for(let i=0;i<Fr;i++){const s=this.rows[i].getTextString();s&&(r=i+1,t?e.push("Row "+r+": '"+s+"'"):e.push(s.trim()))}return e.length>0&&(i=t?"["+e.join(" | ")+"]":e.join("\n")),i}getTextAndFormat(){return this.rows}}class zr{constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new Yr(i),this.nonDisplayedMemory=new Yr(i),this.lastOutputScreen=new Yr(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,(()=>"MODE="+t)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);const e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>e+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){const e={flash:!1};if(e.underline=t%2==1,e.italics=t>=46,e.italics)e.foreground="white";else{const i=Math.floor(t/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=r[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){const e=this.logger.time;null!==e&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e):this.cueStartTime=e,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class Xr{constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;const r=new Hr;this.channels=[null,new zr(t,e,r),new zr(t+1,i,r)],this.cmdHistory={a:null,b:null},this.logger=r}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){let i,r,s,n=!1;this.logger.time=t;for(let t=0;t<e.length;t+=2)if(r=127&e[t],s=127&e[t+1],0!==r||0!==s){if(this.logger.log(3,"["+Vr([e[t],e[t+1]])+"] -> ("+Vr([r,s])+")"),i=this.parseCmd(r,s),i||(i=this.parseMidrow(r,s)),i||(i=this.parsePAC(r,s)),i||(i=this.parseBackgroundAttributes(r,s)),!i&&(n=this.parseChars(r,s),n)){const t=this.currentChannel;t&&t>0?this.channels[t].insertChars(n):this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||n||this.logger.log(2,"Couldn't parse cleaned data "+Vr([r,s])+" orig: "+Vr([e[t],e[t+1]]))}}parseCmd(t,e){const{cmdHistory:i}=this;if(!((20===t||28===t||21===t||29===t)&&e>=32&&e<=47||(23===t||31===t)&&e>=33&&e<=35))return!1;if(Jr(t,e,i))return Qr(null,null,i),this.logger.log(3,"Repeated command ("+Vr([t,e])+") is dropped"),!0;const r=20===t||21===t||23===t?1:2,s=this.channels[r];return 20===t||21===t||28===t||29===t?32===e?s.ccRCL():33===e?s.ccBS():34===e?s.ccAOF():35===e?s.ccAON():36===e?s.ccDER():37===e?s.ccRU(2):38===e?s.ccRU(3):39===e?s.ccRU(4):40===e?s.ccFON():41===e?s.ccRDC():42===e?s.ccTR():43===e?s.ccRTD():44===e?s.ccEDM():45===e?s.ccCR():46===e?s.ccENM():47===e&&s.ccEOC():s.ccTO(e-32),Qr(t,e,i),this.currentChannel=r,!0}parseMidrow(t,e){let i=0;if((17===t||25===t)&&e>=32&&e<=47){if(i=17===t?1:2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[i];return!!r&&(r.ccMIDROW(e),this.logger.log(3,"MIDROW ("+Vr([t,e])+")"),!0)}return!1}parsePAC(t,e){let i;const r=this.cmdHistory;if(!((t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127||(16===t||24===t)&&e>=64&&e<=95))return!1;if(Jr(t,e,r))return Qr(null,null,r),!0;const s=t<=23?1:2;i=e>=64&&e<=95?1===s?Ur[t]:$r[t]:1===s?Br[t]:Gr[t];const n=this.channels[s];return!!n&&(n.setPAC(this.interpretPAC(i,e)),Qr(t,e,r),this.currentChannel=s,!0)}interpretPAC(t,e){let i;const r={color:null,italics:!1,indent:null,underline:!1,row:t};return i=e>95?e-96:e-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(t,e){let i,r=null,s=null;if(t>=25?(i=2,s=t-8):(i=1,s=t),s>=17&&s<=19){let t;t=17===s?e+80:18===s?e+112:e+144,this.logger.log(2,"Special char '"+Mr(t)+"' in channel "+i),r=[t]}else t>=32&&t<=127&&(r=0===e?[t]:[t,e]);if(r){const i=Vr(r);this.logger.log(3,"Char codes =  "+i.join(",")),Qr(t,e,this.cmdHistory)}return r}parseBackgroundAttributes(t,e){if(!((16===t||24===t)&&e>=32&&e<=47||(23===t||31===t)&&e>=45&&e<=47))return!1;let i;const r={};16===t||24===t?(i=Math.floor((e-32)/2),r.background=Kr[i],e%2==1&&(r.background=r.background+"_semi")):45===e?r.background="transparent":(r.foreground="black",47===e&&(r.underline=!0));const s=t<=23?1:2;return this.channels[s].setBkgData(r),Qr(t,e,this.cmdHistory),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){const e=this.channels[t];e&&e.reset()}this.cmdHistory={a:null,b:null}}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){const i=this.channels[e];i&&i.cueSplitAtTime(t)}}}function Qr(t,e,i){i.a=t,i.b=e}function Jr(t,e,i){return i.a===t&&i.b===e}class Zr{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(null===this.startTime||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var ts=function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;const t=["","lr","rl"],e=["start","middle","end","left","right"];function i(t,e){if("string"!=typeof e)return!1;if(!Array.isArray(t))return!1;const i=e.toLowerCase();return!!~t.indexOf(i)&&i}function r(t){return i(e,t)}function s(t,...e){let i=1;for(;i<arguments.length;i++){const e=arguments[i];for(const i in e)t[i]=e[i]}return t}function n(e,n,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let h="",d=!1,c=e,u=n,f=a,g=null,p="",m=!0,y="auto",v="start",E=50,T="middle",b=50,S="middle";Object.defineProperty(o,"id",s({},l,{get:function(){return h},set:function(t){h=""+t}})),Object.defineProperty(o,"pauseOnExit",s({},l,{get:function(){return d},set:function(t){d=!!t}})),Object.defineProperty(o,"startTime",s({},l,{get:function(){return c},set:function(t){if("number"!=typeof t)throw new TypeError("Start time must be set to a number.");c=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",s({},l,{get:function(){return u},set:function(t){if("number"!=typeof t)throw new TypeError("End time must be set to a number.");u=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",s({},l,{get:function(){return f},set:function(t){f=""+t,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",s({},l,{get:function(){return g},set:function(t){g=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",s({},l,{get:function(){return p},set:function(e){const r=function(e){return i(t,e)}(e);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");p=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",s({},l,{get:function(){return m},set:function(t){m=!!t,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",s({},l,{get:function(){return y},set:function(t){if("number"!=typeof t&&"auto"!==t)throw new SyntaxError("An invalid number or illegal string was specified.");y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",s({},l,{get:function(){return v},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",s({},l,{get:function(){return E},set:function(t){if(t<0||t>100)throw new Error("Position must be between 0 and 100.");E=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",s({},l,{get:function(){return T},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");T=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",s({},l,{get:function(){return b},set:function(t){if(t<0||t>100)throw new Error("Size must be between 0 and 100.");b=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",s({},l,{get:function(){return S},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");S=e,this.hasBeenReset=!0}})),o.displayState=void 0}return n.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},n}();class es{decode(t,e){if(!t)return"";if("string"!=typeof t)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function is(t){function e(t,e,i,r){return 3600*(0|t)+60*(0|e)+(0|i)+parseFloat(r||0)}const i=t.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?e(i[2],i[3],0,i[4]):e(i[1],i[2],i[3],i[4]):null}class rs{constructor(){this.values=Object.create(null)}set(t,e){this.get(t)||""===e||(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let r=0;r<i.length;++r)if(e===i[r]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){const i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}}function ss(t,e,i,r){const s=r?t.split(r):[t];for(const t in s){if("string"!=typeof s[t])continue;const r=s[t].split(i);2===r.length&&e(r[0],r[1])}}const ns=new ts(0,0,""),as="middle"===ns.align?"middle":"center";function os(t,e,i){const r=t;function s(){const e=is(t);if(null===e)throw new Error("Malformed timestamp: "+r);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e}function n(){t=t.replace(/^\s+/,"")}if(n(),e.startTime=s(),n(),"--\x3e"!==t.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);t=t.slice(3),n(),e.endTime=s(),n(),function(t,e){const r=new rs;ss(t,(function(t,e){let s;switch(t){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===e){r.set(t,i[s].region);break}break;case"vertical":r.alt(t,e,["rl","lr"]);break;case"line":s=e.split(","),r.integer(t,s[0]),r.percent(t,s[0])&&r.set("snapToLines",!1),r.alt(t,s[0],["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start",as,"end"]);break;case"position":s=e.split(","),r.percent(t,s[0]),2===s.length&&r.alt("positionAlign",s[1],["start",as,"end","line-left","line-right","auto"]);break;case"size":r.percent(t,e);break;case"align":r.alt(t,e,["start",as,"end","left","right"])}}),/:/,/\s/),e.region=r.get("region",null),e.vertical=r.get("vertical","");let s=r.get("line","auto");"auto"===s&&-1===ns.line&&(s=-1),e.line=s,e.lineAlign=r.get("lineAlign","start"),e.snapToLines=r.get("snapToLines",!0),e.size=r.get("size",100),e.align=r.get("align",as);let n=r.get("position","auto");"auto"===n&&50===ns.position&&(n="start"===e.align||"left"===e.align?0:"end"===e.align||"right"===e.align?100:50),e.position=n}(t,e)}function ls(t){return t.replace(/<br(?: \/)?>/gi,"\n")}class hs{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new es,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){const e=this;function i(){let t=e.buffer,i=0;for(t=ls(t);i<t.length&&"\r"!==t[i]&&"\n"!==t[i];)++i;const r=t.slice(0,i);return"\r"===t[i]&&++i,"\n"===t[i]&&++i,e.buffer=t.slice(i),r}t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));try{let t="";if("INITIAL"===e.state){if(!/\r\n|\n/.test(e.buffer))return this;t=i();const r=t.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");e.state="HEADER"}let r=!1;for(;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(r?r=!1:t=i(),e.state){case"HEADER":/:/.test(t)?ss(t,(function(t,e){}),/:/):t||(e.state="ID");continue;case"NOTE":t||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(t)){e.state="NOTE";break}if(!t)continue;if(e.cue=new ts(0,0,""),e.state="CUE",-1===t.indexOf("--\x3e")){e.cue.id=t;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{os(t,e.cue,e.regionList)}catch(t){e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{const i=-1!==t.indexOf("--\x3e");if(!t||i&&(r=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(null===e.cue)continue;e.cue.text&&(e.cue.text+="\n"),e.cue.text+=t}continue;case"BADCUE":t||(e.state="ID")}}}catch(t){"CUETEXT"===e.state&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state="INITIAL"===e.state?"BADWEBVTT":"BADCUE"}return this}flush(){const t=this;try{if((t.cue||"HEADER"===t.state)&&(t.buffer+="\n\n",t.parse()),"INITIAL"===t.state||"BADWEBVTT"===t.state)throw new Error("Malformed WebVTT signature.")}catch(e){t.onparsingerror&&t.onparsingerror(e)}return t.onflush&&t.onflush(),this}}const ds=/\r\n|\n\r|\n|\r/g,cs=function(t,e,i=0){return t.slice(i,i+e.length)===e},us=function(t){let e=5381,i=t.length;for(;i;)e=33*e^t.charCodeAt(--i);return(e>>>0).toString()};function fs(t,e,i){return us(t.toString())+us(e.toString())+us(i)}const gs="stpp.ttml.im1t",ps=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,ms=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,ys={left:"start",center:"center",right:"end",start:"start",end:"end"};function vs(t,e,i,r){const s=ct(new Uint8Array(t),["mdat"]);if(0===s.length)return void r(new Error("Could not parse IMSC1 mdat"));const n=s.map((t=>Z(t))),a=function(t,e,i=1,r=!1){return er(t,e,1/i,r)}(e.baseTime,1,e.timescale);try{n.forEach((t=>i(function(t,e){const i=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("tt")[0];if(!i)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(r).reduce(((t,e)=>(t[e]=i.getAttribute(`ttp:${e}`)||r[e],t)),{}),n="preserve"!==i.getAttribute("xml:space"),a=Ts(Es(i,"styling","style")),l=Ts(Es(i,"layout","region")),h=Es(i,"body","[begin]");return[].map.call(h,(t=>{const i=bs(t,n);if(!i||!t.hasAttribute("begin"))return null;const r=Rs(t.getAttribute("begin"),s),h=Rs(t.getAttribute("dur"),s);let d=Rs(t.getAttribute("end"),s);if(null===r)throw ws(t);if(null===d){if(null===h)throw ws(t);d=r+h}const c=new ts(r-e,d-e,i);c.id=fs(c.startTime,c.endTime,c.text);const u=function(t,e,i){const r="http://www.w3.org/ns/ttml#styling";let s=null;const n=null!=t&&t.hasAttribute("style")?t.getAttribute("style"):null;return n&&i.hasOwnProperty(n)&&(s=i[n]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce(((i,n)=>{const a=Ss(e,r,n)||Ss(t,r,n)||Ss(s,r,n);return a&&(i[n]=a),i}),{})}(l[t.getAttribute("region")],a[t.getAttribute("style")],a),{textAlign:f}=u;if(f){const t=ys[f];t&&(c.lineAlign=t),c.align=f}return o(c,u),c})).filter((t=>null!==t))}(t,a))))}catch(t){r(t)}}function Es(t,e,i){const r=t.getElementsByTagName(e)[0];return r?[].slice.call(r.querySelectorAll(i)):[]}function Ts(t){return t.reduce(((t,e)=>{const i=e.getAttribute("xml:id");return i&&(t[i]=e),t}),{})}function bs(t,e){return[].slice.call(t.childNodes).reduce(((t,i,r)=>{var s;return"br"===i.nodeName&&r?t+"\n":null!=(s=i.childNodes)&&s.length?bs(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent}),"")}function Ss(t,e,i){return t&&t.hasAttributeNS(e,i)?t.getAttributeNS(e,i):null}function ws(t){return new Error(`Could not parse ttml timestamp ${t}`)}function Rs(t,e){if(!t)return null;let i=is(t);return null===i&&(ps.test(t)?i=function(t,e){const i=ps.exec(t),r=(0|i[4])+(0|i[5])/e.subFrameRate;return 3600*(0|i[1])+60*(0|i[2])+(0|i[3])+r/e.frameRate}(t,e):ms.test(t)&&(i=function(t,e){const i=ms.exec(t),r=Number(i[1]);switch(i[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/e.frameRate;case"t":return r/e.tickRate}return r}(t,e))),i}function _s(t,e){return!!t&&t.label===e.name&&!(t.textTrack1||t.textTrack2)}class As{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(h.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.BUFFER_CODECS,this.onBufferCodecs,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(h.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.BUFFER_CODECS,this.onBufferCodecs,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null}onManifestParsed(t,e){const i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const t=this.hls.levels;if(t.length){const e=this.hls;e.autoLevelCapping=this.getMaxLevel(t.length-1),e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const i=e.filter(((e,i)=>this.isLevelAllowed(e)&&i<=t));return this.clientRect=null,As.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.width||e.height||(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch(t){}return t}isLevelAllowed(t){return!this.restrictedLevels.some((e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height))}static getMaxLevelByMediaSize(t,e,i){if(null==t||!t.length)return-1;let r=t.length-1;for(let a=0;a<t.length;a+=1){const o=t[a];if((o.width>=e||o.height>=i)&&(s=o,!(n=t[a+1])||s.width!==n.width||s.height!==n.height)){r=a;break}}var s,n;return r}}const Ls="[eme]";class Cs{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Cs.CDMCleanupPromise?[Cs.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=p.debug.bind(p,Ls),this.log=p.log.bind(p,Ls),this.warn=p.warn.bind(p,Ls),this.error=p.error.bind(p,Ls),this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(h.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(h.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(h.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(h.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(t){const{drmSystems:e,widevineLicenseUrl:i}=this.config,r=e[t];if(r)return r.licenseUrl;if(t===I.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${t}"`)}getServerCertificateUrl(t){const{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){const e=this.hls.levels,i=(t,e,i)=>!!t&&i.indexOf(t)===e,r=e.map((t=>t.audioCodec)).filter(i),s=e.map((t=>t.videoCodec)).filter(i);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise(((e,i)=>{const n=t=>{const a=t.shift();this.getMediaKeysPromise(a,r,s).then((t=>e({keySystem:a,mediaKeys:t}))).catch((e=>{t.length?n(t):i(e instanceof Is?e:new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_ACCESS,error:e,fatal:!0},e.message))}))};n(t)}))}requestMediaKeySystemAccess(t,e){const{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let t=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===U&&"http:"===self.location.protocol&&(t=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(t))}return i(t,e)}getMediaKeysPromise(t,e,i){const r=function(t,e,i,r){let s;switch(t){case I.FAIRPLAY:s=["cenc","sinf"];break;case I.WIDEVINE:case I.PLAYREADY:s=["cenc"];break;case I.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${t}`)}return function(t,e,i,r){return[{initDataTypes:t,persistentState:r.persistentState||"not-allowed",distinctiveIdentifier:r.distinctiveIdentifier||"not-allowed",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:e.map((t=>({contentType:`audio/mp4; codecs="${t}"`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}))),videoCapabilities:i.map((t=>({contentType:`video/mp4; codecs="${t}"`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null})))}]}(s,e,i,r)}(t,e,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[t];let n=null==s?void 0:s.keySystemAccess;if(!n){this.log(`Requesting encrypted media "${t}" key-system access with config: ${JSON.stringify(r)}`),n=this.requestMediaKeySystemAccess(t,r);const e=this.keySystemAccessPromises[t]={keySystemAccess:n};return n.catch((e=>{this.log(`Failed to obtain access to key-system "${t}": ${e}`)})),n.then((i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);const r=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),e.mediaKeys=i.createMediaKeys().then((e=>(this.log(`Media-keys created for "${t}"`),r.then((i=>i?this.setMediaKeysServerCertificate(e,t,i):e))))),e.mediaKeys.catch((e=>{this.error(`Failed to create media-keys for "${t}"}: ${e}`)})),e.mediaKeys}))}return n.then((()=>s.mediaKeys))}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:i}){this.log(`Creating key-system session "${e}" keyId: ${it(t.keyId||[])}`);const r=i.createSession(),s={decryptdata:t,keySystem:e,mediaKeys:i,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(t){const e=t.decryptdata;if(e.pssh){const i=this.createMediaKeySessionContext(t),r=this.getKeyIdString(e),s="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,s,e.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(null===t.keyId)throw new Error("keyId is null");return it(t.keyId)}updateKeySession(t,e){var i;const r=t.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${it((null==(i=t.decryptdata)?void 0:i.keyId)||[])}\n      } (data length: ${e?e.byteLength:e})`),r.update(e)}selectKeySystemFormat(t){const e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){return new Promise(((e,i)=>{const r=N(this.config),s=t.map(O).filter((t=>!!t&&-1!==r.indexOf(t)));return this.getKeySystemSelectionPromise(s).then((({keySystem:t})=>{const r=F(t);r?e(r):i(new Error(`Unable to find format for key-system "${t}"`))})).catch(i)}))}loadKey(t){const e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),r=`(keyId: ${i} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${r}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(e).then((({keySystem:i,mediaKeys:s})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${r}`),this.attemptSetMediaKeys(i,s).then((()=>{this.throwIfDestroyed();const t=this.createMediaKeySessionContext({keySystem:i,mediaKeys:s,decryptdata:e});return this.generateRequestWithPreferredKeySession(t,"cenc",e.pssh,"playlist-key")}))))),s.catch((t=>this.handleError(t)))),s}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof Is?this.hls.trigger(h.ERROR,t.data):this.hls.trigger(h.ERROR,{type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){const e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){const e=O(t.keyFormat),i=e?[e]:N(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=N(this.config)),0===t.length)throw new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}_onMediaEncrypted(t){const{initDataType:e,initData:i}=t;if(this.debug(`"${t.type}" event: init data type: "${e}"`),null===i)return;let r,s;if("sinf"===e&&this.config.drmSystems[I.FAIRPLAY]){const t=at(new Uint8Array(i));try{const e=L(JSON.parse(t).sinf),i=gt(new Uint8Array(e));if(!i)return;r=i.subarray(8,24),s=I.FAIRPLAY}catch(t){return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{const t=function(t){if(!(t instanceof ArrayBuffer)||t.byteLength<32)return null;const e={version:0,systemId:"",kids:null,data:null},i=new DataView(t),r=i.getUint32(0);if(t.byteLength!==r&&r>44)return null;if(1886614376!==i.getUint32(4))return null;if(e.version=i.getUint32(8)>>>24,e.version>1)return null;e.systemId=it(new Uint8Array(t,12,16));const s=i.getUint32(28);if(0===e.version){if(r-32<s)return null;e.data=new Uint8Array(t,32,s)}else if(1===e.version){e.kids=[];for(let i=0;i<s;i++)e.kids.push(new Uint8Array(t,32+16*i,16))}return e}(i);if(null===t)return;0===t.version&&t.systemId===M&&t.data&&(r=t.data.subarray(8,24)),s=function(t){if(t===M)return I.WIDEVINE}(t.systemId)}if(!s||!r)return;const n=it(r),{keyIdToKeySessionPromise:a,mediaKeySessions:o}=this;let l=a[n];for(let t=0;t<o.length;t++){const s=o[t],h=s.decryptdata;if(h.pssh||!h.keyId)continue;const d=it(h.keyId);if(n===d||-1!==h.uri.replace(/-/g,"").indexOf(n)){l=a[d],delete a[d],h.pssh=new Uint8Array(i),h.keyId=r,l=a[n]=l.then((()=>this.generateRequestWithPreferredKeySession(s,e,i,"encrypted-event-key-match")));break}}l||(l=a[n]=this.getKeySystemSelectionPromise([s]).then((({keySystem:t,mediaKeys:s})=>{var a;this.throwIfDestroyed();const o=new St("ISO-23001-7",n,null!=(a=F(t))?a:"");return o.pssh=new Uint8Array(i),o.keyId=r,this.attemptSetMediaKeys(t,s).then((()=>{this.throwIfDestroyed();const r=this.createMediaKeySessionContext({decryptdata:o,keySystem:t,mediaKeys:s});return this.generateRequestWithPreferredKeySession(r,e,i,"encrypted-event-no-match")}))}))),l.catch((t=>this.handleError(t)))}_onWaitingForKey(t){this.log(`"${t.type}" event`)}attemptSetMediaKeys(t,e){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);const r=Promise.all(i).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)}));return this.setMediaKeysQueue.push(r),r.then((()=>{this.log(`Media-keys set for "${t}"`),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((t=>-1===i.indexOf(t)))}))}generateRequestWithPreferredKeySession(t,e,i,r){var s,n;const a=null==(s=this.config.drmSystems)||null==(n=s[t.keySystem])?void 0:n.generateRequest;if(a)try{const r=a.call(this.hls,e,i,t);if(!r)throw new Error("Invalid response from configured generateRequest filter");e=r.initDataType,i=t.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(t){var o;if(this.warn(t.message),null!=(o=this.hls)&&o.config.debug)throw t}if(null===i)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(t);const l=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${e} length: ${i?i.byteLength:null})`);const h=new Er;t.mediaKeysSession.onmessage=e=>{const i=t.mediaKeysSession;if(!i)return void h.emit("error",new Error("invalid state"));const{messageType:r,message:s}=e;this.log(`"${r}" message event for session "${i.sessionId}" message size: ${s.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(t,s).catch((t=>{this.handleError(t),h.emit("error",t)})):"license-release"===r?t.keySystem===I.FAIRPLAY&&(this.updateKeySession(t,C("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${r}"`)},t.mediaKeysSession.onkeystatuseschange=e=>{if(!t.mediaKeysSession)return void h.emit("error",new Error("invalid state"));this.onKeyStatusChange(t);const i=t.keyStatus;h.emit("keyStatus",i),"expired"===i&&(this.warn(`${t.keySystem} expired for key ${l}`),this.renewKeySession(t))};const u=new Promise(((t,e)=>{h.on("error",e),h.on("keyStatus",(i=>{i.startsWith("usable")?t():"output-restricted"===i?e(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?e(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?e(new Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)}))}));return t.mediaKeysSession.generateRequest(e,i).then((()=>{var e;this.log(`Request generated for key-session "${null==(e=t.mediaKeysSession)?void 0:e.sessionId}" keyId: ${l}`)})).catch((t=>{throw new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_SESSION,error:t,fatal:!1},`Error generating key-session request: ${t}`)})).then((()=>u)).catch((e=>{throw h.removeAllListeners(),this.removeSession(t),e})).then((()=>(h.removeAllListeners(),t)))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach(((e,i)=>{this.log(`key status change "${e}" for keyStatuses keyId: ${it("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${it(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=e}))}fetchServerCertificate(t){const e=this.config,i=new(0,e.loader)(e),r=this.getServerCertificateUrl(t);return r?(this.log(`Fetching serverCertificate for "${t}"`),new Promise(((s,a)=>{const o={responseType:"arraybuffer",url:r},l=e.certLoadPolicy.default,h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:(t,e,i,r)=>{s(t.data)},onError:(e,i,s,l)=>{a(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:n({url:o.url,data:void 0},e)},`"${t}" certificate request failed (${r}). Status: ${e.code} (${e.text})`))},onTimeout:(e,i,s)=>{a(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:o.url,data:void 0}},`"${t}" certificate request timed out (${r})`))},onAbort:(t,e,i)=>{a(new Error("aborted"))}};i.load(o,h,u)}))):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise(((r,s)=>{t.setServerCertificate(i).then((s=>{this.log(`setServerCertificate ${s?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${e}"`),r(t)})).catch((t=>{s(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:t,fatal:!0},t.message))}))}))}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then((e=>this.updateKeySession(t,new Uint8Array(e)).catch((t=>{throw new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:t,fatal:!0},t.message)}))))}setupLicenseXHR(t,e,i,r){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then((()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,t,e,i,r)})).catch((n=>{if(!i.decryptdata)throw n;return t.open("POST",e,!0),s.call(this.hls,t,e,i,r)})).then((i=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:i||r}))):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:r}))}requestLicense(t,e){const i=this.config.keyLoadPolicy.default;return new Promise(((r,s)=>{const n=this.getLicenseServerUrl(t.keySystem);this.log(`Sending license request to URL: ${n}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return s(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let e=a.response;this.log(`License received ${e instanceof ArrayBuffer?e.byteLength:e}`);const i=this.config.licenseResponseCallback;if(i)try{e=i.call(this.hls,a,n,t)}catch(t){this.error(t)}r(e)}else{const o=i.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)s(new Is({type:d.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:n,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${n}). Status: ${a.status} (${a.statusText})`));else{const i=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(t,e).then(r,s)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=a,this.setupLicenseXHR(a,n,t,e).then((({xhr:t,licenseChallenge:e})=>{t.send(e)}))}))}onMediaAttached(t,e){if(!this.config.emeEnabled)return;const i=e.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const t=this.media,e=this.mediaKeySessions;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},St.clearKeyUriToKeyIdMap();const i=e.length;Cs.CDMCleanupPromise=Promise.all(e.map((t=>this.removeSession(t))).concat(null==t?void 0:t.setMediaKeys(null).catch((e=>{this.log(`Could not clear media keys: ${e}. media.src: ${null==t?void 0:t.src}`)})))).then((()=>{i&&(this.log("finished closing key sessions and clearing media keys"),e.length=0)})).catch((e=>{this.log(`Could not close sessions and clear media keys: ${e}. media.src: ${null==t?void 0:t.src}`)}))}onManifestLoaded(t,{sessionKeys:e}){if(e&&this.config.emeEnabled&&!this.keyFormatPromise){const t=e.reduce(((t,e)=>(-1===t.indexOf(e.keyFormat)&&t.push(e.keyFormat),t)),[]);this.log(`Selecting key-system from session-keys ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)}}removeSession(t){const{mediaKeysSession:e,licenseXhr:i}=t;if(e){this.log(`Remove licenses and keys and close session ${e.sessionId}`),e.onmessage=null,e.onkeystatuseschange=null,i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(t);return r>-1&&this.mediaKeySessions.splice(r,1),e.remove().catch((t=>{this.log(`Could not remove session: ${t}`)})).then((()=>e.close())).catch((t=>{this.log(`Could not close session: ${t}`)}))}}}Cs.CDMCleanupPromise=void 0;class Is extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=new Error(e)),this.data=t,t.err=t.error}}var ks="a",Ds="av";class Ps{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=t=>{try{this.apply(t,{ot:"m",su:!this.initialized})}catch(t){p.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=t=>{try{const e=t.frag,i=this.hls.levels[e.level],r=this.getObjectType(e),s={d:1e3*e.duration,ot:r};"v"!==r&&r!==ks&&r!=Ds||(s.br=i.bitrate/1e3,s.tb=this.getTopBandwidth(r)/1e3,s.bl=this.getBufferLength(r)),this.apply(t,s)}catch(t){p.warn("Could not generate segment CMCD data.",t)}},this.hls=t;const e=this.config=t.config,{cmcd:i}=e;null!=i&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||Ps.uuid(),this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.registerListeners())}registerListeners(){const t=this.hls;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHED,this.onMediaDetached,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const t=this.hls;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHED,this.onMediaDetached,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,r;this.audioBuffer=null==(i=e.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(r=e.tracks.video)?void 0:r.buffer}createData(){var t;return{v:1,sf:"h",sid:this.sid,cid:this.cid,pr:null==(t=this.media)?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){o(e,this.createData());const i="i"===e.ot||"v"===e.ot||e.ot===Ds;if(this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),null==e.su&&(e.su=this.buffering),this.useHeaders){const i=Ps.toHeaders(e);if(!Object.keys(i).length)return;t.headers||(t.headers={}),o(t.headers,i)}else{const i=Ps.toQuery(e);if(!i)return;t.url=Ps.appendQueryToUri(t.url,i)}}getObjectType(t){const{type:e}=t;return"subtitle"===e?"tt":"initSegment"===t.sn?"i":"audio"===e?ks:"main"===e?this.hls.audioTracks.length?"v":Ds:void 0}getTopBandwidth(t){let e,i=0;const r=this.hls;if(t===ks)e=r.audioTracks;else{const t=r.maxAutoLevel,i=t>-1?t+1:r.levels.length;e=r.levels.slice(0,i)}for(const t of e)t.bitrate>i&&(i=t.bitrate);return i>0?i:NaN}getBufferLength(t){const e=this.hls.media,i=t===ks?this.audioBuffer:this.videoBuffer;return i&&e?1e3*Ye.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){const{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}}}createFragmentLoader(){const{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}}}static uuid(){const t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}static serialize(t){const e=[],i=t=>!Number.isNaN(t)&&null!=t&&""!==t&&!1!==t,r=t=>Math.round(t),s=t=>100*r(t/100),n={br:r,d:r,bl:s,dl:s,mtp:s,nor:t=>encodeURIComponent(t),rtp:s,tb:r},a=Object.keys(t||{}).sort();for(const r of a){let s=t[r];if(!i(s))continue;if("v"===r&&1===s)continue;if("pr"==r&&1===s)continue;const a=n[r];a&&(s=a(s));const o=typeof s;let l;l="ot"===r||"sf"===r||"st"===r?`${r}=${s}`:"boolean"===o?r:"number"===o?`${r}=${s}`:`${r}=${JSON.stringify(s)}`,e.push(l)}return e.join(",")}static toHeaders(t){const e=Object.keys(t),i={},r=["Object","Request","Session","Status"],s=[{},{},{},{}],n={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3};for(const i of e)s[null!=n[i]?n[i]:1][i]=t[i];for(let t=0;t<s.length;t++){const e=Ps.serialize(s[t]);e&&(i[`CMCD-${r[t]}`]=e)}return i}static toQuery(t){return`CMCD=${encodeURIComponent(Ps.serialize(t))}`}static appendQueryToUri(t,e){if(!e)return t;const i=t.includes("?")?"&":"?";return`${t}${i}${e}`}}function xs(t,e,i,r){t&&Object.keys(e).forEach((s=>{const n=t.filter((t=>t.groupId===s)).map((t=>{const n=o({},t);return n.details=void 0,n.attrs=new v(n.attrs),n.url=n.attrs.URI=Os(t.url,t.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),n.groupId=n.attrs["GROUP-ID"]=e[s],n.attrs["PATHWAY-ID"]=r,n}));t.push(...n)}))}function Os(t,e,i,r){const{HOST:s,PARAMS:n,[i]:a}=r;let o;e&&(o=null==a?void 0:a[e],o&&(t=o));const l=new self.URL(t);return s&&!o&&(l.host=s),n&&Object.keys(n).sort().forEach((t=>{t&&l.searchParams.set(t,n[t])})),l.href}const Ms=/^age:\s*[\d.]+\s*$/im;class Fs{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new b,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,4!==t.readyState&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t)return;const i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0;const s=this.xhrSetup;s?Promise.resolve().then((()=>{if(!this.stats.aborted)return s(i,e.url)})).catch((t=>(i.open("GET",e.url,!0),s(i,e.url)))).then((()=>{this.stats.aborted||this.openAndSendXhr(i,e,t)})).catch((t=>{this.callbacks.onError({code:i.status,text:t.message},e,i,r)})):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);const r=this.context.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:n}=i.loadPolicy;if(r)for(const e in r)t.setRequestHeader(e,r[e]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&l(s)?s:n,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:i}=this;if(!t||!e)return;const r=e.readyState,s=this.config;if(!i.aborted&&r>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const r=e.status,n="text"!==e.responseType;if(r>=200&&r<300&&(n&&e.response||null!==e.responseText)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const s=n?e.response:e.responseText,a="arraybuffer"===e.responseType?s.byteLength:s.length;if(i.loaded=i.total=a,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first),!this.callbacks)return;const o=this.callbacks.onProgress;if(o&&o(i,t,s,e),!this.callbacks)return;const l={url:e.responseURL,data:s,code:r};this.callbacks.onSuccess(l,i,t,e)}else{const n=s.loadPolicy.errorRetry;Se(n,i.retry,!1,r)?this.retry(n):(p.error(`${r} while loading ${t.url}`),this.callbacks.onError({code:r,text:e.statusText},t,e,i))}}}loadtimeout(){var t;const e=null==(t=this.config)?void 0:t.loadPolicy.timeoutRetry;if(Se(e,this.stats.retry,!0))this.retry(e);else{p.warn(`timeout while loading ${this.context.url}`);const t=this.callbacks;t&&(this.abortInternal(),t.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:i}=this;this.retryDelay=Te(t,i.retry),i.retry++,p.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${e.url}, retrying ${i.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&Ms.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}const Ns=/(\d+)-(\d+)\/(\d+)/;class Us{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||Bs,this.controller=new self.AbortController,this.stats=new b}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){const t=this.response;null!=t&&t.ok||(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const s=function(t,e){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(o({},t.headers))};return t.rangeEnd&&i.headers.set("Range","bytes="+t.rangeStart+"-"+String(t.rangeEnd-1)),i}(t,this.controller.signal),n=i.onProgress,a="arraybuffer"===t.responseType,h=a?"byteLength":"length",{maxTimeToFirstByteMs:d,maxLoadTimeMs:c}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,s),self.clearTimeout(this.requestTimeout),e.timeout=d&&l(d)?d:c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,t,this.response)}),e.timeout),self.fetch(this.request).then((s=>{this.response=this.loader=s;const o=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=c,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,t,this.response)}),c-(o-r.loading.start)),!s.ok){const{status:t,statusText:e}=s;throw new $s(e||"fetch, bad network response",t,s)}return r.loading.first=o,r.total=function(t){const e=t.get("Content-Range");if(e){const t=function(t){const e=Ns.exec(t);if(e)return parseInt(e[2])-parseInt(e[1])+1}(e);if(l(t))return t}const i=t.get("Content-Length");if(i)return parseInt(i)}(s.headers)||r.total,n&&l(e.highWaterMark)?this.loadProgressively(s,r,t,e.highWaterMark,n):a?s.arrayBuffer():"json"===t.responseType?s.json():s.text()})).then((s=>{const{response:a}=this;self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const o=s[h];o&&(r.loaded=r.total=o);const d={url:a.url,data:s,code:a.status};n&&!l(e.highWaterMark)&&n(r,t,s,a),i.onSuccess(d,r,t,a)})).catch((e=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const s=e&&e.code||0,n=e?e.message:null;i.onError({code:s,text:n},t,e?e.details:null,r)}))}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i,r=0,s){const n=new Ar,a=t.body.getReader(),o=()=>a.read().then((a=>{if(a.done)return n.dataLength&&s(e,i,n.flush(),t),Promise.resolve(new ArrayBuffer(0));const l=a.value,h=l.length;return e.loaded+=h,h<r||n.dataLength?(n.push(l),n.dataLength>=r&&s(e,i,n.flush(),t)):s(e,i,l,t),o()})).catch((()=>Promise.reject()));return o()}}function Bs(t,e){return new self.Request(t.url,e)}class $s extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}const Gs=/\s/,Ks={newCue(t,e,i,r){const s=[];let n,a,o,l,h;const d=self.VTTCue||self.TextTrackCue;for(let u=0;u<r.rows.length;u++)if(n=r.rows[u],o=!0,l=0,h="",!n.isEmpty()){var c;for(let t=0;t<n.chars.length;t++)Gs.test(n.chars[t].uchar)&&o?l++:(h+=n.chars[t].uchar,o=!1);n.cueStartTime=e,e===i&&(i+=1e-4),l>=16?l--:l++;const r=ls(h.trim()),f=fs(e,i,r);null!=t&&null!=(c=t.cues)&&c.getCueById(f)||(a=new d(e,i,r),a.id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),s.push(a))}return t&&s.length&&(s.sort(((t,e)=>"auto"===t.line||"auto"===e.line?0:t.line>8&&e.line>8?e.line-t.line:t.line-e.line)),s.forEach((e=>Xt(t,e)))),s}},Hs=n(n({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Fs,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=-1,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=t;const e=t.config;this.bwEstimator=new _r(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate),this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(h.FRAG_LOADING,this.onFragLoading,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this)}unregisterListeners(){const{hls:t}=this;t.off(h.FRAG_LOADING,this.onFragLoading,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null}onFragLoading(t,e){var i;const r=e.frag;this.ignoreFragment(r)||(this.fragCurrent=r,this.partCurrent=null!=(i=e.part)?i:null,this.clearTimer(),this.timer=self.setInterval(this.onCheck,100))}onLevelSwitching(t,e){this.clearTimer()}getTimeToLoadFrag(t,e,i,r){return t+i/e+(r?this.lastLevelLoadSec:0)}onLevelLoaded(t,e){const i=this.hls.config,{total:r,bwEstimate:s}=e.stats;l(r)&&l(s)&&(this.lastLevelLoadSec=8*r/s),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}_abandonRulesCheck(){const{fragCurrent:t,partCurrent:e,hls:i}=this,{autoLevelEnabled:r,media:s}=i;if(!t||!s)return;const n=performance.now(),a=e?e.stats:t.stats,o=e?e.duration:t.duration,d=n-a.loading.start;if(a.aborted||a.loaded&&a.loaded===a.total||0===t.level)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!r||s.paused||!s.playbackRate||!s.readyState)return;const c=i.mainForwardBufferInfo;if(null===c)return;const u=this.bwEstimator.getEstimateTTFB(),f=Math.abs(s.playbackRate);if(d<=Math.max(u,o/(2*f)*1e3))return;const g=c.len/f;if(g>=2*o/f)return;const m=a.loading.first?a.loading.first-a.loading.start:-1,y=a.loaded&&m>-1,v=this.bwEstimator.getEstimate(),{levels:E,minAutoLevel:T}=i,b=E[t.level],S=a.total||Math.max(a.loaded,Math.round(o*b.maxBitrate/8));let w=d-m;w<1&&y&&(w=Math.min(d,8*a.loaded/v));const R=y?1e3*a.loaded/w:0,_=R?(S-a.loaded)/R:8*S/v+u/1e3;if(_<=g)return;const A=R?8*R:v;let L,C=Number.POSITIVE_INFINITY;for(L=t.level-1;L>T;L--){const t=E[L].maxBitrate;if(C=this.getTimeToLoadFrag(u/1e3,A,o*t,!E[L].details),C<g)break}C>=_||C>10*o||(i.nextLoadLevel=L,y?this.bwEstimator.sample(d-Math.min(u,m),a.loaded):this.bwEstimator.sampleTTFB(d),this.clearTimer(),p.warn(`[abr] Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} is loading too slowly;\n      Time to underbuffer: ${g.toFixed(3)} s\n      Estimated load time for current fragment: ${_.toFixed(3)} s\n      Estimated load time for down switch fragment: ${C.toFixed(3)} s\n      TTFB estimate: ${m}\n      Current BW estimate: ${l(v)?(v/1024).toFixed(3):"Unknown"} Kb/s\n      New BW estimate: ${(this.bwEstimator.getEstimate()/1024).toFixed(3)} Kb/s\n      Aborting and switching to level ${L}`),t.loader&&(this.fragCurrent=this.partCurrent=null,t.abortRequests()),i.trigger(h.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:e,stats:a}))}onFragLoaded(t,{frag:e,part:i}){const r=i?i.stats:e.stats;if(e.type===jt.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),this.lastLoadedFragLevel=e.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const t=i?i.duration:e.duration,s=this.hls.levels[e.level],n=(s.loaded?s.loaded.bytes:0)+r.loaded,a=(s.loaded?s.loaded.duration:0)+t;s.loaded={bytes:n,duration:a},s.realBitrate=Math.round(8*n/a)}if(e.bitrateTest){const t={stats:r,frag:e,part:i,id:e.type};this.onFragBuffered(h.FRAG_BUFFERED,t),e.bitrateTest=!1}}}onFragBuffered(t,e){const{frag:i,part:r}=e,s=null!=r&&r.stats.loaded?r.stats:i.stats;if(s.aborted)return;if(this.ignoreFragment(i))return;const n=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(n,s.loaded),s.bwEstimate=this.bwEstimator.getEstimate(),i.bitrateTest?this.bitrateTestDelay=n/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==jt.MAIN||"initSegment"===t.sn}clearTimer(){self.clearInterval(this.timer)}get nextAutoLevel(){const t=this._nextAutoLevel,e=this.bwEstimator;if(-1!==t&&!e.canEstimate())return t;let i=this.getNextABRAutoLevel();if(-1!==t){const e=this.hls.levels;if(e.length>Math.max(t,i)&&e[t].loadError<=e[i].loadError)return t}return-1!==t&&(i=Math.min(t,i)),i}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:i}=this,{maxAutoLevel:r,config:s,minAutoLevel:n,media:a}=i,o=e?e.duration:t?t.duration:0,l=a&&0!==a.playbackRate?Math.abs(a.playbackRate):1,h=this.bwEstimator?this.bwEstimator.getEstimate():s.abrEwmaDefaultEstimate,d=i.mainForwardBufferInfo,c=(d?d.len:0)/l;let u=this.findBestLevel(h,n,r,c,s.abrBandWidthFactor,s.abrBandWidthUpFactor);if(u>=0)return u;p.trace(`[abr] ${c?"rebuffering expected":"buffer is empty"}, finding optimal quality level`);let f=o?Math.min(o,s.maxStarvationDelay):s.maxStarvationDelay,g=s.abrBandWidthFactor,m=s.abrBandWidthUpFactor;if(!c){const t=this.bitrateTestDelay;t&&(f=(o?Math.min(o,s.maxLoadingDelay):s.maxLoadingDelay)-t,p.trace(`[abr] bitrate test took ${Math.round(1e3*t)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),g=m=1)}return u=this.findBestLevel(h,n,r,c+f,g,m),Math.max(u,0)}findBestLevel(t,e,i,r,s,n){var a;const{fragCurrent:o,partCurrent:h,lastLoadedFragLevel:d}=this,{levels:c}=this.hls,u=c[d],f=!(null==u||null==(a=u.details)||!a.live),g=null==u?void 0:u.codecSet,m=h?h.duration:o?o.duration:0,y=this.bwEstimator.getEstimateTTFB()/1e3;let v=e,E=-1;for(let a=i;a>=e;a--){const e=c[a];if(!e||g&&e.codecSet!==g){e&&(v=Math.min(a,v),E=Math.max(a,E));continue}-1!==E&&p.trace(`[abr] Skipped level(s) ${v}-${E} with CODECS:"${c[E].attrs.CODECS}"; not compatible with "${u.attrs.CODECS}"`);const i=e.details,o=(h?null==i?void 0:i.partTarget:null==i?void 0:i.averagetargetduration)||m;let T;T=a<=d?s*t:n*t;const b=c[a].maxBitrate,S=this.getTimeToLoadFrag(y,T,b*o,void 0===i);if(p.trace(`[abr] level:${a} adjustedbw-bitrate:${Math.round(T-b)} avgDuration:${o.toFixed(1)} maxFetchDuration:${r.toFixed(1)} fetchDuration:${S.toFixed(1)}`),T>b&&(0===S||!l(S)||f&&!this.bitrateTestDelay||S<r))return a}return-1}set nextAutoLevel(t){this._nextAutoLevel=t}},bufferController:class{constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=()=>{const{media:t,mediaSource:e}=this;p.log("[buffer-controller]: Media source opened"),t&&(t.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(h.MEDIA_ATTACHED,{media:t})),e&&e.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{p.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=()=>{p.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=()=>{const{media:t,_objectUrl:e}=this;t&&t.src!==e&&p.error(`Media element src was set while attaching MediaSource (${e} > ${t.src})`)},this.hls=t,this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null}registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.BUFFER_RESET,this.onBufferReset,this),t.on(h.BUFFER_APPENDING,this.onBufferAppending,this),t.on(h.BUFFER_CODECS,this.onBufferCodecs,this),t.on(h.BUFFER_EOS,this.onBufferEos,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(h.FRAG_PARSED,this.onFragParsed,this),t.on(h.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.BUFFER_RESET,this.onBufferReset,this),t.off(h.BUFFER_APPENDING,this.onBufferAppending,this),t.off(h.BUFFER_CODECS,this.onBufferCodecs,this),t.off(h.BUFFER_EOS,this.onBufferEos,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(h.FRAG_PARSED,this.onFragParsed,this),t.off(h.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new Dr(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null}onManifestParsed(t,e){let i=2;(e.audio&&!e.video||!e.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.details=null,p.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(t,e){const i=this.media=e.media;if(i&&Pr){const t=this.mediaSource=new Pr;t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),i.src=self.URL.createObjectURL(t),this._objectUrl=i.src,i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:t,mediaSource:e,_objectUrl:i}=this;if(e){if(p.log("[buffer-controller]: media source detaching"),"open"===e.readyState)try{e.endOfStream()}catch(t){p.warn(`[buffer-controller]: onMediaDetaching: ${t.message} while calling endOfStream`)}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),t&&(t.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),t.src===i?(t.removeAttribute("src"),t.load()):p.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(h.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((t=>{const e=this.sourceBuffer[t];try{e&&(this.removeBufferListeners(t),this.mediaSource&&this.mediaSource.removeSourceBuffer(e),this.sourceBuffer[t]=void 0)}catch(e){p.warn(`[buffer-controller]: Failed to reset the ${t} buffer`,e)}})),this._initSourceBuffer()}onBufferCodecs(t,e){const i=this.getSourceBufferTypes().length;Object.keys(e).forEach((t=>{if(i){const i=this.tracks[t];if(i&&"function"==typeof i.buffer.changeType){const{id:r,codec:s,levelCodec:n,container:a,metadata:o}=e[t],l=(i.levelCodec||i.codec).replace(xr,"$1"),h=(n||s).replace(xr,"$1");if(l!==h){const e=`${a};codecs=${n||s}`;this.appendChangeType(t,e),p.log(`[buffer-controller]: switching codec ${l} to ${h}`),this.tracks[t]={buffer:i.buffer,codec:s,container:a,levelCodec:n,metadata:o,id:r}}}}else this.pendingTracks[t]=e[t]})),i||(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())}appendChangeType(t,e){const{operationQueue:i}=this,r={execute:()=>{const r=this.sourceBuffer[t];r&&(p.log(`[buffer-controller]: changing ${t} sourceBuffer type to ${e}`),r.changeType(e)),i.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:e=>{p.warn(`[buffer-controller]: Failed to change ${t} SourceBuffer type`,e)}};i.append(r,t)}onBufferAppending(t,e){const{hls:i,operationQueue:r,tracks:s}=this,{data:n,type:a,frag:o,part:l,chunkMeta:u}=e,f=u.buffering[a],g=self.performance.now();f.start=g;const m=o.stats.buffering,y=l?l.stats.buffering:null;0===m.start&&(m.start=g),y&&0===y.start&&(y.start=g);const v=s.audio;let E=!1;"audio"===a&&"audio/mpeg"===(null==v?void 0:v.container)&&(E=!this.lastMpegAudioChunk||1===u.id||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);const T=o.start,b={execute:()=>{if(f.executeStart=self.performance.now(),E){const t=this.sourceBuffer[a];if(t){const e=T-t.timestampOffset;Math.abs(e)>=.1&&(p.log(`[buffer-controller]: Updating audio SourceBuffer timestampOffset to ${T} (delta: ${e}) sn: ${o.sn})`),t.timestampOffset=T)}}this.appendExecutor(n,a)},onStart:()=>{},onComplete:()=>{const t=self.performance.now();f.executeEnd=f.end=t,0===m.first&&(m.first=t),y&&0===y.first&&(y.first=t);const{sourceBuffer:e}=this,i={};for(const t in e)i[t]=Ye.getBuffered(e[t]);this.appendError=0,this.hls.trigger(h.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:u,parent:o.type,timeRanges:i})},onError:t=>{p.error(`[buffer-controller]: Error encountered while trying to append to the ${a} SourceBuffer`,t);const e={type:d.MEDIA_ERROR,parent:o.type,details:c.BUFFER_APPEND_ERROR,frag:o,part:l,chunkMeta:u,error:t,err:t,fatal:!1};t.code===DOMException.QUOTA_EXCEEDED_ERR?e.details=c.BUFFER_FULL_ERROR:(this.appendError++,e.details=c.BUFFER_APPEND_ERROR,this.appendError>i.config.appendErrorMaxRetry&&(p.error(`[buffer-controller]: Failed ${i.config.appendErrorMaxRetry} times to append segment in sourceBuffer`),e.fatal=!0)),i.trigger(h.ERROR,e)}};r.append(b,a)}onBufferFlushing(t,e){const{operationQueue:i}=this,r=t=>({execute:this.removeExecutor.bind(this,t,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(h.BUFFER_FLUSHED,{type:t})},onError:e=>{p.warn(`[buffer-controller]: Failed to remove from ${t} SourceBuffer`,e)}});e.type?i.append(r(e.type),e.type):this.getSourceBufferTypes().forEach((t=>{i.append(r(t),t)}))}onFragParsed(t,e){const{frag:i,part:r}=e,s=[],n=r?r.elementaryStreams:i.elementaryStreams;n[S.AUDIOVIDEO]?s.push("audiovideo"):(n[S.AUDIO]&&s.push("audio"),n[S.VIDEO]&&s.push("video")),0===s.length&&p.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers((()=>{const t=self.performance.now();i.stats.buffering.end=t,r&&(r.stats.buffering.end=t);const e=r?r.stats:i.stats;this.hls.trigger(h.FRAG_BUFFERED,{frag:i,part:r,stats:e,id:i.type})}),s)}onFragChanged(t,e){this.flushBackBuffer()}onBufferEos(t,e){this.getSourceBufferTypes().reduce(((t,i)=>{const r=this.sourceBuffer[i];return!r||e.type&&e.type!==i||(r.ending=!0,r.ended||(r.ended=!0,p.log(`[buffer-controller]: ${i} sourceBuffer now EOS`))),t&&!(r&&!r.ended)}),!0)&&(p.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((t=>{const e=this.sourceBuffer[t];e&&(e.ending=!1)}));const{mediaSource:t}=this;t&&"open"===t.readyState?(p.log("[buffer-controller]: Calling mediaSource.endOfStream()"),t.endOfStream()):t&&p.info(`[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: ${t.readyState}`)})))}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}flushBackBuffer(){const{hls:t,details:e,media:i,sourceBuffer:r}=this;if(!i||null===e)return;const s=this.getSourceBufferTypes();if(!s.length)return;const n=e.live&&null!==t.config.liveBackBufferLength?t.config.liveBackBufferLength:t.config.backBufferLength;if(!l(n)||n<0)return;const a=i.currentTime,o=e.levelTargetDuration,d=Math.max(n,o),c=Math.floor(a/o)*o-d;s.forEach((i=>{const s=r[i];if(s){const r=Ye.getBuffered(s);if(r.length>0&&c>r.start(0)){if(t.trigger(h.BACK_BUFFER_REACHED,{bufferEnd:c}),e.live)t.trigger(h.LIVE_BACK_BUFFER_REACHED,{bufferEnd:c});else if(s.ended&&r.end(r.length-1)-a<2*o)return void p.info(`[buffer-controller]: Cannot flush ${i} back buffer while SourceBuffer is in ended state`);t.trigger(h.BUFFER_FLUSHING,{startOffset:0,endOffset:c,type:i})}}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:t,hls:e,media:i,mediaSource:r}=this,s=t.fragments[0].start+t.totalduration,n=i.duration,a=l(r.duration)?r.duration:0;t.live&&e.config.liveDurationInfinity?(p.log("[buffer-controller]: Media Source duration is set to Infinity"),r.duration=1/0,this.updateSeekableRange(t)):(s>a&&s>n||!l(n))&&(p.log(`[buffer-controller]: Updating Media Source duration to ${s.toFixed(3)}`),r.duration=s)}updateSeekableRange(t){const e=this.mediaSource,i=t.fragments;if(i.length&&t.live&&null!=e&&e.setLiveSeekableRange){const r=Math.max(0,i[0].start),s=Math.max(r,r+t.totalduration);e.setLiveSeekableRange(r,s)}}checkPendingTracks(){const{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:i}=this,r=Object.keys(i).length;if(r&&!t||2===r){this.createSourceBuffers(i),this.pendingTracks={};const t=this.getSourceBufferTypes();if(t.length)this.hls.trigger(h.BUFFER_CREATED,{tracks:this.tracks}),t.forEach((t=>{e.executeNext(t)}));else{const t=new Error("could not create source buffer for media codec(s)");this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:t,reason:t.message})}}}createSourceBuffers(t){const{sourceBuffer:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const r in t)if(!e[r]){const s=t[r];if(!s)throw Error(`source buffer exists for track ${r}, however track does not`);const n=s.levelCodec||s.codec,a=`${s.container};codecs=${n}`;p.log(`[buffer-controller]: creating sourceBuffer(${a})`);try{const t=e[r]=i.addSourceBuffer(a),o=r;this.addBufferListener(o,"updatestart",this._onSBUpdateStart),this.addBufferListener(o,"updateend",this._onSBUpdateEnd),this.addBufferListener(o,"error",this._onSBUpdateError),this.tracks[r]={buffer:t,codec:n,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(t){p.error(`[buffer-controller]: error while trying to add sourceBuffer: ${t.message}`),this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:t,mimeType:a})}}}_onSBUpdateStart(t){const{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){const{operationQueue:e}=this;e.current(t).onComplete(),e.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){const i=new Error(`${t} SourceBuffer error`);p.error(`[buffer-controller]: ${i}`,e),this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.BUFFER_APPENDING_ERROR,error:i,fatal:!1});const r=this.operationQueue.current(t);r&&r.onError(e)}removeExecutor(t,e,i){const{media:r,mediaSource:s,operationQueue:n,sourceBuffer:a}=this,o=a[t];if(!r||!s||!o)return p.warn(`[buffer-controller]: Attempting to remove from the ${t} SourceBuffer, but it does not exist`),void n.shiftAndExecuteNext(t);const h=l(r.duration)?r.duration:1/0,d=l(s.duration)?s.duration:1/0,c=Math.max(0,e),u=Math.min(i,h,d);u>c&&!o.ending?(o.ended=!1,p.log(`[buffer-controller]: Removing [${c},${u}] from the ${t} SourceBuffer`),o.remove(c,u)):n.shiftAndExecuteNext(t)}appendExecutor(t,e){const{operationQueue:i,sourceBuffer:r}=this,s=r[e];if(!s)return p.warn(`[buffer-controller]: Attempting to append to the ${e} SourceBuffer, but it does not exist`),void i.shiftAndExecuteNext(e);s.ended=!1,s.appendBuffer(t)}blockBuffers(t,e=this.getSourceBufferTypes()){if(!e.length)return p.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(t);const{operationQueue:i}=this,r=e.map((t=>i.appendBlocker(t)));Promise.all(r).then((()=>{t(),e.forEach((t=>{const e=this.sourceBuffer[t];null!=e&&e.updating||i.shiftAndExecuteNext(t)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,i){const r=this.sourceBuffer[t];if(!r)return;const s=i.bind(this,t);this.listeners[t].push({event:e,listener:s}),r.addEventListener(e,s)}removeBufferListeners(t){const e=this.sourceBuffer[t];e&&this.listeners[t].forEach((t=>{e.removeEventListener(t.event,t.listener)}))}},capLevelController:As,errorController:class{constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=p.log.bind(p,"[info]:"),this.warn=p.warn.bind(p,"[warning]:"),this.error=p.error.bind(p,"[error]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(h.ERROR,this.onError,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this)}unregisterListeners(){const t=this.hls;t&&(t.off(h.ERROR,this.onError,this),t.off(h.ERROR,this.onErrorOut,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){this.playlistError=0}stopLoad(){}getVariantLevelIndex(t){return(null==t?void 0:t.type)===jt.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onError(t,e){var i;if(e.fatal)return;const r=this.hls,s=e.context;switch(e.details){case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:return void(e.errorAction=this.getFragRetryOrSwitchAction(e));case c.FRAG_GAP:case c.FRAG_PARSING_ERROR:case c.FRAG_DECRYPT_ERROR:return e.errorAction=this.getFragRetryOrSwitchAction(e),void(e.errorAction.action=2);case c.LEVEL_EMPTY_ERROR:case c.LEVEL_PARSING_ERROR:{var n,a;const t=e.parent===jt.MAIN?e.level:r.loadLevel;e.details===c.LEVEL_EMPTY_ERROR&&null!=(n=e.context)&&null!=(a=n.levelDetails)&&a.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,t):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t))}return;case c.LEVEL_LOAD_ERROR:case c.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==s?void 0:s.level)&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,s.level)));case c.AUDIO_TRACK_LOAD_ERROR:case c.AUDIO_TRACK_LOAD_TIMEOUT:case c.SUBTITLE_LOAD_ERROR:case c.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const t=r.levels[r.loadLevel];if(t&&(s.type===Vt.AUDIO_TRACK&&s.groupId===t.audioGroupId||s.type===Vt.SUBTITLE_TRACK&&s.groupId===t.textGroupId))return e.errorAction=this.getPlaylistRetryOrSwitchAction(e,r.loadLevel),e.errorAction.action=2,void(e.errorAction.flags=1)}return;case c.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const t=r.levels[r.loadLevel],i=null==t?void 0:t.attrs["HDCP-LEVEL"];i&&(e.errorAction={action:2,flags:2,hdcpLevel:i})}return;case c.BUFFER_ADD_CODEC_ERROR:case c.REMUX_ALLOC_ERROR:return void(e.errorAction=this.getLevelSwitchAction(e,null!=(i=e.level)?i:r.loadLevel));case c.INTERNAL_EXCEPTION:case c.BUFFER_APPENDING_ERROR:case c.BUFFER_APPEND_ERROR:case c.BUFFER_FULL_ERROR:case c.LEVEL_SWITCH_ERROR:case c.BUFFER_STALLED_ERROR:case c.BUFFER_SEEK_OVER_HOLE:case c.BUFFER_NUDGE_ON_STALL:return void(e.errorAction={action:0,flags:0})}if(e.type===d.KEY_SYSTEM_ERROR){const t=this.getVariantLevelIndex(e.frag);return e.levelRetry=!1,void(e.errorAction=this.getLevelSwitchAction(e,t))}}getPlaylistRetryOrSwitchAction(t,e){var i,r;const s=Ee(this.hls.config.playlistLoadPolicy,t),n=this.playlistError++,a=null==(i=t.response)?void 0:i.code;return Se(s,n,ve(t),a)?{action:5,flags:0,retryConfig:s,retryCount:n}:null!=(r=t.context)&&r.deliveryDirectives?{action:0,flags:0,retryConfig:s||{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},retryCount:n}:this.getLevelSwitchAction(t,e)}getFragRetryOrSwitchAction(t){const e=this.hls,i=this.getVariantLevelIndex(t.frag),r=e.levels[i],{fragLoadPolicy:s,keyLoadPolicy:n}=e.config,a=Ee(t.details.startsWith("key")?n:s,t),o=e.levels.reduce(((t,e)=>t+e.fragmentError),0);if(r){var l;t.details!==c.FRAG_GAP&&r.fragmentError++;const e=null==(l=t.response)?void 0:l.code;if(Se(a,o,ve(t),e))return{action:5,flags:0,retryConfig:a,retryCount:o}}const h=this.getLevelSwitchAction(t,i);return a&&(h.retryConfig=a,h.retryCount=o),h}getLevelSwitchAction(t,e){const i=this.hls;null==e&&(e=i.loadLevel);const r=this.hls.levels[e];if(r&&(r.loadError++,i.autoLevelEnabled)){var s,n;let e=-1;const a=i.levels,o=null==(s=t.frag)?void 0:s.type,{type:l,groupId:h}=null!=(n=t.context)?n:{};for(let s=a.length;s--;){const n=(s+i.loadLevel)%a.length;if(n!==i.loadLevel&&0===a[n].loadError){const i=a[n];if(t.details===c.FRAG_GAP&&t.frag){const e=a[n].details;if(e){const i=Re(t.frag,e.fragments,t.frag.start);if(null!=i&&i.gap)continue}}else{if(l===Vt.AUDIO_TRACK&&h===i.audioGroupId||l===Vt.SUBTITLE_TRACK&&h===i.textGroupId)continue;if(o===jt.AUDIO&&r.audioGroupId===i.audioGroupId||o===jt.SUBTITLE&&r.textGroupId===i.textGroupId)continue}e=n;break}}if(e>-1&&i.loadLevel!==e)return t.levelRetry=!0,{action:2,flags:0,nextAutoLevel:e}}return{action:2,flags:1}}onErrorOut(t,e){var i;switch(null==(i=e.errorAction)?void 0:i.action){case 0:break;case 2:this.sendAlternateToPenaltyBox(e),e.errorAction.resolved||e.details===c.FRAG_GAP||(e.fatal=!0)}e.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(t){const e=this.hls,i=t.errorAction;if(!i)return;const{flags:r,hdcpLevel:s,nextAutoLevel:n}=i;switch(r){case 0:this.switchLevel(t,n);break;case 1:i.resolved||(i.resolved=this.redundantFailover(t));break;case 2:s&&(e.maxHdcpLevel=ae[ae.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(t,n)}switchLevel(t,e){void 0!==e&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}redundantFailover(t){const{hls:e,penalizedRenditions:i}=this,r=t.parent===jt.MAIN?t.level:e.loadLevel,s=e.levels[r],n=s.url.length,a=t.frag?t.frag.urlId:s.urlId;s.urlId!==a||t.frag&&!s.details||this.penalizeRendition(s,t);for(let o=1;o<n;o++){const l=(a+o)%n,h=i[l];if(!h||Le(h,t,i[a]))return this.warn(`Switching to Redundant Stream ${l+1}/${n}: "${s.url[l]}" after ${t.details}`),this.playlistError=0,e.levels.forEach((t=>{t.urlId=l})),e.nextLoadLevel=r,!0}return!1}penalizeRendition(t,e){const{penalizedRenditions:i}=this,r=i[t.urlId]||{lastErrorPerfMs:0,errors:[],details:void 0};r.lastErrorPerfMs=performance.now(),r.errors.push(e),r.details=t.details,i[t.urlId]=r}},fpsController:class{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const i=this.hls.config;if(i.capLevelOnFPSDrop){const t=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=t,t&&"function"==typeof t.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,i){const r=performance.now();if(e){if(this.lastTime){const t=r-this.lastTime,s=i-this.lastDroppedFrames,n=e-this.lastDecodedFrames,a=1e3*s/t,o=this.hls;if(o.trigger(h.FPS_DROP,{currentDropped:s,currentDecoded:n,totalDroppedFrames:i}),a>0&&s>o.config.fpsDroppedMonitoringThreshold*n){let t=o.currentLevel;p.warn("drop FPS ratio greater than max allowed value for currentLevel: "+t),t>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=t)&&(t-=1,o.trigger(h.FPS_DROP_LEVEL_CAPPING,{level:t,droppedLevel:o.currentLevel}),o.autoLevelCapping=t,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:U,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:Ks,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends mi{constructor(t,e,i){super(t,e,i,"[subtitle-stream-controller]",jt.SUBTITLE),this.levels=[],this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null}_registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.ERROR,this.onError,this),t.on(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(h.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.ERROR,this.onError,this),t.off(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(h.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(h.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(t){this.stopLoad(),this.state=ni,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){const{frag:i,success:r}=e;if(this.fragPrevious=i,this.state=ni,!r)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let n;const a=i.start;for(let t=0;t<s.length;t++)if(a>=s[t].start&&a<=s[t].end){n=s[t];break}const o=i.start+i.duration;n?n.end=o:(n={start:a,end:o},s.push(n)),this.fragmentTracker.fragBuffered(i)}onBufferFlushing(t,e){const{startOffset:i,endOffset:r}=e;if(0===i&&r!==Number.POSITIVE_INFINITY){const{currentTrackId:t,levels:s}=this;if(!s.length||!s[t]||!s[t].details)return;const n=r-s[t].details.targetduration;if(n<=0)return;e.endOffsetSubtitles=Math.max(0,n),this.tracksBuffered.forEach((t=>{for(let e=0;e<t.length;)if(t[e].end<=n)t.shift();else{if(!(t[e].start<n))break;t[e].start=n,e++}})),this.fragmentTracker.removeFragmentsInRange(i,n,jt.SUBTITLE)}}onFragBuffered(t,e){var i;this.loadedmetadata||e.frag.type!==jt.MAIN||null!=(i=this.media)&&i.buffered.length&&(this.loadedmetadata=!0)}onError(t,e){const i=e.frag;(null==i?void 0:i.type)===jt.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==si&&(this.state=ni))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){Lr(this.levels,e)?this.levels=e.map((t=>new ce(t))):(this.tracksBuffered=[],this.levels=e.map((t=>{const e=new ce(t);return this.tracksBuffered[e.id]=[],e})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,jt.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(t,e){if(this.currentTrackId=e.id,!this.levels.length||-1===this.currentTrackId)return void this.clearInterval();const i=this.levels[this.currentTrackId];null!=i&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.setInterval(500)}onSubtitleTrackLoaded(t,e){var i;const{details:r,id:s}=e,{currentTrackId:n,levels:a}=this;if(!a.length)return;const o=a[n];if(s>=a.length||s!==n||!o)return;this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(r.live||null!=(i=o.details)&&i.live){const t=this.mainDetails;if(r.deltaUpdateFailed||!t)return;const e=t.fragments[0];o.details?(l=this.alignPlaylists(r,o.details),0===l&&e&&(l=e.start,pe(r,l))):r.hasProgramDateTime&&t.hasProgramDateTime?(Ze(r,t),l=r.fragments[0].start):e&&(l=e.start,pe(r,l))}o.details=r,this.levelLastLoaded=s,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(o.details,l),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===ni&&(Re(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0))}_handleFragmentLoadComplete(t){const{frag:e,payload:i}=t,r=e.decryptdata,s=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&r&&r.key&&r.iv&&"AES-128"===r.method){const t=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch((t=>{throw s.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((i=>{const r=performance.now();s.trigger(h.FRAG_DECRYPTED,{frag:e,payload:i,stats:{tstart:t,tdecrypt:r}})})).catch((t=>{this.warn(`${t.name}: ${t.message}`),this.state=ni}))}}doTick(){if(this.media){if(this.state===ni){const{currentTrackId:t,levels:e}=this,i=e[t];if(!e.length||!i||!i.details)return;const r=i.details,s=r.targetduration,{config:n}=this,a=this.getLoadPosition(),o=Ye.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],a-s,n.maxBufferHole),{end:l,len:h}=o,d=this.getFwdBufferInfo(this.media,jt.MAIN);if(h>this.getMaxBufferLength(null==d?void 0:d.len)+s)return;const c=r.fragments,u=c.length,f=r.edge;let g=null;const p=this.fragPrevious;if(l<f){const{maxFragLookUpTolerance:t}=n;g=Re(p,c,Math.max(c[0].start,l),t),!g&&p&&p.start<c[0].start&&(g=c[0])}else g=c[u-1];if(!g)return;g=this.mapToInitFragWhenRequired(g),this.fragmentTracker.getState(g)===xe&&this.loadFragment(g,i,l)}}else this.state=ni}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.max(e,t):e}loadFragment(t,e,i){this.fragCurrent=t,"initSegment"===t.sn?this._loadInitSegment(t,e):(this.startFragRequested=!0,super.loadFragment(t,e,i))}get mediaBufferTimeRanges(){return new Ir(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends Ce{constructor(t){super(t,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.trackChangeListener=()=>this.onTextTracksChanged(),this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes(this.trackId)}registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(h.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,t)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),kr(this.media.textTracks).forEach((t=>{Qt(t)})),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){const{id:i,details:r}=e,{trackId:s}=this,n=this.tracksInGroup[s];if(!n)return void this.warn(`Invalid subtitle track id ${i}`);const a=n.details;n.details=e.details,this.log(`subtitle track ${i} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(null==e||!e.textGroupIds)return;const i=e.textGroupIds[e.urlId],r=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;if(this.groupId!==i){const t=this.tracks.filter((t=>!i||t.groupId===i));this.tracksInGroup=t;const e=this.findTrackId(null==r?void 0:r.name)||this.findTrackId();this.groupId=i||null;const s={subtitleTracks:t};this.log(`Updating subtitle tracks, ${t.length} track(s) found in "${i}" group-id`),this.hls.trigger(h.SUBTITLE_TRACKS_UPDATED,s),-1!==e&&this.setSubtitleTrack(e,r)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId,r)}findTrackId(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const r=e[i];if((!this.selectDefaultTrack||r.default)&&(!t||t===r.name))return r.id}return-1}onError(t,e){!e.fatal&&e.context&&e.context.type===Vt.SUBTITLE_TRACK&&e.context.id===this.trackId&&e.context.groupId===this.groupId&&this.checkRetry(e)}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1;const e=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(t,e)}loadPlaylist(t){super.loadPlaylist();const e=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(e)){const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(h.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}toggleTrackModes(t){const{media:e,trackId:i}=this;if(!e)return;const r=kr(e.textTracks),s=r.filter((t=>t.groupId===this.groupId));if(-1===t)[].slice.call(r).forEach((t=>{t.mode="disabled"}));else{const t=s[i];t&&(t.mode="disabled")}const n=s[t];n&&(n.mode=this.subtitleDisplay?"showing":"hidden")}setSubtitleTrack(t,e){var i;const r=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=t);if(this.trackId!==t&&this.toggleTrackModes(t),this.trackId===t&&(-1===t||null!=(i=r[t])&&i.details)||t<-1||t>=r.length)return;this.clearTimer();const s=r[t];if(this.log(`Switching to subtitle-track ${t}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:"")),this.trackId=t,s){const{id:t,groupId:i="",name:r,type:n,url:a}=s;this.hls.trigger(h.SUBTITLE_TRACK_SWITCH,{id:t,groupId:i,name:r,type:n,url:a});const o=this.switchParams(s.url,null==e?void 0:e.details);this.loadPlaylist(o)}else this.hls.trigger(h.SUBTITLE_TRACK_SWITCH,{id:t})}onTextTracksChanged(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=-1;const e=kr(this.media.textTracks);for(let i=0;i<e.length;i++)if("hidden"===e[i].mode)t=i;else if("showing"===e[i].mode){t=i;break}this.subtitleTrack!==t&&(this.subtitleTrack=t)}},timelineController:class{constructor(t){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){const t=new Zr(this,"textTrack1"),e=new Zr(this,"textTrack2"),i=new Zr(this,"textTrack3"),r=new Zr(this,"textTrack4");this.cea608Parser1=new Xr(1,t,e),this.cea608Parser2=new Xr(3,i,r)}t.on(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(h.FRAG_LOADING,this.onFragLoading,this),t.on(h.FRAG_LOADED,this.onFragLoaded,this),t.on(h.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(h.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(h.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(h.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:t}=this;t.off(h.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(h.FRAG_LOADING,this.onFragLoading,this),t.off(h.FRAG_LOADED,this.onFragLoaded,this),t.off(h.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(h.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(h.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(h.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null}addCues(t,e,i,r,s){let n=!1;for(let t=s.length;t--;){const r=s[t],h=(a=r[0],o=r[1],l=e,d=i,Math.min(o,d)-Math.max(a,l));if(h>=0&&(r[0]=Math.min(r[0],e),r[1]=Math.max(r[1],i),n=!0,h/(i-e)>.5))return}var a,o,l,d;if(n||s.push([e,i]),this.config.renderTextTracksNatively){const s=this.captionsTracks[t];this.Cues.newCue(s,e,i,r)}else{const s=this.Cues.newCue(null,e,i,r);this.hls.trigger(h.CUES_PARSED,{type:"captions",cues:s,track:t})}}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){const{unparsedVttFrags:n}=this;"main"===i&&(this.initPTS[e.cc]={baseTime:r,timescale:s}),n.length&&(this.unparsedVttFrags=[],n.forEach((t=>{this.onFragLoaded(h.FRAG_LOADED,t)})))}getExistingTrack(t){const{media:e}=this;if(e)for(let i=0;i<e.textTracks.length;i++){const r=e.textTracks[i];if(r[t])return r}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;const{captionsProperties:e,captionsTracks:i,media:r}=this,{label:s,languageCode:n}=e[t],a=this.getExistingTrack(t);if(a)i[t]=a,Qt(i[t]),zt(i[t],r);else{const e=this.createTextTrack("captions",s,n);e&&(e[t]=!0,i[t]=e)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;const e=this.captionsProperties[t];if(!e)return;const i={_id:t,label:e.label,kind:"captions",default:!!e.media&&!!e.media.default,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=i,this.hls.trigger(h.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(t,e,i){const r=this.media;if(r)return r.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:t}=this;Object.keys(t).forEach((e=>{Qt(t[e]),delete t[e]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:t}=this;if(!t)return;const e=t.textTracks;if(e)for(let t=0;t<e.length;t++)Qt(e[t])}onSubtitleTracksUpdated(t,e){const i=e.subtitleTracks||[],r=i.some((t=>t.textCodec===gs));if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(Lr(this.tracks,i))return void(this.tracks=i);if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const t=this.media?this.media.textTracks:null;this.tracks.forEach(((e,i)=>{let r;if(t&&i<t.length){let i=null;for(let r=0;r<t.length;r++)if(_s(t[r],e)){i=t[r];break}i&&(r=i)}if(r)Qt(r);else{const t=this._captionsOrSubtitlesFromCharacteristics(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode="disabled")}r&&(r.groupId=e.groupId,this.textTracks.push(r))}))}else if(this.tracks.length){const t=this.tracks.map((t=>({label:t.name,kind:t.type.toLowerCase(),default:t.default,subtitleTrack:t})));this.hls.trigger(h.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:t})}}}_captionsOrSubtitlesFromCharacteristics(t){if(t.attrs.CHARACTERISTICS){const e=/transcribes-spoken-dialog/gi.test(t.attrs.CHARACTERISTICS),i=/describes-music-and-sound/gi.test(t.attrs.CHARACTERISTICS);if(e&&i)return"captions"}return"subtitles"}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach((t=>{const e=/(?:CC|SERVICE)([1-4])/.exec(t.instreamId);if(!e)return;const i=`textTrack${e[1]}`,r=this.captionsProperties[i];r&&(r.label=t.name,t.lang&&(r.languageCode=t.lang),r.media=t)}))}closedCaptionsForLevel(t){const e=this.hls.levels[t.level];return null==e?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){const{cea608Parser1:i,cea608Parser2:r,lastSn:s,lastPartIndex:n}=this;if(this.enabled&&i&&r&&e.frag.type===jt.MAIN){var a,o;const t=e.frag.sn,l=null!=(a=null==e||null==(o=e.part)?void 0:o.index)?a:-1;t===s+1||t===s&&l===n+1||(i.reset(),r.reset()),this.lastSn=t,this.lastPartIndex=l}}onFragLoaded(t,e){const{frag:i,payload:r}=e,{initPTS:s,unparsedVttFrags:n}=this;if(i.type===jt.SUBTITLE)if(r.byteLength){if(!s[i.cc])return n.push(e),void(s.length&&this.hls.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Missing initial subtitle PTS")}));const t=i.decryptdata,a="stats"in e;if(null==t||!t.encrypted||a){const t=this.tracks[i.level],e=this.vttCCs;e[i.cc]||(e[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),t&&t.textCodec===gs?this._parseIMSC1(i,r):this._parseVTTs(i,r,e)}}else this.hls.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(t,e){const i=this.hls;vs(e,this.initPTS[t.cc],(e=>{this._appendCues(e,t.level),i.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})}),(e=>{p.log(`Failed to parse IMSC1: ${e}`),i.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:e})}))}_parseVTTs(t,e,i){var r;const s=this.hls;!function(t,e,i,r,s,n,a){const o=new hs,h=Z(new Uint8Array(t)).trim().replace(ds,"\n").split("\n"),d=[],c=function(t,e=1){return er(t,tr,1/e)}(e.baseTime,e.timescale);let u,f="00:00.000",g=0,p=0,m=!0;o.oncue=function(t){const e=i[r];let n=i.ccOffset;const a=(g-c)/9e4;null!=e&&e.new&&(void 0!==p?n=i.ccOffset=e.start:function(t,e,i){let r=t[e],s=t[r.prevCC];if(!s||!s.new&&r.new)return t.ccOffset=t.presentationOffset=r.start,void(r.new=!1);for(;null!=(n=s)&&n.new;){var n;t.ccOffset+=r.start-s.start,r.new=!1,r=s,s=t[r.prevCC]}t.presentationOffset=i}(i,r,a)),a&&(n=a-i.presentationOffset);const o=t.endTime-t.startTime,l=or(9e4*(t.startTime+n-p),9e4*s)/9e4;t.startTime=Math.max(l,0),t.endTime=Math.max(l+o,0);const h=t.text.trim();t.text=decodeURIComponent(encodeURIComponent(h)),t.id||(t.id=fs(t.startTime,t.endTime,h)),t.endTime>0&&d.push(t)},o.onparsingerror=function(t){u=t},o.onflush=function(){u?a(u):n(d)},h.forEach((t=>{if(m){if(cs(t,"X-TIMESTAMP-MAP=")){m=!1,t.slice(16).split(",").forEach((t=>{cs(t,"LOCAL:")?f=t.slice(6):cs(t,"MPEGTS:")&&(g=parseInt(t.slice(7)))}));try{p=function(t){let e=parseInt(t.slice(-3));const i=parseInt(t.slice(-6,-4)),r=parseInt(t.slice(-9,-7)),s=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!(l(e)&&l(i)&&l(r)&&l(s)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${t}`);return e+=1e3*i,e+=6e4*r,e+=36e5*s,e}(f)/1e3}catch(t){u=t}return}""===t&&(m=!1)}o.parse(t+"\n")})),o.flush()}(null!=(r=t.initSegment)&&r.data?mt(t.initSegment.data,new Uint8Array(e)):e,this.initPTS[t.cc],i,t.cc,t.start,(e=>{this._appendCues(e,t.level),s.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})}),(i=>{this._fallbackToIMSC1(t,e),p.log(`Failed to parse VTT cue: ${i}`),s.trigger(h.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:i})}))}_fallbackToIMSC1(t,e){const i=this.tracks[t.level];i.textCodec||vs(e,this.initPTS[t.cc],(()=>{i.textCodec=gs,this._parseIMSC1(t,e)}),(()=>{i.textCodec="wvtt"}))}_appendCues(t,e){const i=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[e];if(!i||"disabled"===i.mode)return;t.forEach((t=>Xt(i,t)))}else{const r=this.tracks[e];if(!r)return;const s=r.default?"default":"subtitles"+e;i.trigger(h.CUES_PARSED,{type:"subtitles",cues:t,track:s})}}onFragDecrypted(t,e){const{frag:i}=e;if(i.type===jt.SUBTITLE){if(!this.initPTS[i.cc])return void this.unparsedVttFrags.push(e);this.onFragLoaded(h.FRAG_LOADED,e)}}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){const{cea608Parser1:i,cea608Parser2:r}=this;if(!this.enabled||!i||!r)return;const{frag:s,samples:n}=e;if(s.type!==jt.MAIN||"NONE"!==this.closedCaptionsForLevel(s))for(let t=0;t<n.length;t++){const e=n[t].bytes;if(e){const s=this.extractCea608Data(e);i.addData(n[t].pts,s[0]),r.addData(n[t].pts,s[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:i,endOffsetSubtitles:r,type:s}){const{media:n}=this;if(n&&!(n.currentTime<i)){if(!s||"video"===s){const{captionsTracks:t}=this;Object.keys(t).forEach((r=>Jt(t[r],e,i)))}if(this.config.renderTextTracksNatively&&0===e&&void 0!==r){const{textTracks:t}=this;Object.keys(t).forEach((i=>Jt(t[i],e,r)))}}}extractCea608Data(t){const e=[[],[]],i=31&t[0];let r=2;for(let s=0;s<i;s++){const i=t[r++],s=127&t[r++],n=127&t[r++];if((0!==s||0!==n)&&0!=(4&i)){const t=3&i;0!==t&&1!==t||(e[t].push(s),e[t].push(n))}}return e}},audioStreamController:class extends mi{constructor(t,e,i){super(t,e,i,"[audio-stream-controller]",jt.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:t}=this;t.on(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.LEVEL_LOADED,this.onLevelLoaded,this),t.on(h.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(h.ERROR,this.onError,this),t.on(h.BUFFER_RESET,this.onBufferReset,this),t.on(h.BUFFER_CREATED,this.onBufferCreated,this),t.on(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(h.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(h.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(h.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.LEVEL_LOADED,this.onLevelLoaded,this),t.off(h.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(h.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(h.ERROR,this.onError,this),t.off(h.BUFFER_RESET,this.onBufferReset,this),t.off(h.BUFFER_CREATED,this.onBufferCreated,this),t.off(h.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(h.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(h.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){if("main"===i){const t=e.cc;this.initPTS[e.cc]={baseTime:r,timescale:s},this.log(`InitPTS for cc: ${t} found from main: ${r}`),this.videoTrackCC=t,this.state===gi&&this.tick()}}startLoad(t){if(!this.levels)return this.startPosition=t,void(this.state=si);const e=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),e>0&&-1===t?(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e,this.state=ni):(this.loadedmetadata=!1,this.state=hi),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}doTick(){switch(this.state){case ni:this.doTickIdle();break;case hi:{var t;const{levels:e,trackId:i}=this,r=null==e||null==(t=e[i])?void 0:t.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=gi}break}case li:{var e;const t=performance.now(),i=this.retryDate;(!i||t>=i||null!=(e=this.media)&&e.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=ni);break}case gi:{const t=this.waitingData;if(t){const{frag:e,part:i,cache:r,complete:s}=t;if(void 0!==this.initPTS[e.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=oi;const t={frag:e,part:i,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(t),s&&super._handleFragmentLoadComplete(t)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${e.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const t=this.getLoadPosition(),i=Ye.bufferInfo(this.mediaBuffer,t,this.config.maxBufferHole);_e(i.end,this.config.maxFragLookUpTolerance,e)<0&&(this.log(`Waiting fragment cc (${e.cc}) @ ${e.start} cancelled because another fragment at ${i.end} is needed`),this.clearWaitingFragment())}}else this.state=ni}}this.onTickEnd()}clearWaitingFragment(){const t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=ni)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:t}=this;null!=t&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){const{hls:t,levels:e,media:i,trackId:r}=this,s=t.config;if(null==e||!e[r])return;if(!i&&(this.startFragRequested||!s.startFragPrefetch))return;const n=e[r],a=n.details;if(!a||a.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(a))return void(this.state=hi);const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,S.AUDIO,jt.AUDIO));const l=this.getFwdBufferInfo(o,jt.AUDIO);if(null===l)return;const{bufferedTrack:d,switchingTrack:c}=this;if(!c&&this._streamEnded(l,a))return t.trigger(h.BUFFER_EOS,{type:"audio"}),void(this.state=ui);const u=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,jt.MAIN),f=l.len,g=this.getMaxBufferLength(null==u?void 0:u.len);if(f>=g&&!c)return;const p=a.fragments[0].start;let m=l.end;if(c&&i){const t=this.getLoadPosition();d&&c.attrs!==d.attrs&&(m=t),a.PTSKnown&&t<p&&(l.end>p||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=p+.05)}let y=this.getNextFragment(m,a),v=!1;if(y&&this.isLoopLoading(y,m)&&(v=!!y.gap,y=this.getNextFragmentLoopLoading(y,a,l,jt.MAIN,g)),!y)return void(this.bufferFlushed=!0);const E=u&&y.start>u.end+a.targetduration;if(E||(null==u||!u.len)&&l.len){const t=this.fragmentTracker.getBufferedFrag(y.start,jt.MAIN);if(null===t)return;if(v||(v=!!t.gap||!!E&&0===u.len),E&&!v||v&&l.nextStart&&l.nextStart<t.end)return}this.loadFragment(y,n,m)}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.min(Math.max(e,t),this.config.maxMaxBufferLength):e}onMediaDetaching(){this.videoBuffer=null,super.onMediaDetaching()}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map((t=>new ce(t)))}onAudioTrackSwitching(t,e){const i=!!e.url;this.trackId=e.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?this.setInterval(100):this.resetTransmuxer(),i?(this.switchingTrack=e,this.state=ni):(this.switchingTrack=null,this.bufferedTrack=e,this.state=si),this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1,this.bufferedTrack=null,this.switchingTrack=null}onLevelLoaded(t,e){this.mainDetails=e.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(h.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(t,e){var i;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=e);const{levels:r}=this,{details:s,id:n}=e;if(!r)return void this.warn(`Audio tracks were reset while loading level ${n}`);this.log(`Track ${n} loaded [${s.startSN},${s.endSN}],duration:${s.totalduration}`);const a=r[n];let o=0;if(s.live||null!=(i=a.details)&&i.live){const t=this.mainDetails;if(s.fragments[0]||(s.deltaUpdateFailed=!0),s.deltaUpdateFailed||!t)return;!a.details&&s.hasProgramDateTime&&t.hasProgramDateTime?(Ze(s,t),o=s.fragments[0].start):o=this.alignPlaylists(s,a.details)}a.details=s,this.levelLastLoaded=n,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(a.details,o),this.state!==hi||this.waitForCdnTuneIn(s)||(this.state=ni),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{config:n,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const h=l.details;if(!h)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(i.start);const d=n.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let c=this.transmuxer;c||(c=this.transmuxer=new br(this.hls,jt.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[i.cc],f=null==(e=i.initSegment)?void 0:e.data;if(void 0!==u){const t=!1,e=r?r.index:-1,n=-1!==e,a=new ze(i.level,i.sn,i.stats.chunkCount,s.byteLength,e,n);c.push(s,f,d,"",i,r,h.totalduration,t,a,u)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${h.startSN} ,${h.endSN}],track ${a}`);const{cache:t}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new Ar,complete:!1};t.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=gi}}_handleFragmentLoadComplete(t){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(t,e){const i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),e.tracks.video&&(this.videoBuffer=e.tracks.video.buffer||null)}onFragBuffered(t,e){const{frag:i,part:r}=e;var s;if(i.type===jt.AUDIO)if(this.fragContextChanged(i))this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==i.sn){this.fragPrevious=i;const t=this.switchingTrack;t&&(this.bufferedTrack=t,this.switchingTrack=null,this.hls.trigger(h.AUDIO_TRACK_SWITCHED,n({},t)))}this.fragBufferedComplete(i,r)}else this.loadedmetadata||i.type!==jt.MAIN||null!=(s=this.videoBuffer||this.media)&&s.buffered.length&&(this.loadedmetadata=!0)}onError(t,e){var i;if(e.fatal)this.state=fi;else switch(e.details){case c.FRAG_GAP:case c.FRAG_PARSING_ERROR:case c.FRAG_DECRYPT_ERROR:case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(jt.AUDIO,e);break;case c.AUDIO_TRACK_LOAD_ERROR:case c.AUDIO_TRACK_LOAD_TIMEOUT:case c.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==hi||(null==(i=e.context)?void 0:i.type)!==Vt.AUDIO_TRACK||(this.state=ni);break;case c.BUFFER_FULL_ERROR:if(!e.parent||"audio"!==e.parent)return;this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case c.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}onBufferFlushed(t,{type:e}){e===S.AUDIO&&(this.bufferFlushed=!0,this.state===ui&&(this.state=ni))}_handleTransmuxComplete(t){var e;const i="audio",{hls:r}=this,{remuxResult:s,chunkMeta:n}=t,a=this.getCurrentContext(n);if(!a)return void this.resetWhenMissingContext(n);const{frag:l,part:d,level:c}=a,{details:u}=c,{audio:f,text:g,id3:p,initSegment:m}=s;if(!this.fragContextChanged(l)&&u){if(this.state=di,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),null!=m&&m.tracks&&(this._bufferInitSegment(m.tracks,l,n),r.trigger(h.FRAG_PARSING_INIT_SEGMENT,{frag:l,id:i,tracks:m.tracks})),f){const{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=f;d&&(d.elementaryStreams[S.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),l.setElementaryStreamInfo(S.AUDIO,t,e,i,r),this.bufferFragmentData(f,l,d,n)}if(null!=p&&null!=(e=p.samples)&&e.length){const t=o({id:i,frag:l,details:u},p);r.trigger(h.FRAG_PARSING_METADATA,t)}if(g){const t=o({id:i,frag:l,details:u},g);r.trigger(h.FRAG_PARSING_USERDATA,t)}}else this.fragmentTracker.removeFragment(l)}_bufferInitSegment(t,e,i){if(this.state!==di)return;t.video&&delete t.video;const r=t.audio;if(!r)return;r.levelCodec=r.codec,r.id="audio",this.log(`Init audio buffer, container:${r.container}, codecs[parsed]=[${r.codec}]`),this.hls.trigger(h.BUFFER_CODECS,t);const s=r.initSegment;if(null!=s&&s.byteLength){const t={type:"audio",frag:e,part:null,chunkMeta:i,parent:e.type,data:s};this.hls.trigger(h.BUFFER_APPENDING,t)}this.tick()}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);var s;this.fragCurrent=t,this.switchingTrack||r===xe||r===Me?"initSegment"===t.sn?this._loadInitSegment(t,e):null!=(s=e.details)&&s.live&&!this.initPTS[t.cc]?(this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=gi):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}completeAudioSwitch(t){const{hls:e,media:i,bufferedTrack:r}=this,s=null==r?void 0:r.attrs,a=t.attrs;i&&s&&(s.CHANNELS!==a.CHANNELS||s.NAME!==a.NAME||s.LANGUAGE!==a.LANGUAGE)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio")),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(h.AUDIO_TRACK_SWITCHED,n({},t))}},audioTrackController:class extends Ce{constructor(t){super(t,"[audio-track-controller]"),this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.LEVEL_LOADING,this.onLevelLoading,this),t.on(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.LEVEL_LOADING,this.onLevelLoading,this),t.off(h.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(h.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(h.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){const{id:i,groupId:r,details:s}=e,n=this.tracksInGroup[i];if(!n||n.groupId!==r)return void this.warn(`Track with id:${i} and group:${r} not found in active group ${n.groupId}`);const a=n.details;n.details=e.details,this.log(`audio-track ${i} "${n.name}" lang:${n.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(null==e||!e.audioGroupIds)return;const i=e.audioGroupIds[e.urlId];if(this.groupId!==i){this.groupId=i||null;const t=this.tracks.filter((t=>!i||t.groupId===i));this.selectDefaultTrack&&!t.some((t=>t.default))&&(this.selectDefaultTrack=!1),this.tracksInGroup=t;const e={audioTracks:t};this.log(`Updating audio tracks, ${t.length} track(s) found in group:${i}`),this.hls.trigger(h.AUDIO_TRACKS_UPDATED,e),this.selectInitialTrack()}else this.shouldReloadPlaylist(this.currentTrack)&&this.setAudioTrack(this.trackId)}onError(t,e){!e.fatal&&e.context&&e.context.type===Vt.AUDIO_TRACK&&e.context.id===this.trackId&&e.context.groupId===this.groupId&&(this.requestScheduled=-1,this.checkRetry(e))}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioTrack(t){const e=this.tracksInGroup;if(t<0||t>=e.length)return void this.warn("Invalid id passed to audio-track controller");this.clearTimer();const i=this.currentTrack;e[this.trackId];const r=e[t],{groupId:s,name:a}=r;if(this.log(`Switching to audio-track ${t} "${a}" lang:${r.lang} group:${s}`),this.trackId=t,this.currentTrack=r,this.selectDefaultTrack=!1,this.hls.trigger(h.AUDIO_TRACK_SWITCHING,n({},r)),r.details&&!r.details.live)return;const o=this.switchParams(r.url,null==i?void 0:i.details);this.loadPlaylist(o)}selectInitialTrack(){const t=this.tracksInGroup,e=this.findTrackId(this.currentTrack)|this.findTrackId(null);if(-1!==e)this.setAudioTrack(e);else{const e=new Error(`No track found for running audio group-ID: ${this.groupId} track count: ${t.length}`);this.warn(e.message),this.hls.trigger(h.ERROR,{type:d.MEDIA_ERROR,details:c.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:e})}}findTrackId(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const r=e[i];if(!this.selectDefaultTrack||r.default){if(!t||t.attrs["STABLE-RENDITION-ID"]===r.attrs["STABLE-RENDITION-ID"])return r.id;if(t.name===r.name&&t.lang===r.lang)return r.id}}return-1}loadPlaylist(t){super.loadPlaylist();const e=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(e)){const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}this.log(`loading audio-track playlist ${i} "${e.name}" lang:${e.lang} group:${r}`),this.clearTimer(),this.hls.trigger(h.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}},emeController:Cs,cmcdController:Ps,contentSteeringController:class{constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=p.log.bind(p,"[content-steering]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(h.MANIFEST_LOADING,this.onManifestLoading,this),t.on(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(h.MANIFEST_PARSED,this.onManifestParsed,this),t.on(h.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(h.MANIFEST_LOADING,this.onManifestLoading,this),t.off(h.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(h.MANIFEST_PARSED,this.onManifestParsed,this),t.off(h.ERROR,this.onError,this))}startLoad(){if(this.started=!0,self.clearTimeout(this.reloadTimer),this.enabled&&this.uri)if(this.updated){const t=Math.max(1e3*this.timeToLoad-(performance.now()-this.updated),0);this.scheduleRefresh(this.uri,t)}else this.loadSteeringManifest(this.uri)}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),self.clearTimeout(this.reloadTimer)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter((e=>e!==t)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:i}=e;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:i}=e;if(2===(null==i?void 0:i.action)&&1===i.flags){let t=this.pathwayPriority;const e=this.pathwayId;this.penalizedPathways[e]||(this.penalizedPathways[e]=performance.now()),!t&&this.levels&&(t=this.levels.reduce(((t,e)=>(-1===t.indexOf(e.pathwayId)&&t.push(e.pathwayId),t)),[])),t&&t.length>1&&(this.updatePathwayPriority(t),i.resolved=this.pathwayId!==e)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(0===e.length){const i=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length?(this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e):t}getLevelsForPathway(t){return null===this.levels?[]:this.levels.filter((e=>t===e.pathwayId))}updatePathwayPriority(t){let e;this.pathwayPriority=t;const i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach((t=>{r-i[t]>3e5&&delete i[t]}));for(let r=0;r<t.length;r++){const s=t[r];if(i[s])continue;if(s===this.pathwayId)return;const n=this.hls.nextLoadLevel,a=this.hls.levels[n];if(e=this.getLevelsForPathway(s),e.length>0){this.log(`Setting Pathway to "${s}"`),this.pathwayId=s,this.hls.trigger(h.LEVELS_UPDATED,{levels:e});const t=this.hls.levels[n];a&&t&&this.levels&&(t.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&t.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${t.bitrate}`),this.hls.nextLoadLevel=n);break}}}clonePathways(t){const e=this.levels;if(!e)return;const i={},r={};t.forEach((t=>{const{ID:s,"BASE-ID":n,"URI-REPLACEMENT":a}=t;if(e.some((t=>t.pathwayId===s)))return;const l=this.getLevelsForPathway(n).map((t=>{const e=o({},t);e.details=void 0,e.url=Os(t.uri,t.attrs["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a);const n=new v(t.attrs);n["PATHWAY-ID"]=s;const l=n.AUDIO&&`${n.AUDIO}_clone_${s}`,h=n.SUBTITLES&&`${n.SUBTITLES}_clone_${s}`;l&&(i[n.AUDIO]=l,n.AUDIO=l),h&&(r[n.SUBTITLES]=h,n.SUBTITLES=h),e.attrs=n;const d=new ce(e);return De(d,"audio",l),De(d,"text",h),d}));e.push(...l),xs(this.audioTracks,i,a,s),xs(this.subtitleTracks,r,a,s)}))}loadSteeringManifest(t){const e=this.hls.config,i=e.loader;let r;this.loader&&this.loader.destroy(),this.loader=new i(e);try{r=new self.URL(t)}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${t}`)}if("data:"!==r.protocol){const t=0|(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+t)}const s={responseType:"json",url:r.href},n=e.steeringManifestLoadPolicy.default,a=n.errorRetry||n.timeoutRetry||{},o={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(t,e,i,s)=>{this.log(`Loaded steering manifest: "${r}"`);const n=t.data;if(1!==n.VERSION)return void this.log(`Steering VERSION ${n.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=n.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=n;if(a)try{this.uri=new self.URL(a,r).href}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||i.url),o&&this.clonePathways(o),l&&this.updatePathwayPriority(l)},onError:(t,e,i,r)=>{if(this.log(`Error loading steering manifest: ${t.code} ${t.text} (${e.url})`),this.stopLoad(),410===t.code)return this.enabled=!1,void this.log(`Steering manifest ${e.url} no longer available`);let s=1e3*this.timeToLoad;if(429!==t.code)this.scheduleRefresh(this.uri||e.url,s);else{const t=this.loader;if("function"==typeof(null==t?void 0:t.getResponseHeader)){const e=t.getResponseHeader("Retry-After");e&&(s=1e3*parseFloat(e))}this.log(`Steering manifest ${e.url} rate limited`)}},onTimeout:(t,e,i)=>{this.log(`Timeout loading steering manifest (${e.url})`),this.scheduleRefresh(this.uri||e.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(s,o,l)}scheduleRefresh(t,e=1e3*this.timeToLoad){self.clearTimeout(this.reloadTimer),this.reloadTimer=self.setTimeout((()=>{this.loadSteeringManifest(t)}),e)}}});function Vs(t){return t&&"object"==typeof t?Array.isArray(t)?t.map(Vs):Object.keys(t).reduce(((e,i)=>(e[i]=Vs(t[i]),e)),{}):t}class js{static get version(){return"1.4.0"}static isSupported(){return function(){const t=yi();if(!t)return!1;const e=vi(),i=t&&"function"==typeof t.isTypeSupported&&t.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove;return!!i&&!!r}()}static get Events(){return h}static get ErrorTypes(){return d}static get ErrorDetails(){return c}static get DefaultConfig(){return js.defaultConfig?js.defaultConfig:Hs}static set DefaultConfig(t){js.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Er,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,function(t,e){if(self.console&&!0===t||"object"==typeof t){!function(t,...e){e.forEach((function(e){g[e]=t[e]?t[e].bind(t):function(t){const e=self.console[t];return e?e.bind(self.console,`[${t}] >`):u}(e)}))}(t,"debug","log","info","warn","error");try{g.log('Debug logs enabled for "Hls instance" in hls.js version 1.4.0')}catch(t){g=f}}else g=f}(t.debug||!1);const e=this.config=function(t,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==e.liveMaxLatencyDurationCount&&(void 0===e.liveSyncDurationCount||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==e.liveMaxLatencyDuration&&(void 0===e.liveSyncDuration||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Vs(t),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((t=>{const s=`${"level"===t?"playlist":t}LoadPolicy`,n=void 0===e[s],a=[];r.forEach((r=>{const o=`${t}Loading${r}`,l=e[o];if(void 0!==l&&n){a.push(o);const t=i[s].default;switch(e[s]={default:t},r){case"TimeOut":t.maxLoadTimeMs=l,t.maxTimeToFirstByteMs=l;break;case"MaxRetry":t.errorRetry.maxNumRetry=l,t.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":t.errorRetry.retryDelayMs=l,t.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":t.errorRetry.maxRetryDelayMs=l,t.timeoutRetry.maxRetryDelayMs=l}}})),a.length&&p.warn(`hls.js config: "${a.join('", "')}" setting(s) are deprecated, use "${s}": ${JSON.stringify(e[s])}`)})),n(n({},i),e)}(js.DefaultConfig,t);this.userConfig=t,this._autoLevelCapping=-1,e.progressive&&function(t){const e=t.loader;e!==Us&&e!==Fs?(p.log("[config]: Custom loader detected, cannot enable progressive streaming"),t.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1}()&&(t.loader=Us,t.progressive=!0,t.enableSoftwareAES=!0,p.log("[config]: Progressive streaming enabled, using FetchLoader"))}(e);const{abrController:i,bufferController:r,capLevelController:s,errorController:a,fpsController:o}=e,l=new a(this),d=this.abrController=new i(this),c=this.bufferController=new r(this),m=this.capLevelController=new s(this),y=new o(this),v=new Yt(this),E=new se(this),T=e.contentSteeringController,b=T?new T(this):null,S=this.levelController=new ke(this,b),w=new Ne(this),R=new je(this.config),_=this.streamController=new wr(this,w,R);m.setStreamController(_),y.setStreamController(_);const A=[v,S,_];b&&A.splice(1,0,b),this.networkControllers=A;const L=[d,c,m,y,E,w];this.audioTrackController=this.createController(e.audioTrackController,A);const C=e.audioStreamController;C&&A.push(new C(this,w,R)),this.subtitleTrackController=this.createController(e.subtitleTrackController,A);const I=e.subtitleStreamController;I&&A.push(new I(this,w,R)),this.createController(e.timelineController,L),R.emeController=this.emeController=this.createController(e.emeController,L),this.cmcdController=this.createController(e.cmcdController,L),this.latencyController=this.createController(ne,L),this.coreComponents=L,A.push(l);const k=l.onErrorOut;"function"==typeof k&&this.on(h.ERROR,k,l)}createController(t,e){if(t){const i=new t(this);return e&&e.push(i),i}return null}on(t,e,i=this){this._emitter.on(t,e,i)}once(t,e,i=this){this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,i=this,r){this._emitter.off(t,e,i,r)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(e){p.error("An internal error happened while handling event "+t+'. Error message: "'+e.message+'". Here is a stacktrace:',e),this.trigger(h.ERROR,{type:d.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,fatal:!1,event:t,error:e})}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){p.log("destroy"),this.trigger(h.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((t=>t.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((t=>t.destroy())),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){p.log("attachMedia"),this._media=t,this.trigger(h.MEDIA_ATTACHING,{media:t})}detachMedia(){p.log("detachMedia"),this.trigger(h.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();const i=this.media,r=this.url,s=this.url=e.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});p.log(`loadSource:${s}`),i&&r&&r!==s&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(i)),this.trigger(h.MANIFEST_LOADING,{url:t})}startLoad(t=-1){p.log(`startLoad(${t})`),this.networkControllers.forEach((e=>{e.startLoad(t)}))}stopLoad(){p.log("stopLoad"),this.networkControllers.forEach((t=>{t.stopLoad()}))}swapAudioCodec(){p.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){p.log("recoverMediaError");const t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t,e=0){this.levelController.removeLevel(t,e)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){p.log(`set currentLevel:${t}`),this.loadLevel=t,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){p.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){p.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){p.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){return this.levelController.startLevel}set startLevel(t){p.log(`set startLevel:${t}`),-1!==t&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(p.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t)}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){ae.indexOf(t)>-1&&(this._maxHdcpLevel=t)}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const i=t.length;for(let r=0;r<i;r++)if(t[r].maxBitrate>=e)return r;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:i}=this;let r;if(r=-1===e&&t&&t.length?t.length-1:e,i)for(let e=r;e--;){const r=t[e].attrs["HDCP-LEVEL"];if(r&&r<=i)return e}return r}get nextAutoLevel(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)}set nextAutoLevel(t){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,t)}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return!!t&&t.subtitleDisplay}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}js.defaultConfig=void 0;var qs=r(187),Ws=r.n(qs),Ys=r(238),zs=r.n(Ys);const Xs={debug:0,info:1,warn:2,error:3,none:4},Qs=["_debugP","_infoP","_warnP","_errorP"];function Js(){}const Zs={key:"free",wsSignalerAddr:"wss://single.bapy.top/ws",announce:"https://single.bapy.top",wsMaxRetries:3,wsReconnectInterval:5,p2pEnabled:!0,dcRequestTimeout:3,dcUploadTimeout:3,dcPings:5,dcTolerance:4,packetSize:16384,maxBufSize:104857600,loadTimeout:5,enableLogUpload:!1,logUploadAddr:"ws://127.0.0.1/trace",logUploadLevel:"warn",logLevel:"none",autoStartLoad:!0,lowLatencyMode:!1,startFragPrefetch:!0,maxBufferSize:6e7};var tn=r(847),en=r.n(tn);const rn="function"==typeof btoa,sn="function"==typeof Buffer,nn=("function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder?new TextEncoder:void 0),an=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),on=((t=>{let e={};t.forEach(((t,i)=>e[t]=i))})(an),String.fromCharCode.bind(String)),ln=("function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array),t=>t.replace(/=/g,"").replace(/[+\/]/g,(t=>"+"==t?"-":"_"))),hn=rn?t=>btoa(t):sn?t=>Buffer.from(t,"binary").toString("base64"):t=>{let e,i,r,s,n="";const a=t.length%3;for(let a=0;a<t.length;){if((i=t.charCodeAt(a++))>255||(r=t.charCodeAt(a++))>255||(s=t.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=i<<16|r<<8|s,n+=an[e>>18&63]+an[e>>12&63]+an[e>>6&63]+an[63&e]}return a?n.slice(0,a-3)+"===".substring(a):n},dn=sn?t=>Buffer.from(t).toString("base64"):t=>{let e=[];for(let i=0,r=t.length;i<r;i+=4096)e.push(on.apply(null,t.subarray(i,i+4096)));return hn(e.join(""))},cn=t=>{if(t.length<2)return(e=t.charCodeAt(0))<128?t:e<2048?on(192|e>>>6)+on(128|63&e):on(224|e>>>12&15)+on(128|e>>>6&63)+on(128|63&e);var e=65536+1024*(t.charCodeAt(0)-55296)+(t.charCodeAt(1)-56320);return on(240|e>>>18&7)+on(128|e>>>12&63)+on(128|e>>>6&63)+on(128|63&e)},un=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,fn=sn?t=>Buffer.from(t,"utf8").toString("base64"):nn?t=>dn(nn.encode(t)):t=>hn(t.replace(un,cn)),gn=(t,e=!1)=>e?ln(fn(t)):fn(t);class pn extends(Ws()){constructor(t,e,i,r,s){var n;super(),this.engine=t,this.key=e,this.channel=i,this.announce=r,this.browserInfo=s,this.conns=0,this.channelVal=(n=(n=(n=(n=this.engine.hlsjs.url).replace("http://","")).replace("https://","")).replace(".m3u8",""),gn(n)),this.announceURL=this.announce+"/channel",this.heartbeatURL=this.announceURL+"/"+this.channelVal+"/node/",this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.httpDownloaded=0,this.p2pDownloaded=0,this.totalP2PUploaded=0}btAnnounce(){var t={channel:this.channelVal},e=this,i=this.engine.logger;return new Promise((function(r,s){fetch(e.announceURL,{method:"POST",body:JSON.stringify(t)}).then((function(t){return t.json()})).then((function(t){e.peerId=t.data.id,r(t)})).catch((function(t){i.error("[fetcher] btAnnounce error "+t),s(t)}))}))}btHeartbeat(t){var e=this,i=this.engine.logger;this.heartbeater=window.setInterval((function(){fetch(e.heartbeatURL+e.peerId+"/stats",{method:"POST"}).then((function(t){})).catch((function(t){window.clearInterval(e.heartbeater),i.error("[fetcher] btHeartbeat error "+t)}))}),1e3*t)}btGetPeers(t,e){var i=this,r=this.engine.logger;this.getPeers=window.setInterval((function(){fetch(i.heartbeatURL+i.peerId+"/peers",{method:"POST"}).then((function(t){return t.json()})).then((function(t){e(t)})).catch((function(t){window.clearInterval(i.getPeers),r.error("[fetcher] btGetPeers error: "+t)}))}),1e3*t)}btPPeers(){var t=this,e=this.engine.logger;return new Promise((function(i,r){fetch(t.heartbeatURL+t.peerId+"/peers",{method:"POST"}).then((function(t){return t.json()})).then((function(t){i(t)})).catch((function(t){e.error("[fetcher] btAnnounce error "+t),r(t)}))}))}reportUploaded(t){var e=Math.round(t/1024);this.totalP2PUploaded+=e,this._emitStats()}reportFlow(t,e){var i=Math.round(t.total/1024);e?(this.p2pDownloaded+=i,this.totalP2PDownloaded+=i):(this.httpDownloaded+=i,this.totalHTTPDownloaded+=i),this._emitStats()}_emitStats(){this.engine.emit("stats",{totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded})}increConns(){this.conns++}decreConns(){this.conns++}}const mn=pn;class yn extends(Ws()){constructor(t,e,i){super(),this.engine=t,this.peerId=e,this.config=i,this.connected=!1,this._ws=this._init(e),this.wsHeartbeat=null}_init(t){const{logger:e}=this.engine,i={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:1e3*this.config.wsReconnectInterval};let r=`?id=${t}`,s=new(en())(this.config.wsSignalerAddr+r,void 0,i);return s.onopen=()=>{e.info("Signaler websocket connection opened"),this.connected=!0,this.wsHeartbeat=setInterval((()=>{this.send({action:"ping"})}),2e4),this.onopen&&this.onopen()},s.push=s.send,s.send=e=>{let i=JSON.stringify(Object.assign({peer_id:t},e));s.push(i)},s.onmessage=t=>{this.onmessage&&this.onmessage(t)},s.onclose=t=>{console.warn("websocket 断开: "+t.code+" "+t.reason+" "+t.wasClean),console.warn(t),e.warn("Signaler websocket closed"),this.onclose&&this.onclose(),this.connected=!1},s}sendSignal(t,e){let i={action:"signal",peer_id:this.peerId,to_peer_id:t,data:e};this.send(i)}send(t){this._ws.send(t)}close(){this._ws.close(),this._ws=null,clearInterval(this.wsHeartbeat),this.wsHeartbeat=null}}const vn=yn;r(853);const En={DC_PING:"PING",DC_PONG:"PONG",DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_TRANSITION:"TRANSITION",DC_GRANT:"GRANT",DC_LACK:"LACK",DC_DISPLACE:"DISPLACE",DC_BITFIELD:"BITFIELD",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_INTERESTED:"INTERESTED",DC_NOTINTERESTED:"NOT_INTERESTED",DC_HAVE:"HAVE",DC_LOST:"LOST",BM_LOST:"lost",SEGMENT:"segment",TRANSITION:"transition",DISPLACE:"displace",CONNECT:"connect",ADOPT:"adopt"};var Tn=r(764);class bn extends(Ws()){constructor(t,e,i,s,n){super();var a=r(853);return this.engine=t,this.channelId=s?e+"-"+i:i+"-"+e,this.config=n,this.connected=!1,this.localPeerId=e,this.remotePeerId=i,this.delays=[],this.msgQueue=[],this.rcvdReqQueue=[],this._datachannel=new a({initiator:s,objectMode:!0}),this._init(this._datachannel),this.recordSended=this._adjustStreamingRate(10),this}_init(e){let i=this.engine.logger;var r=this;e.on("error",(function(){r.emit(En.DC_ERROR)})),e.on("signal",(t=>{i.debug(t),r.emit(En.DC_SIGNAL,t)})),e.once("connect",(function(){for(i.debug("datachannel CONNECTED to "+r.remotePeerId),r.connected=!0,r.emit(En.DC_OPEN),r._sendPing();r.msgQueue.length>0;){var t=r.msgQueue.shift();r.emit(t.event,t)}})),e.on("data",(function(e){if(i.debug("接收数据:",e),"string"==typeof e){i.debug("datachannel receive string: "+e+"from "+r.remotePeerId);var s=JSON.parse(e);if(!r.connected)return void r.msgQueue.push(s);switch(s.event){case En.DC_PONG:r._handlePongMsg();break;case En.DC_PING:r.sendJson({event:En.DC_PONG});break;case En.DC_PIECE:r._prepareForBinary(s.attachments,s.url,s.sn,s.size),r.emit(s.event,s);break;case En.DC_PIECE_NOT_FOUND:window.clearTimeout(t.requestTimeout),r.requestTimeout=null,r.emit(s.event,s);break;case En.DC_REQUEST:r._handleRequestMsg(s);break;case En.DC_GRANT:r._handleGrant(s);break;case En.DC_PIECE_ACK:r._handlePieceAck();break;default:r.emit(s.event,s)}}else r.bufArr.push(e),0==--r.remainAttachments&&(window.clearTimeout(r.requestTimeout),r.requestTimeout=null,r.sendJson({event:En.DC_PIECE_ACK,sn:r.bufSN,url:r.bufUrl}),r._handleBinaryData())})),e.once("close",(function(){r.emit(En.DC_CLOSE)}))}_sendPing(){var t=this;this.ping=performance.now();for(var e=0;e<this.config.dcPings;e++)this.sendJson({event:En.DC_PING});window.setTimeout((function(){if(t.delays.length>0){var e=0,i=!0,r=!1,s=void 0;try{for(var n,a=t.delays[Symbol.iterator]();!(i=(n=a.next()).done);i=!0)e+=n.value}catch(t){r=!0,s=t}finally{try{!i&&a.return&&a.return()}finally{if(r)throw s}}t.delay=e/t.delays.length,t.delays=[]}}),100)}sendBitField(t){this.engine.logger.debug("sendBitField:",t),this.sendJson({event:En.DC_BITFIELD,field:t})}sendJson(t){this.send(JSON.stringify(t))}send(t){this._datachannel&&this._datachannel.connected&&this._datachannel.send(t)}receiveSignal(t){this.engine.logger.debug("接收数据-receiveSignal:",t),this._datachannel.signal(t)}_handlePongMsg(){var t=performance.now()-this.ping;this.delays.push(t)}_prepareForBinary(t,e,i,r){this.bufArr=[],this.remainAttachments=t,this.bufUrl=e,this.bufSN=i,this.expectedSize=r}_handleRequestMsg(t){this.rcvdReqQueue.length>0?t.urgent?this.rcvdReqQueue.push(t.sn):this.rcvdReqQueue.unshift(t.sn):this.emit(En.DC_REQUEST,t)}_handleGrant(t){t.TTL>0&&this.emit(En.DC_GRANT,t)}_handlePieceAck(){let t=this.engine.logger;if(this.uploading=!1,window.clearTimeout(this.uploadTimeout),this.uploadTimeout=null,this.rcvdReqQueue.length>0){var e=this.rcvdReqQueue.pop();t.debug("_handlePieceAck:",e),this.emit(En.DC_REQUEST,{sn:e})}}_handleBinaryData(){var t=Tn.Buffer.concat(this.bufArr);this.engine.logger.debug("_handleBinaryData::",t,t.byteLength,this.expectedSize),t.byteLength==this.expectedSize&&this.emit(En.DC_RESPONSE,{url:this.bufUrl,sn:this.bufSN,data:t}),this.bufUrl="",this.bufArr=[],this.expectedSize=-1,this.downloading=!1}_loadtimeout(){var t=this.engine.logger;if(t.warn("datachannel timeout while downloading from "+this.remotePeerId),this.emit(En.DC_TIMEOUT),this.requestTimeout=null,this.downloading=!1,++this.miss>=this.config.dcTolerance){var e={event:En.DC_CLOSE};this.sendJson(e),t.warn("datachannel download miss reach dcTolerance, close "+this.remotePeerId),this.emit(En.DC_ERROR)}}requestDataByURL(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i={event:En.DC_REQUEST,url:t,urgent:e};this.downloading=!0,this.sendJson(i),e&&(this.requestTimeout=window.setTimeout(this._loadtimeout.bind(this),1e3*this.config.dcRequestTimeout))}requestDataBySN(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i={event:En.DC_REQUEST,sn:t,urgent:e};this.downloading=!0,this.sendJson(i),e&&(this.requestTimeout=window.setTimeout(this._loadtimeout.bind(this),1e3*this.config.dcRequestTimeout))}_uploadtimeout(){this.engine.logger.warn("datachannel timeout while uploading to "+this.remotePeerId),this.uploading=!1,this.rcvdReqQueue=[]}_adjustStreamingRate(t){var e=this,i=0;return this.adjustSRInterval=window.setInterval((function(){e.streamingRate=Math.round(8*i/t),i=0}),1e3*t),function(t){i+=t}}sendBuffer(t,e,i){this.uploading=!0,this.uploadTimeout=window.setTimeout(this._uploadtimeout.bind(this),1e3*this.config.dcUploadTimeout);var r=i.byteLength,s=this.config.packetSize,n=0,a=0;r%s==0?a=r/s:(a=Math.floor(r/s)+1,n=r%s);var o={event:En.DC_PIECE,attachments:a,url:e,sn:t,size:r};this.sendJson(o);for(var l=function(t,e,i,r){var s=[];if(r){for(var n=void 0,a=0;a<i-1;a++)n=t.slice(a*e,(a+1)*e),s.push(n);n=t.slice(t.byteLength-r,t.byteLength),s.push(n)}else for(var o=void 0,l=0;l<i;l++)o=t.slice(l*e,(l+1)*e),s.push(o);return s}(i,s,a,n),h=0;h<l.length;h++)this.send(l[h]);this.recordSended(r)}destroy(){window.clearInterval(this.adjustSRInterval),window.clearInterval(this.pinger),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}}const Sn=bn;class wn extends(Ws()){constructor(t,e){super(),this.engine=t,this.config=e,this.bufMgr=null,this.peerMap=new Map,this.bitset=new Set,this.bitCounts=new Map}set bufferManager(t){this.bufMgr=t,t.on(En.BM_LOST,(t=>{this._broadcastToPeers({event:En.DC_LOST,sn:t}),this.bitset.delete(t)}))}updateLoadedSN(t){if(this.bitset.add(t),this.bitCounts.has(t)&&this.bitCounts.delete(t),this.peerMap.size>0){const e={event:En.DC_HAVE,sn:t};this._broadcastToPeers(e)}}updateLoadingSN(t){this.loadingSN=t}updatePlaySN(t){const{logger:e}=this.engine;if(e.debug("scheduler updatePlaySN:",t),this.config.live)return;if(!this.hasPeers)return;let i=[];for(let r=t+1;r<=t+this.config.urgentOffset+1;r++)if(!this.bitset.has(r)&&r!==this.loadingSN&&this.bitCounts.has(r))for(let t of this.peerMap.values())if(!1===t.downloading&&t.bitset.has(r)){t.requestDataBySN(r,!0),e.debug(`request urgent ${r} from peer ${t.remotePeerId}`),i.push(r);break}let r=this._getIdlePeer();if(0===r.length||0===this.bitCounts.size||this.bufMgr.overflowed)return;let s=[...this.bitCounts.entries()].sort(((t,e)=>t[1]<e[1]));if(0===s.length)return;let n=s.pop()[0];for(;n===this.loadingSN||i.includes(n);){if(0===s.length)return;n=s.pop()[0]}for(let t of r)if(t.bitset.has(n)){t.requestDataBySN(n,!1),e.debug(`request rearest ${n} from peer ${t.remotePeerId}`);break}}_broadcastToPeers(t){for(let e of this.peerMap.values())e.sendJson(t)}addPeer(t){const{logger:e}=this.engine;e.info(`add peer ${t.remotePeerId}`),this.peerMap.set(t.remotePeerId,t),this.engine.emit("peers",[...this.peerMap.keys()])}peersHasSN(t){return this.bitCounts.has(t)}load(t,e,i){const{logger:r}=this.engine;this.context=t;const s=t.frag;let n;this.callbacks=i,this.stats={trequest:performance.now(),retry:0,tfirst:0,tload:0,loaded:0},this.criticalSeg={sn:s.sn,relurl:s.relurl};for(let t of this.peerMap.values())r.info("scheduler load",t),t.bitset.has(s.sn)&&(n=t);n&&(n.requestDataByURL(s.relurl,!0),r.info(`request criticalSeg url ${s.relurl} at ${s.sn}`)),this.criticaltimeouter=window.setTimeout(this._criticaltimeout.bind(this),1e3*this.config.loadTimeout)}handshakePeer(t){this._setupDC(t),t.sendBitField(Array.from(this.bitset))}_setupDC(t){var e=this;const{logger:i}=this.engine;t.on(En.DC_BITFIELD,(e=>{if(!e.field)return;let i=new Set(e.field);t.bitset=i,e.field.forEach((t=>{this.bitset.has(t)||this._increBitCounts(t)})),this.addPeer(t)})).on(En.DC_HAVE,(e=>{if(!e.sn||!t.bitset)return;const i=e.sn;t.bitset.add(i),this.bitset.has(i)||this._increBitCounts(i)})).on(En.DC_LOST,(e=>{if(!e.sn||!t.bitset)return;const i=e.sn;t.bitset.delete(i),this._decreBitCounts(i)})).on(En.DC_PIECE,(t=>{this.criticalSeg&&this.criticalSeg.relurl===t.url&&(this.stats.tfirst=Math.max(performance.now(),this.stats.trequest))})).on(En.DC_PIECE_NOT_FOUND,(t=>{this.criticalSeg&&this.criticalSeg.relurl===t.url&&(window.clearTimeout(this.criticaltimeouter),this.criticaltimeouter=null,this._criticaltimeout())})).on(En.DC_RESPONSE,(t=>{if(this.criticalSeg&&this.criticalSeg.relurl===t.url&&this.criticaltimeouter){i.info(`receive criticalSeg url ${t.url}`),window.clearTimeout(this.criticaltimeouter),e.criticaltimeouter=null;let r=e.stats;r.tload=Math.max(r.tfirst,performance.now()),r.loaded=r.total=t.data.byteLength,e.criticalSeg=null,t.data=t.data.buffer,e.callbacks.onSuccess(t,r,this.context)}else this.bufMgr.addBuffer(t.sn,t.url,t.data);this.updateLoadedSN(t.sn)})).on(En.DC_REQUEST,(e=>{let r="";if(r=e.url?e.url:this.bufMgr.getURLbySN(e.sn),r&&this.bufMgr.hasSegOfURL(r)){let s=this.bufMgr.getSegByURL(r);i.debug("发送数据 <- 接收到数据请求:",e,s,s.relurl,s.data),t.sendBuffer(e.sn,s.relurl,s.data),this.engine.fetcher.reportUploaded(s.data.byteLength),this.engine.signaler.signalerWs.send({action:"tranx",to_peer_id:t.remotePeerId})}else t.sendJson({event:En.DC_PIECE_NOT_FOUND,url:r,sn:e.sn})})).on(En.DC_TIMEOUT,(()=>{i.warn("DC_TIMEOUT")}))}deletePeer(t){this.peerMap.has(t.remotePeerId)&&(t.bitset.forEach((t=>{this._decreBitCounts(t)})),this.peerMap.delete(t.remotePeerId)),this.engine.emit("peers",[...this.peerMap.keys()])}addPeer(t){const{logger:e}=this.engine;e.info(`add peer ${t.remotePeerId}`),this.peerMap.set(t.remotePeerId,t),this.engine.emit("peers",[...this.peerMap.keys()])}_decreBitCounts(t){if(this.bitCounts.has(t)){let e=this.bitCounts.get(t);1===e?this.bitCounts.delete(t):this.bitCounts.set(t,e-1)}}_increBitCounts(t){if(this.bitCounts.has(t)){let e=this.bitCounts.get(t);this.bitCounts.set(t,e+1)}else this.bitCounts.set(t,1)}_criticaltimeout(){const{logger:t}=this.engine;t.warn("_criticaltimeout"),this.criticalSeg=null,this.callbacks.onTimeout(this.stats,this.context,null),this.criticaltimeouter=null}}const Rn=wn;class _n extends(Ws()){constructor(t,e,i){super(),this.engine=t,this.config=i,this.connected=!1,this.scheduler=new Rn(t,i),this.DCMap=new Map,this.failedDCSet=new Set,this.signalerWs=null,this.heartbeatInterval=30,this.fetcher=e,this.failPeers=new Map,this.peers=[]}set currentPlaySN(t){this.scheduler.updatePlaySN(t)}set currentLoadingSN(t){this.scheduler.updateLoadingSN(t)}set currentLoadedSN(t){this.scheduler.updateLoadedSN(t)}_tryConnectToPeer(){const{logger:t}=this.engine;if(0===this.peers.length)return;let e=this.peers.length;for(var i=0;i<e;i++){var r=this.peers.pop().id;t.info(`tryConnectToPeer ${r}`);var s=new Sn(this.engine,this.peerId,r,!0,this.config);this.DCMap.set(r,s),this._setupDC(s)}}_setupDC(t){var e=this;const{logger:i}=this.engine;t.on(En.DC_SIGNAL,(r=>{const s=t.remotePeerId;i.debug("remotePeerId:",s),e.signalerWs.sendSignal(s,r),e.signalTimer||e.failedDCSet.has(s)||(e.signalTimer=window.setTimeout((()=>{e.DCMap.delete(s),e.failedDCSet.add(s),i.warn(`signaling ${s} timeout`),e.signalTimer=null,e._tryConnectToPeer()}),1e4))})).once(En.DC_ERROR,(()=>{i.warn(`datachannel error ${t.channelId}`),this.scheduler.deletePeer(t),this.DCMap.delete(t.remotePeerId),this.failedDCSet.add(t.remotePeerId),this._tryConnectToPeer(),t.destroy(),this._requestMorePeers(),t.isInitiator&&(t.connected?this.fetcher.decreConns():this.fetcher.increFailConns())})).once(En.DC_OPEN,(()=>{i.debug("连接成功!!! - Events.DC_OPEN"),e.scheduler.handshakePeer(t),e.DCMap.size<e.config.neighbours&&e._tryConnectToPeer(),e.fetcher.increConns()}))}_initSignalerWs(){const{logger:t}=this.engine;t.debug("_initSignalerWs:",this.peerId);let e=new vn(this.engine,this.peerId,this.config);return e.onopen=()=>{this.connected=!0,this._tryConnectToPeer()},e.onmessage=e=>{let i=JSON.parse(e.data),r=i.action;switch(r){case"signal":if(this.failedDCSet.has(i.from_peer_id))return;if(t.debug(`start handle signal of ${i.from_peer_id}`),window.clearTimeout(this.signalTimer),this.signalTimer=null,i.data)this.failPeers.delete(i.from_peer_id),this._handleSignal(i.from_peer_id,i.data);else{var s=this.failPeers.get(i.from_peer_id)||0;s++,this.failPeers.set(i.from_peer_id,s),s>3&&(this.DCMap.delete(i.from_peer_id),this.failedDCSet.add(i.from_peer_id),t.info(`signaling ${i.from_peer_id} not found`)),this._tryConnectToPeer()}break;case"reject":this.stopP2P();break;default:t.warn("Signaler websocket unknown action "+r)}},e.onclose=()=>{this.connected=!1,this.destroy()},e}resumeP2P(){const{logger:t}=this.engine;var e=this;t.debug("Tracker resumeP2P"),this.fetcher.btAnnounce().then((i=>{t.info(`announceURL response ${JSON.stringify(i)}`),e.peerId=i.data.id,t.identifier=e.peerId,e.fetcher.btHeartbeat(i.data.report_interval),e.signalerWs=e._initSignalerWs(),e._handlePeers(i.data.peers),e.engine.emit("peerId",e.peerId),e._requestMorePeers()})).catch((t=>{}))}_handleSignal(t,e){const{logger:i}=this.engine;let r=this.DCMap.get(t);if(r&&r.connected)i.info("datachannel had connected, signal ignored");else{if(!r){if(i.debug(`receive node ${t} connection request`),this.failedDCSet.has(t))return;r=new Sn(this.engine,this.peerId,t,!1,this.config),this.DCMap.set(t,r),this._setupDC(r)}r.receiveSignal(e)}}_handlePeers(t){var e=this,i=function(t){for(var i=0;i<e.peers.length;i++)if(t.id==e.peers[i].id)return!0;return!1};for(let e of t)i(e)||this.peers.push({id:e.id});this.peers=this.peers.filter((t=>{for(let e of[...this.DCMap.keys(),...this.failedDCSet.keys()])if(t.id===e)return!1;return!0}))}_requestMorePeers(){const{logger:t}=this.engine;var e=this;this.fetcher.btPPeers(3).then((i=>{t.info(`_requestMorePeers ${JSON.stringify(i)}`),e._handlePeers(i.data.peers)}))}destroy(){window.clearInterval(this.heartbeater),this.heartbeater=null}}const An=_n;class Ln extends(Ws()){constructor(t){super(),this.logger=t.logger,this.currLoaded=t.currLoaded,this.currLoadedDuration=t.currLoadedDuration,this.currPlay=t.currPlay,this.bufMgr=t.bufMgr,this.xhrLoader=new t.loader(t),this.p2pEnabled=t.p2pEnabled,this.scheduler=t.scheduler,this.fetcher=t.fetcher,this.stats=this.xhrLoader.stats}destroy(){}abort(){}load(t,e,i){const{logger:r}=this,s=t.frag;if(s.loadByP2P=!1,s.loadByHTTP=!1,this.bufMgr.hasSegOfURL(s.relurl)){r.debug(`bufMgr found seg sn ${s.sn} url ${s.relurl}`);let e,n,a,o,l,h=this.bufMgr.getSegByURL(s.relurl),d={url:t.url,data:h.data};e=performance.now(),n=a=e+50,o=l=s.loaded=h.size;let c={trequest:e,tfirst:n,tload:a,loaded:o,total:l,retry:0};s.loadByP2P=!0,d.data=d.data.buffer,window.setTimeout((()=>{this.fetcher.reportFlow(c,!0),i.onSuccess(d,c,t)}),50)}else if(this.scheduler.peersHasSN(s.sn)){r.info(`found sn ${s.sn} from peers`),t.frag.loadByP2P=!0,this.scheduler.load(t,e,i),i.onTimeout=(t,n)=>{r.debug(`xhrLoader load ${s.relurl} at ${s.sn}`),s.loadByP2P=!1,s.loadByHTTP=!0,this.xhrLoader.load(n,e,i)};const n=i.onSuccess;i.onSuccess=(t,e,i)=>{this.bufMgr.hasSegOfURL(s.relurl)||this.bufMgr.copyAndAddBuffer(t.data,s.relurl,s.sn),this.fetcher.reportFlow(e,!0),s.loaded=e.loaded,r.debug("P2P loaded time "+(e.tload-e.trequest)+"ms"),n(t,e,i)}}else{r.debug(`xhrLoader load ${s.relurl} at ${s.sn}`),t.frag.loadByHTTP=!0,this.xhrLoader.load(t,e,i);const n=i.onSuccess;i.onSuccess=(t,e,i)=>{this.bufMgr.hasSegOfURL(s.relurl)||(r.debug("HTTP loaded time "+s.relurl+" "+(e.tload-e.trequest)+"ms"),this.bufMgr.copyAndAddBuffer(t.data,s.relurl,s.sn)),this.fetcher.reportFlow(e,!1),n(t,e,i)}}}}const Cn=Ln;class In extends(Ws()){constructor(t,e){super(),this.engine=t,this.config=e,this._segPool=new Map,this._currBufSize=0,this.sn2Url=new Map,this.overflowed=!1}get currBufSize(){return this._currBufSize}hasSegOfURL(t){return this._segPool.has(t)}copyAndAddBuffer(t,e,i){let r=Tn.Buffer.from(t),s=r.byteLength,n=new Tn.Buffer(s);r.copy(n);let a={sn:i,relurl:e,data:n,size:s};this.addSeg(a),this.sn2Url.set(i,e)}addBuffer(t,e,i){let r={sn:t,relurl:e,data:i,size:i.byteLength};this.addSeg(r),this.sn2Url.set(t,e)}addSeg(t){const{logger:e}=this.engine;for(this._segPool.set(t.relurl,t),this._currBufSize+=parseInt(t.size);this._currBufSize>this.config.maxBufSize;){const t=[...this._segPool.values()].shift();e.info(`pop seg ${t.relurl} at ${t.sn}`),this._segPool.delete(t.relurl),this.sn2Url.delete(t.sn),this._currBufSize-=parseInt(t.size),this.overflowed||(this.overflowed=!0),this.emit(En.BM_LOST,t.sn)}}getSegByURL(t){return this._segPool.get(t)}getURLbySN(t){return this.sn2Url.get(t)}clear(){this._segPool.clear(),this.sn2Url.clear(),this._currBufSize=0}}const kn=In,Dn=(new(zs())).getResult();class Pn extends(Ws()){static get Events(){return En}static get uaParserResult(){return Dn}constructor(t,e){super(),this.config=Object.assign({},Zs,e),this.hlsjs=t,this.p2pEnabled=!1!==this.config.disableP2P,t.config.currLoaded=t.config.currPlay=0;const i=(e,r)=>{const s=r.details.live;this.config.live=s;let n=t.url.split("?")[0],a=new class{constructor(t,e){if(this.config=t,t.logLevel in Xs||(t.logLevel="none"),t.debug)console.log("开始调试");else for(let e=0;e<Xs[t.logLevel];e++)this[Qs[e]]=Js}debug(t){this._debugP(...arguments)}info(t){this._infoP(...arguments)}warn(t){this._warnP(...arguments)}error(t){this._errorP(...arguments)}_debugP(t){console.log("P2P调试:",...arguments)}_infoP(t){console.info("P2P调试:",...arguments)}_warnP(t){console.warn("P2P调试:",...arguments)}_errorP(t){console.error("P2P调试:",...arguments)}}(this.config,n);this.hlsjs.config.logger=this.logger=a,a.debug("M3U8文件加载成功:",e,r),this._init(n),t.off(t.constructor.Events.LEVEL_LOADED,i)};t.on(t.constructor.Events.LEVEL_LOADED,i)}_init(t){const{logger:e}=this;let i={browser:Dn.browser.name,device:"mobile"===Dn.device.type?"mobile":"PC",os:Dn.os.name};this.hlsjs.config.p2pEnabled=this.p2pEnabled,this.bufMgr=new kn(this,this.config),this.hlsjs.config.bufMgr=this.bufMgr;let r=new mn(this,this.config.key,window.encodeURIComponent(t),this.config.announce,i);this.fetcher=r,this.signaler=new An(this,r,this.config),this.signaler.scheduler.bufferManager=this.bufMgr,this.hlsjs.config.fLoader=Cn,this.hlsjs.config.scheduler=this.signaler.scheduler,this.hlsjs.config.fetcher=r,this.hlsjs.on(this.hlsjs.constructor.Events.FRAG_LOADING,((t,i)=>{e.debug("FRAG_LOADING: "+i.frag.sn),this.signaler.currentLoadingSN=i.frag.sn})),this.signalTried=!1,this.hlsjs.on(this.hlsjs.constructor.Events.FRAG_LOADED,((t,e)=>{let i=e.frag.sn;this.hlsjs.config.currLoaded=i,this.signaler.currentLoadedSN=i,this.hlsjs.config.currLoadedDuration=e.frag.duration,!this.signalTried&&this.config.p2pEnabled&&(this.signaler.resumeP2P(),this.signalTried=!0),e.frag.loadByHTTP||(e.frag.loadByP2P=!1,e.frag.loadByHTTP=!0)})),this.hlsjs.on(this.hlsjs.constructor.Events.FRAG_CHANGED,((t,i)=>{e.info("FRAG_CHANGED: "+i.frag.sn);const r=i.frag.sn;this.hlsjs.config.currPlay=r,this.signaler.currentPlaySN=r})),this.hlsjs.on(this.hlsjs.constructor.Events.ERROR,((t,i)=>{e.error(`errorType ${i.type} details ${i.details} errorFatal ${i.fatal}`);const r=this.hlsjs.constructor.ErrorDetails;switch(i.details){case r.FRAG_LOAD_ERROR:case r.FRAG_LOAD_TIMEOUT:this.fetcher.errsFragLoad++;break;case r.BUFFER_STALLED_ERROR:this.fetcher.errsBufStalled++;break;case r.INTERNAL_EXCEPTION:this.fetcher.errsInternalExpt++}})),this.hlsjs.on(this.hlsjs.constructor.Events.DESTROYING,(()=>{this.signaler.destroy(),this.signaler=null}))}disableP2P(){const{logger:t}=this;t.warn("disableP2P"),this.p2pEnabled&&(this.p2pEnabled=!1,this.config.p2pEnabled=this.hlsjs.config.p2pEnabled=this.p2pEnabled,this.signaler&&this.signaler.stopP2P())}enableP2P(){const{logger:t}=this;t.warn("enableP2P"),this.p2pEnabled||(this.p2pEnabled=!0,this.config.p2pEnabled=this.hlsjs.config.p2pEnabled=this.p2pEnabled,this.signaler&&this.signaler.resumeP2P())}}Pn.WEBRTC_SUPPORT=!!function(){if("undefined"==typeof globalThis)return null;var t={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return t.RTCPeerConnection?t:null}(),Pn.version="0.0.1";const xn=Pn;let On={maxBufferSize:6e8,maxBufferLength:30,liveSyncDuration:30,fragLoadingTimeOut:1e4};class Mn extends js{static get P2PEvents(){return xn.Events}static get uaParserResult(){return xn.uaParserResult}constructor(t={}){let e=t.p2pConfig||{};delete t.p2pConfig;let i=Object.assign({},On,t);i.debug=!1,super(i),xn.WEBRTC_SUPPORT&&(this.engine=new xn(this,e))}enableP2P(){this.engine.enableP2P()}disableP2P(){this.engine.disableP2P()}}Mn.engineVersion=xn.version;const Fn=Mn})(),s.default})()));
//# sourceMappingURL=p2p.min.js.map